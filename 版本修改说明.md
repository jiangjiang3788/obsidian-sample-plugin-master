### 1 · 我们已经完成的核心调整

| 调整点                               | 目的                    | 关键改动                                                                      |
| --------------------------------- | --------------------- | ------------------------------------------------------------------------- |
| **抽象 Obsidian API → `@platform`** | 让核心逻辑不再直接依赖 Obsidian。 | `src/platform/obsidian.ts` 封装 `readFile / writeFile / getMarkdownFiles …` |
| **业务核心下沉 → `@core`**              | 提升可测试性；以后迁移平台更简单。     | `dataStore / taskService / utils …` 移到 `src/core/**`，并用别名 `@core/*` 引用    |
| **UI 组件插件化 → `@features`**        | 每个功能独立，可按需裁剪、启停。      | Dashboard、Quick-Input 组件移至 `src/features/*/ui` 并暴露 `setup()`              |
| **共享层 → `@shared`**               | 公用样式 & 小组件一处维护。       | `TaskCheckbox / FieldRadio / styles.css …`                                |
| **`main.ts` 重写**                  | 保持“薄壳”，只做装配 & 设置读写    | 创建 `ThinkContext`，在 `setup()` 时统一注入                                       |

> *结果：项目已完全符合**Core + Platform + Features + Shared** 四层架构，代码块解析 & Dashboard 渲染恢复正常。*

---

### 2 · 接下来建议的收尾事项

| 优先级 | 任务                          | 操作要点                                                                                                                                    |
| --- | --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| ★★★ | **迁移/精简旧的 src/ui\***        | · 将仍残留在 `src/ui` 下的配置页、主题表单等，按“Feature or Shared”规则挪到位<br>· 更新 import；然后删除原文件                                                           |
| ★★  | **SettingsTab → Feature 化** | - 建议在 `src/features/settings/` 新建 `ui/SettingsTab.tsx`<br>- 在 `index.ts` 暴露 `setup(ctx)` ➜ `plugin.addSettingTab(new SettingsTab(ctx))` |
| ★★  | **统一 ESLint 边界规则**          | 使用 `eslint-plugin-boundaries` 禁止跨 Feature 直接 import                                                                                     |
| ★   | **单元测试补货**                  | `core` 层可用 vitest / jest 直接跑；`platform` 接口用 mock                                                                                        |
| ★   | **CI：tsc + vite build**     | 确保 PR / commit 阶段触发编译；早发现路径/类型错误                                                                                                        |
| ☆   | **文档梳理**                    | 在 `README` 添加「如何写新 Feature / 如何扩展 Platform」说明                                                                                           |

---

### 3 · 仍存在的历史遗留 & 易踩坑

| 类别                 | 详情                                                                       | 规避方案                                                                                                 |
| ------------------ | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------- |
| **路径遗漏**           | 旧文件的相对 import（`../views/...`）若未跑完脚本会在 build 时报 *Could not resolve*       | · 继续补充 `moved-paths.json`<br>· 或 VS Code `Find in Files` 搜 `../views`、`../data`                      |
| **样式加载顺序**         | 统一改走 `@shared/styles/styles.css` 后，局部 CSS 可能被覆盖                          | - 调整 `styles.css` 中的选择器权重或拆分成模块化 CSS                                                                 |
| **未抽象的方法**         | 若未来核心层需要 `app.workspace.…` 等接口，要记得在 `platform/obsidian.ts` 再加包装          | 保持 **core 禁止直接 import obsidian** 的原则                                                                 |
| **State 同步**       | Dashboard 内部仍直接读取 `plugin.dashboards`；若设置页改动后没 `notifyChange` 会导致 UI 不刷新 | · 在 `upsertDashboard()` 后调用 `dataStore.notifyChange()`<br>· 或给 Dashboard 加 `useEffect` 订阅 Setting 变更 |
| **Quick-Input 验证** | Modal 里对字段的判空、日期格式仍较脆弱                                                   | 引入 `zod / yup` 在 UI 层做一次 schema 校验                                                                   |
| **Tree-Shake**     | vite build 已设 `moduleSideEffects:false`；务必确认第三方包没有副作用导入（例如 dayjs 插件）     | 若出问题，可在 `package.json#sideEffects` 白名单保留                                                             |

---

> **一句话总结**：
> **核心(无平台依赖) → 平台(Obsidian API) → 插件化特性(Feature) → 共享层(Shared)** 的纵向分层已经打好地基；
> 剩余工作主要是**扫尾迁移 / 规则固化 / 自动化保障**，确保以后再添加功能时不会重蹈耦合的老路。



非常好，这是一个清晰的问题类型总结表。现在你已经修复了一系列构建和运行时错误，我们来 **基于你当前项目结构和状态**，**重新梳理这些问题的含义、成因和最终解决方式**，以便你后续查阅与复用。

---

## ✅ 更新后的问题说明与解决方案

| 问题类型                     | 说明与当前解决方案                                                                                                                                                                           |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ❌ 构建报错：找不到 `./mui-theme` | 原因：你将 `mui-theme.ts` 从 `src/ui/` 移动到了 `src/shared/styles/`，但引用路径未更新。<br>✅ 已改为：<br>`import { theme } from '@shared/styles/mui-theme';`                                               |
| 🧨 组件未被导出                | 例如 `DashboardConfigForm` 被 `SettingsTab` 引用但未暴露。<br>✅ 你已在 `features/dashboard/ui/index.ts` 中补充导出：<br>`export * from './DashboardConfigForm';`                                       |
| 🔁 跨 Feature 引用          | 原本 `features/settings` 直接 import `features/dashboard/ui/DashboardConfigForm`。<br>✅ 已通过 index.ts 暴露，并通过 alias 引入：<br>`import { DashboardConfigForm } from '@features/dashboard/ui';` |
| ❗循环依赖风险                  | 若在 `features/settings/ui/SettingsTab.tsx` 中直接 `import ThinkPlugin from '../main'` 会造成循环依赖。<br>✅ 已通过 `type ThinkPlugin from '@root/main'` 避免实引用，仅作类型标注。                              |
| 💥 Obsidian 低版本兼容性       | 你使用了 API 如 `registerMarkdownCodeBlockProcessor()`、`app.setting.setTabById()` 等，<br>这些需要 Obsidian v0.15.0+。<br>✅ 若需支持旧版本，需添加 Polyfill 或避免调用。                                         |

---

## 📁 当前结构推荐 & 说明

| 文件或模块                      | 推荐位置                        | 说明                                               |
| -------------------------- | --------------------------- | ------------------------------------------------ |
| 样式与主题 `mui-theme.ts`       | `src/shared/styles/`        | 全局样式、theme、变量等归为 `shared` 层                      |
| 设置页相关组件                    | `src/features/settings/ui`  | 与插件设置相关的 `Tab`、表格、表单组件集中在此                       |
| 儿童组件 `DashboardConfigForm` | `src/features/dashboard/ui` | 专属于 Dashboard 配置逻辑的 UI，**不应被设置页直接持有**，已通过导出暴露给外部 |
| 主插件类 `main.ts`             | `src/main.ts`               | 应避免其他模块依赖此文件，以免循环依赖；通过 context 传入即可              |

---

## ✅ 当前已修复的构建/运行问题一览

| 问题                                      | 修复方式                                                     |
| --------------------------------------- | -------------------------------------------------------- |
| `Cannot find module './mui-theme'`      | 改为 `@shared/styles/mui-theme`                            |
| `render is not defined`                 | 添加 `import { render } from 'preact'`                     |
| `h is not defined`                      | 添加 `import { h } from 'preact'`（或一起引入）                   |
| `this.openSettingTab is not a function` | 改为 `this.app.setting.open()` + `setTabById(...)`         |
| `SettingsTab` 无法定位                      | 在其类中添加 `this.id = 'think-settings'`                      |
| `DashboardConfigForm` 未导出               | 在 `index.ts` 中手动 `export * from './DashboardConfigForm'` |

---

## ✅ 统一 import 建议（别名使用）

| 引入模块              | 推荐写法                                                           |
| ----------------- | -------------------------------------------------------------- |
| 引入主插件类类型          | `import type ThinkPlugin from '@root/main'`                    |
| 引入 Dashboard 表单组件 | `import { DashboardConfigForm } from '@features/dashboard/ui'` |
| 引入 Input 表格组件     | `import { InputSettingsTable } from './InputSettingsTable'`    |
| 引入样式主题            | `import { theme } from '@shared/styles/mui-theme'`             |

---

如你需要，我可以继续帮你：

* 生成 `vscode` 自动补全友好的 tsconfig 路径配置；
* 写一个迁移检测脚本，找出所有未更新的 import；
* 优化 Dashboard 模块的懒加载逻辑。

需要继续吗？



这是对你项目当前状态的进一步“代码质量与运行时鲁棒性”增强建议。我们来逐项判断：

---

## ✅ 必要性评估一览

| 问题类型                  | 修改必要性         | 说明                                                                                                                                                                                                                                  |
| --------------------- | ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. State 同步问题**     | ✅ **强烈推荐**    | `plugin.dashboards` 是**共享状态源**，目前 dashboard 组件没有监听这个变化，<br>用户在设置页保存后，若 dashboard 仍显示旧内容，会影响体验与信任感。                                                                                                                                  |
| **2. Quick-Input 验证** | 🔶 **视情况推荐**  | 现在你只对“是否为空”做了简单判断，但没做格式、合法值校验。<br>如果用户粘贴了一段非法 JSON、日期写错、图标字段过长，程序会**悄悄失败**或出错。<br>建议用 `zod` 或 `yup` 做**轻量 schema 校验**（可选，但有价值）。                                                                                                     |
| **3. Tree-Shake 设置**  | 🟡 **建议确认即可** | `vite.config.ts` 中 `treeshake: { moduleSideEffects: false }` 默认是合理的。<br>但你引入了如 `dayjs/plugin/xxx` 这类副作用模块，**不当使用会被误删**。<br>建议你检查是否用了副作用初始化逻辑（如 `dayjs.extend()`）。<br>若有，可以在 `package.json` 添加 `sideEffects: [ "dayjs/plugin/**" ]`。 |

---

## 🧠 建议的优先级排序（含操作说明）

| 优先级      | 项目                   | 操作建议                                                                                                                                     |
| -------- | -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| ⭐ 第 1 顺位 | **Dashboard 状态同步**   | 在 `plugin.upsertDashboard()` 后添加：<br>`this.dataStore.notifyChange();`<br>或 Dashboard 内部加 `useEffect(() => { dataStore.subscribe(...) })` |
| ⭐ 第 2 顺位 | **Quick-Input 校验优化** | 使用 `zod` 写一份输入校验 schema（支持默认值、字段 trim、非法提示），并在 `onSubmit` 前验证                                                                            |
| 第 3 顺位   | **Tree-Shake 安全性**   | 若使用了副作用模块（如 dayjs 的 plugin extend），请在 `package.json` 添加：<br>`"sideEffects": [ "dayjs/plugin/**" ]`                                       |

---

## 🧩 示意代码片段（可选）

### ✅ 1. Dashboard 更新后通知刷新

```ts
async upsertDashboard(cfg: DashboardConfig) {
  const list = this._settings.dashboards;
  const idx = list.findIndex(d => d.name === cfg.name);
  idx >= 0 ? (list[idx] = cfg) : list.push(cfg);
  await this.saveSettings();
  this.dataStore.notifyChange();  // 👈 添加这个
  new Notice(`已保存仪表盘「${cfg.name}」`);
}
```

### ✅ 2. Quick-Input zod schema 示例

```ts
import { z } from 'zod';

const taskSchema = z.object({
  内容: z.string().min(1, '请填写内容'),
  日期: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, '日期格式错误'),
  图标: z.string().max(2).optional(),
});
```

然后在 `submit()` 中：

```ts
const result = taskSchema.safeParse(fields);
if (!result.success) {
  new Notice('输入有误：' + result.error.issues[0].message);
  return;
}
```

---

如你希望我直接生成 `QuickTaskModal.tsx` 的校验增强代码，可以继续说。也可以自动加 dashboard useEffect 刷新逻辑。是否继续？

### 总体架构速览

该插件按“核心层 (core) → 特性层 (features) → 共享层 (shared)”三层分包：

| 层级              | 作用                                                    | 关键点 |
| --------------- | ----------------------------------------------------- | --- |
| **platform**    | 抽象对 Obsidian API 的最薄包装，只暴露插件真正用到的文件/事件读写方法。           |     |
| **core**        | 不依赖 UI，负责数据模型、解析、持久化与事件分发，是所有功能的基础。                   |     |
| **features/**\* | 每个子目录代表一项功能（仪表盘、快速录入、设置等），内部再拆入口 `index.ts` + UI 子目录。 |     |
| **shared**      | 被多功能公用的小组件、样式与工具函数。                                   |     |

> 主入口 `src/main.ts` 在 `onload` 里完成：加载设置 → 初始化平台与 DataStore → 把上下文注入各 Feature。

---

### 各文件一句话说明

> **提示**：以“文件路径 → 功能描述”的格式，方便快速检索。

* **src/main.ts** → 插件主类 `ThinkPlugin`：生命周期、设置加载保存、特性初始化入口。
* **core/CodeblockEmbedder.ts** → 注册 `think` 代码块处理器并渲染 Dashboard 组件。
* **core/VaultWatcher.ts** → 监听 Vault CRUD 事件并触发 DataStore 增量扫描与刷新。
* **core/index.ts** → 汇总 re-export，供外部一行导入 core 各模块。
* **core/domain/constants.ts** → 定义代码块语言名、符号常量、全局样式等。
* **core/domain/categoryColorMap.ts** → 类别-颜色映射表与查询函数。
* **core/domain/schema.ts** → 定义 Item、DashboardConfig 等核心数据结构及字段工具。
* **core/services/dataStore.ts** → 扫描 Markdown→解析 Item→缓存→提供查询/订阅 API 的核心数据层。
* **core/services/taskService.ts** → 负责勾选任务行，修改文件文本并生成下一条周期任务。
* **core/services/inputService.ts** → 根据插件“输入设置”写入任务/块内容到指定文件并提供主题查询工具。
* **core/utils/**\* → 日期、正则、模板、节流等纯函数工具库（每个文件各自封装单一职能）。

  * `date.ts` → dayjs 封装与日期格式化/区间计算。
  * `templates.ts` → 生成任务行与块文本的模板函数。
  * `parser.ts` → 解析任务行与 `<!-- start -->…<!-- end -->` 块为 Item。
  * `itemFilter.ts` → 通用过滤、排序、关键字、日期区间工具。
  * `mark.ts` → 任务完成/周期任务算法。
  * `timing.ts` → throttle 节流实现。
  * 其余 utils 文件同理，均提供独立小功能。
* **platform/obsidian.ts** → 对 Obsidian API 的极简包装类 `ObsidianPlatform`。
* **features/dashboard/index.ts** → Dashboard 特性入口：注册 VaultWatcher 与 CodeblockEmbedder。
* **features/dashboard/ui/Dashboard.tsx** → 顶级 Dashboard 组件：视图切换、过滤、模块循环。
* **features/dashboard/ui/ModulePanel.tsx** → 每个仪表盘模块的折叠面板容器。
* **features/dashboard/ui/BlockView\.tsx** → Block/Task 列表视图，支持分组及勾选。
* **features/dashboard/ui/TableView\.tsx** → 行×列二维表格视图。
* **features/dashboard/ui/ExcelView\.tsx** → 扁平表格视图，便于导表。
* **features/dashboard/ui/index.ts** → 视图注册表与导出；含 DashboardConfigForm 表单。
* **features/dashboard/ui/DashboardConfigForm.tsx** → GUI 表单，所见即所得编辑仪表盘 JSON。
* **features/quick-input/index.ts** → 快速录入特性入口，注册三条命令。
* **features/quick-input/logic/registerCommands.ts** → 把三种快速录入 Modal 绑定到命令面板。
* **features/quick-input/ui/QuickTaskModal.tsx** → “快速录入·任务” 弹窗，模板化生成任务行并写入。
* **features/quick-input/ui/QuickBlockModal.tsx** → “快速录入·计划/总结/思考” 弹窗。
* **features/quick-input/ui/QuickHabitModal.tsx** → “快速录入·打卡” 弹窗。
* **features/settings/index.ts** → 设置页特性入口与类型导出。
* **features/settings/ui/SettingsTab.ts** → Obsidian SettingTab，包含仪表盘管理与输入设置。
* **features/settings/ui/InputSettingsTable.tsx** → 可折叠的输入设置表格，支持图标/JSON 单元格编辑。
* **shared/components/TaskCheckbox.tsx** → 通用复选框组件，封装任务勾选逻辑。
* **shared/components/FieldRadio.tsx** → 表单辅助组件 Field 与单选 Radio。
* **shared/styles/mui-theme.ts** → 全局 MUI 主题：iOS-风格调色与尺寸。
* **shared/styles/styles.css** → 插件自带样式补丁（复选框皮肤、表格字号等）。
* **shared/components/index.ts**、**shared/index.ts** → 统一导出 shared 组件与样式。

> **未列出的 `*.tsx/ts`**（如若存在）均遵循同一规律：UI 组件放 ui 文件夹、纯业务/工具放 utils 或 services，文件名即职责名，一目了然。
