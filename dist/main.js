"use strict";const $=require("obsidian"),ut=["id","title","content","type","status","category","tags","recurrence","date","header","icon","priority","createdDate","scheduledDate","startDate","dueDate","doneDate","cancelledDate","created","modified","filename"];function ke(t){const e=new Set(ut);for(const n of t)Object.keys(n.extra||{}).forEach(i=>e.add("extra."+i));return Array.from(e)}function G(t,e){if(e.startsWith("extra.")){const n=e.substring(6);return t.extra?.[n]}return t[e]}const dt="\\d{4}[-/]\\d{2}[-/]\\d{2}",ee=new RegExp(dt),ht=/#([\p{L}\p{N}_\/-]+)/gu,pt=/\(([^:：]+)::\s*([^)]+)\)/g,Ne=/^\s*-\s*\[[ xX-]\]/,_t=/^\s*-\s*\[x\]/i,ft=/^\s*-\s*\[-\]/;function xe(t){return t.replace(/\//g,"-")}function $e(t,e){let n=t.clone(),i=t.clone();switch(e){case"年":n=t.clone().startOf("year"),i=t.clone().endOf("year");break;case"季":n=t.clone().startOf("quarter"),i=t.clone().endOf("quarter");break;case"月":n=t.clone().startOf("month"),i=t.clone().endOf("month");break;case"周":n=t.clone().startOf("week"),i=t.clone().endOf("week");break;case"天":default:n=t.clone().startOf("day"),i=t.clone().endOf("day")}return{startDate:n,endDate:i}}const gt="think",mt=["=","!=","includes","regex",">","<"],B={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕",repeat:"🔁"},Ae="无日期",fe="think-dashboard-style",vt=`
.think-table{width:100%;border:1px solid #ccc;border-collapse:collapse;}
.think-table th,.think-table td{border:1px solid #ccc;padding:4px;}
.think-table th{background:#f0f0f0;text-align:center;}
.think-table td{text-align:left;}
.think-table td.empty{background:#f9f9f9;}
.tag-pill{background:#e0e0e0;border-radius:4px;padding:0 6px;margin-right:6px;font-size:90%;display:inline-block;}
.task-done{text-decoration:line-through;color:gray;}
.module-header{display:flex;align-items:center;padding:4px 8px;background:#eee;cursor:pointer;}
.module-title{flex:1;font-weight:bold;}
.module-toggle{margin-left:4px;}
.module-content{padding:6px 8px;}
.think-module a{color:black;text-decoration:none;}
`.trim();function yt(t){let e=t.replace(/^\s*-\s*\[[ xX-]\]\s*/,"").trim();e=e.replace(/#[\p{L}\p{N}_-]+/gu,"");let n=e.split(/[\s(]/).find(i=>i&&i.trim());return n=n?.replace(new RegExp("^\\p{Extended_Pictographic}\\uFE0F?","u"),"").trim(),n?n.trim():""}function bt(t){if(t.includes("🔺"))return"highest";if(t.includes("⏫"))return"high";if(t.includes("🔼"))return"medium";if(t.includes("🔽"))return"low";if(t.includes("⏬"))return"lowest"}function wt(t,e,n,i){const r=e;if(!Ne.test(r))return null;let a="open";_t.test(r)?a="done":ft.test(r)&&(a="cancelled");const d=(r.match(ht)||[]).map(F=>F.replace("#",""));let h="none";const p=r.match(/🔁\s*([^\n📅⏳🛫➕✅❌]*)/);p&&p[1]&&(h=p[1].trim());const f={};let c;for(;(c=pt.exec(r))!==null;){const F=c[1].trim(),s=c[2].trim(),_=F.toLowerCase();if(["主题","标签","tag","tags"].includes(_))s.split(/[,，]/).forEach(g=>{const y=g.trim().replace(/^#/,"");y&&d.push(y)});else{const g=Number(s);let y=s;s!==""&&!isNaN(g)?y=g:/^(true|false)$/i.test(s)&&(y=s.toLowerCase()==="true"),f[F]=y}}const u=F=>{const s=r.match(new RegExp(`${F}\\s*(${ee.source})`));return s?xe(s[1]):void 0},m=u(B.done),w=u(B.cancelled),S=u(B.due),x=u(B.scheduled),v=u(B.start),b=u(B.created),Y=bt(r);let M;const R=r.replace(Ne,"").trim(),I=R.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let P=R;I&&(M=I[1],P=P.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),P=yt(P);const V={id:`${t}#${n}`,title:P||"",content:r.trim(),type:"task",status:a,category:"任务",tags:Array.from(new Set(d)),recurrence:h,date:void 0,created:0,modified:0,extra:{}};return M&&(V.icon=M,f.图标=M),Y&&(V.priority=Y),b&&(V.createdDate=b),x&&(V.scheduledDate=x),v&&(V.startDate=v),S&&(V.dueDate=S),m&&(V.doneDate=m,a==="done"&&(V.date=m)),w&&(V.cancelledDate=w,a==="cancelled"&&(V.date=w)),a==="open"&&(V.date=S||x||v||b),V.extra=f,V}function kt(t,e,n,i,r){const a=e.slice(n+1,i);let l="",d=null,h,p;const f=[],c={};let u=null,m="",w=!1,S=null;for(let v=0;v<a.length;v++){const b=a[v],Y=b.trim();if(w)m+=(m?`
`:"")+b;else{if(Y==="")continue;const M=Y.match(/^([^:：]{1,20})::\s*(.*)$/);if(M){const R=M[1].trim(),I=M[2]||"",P=R.toLowerCase();if(["分类","类别","category"].includes(P))d=I.trim();else if(["主题","标签","tag","tags"].includes(P))u=I.trim();else if(["状态","status"].includes(P))h=I.trim();else if(["日期","date"].includes(P))p=xe(I.trim());else if(["内容","content"].includes(P))w=!0,m=I;else if(["图标","icon"].includes(P))S=I.trim(),c.图标=S;else{const V=Number(I.trim());let F=I.trim();F!==""&&!isNaN(V)?F=V:/^(true|false)$/i.test(F)&&(F=F.toLowerCase()==="true"),c[R]=F}}else w=!0,m=b}}u&&u.split(/[,，]/).map(v=>v.trim()).filter(Boolean).forEach(v=>f.push(v.replace(/^#/,""))),m.trim()!==""?l=m.trim().split(/\r?\n/)[0]:u&&(l=u.split(/[,，]/).map(v=>v.trim()).filter(Boolean).join(", ")),l=l.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),l&&(l=l.slice(0,10)),d||(d=r||"");const x={id:`${t}#${n+1}`,title:l||"",content:m.trim(),type:"block",status:h,category:d,tags:Array.from(new Set(f)),recurrence:"none",date:p,created:0,modified:0,extra:c};return S&&(x.icon=S),x}function xt(t,e=250){let n=0,i=null;return function(...r){const a=Date.now();a-n>=e?(n=a,t.apply(this,r)):(clearTimeout(i),i=setTimeout(()=>{n=Date.now(),t.apply(this,r)},e-(a-n)))}}function Dt(t,e,n){let i=t;return i=i.replace(/(\s|^)(时长::[^\s()]+)/g,(r,a,l)=>r.includes("(")?r:`${a}(${l})`),/\(时长::[^\)]+\)/.test(i)?i=i.replace(/\((时长::[^\)]+)\)/,`(时间::${n}) ($1)`):/时长::[^\s]+/.test(i)?i=i.replace(/(时长::[^\s]+)/,`(时间::${n}) ($1)`):i.includes(B.repeat)?i=i.replace(B.repeat,`(时间::${n}) ${B.repeat}`):i=`${i} (时间::${n})`,i=i.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(i)||(i=`- [x] ${i.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")}`),i=i.replace(new RegExp(`\\s*${B.done}\\s*${ee.source}$`),""),`${i.trim()} ${B.done} ${e}`}function qe(t){const e=t.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/i);if(!e)return null;const n=e[1]?parseInt(e[1],10):1;let i=e[2].toLowerCase();i.endsWith("s")&&(i=i.slice(0,-1));const r=!!e[3];return{interval:n,unit:i,whenDone:r}}function Et(t,e,n){if(e)return n;const i=r=>{const a=new RegExp(`${r}\\s*(${ee.source})`),l=t.match(a);return l?xe(l[1]):null};return i(B.due)||i(B.scheduled)||i(B.start)||n}function St(t,e){let n=t.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]").replace(new RegExp(`\\s*${B.done}\\s*${ee.source}`),"").replace(/\(时间::\d{2}:\d{2}\)/,"");const i=qe(t);if(!i)return n.trim();const r=window.moment,d=r(e,["YYYY-MM-DD","YYYY/MM/DD"]).clone().add(i.interval,i.unit+(i.interval>1?"s":"")).format("YYYY-MM-DD"),h=p=>{const f=new RegExp(`${p}\\s*${ee.source}`);f.test(n)&&(n=n.replace(f,`${p} ${d}`))};return h(B.due),h(B.scheduled),h(B.start),n.trim()}function Ct(t,e,n){const i=Dt(t,e,n),r=qe(t);if(!r)return{completedLine:i};const a=Et(t,r.whenDone,e),l=St(t,a);return{completedLine:i,nextTaskLine:l}}class Tt{static async completeTask(e){const n=J.instance;if(!n)throw new Error("DataStore not ready");const[i,r]=e.split("#"),a=Number(r),l=n.app.vault.getAbstractFileByPath(i);if(!(l instanceof $.TFile))return;const h=(await n.app.vault.read(l)).split(/\r?\n/);if(a<1||a>h.length)return;const p=h[a-1];if(!/^\s*-\s*\[ \]/.test(p))return;const f=window.moment,c=f().format("YYYY-MM-DD"),u=f().format("HH:mm"),{completedLine:m,nextTaskLine:w}=Ct(p,c,u);h[a-1]=m,w&&h.splice(a,0,w),await n.app.vault.modify(l,h.join(`
`)),await n.scanFile(l),n.notifyChange()}}class J{constructor(e){this.items=[],this.fileIndex=new Map,this.changeListeners=new Set,this._emitThrottled=xt(()=>this._emitChange(),250),this.app=e,J.instance=this}async scanAll(){this.items=[],this.fileIndex.clear();const e=this.app.vault.getMarkdownFiles();for(const n of e)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(e){try{const i=(await this.app.vault.read(e)).split(/\r?\n/),r=e.path,a=e.parent?.name||"",l=[],h=this.app.metadataCache.getFileCache(e)?.headings||[];let p=0,f=[],c="";for(let u=0;u<i.length;u++){const m=i[u];if(p<h.length&&h[p].position.start.line===u){const x=h[p].heading,v=x.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];f=v.map(Y=>Y.replace("#","")).filter(Boolean);let b=x;for(const Y of v)b=b.replace(Y,"").trim();c=b||"",p++;continue}if(m.trim()==="<!-- start -->"){const S=i.indexOf("<!-- end -->",u+1);if(S!==-1){const x=kt(r,i,u,S,a);if(x){x.created=e.stat.ctime,x.modified=e.stat.mtime,c&&(x.header=c),x.tags=Array.from(new Set([...f,...x.tags]));let v=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;x.filename=v,l.push(x)}u=S;continue}}const w=wt(r,m,u+1,a);if(w){w.tags=Array.from(new Set([...f,...w.tags])),w.created=e.stat.ctime,w.modified=e.stat.mtime,c&&(w.header=c);let S=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;w.filename=S,l.push(w)}}return this.fileIndex.has(r)&&(this.items=this.items.filter(u=>u.id&&!u.id.startsWith(r+"#"))),this.fileIndex.set(r,l),this.items.push(...l),l}catch(n){return console.error("ThinkPlugin: 扫描文件失败",e.path,n),[]}}removeFileItems(e){this.fileIndex.has(e)&&(this.fileIndex.delete(e),this.items=this.items.filter(n=>!n.id.startsWith(e+"#")))}removeFile(e){this.removeFileItems(e)}queryItems(e=[],n=[]){let i=this.items.filter(r=>(e||[]).every(a=>this._matchItem(r,a)));return n.length>0&&i.sort((r,a)=>{for(const l of n){const d=G(r,l.field),h=G(a,l.field);if(!(d==null&&h==null)){if(d==null)return l.dir==="asc"?1:-1;if(h==null)return l.dir==="asc"?-1:1;if(typeof d=="number"&&typeof h=="number"){if(d!==h)return l.dir==="asc"?d-h:h-d}else{const p=String(d),f=String(h);if(p!==f)return l.dir==="asc"?p.localeCompare(f):f.localeCompare(p)}}}return 0}),i}query(e=[],n=[]){return this.queryItems(e,n)}async markItemDone(e){await Tt.completeTask(e)}_emitChange(){this.changeListeners.forEach(e=>{try{e()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}subscribe(e){this.changeListeners.add(e)}unsubscribe(e){this.changeListeners.delete(e)}notifyChange(){this._emitThrottled()}_matchItem(e,n){const i=G(e,n.field),r=n.value;if(n.op==="="||n.op==="!="){const a=i!=null&&r!=null&&String(i)===String(r);return n.op==="="?a:!a}if(n.op==="includes")return i==null?!1:Array.isArray(i)?i.some(a=>String(a).includes(String(r))):String(i).includes(String(r));if(n.op==="regex"){if(i==null)return!1;try{const a=new RegExp(String(r));return Array.isArray(i)?i.some(l=>a.test(String(l))):a.test(String(i))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",r),!1}}if(n.op===">"||n.op==="<"){if(i==null)return!1;const a=Number(i),l=Number(r);if(!isNaN(a)&&!isNaN(l))return n.op===">"?a>l:a<l;const d=Date.parse(String(i)),h=Date.parse(String(r));if(!isNaN(d)&&!isNaN(h))return n.op===">"?d>h:d<h;const p=String(i),f=String(r);return n.op===">"?p>f:p<f}return!1}}var de,A,je,z,Ve,Ke,Xe,Je,De,ve,ye,te={},ze=[],Nt=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,he=Array.isArray;function X(t,e){for(var n in e)t[n]=e[n];return t}function Ee(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function Ge(t,e,n){var i,r,a,l={};for(a in e)a=="key"?i=e[a]:a=="ref"?r=e[a]:l[a]=e[a];if(arguments.length>2&&(l.children=arguments.length>3?de.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(a in t.defaultProps)l[a]===void 0&&(l[a]=t.defaultProps[a]);return re(t,l,i,r,null)}function re(t,e,n,i,r){var a={type:t,props:e,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:r??++je,__i:-1,__u:0};return r==null&&A.vnode!=null&&A.vnode(a),a}function pe(t){return t.children}function ae(t,e){this.props=t,this.context=e}function Q(t,e){if(e==null)return t.__?Q(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Q(t):null}function Qe(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Qe(t)}}function Fe(t){(!t.__d&&(t.__d=!0)&&z.push(t)&&!oe.__r++||Ve!=A.debounceRendering)&&((Ve=A.debounceRendering)||Ke)(oe)}function oe(){for(var t,e,n,i,r,a,l,d=1;z.length;)z.length>d&&z.sort(Xe),t=z.shift(),d=z.length,t.__d&&(n=void 0,r=(i=(e=t).__v).__e,a=[],l=[],e.__P&&((n=X({},i)).__v=i.__v+1,A.vnode&&A.vnode(n),Se(e.__P,n,i,e.__n,e.__P.namespaceURI,32&i.__u?[r]:null,a,r??Q(i),!!(32&i.__u),l),n.__v=i.__v,n.__.__k[n.__i]=n,tt(a,n,l),n.__e!=r&&Qe(n)));oe.__r=0}function Ze(t,e,n,i,r,a,l,d,h,p,f){var c,u,m,w,S,x,v=i&&i.__k||ze,b=e.length;for(h=$t(n,e,v,h,b),c=0;c<b;c++)(m=n.__k[c])!=null&&(u=m.__i==-1?te:v[m.__i]||te,m.__i=c,x=Se(t,m,u,r,a,l,d,h,p,f),w=m.__e,m.ref&&u.ref!=m.ref&&(u.ref&&Ce(u.ref,null,m),f.push(m.ref,m.__c||w,m)),S==null&&w!=null&&(S=w),4&m.__u||u.__k===m.__k?h=et(m,h,t):typeof m.type=="function"&&x!==void 0?h=x:w&&(h=w.nextSibling),m.__u&=-7);return n.__e=S,h}function $t(t,e,n,i,r){var a,l,d,h,p,f=n.length,c=f,u=0;for(t.__k=new Array(r),a=0;a<r;a++)(l=e[a])!=null&&typeof l!="boolean"&&typeof l!="function"?(h=a+u,(l=t.__k[a]=typeof l=="string"||typeof l=="number"||typeof l=="bigint"||l.constructor==String?re(null,l,null,null,null):he(l)?re(pe,{children:l},null,null,null):l.constructor==null&&l.__b>0?re(l.type,l.props,l.key,l.ref?l.ref:null,l.__v):l).__=t,l.__b=t.__b+1,d=null,(p=l.__i=At(l,n,h,c))!=-1&&(c--,(d=n[p])&&(d.__u|=2)),d==null||d.__v==null?(p==-1&&(r>f?u--:r<f&&u++),typeof l.type!="function"&&(l.__u|=4)):p!=h&&(p==h-1?u--:p==h+1?u++:(p>h?u--:u++,l.__u|=4))):t.__k[a]=null;if(c)for(a=0;a<f;a++)(d=n[a])!=null&&(2&d.__u)==0&&(d.__e==i&&(i=Q(d)),it(d,d));return i}function et(t,e,n){var i,r;if(typeof t.type=="function"){for(i=t.__k,r=0;i&&r<i.length;r++)i[r]&&(i[r].__=t,e=et(i[r],e,n));return e}t.__e!=e&&(e&&t.type&&!n.contains(e)&&(e=Q(t)),n.insertBefore(t.__e,e||null),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function At(t,e,n,i){var r,a,l=t.key,d=t.type,h=e[n];if(h===null&&t.key==null||h&&l==h.key&&d==h.type&&(2&h.__u)==0)return n;if(i>(h!=null&&(2&h.__u)==0?1:0))for(r=n-1,a=n+1;r>=0||a<e.length;){if(r>=0){if((h=e[r])&&(2&h.__u)==0&&l==h.key&&d==h.type)return r;r--}if(a<e.length){if((h=e[a])&&(2&h.__u)==0&&l==h.key&&d==h.type)return a;a++}}return-1}function Ie(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||Nt.test(e)?n:n+"px"}function ie(t,e,n,i,r){var a,l;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof i=="string"&&(t.style.cssText=i=""),i)for(e in i)n&&e in n||Ie(t.style,e,"");if(n)for(e in n)i&&n[e]==i[e]||Ie(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")a=e!=(e=e.replace(Je,"$1")),l=e.toLowerCase(),e=l in t||e=="onFocusOut"||e=="onFocusIn"?l.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+a]=n,n?i?n.u=i.u:(n.u=De,t.addEventListener(e,a?ye:ve,a)):t.removeEventListener(e,a?ye:ve,a);else{if(r=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Ye(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=De++;else if(e.t<n.u)return;return n(A.event?A.event(e):e)}}}function Se(t,e,n,i,r,a,l,d,h,p){var f,c,u,m,w,S,x,v,b,Y,M,R,I,P,V,F,s,_=e.type;if(e.constructor!=null)return null;128&n.__u&&(h=!!(32&n.__u),a=[d=e.__e=n.__e]),(f=A.__b)&&f(e);e:if(typeof _=="function")try{if(v=e.props,b="prototype"in _&&_.prototype.render,Y=(f=_.contextType)&&i[f.__c],M=f?Y?Y.props.value:f.__:i,n.__c?x=(c=e.__c=n.__c).__=c.__E:(b?e.__c=c=new _(v,M):(e.__c=c=new ae(v,M),c.constructor=_,c.render=Ft),Y&&Y.sub(c),c.props=v,c.state||(c.state={}),c.context=M,c.__n=i,u=c.__d=!0,c.__h=[],c._sb=[]),b&&c.__s==null&&(c.__s=c.state),b&&_.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=X({},c.__s)),X(c.__s,_.getDerivedStateFromProps(v,c.__s))),m=c.props,w=c.state,c.__v=e,u)b&&_.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),b&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(b&&_.getDerivedStateFromProps==null&&v!==m&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(v,M),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(v,c.__s,M)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(c.props=v,c.state=c.__s,c.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(g){g&&(g.__=e)}),R=0;R<c._sb.length;R++)c.__h.push(c._sb[R]);c._sb=[],c.__h.length&&l.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(v,c.__s,M),b&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(m,w,S)})}if(c.context=M,c.props=v,c.__P=t,c.__e=!1,I=A.__r,P=0,b){for(c.state=c.__s,c.__d=!1,I&&I(e),f=c.render(c.props,c.state,c.context),V=0;V<c._sb.length;V++)c.__h.push(c._sb[V]);c._sb=[]}else do c.__d=!1,I&&I(e),f=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++P<25);c.state=c.__s,c.getChildContext!=null&&(i=X(X({},i),c.getChildContext())),b&&!u&&c.getSnapshotBeforeUpdate!=null&&(S=c.getSnapshotBeforeUpdate(m,w)),F=f,f!=null&&f.type===pe&&f.key==null&&(F=nt(f.props.children)),d=Ze(t,he(F)?F:[F],e,n,i,r,a,l,d,h,p),c.base=e.__e,e.__u&=-161,c.__h.length&&l.push(c),x&&(c.__E=c.__=null)}catch(g){if(e.__v=null,h||a!=null)if(g.then){for(e.__u|=h?160:128;d&&d.nodeType==8&&d.nextSibling;)d=d.nextSibling;a[a.indexOf(d)]=null,e.__e=d}else for(s=a.length;s--;)Ee(a[s]);else e.__e=n.__e,e.__k=n.__k;A.__e(g,e,n)}else a==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):d=e.__e=Vt(n.__e,e,n,i,r,a,l,h,p);return(f=A.diffed)&&f(e),128&e.__u?void 0:d}function tt(t,e,n){for(var i=0;i<n.length;i++)Ce(n[i],n[++i],n[++i]);A.__c&&A.__c(e,t),t.some(function(r){try{t=r.__h,r.__h=[],t.some(function(a){a.call(r)})}catch(a){A.__e(a,r.__v)}})}function nt(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:he(t)?t.map(nt):X({},t)}function Vt(t,e,n,i,r,a,l,d,h){var p,f,c,u,m,w,S,x=n.props,v=e.props,b=e.type;if(b=="svg"?r="http://www.w3.org/2000/svg":b=="math"?r="http://www.w3.org/1998/Math/MathML":r||(r="http://www.w3.org/1999/xhtml"),a!=null){for(p=0;p<a.length;p++)if((m=a[p])&&"setAttribute"in m==!!b&&(b?m.localName==b:m.nodeType==3)){t=m,a[p]=null;break}}if(t==null){if(b==null)return document.createTextNode(v);t=document.createElementNS(r,b,v.is&&v),d&&(A.__m&&A.__m(e,a),d=!1),a=null}if(b==null)x===v||d&&t.data==v||(t.data=v);else{if(a=a&&de.call(t.childNodes),x=n.props||te,!d&&a!=null)for(x={},p=0;p<t.attributes.length;p++)x[(m=t.attributes[p]).name]=m.value;for(p in x)if(m=x[p],p!="children"){if(p=="dangerouslySetInnerHTML")c=m;else if(!(p in v)){if(p=="value"&&"defaultValue"in v||p=="checked"&&"defaultChecked"in v)continue;ie(t,p,null,m,r)}}for(p in v)m=v[p],p=="children"?u=m:p=="dangerouslySetInnerHTML"?f=m:p=="value"?w=m:p=="checked"?S=m:d&&typeof m!="function"||x[p]===m||ie(t,p,m,x[p],r);if(f)d||c&&(f.__html==c.__html||f.__html==t.innerHTML)||(t.innerHTML=f.__html),e.__k=[];else if(c&&(t.innerHTML=""),Ze(e.type=="template"?t.content:t,he(u)?u:[u],e,n,i,b=="foreignObject"?"http://www.w3.org/1999/xhtml":r,a,l,a?a[0]:n.__k&&Q(n,0),d,h),a!=null)for(p=a.length;p--;)Ee(a[p]);d||(p="value",b=="progress"&&w==null?t.removeAttribute("value"):w!=null&&(w!==t[p]||b=="progress"&&!w||b=="option"&&w!=x[p])&&ie(t,p,w,x[p],r),p="checked",S!=null&&S!=t[p]&&ie(t,p,S,x[p],r))}return t}function Ce(t,e,n){try{if(typeof t=="function"){var i=typeof t.__u=="function";i&&t.__u(),i&&e==null||(t.__u=t(e))}else t.current=e}catch(r){A.__e(r,n)}}function it(t,e,n){var i,r;if(A.unmount&&A.unmount(t),(i=t.ref)&&(i.current&&i.current!=t.__e||Ce(i,null,e)),(i=t.__c)!=null){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(a){A.__e(a,e)}i.base=i.__P=null}if(i=t.__k)for(r=0;r<i.length;r++)i[r]&&it(i[r],e,n||typeof t.type!="function");n||Ee(t.__e),t.__c=t.__=t.__e=void 0}function Ft(t,e,n){return this.constructor(t,n)}function It(t,e,n){var i,r,a,l;e==document&&(e=document.documentElement),A.__&&A.__(t,e),r=(i=!1)?null:e.__k,a=[],l=[],Se(e,t=e.__k=Ge(pe,null,[t]),r||te,te,e.namespaceURI,r?null:e.firstChild?de.call(e.childNodes):null,a,r?r.__e:e.firstChild,i,l),tt(a,t,l)}de=ze.slice,A={__e:function(t,e,n,i){for(var r,a,l;e=e.__;)if((r=e.__c)&&!r.__)try{if((a=r.constructor)&&a.getDerivedStateFromError!=null&&(r.setState(a.getDerivedStateFromError(t)),l=r.__d),r.componentDidCatch!=null&&(r.componentDidCatch(t,i||{}),l=r.__d),l)return r.__E=r}catch(d){t=d}throw t}},je=0,ae.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=X({},this.state),typeof t=="function"&&(t=t(X({},n),this.props)),t&&X(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Fe(this))},ae.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Fe(this))},ae.prototype.render=pe,z=[],Ke=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Xe=function(t,e){return t.__v.__b-e.__v.__b},oe.__r=0,Je=/(PointerCapture)$|Capture$/i,De=0,ve=Ye(!1),ye=Ye(!0);var Yt=0;function o(t,e,n,i,r,a){e||(e={});var l,d,h=e;if("ref"in h)for(d in h={},e)d=="ref"?l=e[d]:h[d]=e[d];var p={type:t,props:h,key:n,ref:l,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Yt,__i:-1,__u:0,__source:r,__self:a};if(typeof t=="function"&&(l=t.defaultProps))for(d in l)h[d]===void 0&&(h[d]=l[d]);return A.vnode&&A.vnode(p),p}function ce(t){const e=t.lastIndexOf("#"),n=e>=0?t.substring(0,e):t,i=e>=0?t.substring(e+1):"";return`obsidian://advanced-uri?vault=${encodeURIComponent(J.instance.app.vault.getName())}&filepath=${encodeURIComponent(n)}${i?"&line="+i:""}`}function st({done:t,onMarkDone:e}){const n="task-checkbox"+(t?" done":"");return o("input",{type:"checkbox",class:n,checked:t,onClick:t?r=>r.preventDefault():void 0,onChange:r=>{!t&&e&&e()}})}function Mt({items:t,rowField:e,colField:n}){if(!e||!n)return o("div",{children:"（TableView 需要配置 rowField 和 colField）"});const i=[],r=[],a={};return t.forEach(l=>{const d=String(G(l,e)??Ae),h=String(G(l,n)??Ae);a[d]||(a[d]={},i.push(d)),a[d][h]||(a[d][h]=[]),a[d][h].push(l),r.includes(h)||r.push(h)}),i.sort(),r.sort(),o("table",{class:"think-table",children:[o("thead",{children:o("tr",{children:[o("th",{children:e}),r.map(l=>o("th",{children:l},l))]})}),o("tbody",{children:i.map(l=>o("tr",{children:[o("td",{children:o("strong",{children:l})}),r.map(d=>{const h=a[l]?.[d]||[];return h.length?o("td",{children:h.map(p=>o("div",{children:Lt(p)},p.id))},d):o("td",{class:"empty"},d)})]},l))})]})}function Lt(t){if(t.type==="task"){const e=t.status==="done";return o("span",{children:[o(st,{done:e,onMarkDone:()=>J.instance.markItemDone(t.id)}),t.icon&&o("span",{class:"task-icon",children:t.icon}),o("a",{href:ce(t.id),target:"_blank",rel:"noopener",children:t.title})]})}return o("a",{href:ce(t.id),target:"_blank",rel:"noopener",children:t.title})}const Pt={打卡:"#d2cceb",任务:"#caebf3",计划:"#d8ecb2",总结:"#E5D5B9",事件:"#94e2d6",感受:"#93daf0",思考:"#f09393"};function Ot(t){return Pt[t]||"#e0e0e0"}function Bt(t){const{groupField:e,showMeta:n=!0,fields:i}=t;let r=t.items,a=null,l=[];if(e){a={};for(const f of r){const c=String(G(f,e)??"(none)");a[c]||(a[c]=[],l.push(c)),a[c].push(f)}l.sort()}const d=f=>{const c=f.status==="done";return o("div",{style:"margin-bottom:4px;line-height:1.5;",children:[o(st,{done:c,onMarkDone:()=>J.instance.markItemDone(f.id)}),o("a",{href:ce(f.id),target:"_blank",rel:"noopener",class:c?"task-done":"",children:f.title}),f.icon&&o("span",{class:"tag-pill",children:f.icon}),f.tags.map(u=>o("span",{class:"tag-pill",children:u},u))]})},h=f=>o("div",{style:`\r
        display:grid;\r
        grid-template-columns:auto minmax(180px,1fr);\r
        align-items:start;\r
        gap:8px;\r
        margin-bottom:8px;\r
      `,children:[n&&o("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:[o("span",{class:"tag-pill",style:`background:${Ot(f.category)};`,children:f.category}),f.date&&o("span",{class:"tag-pill",children:f.date}),f.extra.图标&&o("span",{class:"tag-pill",children:f.extra.图标})]}),o("div",{style:"white-space:pre-wrap;line-height:1.5;",children:o("a",{href:ce(f.id),target:"_blank",rel:"noopener",children:f.content})})]}),p=f=>f.type==="task"?d(f):h(f);return o("div",{children:a?l.map(f=>o("div",{children:[o("h5",{children:f}),a[f].map(p)]},f)):r.map(p)})}function Ht(t){return o("div",{children:"（Timeline 视图暂未实现）"})}function Rt(t){return o("div",{children:"（Calendar 日视图暂未实现）"})}function Wt(t){return o("div",{children:"（Chart 图表视图暂未实现）"})}function Ut(t){return Array.isArray(t)?t.join(", "):t==null?"":String(t)}function qt({items:t,fields:e}){const n=e&&e.length?e:ke(t);return o("div",{children:o("table",{class:"think-table",style:"min-width:100%; white-space:nowrap;",children:[o("thead",{children:o("tr",{children:n.map(i=>o("th",{children:i},i))})}),o("tbody",{children:t.map(i=>o("tr",{children:n.map(r=>o("td",{children:Ut(G(i,r))},r))},i.id))})]})})}var ne,L,ge,Me,ue=0,rt=[],O=A,Le=O.__b,Pe=O.__r,Oe=O.diffed,Be=O.__c,He=O.unmount,Re=O.__;function Te(t,e){O.__h&&O.__h(L,t,ue||e),ue=0;var n=L.__H||(L.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function K(t){return ue=1,jt(lt,t)}function jt(t,e,n){var i=Te(ne++,2);if(i.t=t,!i.__c&&(i.__=[lt(void 0,e),function(d){var h=i.__N?i.__N[0]:i.__[0],p=i.t(h,d);h!==p&&(i.__N=[p,i.__[1]],i.__c.setState({}))}],i.__c=L,!L.__f)){var r=function(d,h,p){if(!i.__c.__H)return!0;var f=i.__c.__H.__.filter(function(u){return!!u.__c});if(f.every(function(u){return!u.__N}))return!a||a.call(this,d,h,p);var c=i.__c.props!==d;return f.forEach(function(u){if(u.__N){var m=u.__[0];u.__=u.__N,u.__N=void 0,m!==u.__[0]&&(c=!0)}}),a&&a.call(this,d,h,p)||c};L.__f=!0;var a=L.shouldComponentUpdate,l=L.componentWillUpdate;L.componentWillUpdate=function(d,h,p){if(this.__e){var f=a;a=void 0,r(d,h,p),a=f}l&&l.call(this,d,h,p)},L.shouldComponentUpdate=r}return i.__N||i.__}function be(t,e){var n=Te(ne++,3);!O.__s&&at(n.__H,e)&&(n.__=t,n.u=e,L.__H.__h.push(n))}function Kt(t){return ue=5,Xt(function(){return{current:t}},[])}function Xt(t,e){var n=Te(ne++,7);return at(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Jt(){for(var t;t=rt.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(le),t.__H.__h.forEach(we),t.__H.__h=[]}catch(e){t.__H.__h=[],O.__e(e,t.__v)}}O.__b=function(t){L=null,Le&&Le(t)},O.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),Re&&Re(t,e)},O.__r=function(t){Pe&&Pe(t),ne=0;var e=(L=t.__c).__H;e&&(ge===L?(e.__h=[],L.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(le),e.__h.forEach(we),e.__h=[],ne=0)),ge=L},O.diffed=function(t){Oe&&Oe(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(rt.push(e)!==1&&Me===O.requestAnimationFrame||((Me=O.requestAnimationFrame)||zt)(Jt)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),ge=L=null},O.__c=function(t,e){e.some(function(n){try{n.__h.forEach(le),n.__h=n.__h.filter(function(i){return!i.__||we(i)})}catch(i){e.some(function(r){r.__h&&(r.__h=[])}),e=[],O.__e(i,n.__v)}}),Be&&Be(t,e)},O.unmount=function(t){He&&He(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{le(i)}catch(r){e=r}}),n.__H=void 0,e&&O.__e(e,n.__v))};var We=typeof requestAnimationFrame=="function";function zt(t){var e,n=function(){clearTimeout(i),We&&cancelAnimationFrame(e),setTimeout(t)},i=setTimeout(n,35);We&&(e=requestAnimationFrame(n))}function le(t){var e=L,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),L=e}function we(t){var e=L;t.__c=t.__(),L=e}function at(t,e){return!t||t.length!==e.length||e.some(function(n,i){return n!==t[i]})}function lt(t,e){return typeof e=="function"?e(t):e}function Gt({storageKey:t="inputSettings",plugin:e}){const n=e[t]||{},[i,r]=K(typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))),a=(d,h)=>r(p=>({...p,[d]:h})),l=async()=>{e[t]=i,await e.persistAll(),alert("已保存配置")};return o("div",{style:"display:flex;flex-direction:column;gap:6px;max-width:420px;",children:[o("label",{children:["主题 (可层级“生活/健康”)：",o("input",{value:i.topic||"",onInput:d=>a("topic",d.target.value)})]}),o("label",{children:["图标 (emoji)：",o("input",{value:i.icon||"",onInput:d=>a("icon",d.target.value),placeholder:"✨"})]}),o("label",{children:["任务字段清单 (逗号分隔)：",o("input",{value:i.taskFields||"",onInput:d=>a("taskFields",d.target.value),placeholder:"status,icon,repeat,…"})]}),o("label",{children:["Block 字段清单 (逗号分隔)：",o("input",{value:i.blockFields||"",onInput:d=>a("blockFields",d.target.value),placeholder:"分类,周期,日期,主题,图标,内容"})]}),o("button",{style:"margin-top:8px;",onClick:l,children:"💾 保存配置"})]})}const ot={TableView:Mt,BlockView:Bt,TimelineView:Ht,CalendarView:Rt,ChartView:Wt,ExcelView:qt,SettingsFormView:Gt},se=ot,Ue=Object.keys(ot);class Qt extends $.PluginSettingTab{constructor(e,n){super(e,n),this.selectedDashName="",this.plugin=n,n.dashboards.length>0&&(this.selectedDashName=n.dashboards[0].name)}display(){const{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Think 仪表盘 配置编辑"});const n=this.plugin.dataStore.queryItems(),i=ke(n),r=new Set,a=new Set,l=new Set,d=new Set,h=new Set;for(const s of n)(s.tags||[]).forEach(_=>_&&r.add(_)),s.category&&a.add(s.category),s.status&&l.add(s.status),s.recurrence&&d.add(s.recurrence),s.type&&h.add(s.type);const p=e.createEl("datalist");p.id="think-tags-list",Array.from(r).forEach(s=>p.createEl("option",{value:s}));const f=e.createEl("datalist");f.id="think-category-list",Array.from(a).forEach(s=>f.createEl("option",{value:s}));const c=e.createEl("datalist");c.id="think-status-list",Array.from(l).forEach(s=>c.createEl("option",{value:s}));const u=e.createEl("datalist");u.id="think-recurrence-list",Array.from(d).forEach(s=>u.createEl("option",{value:s}));const m=e.createEl("datalist");m.id="think-type-list",Array.from(h).forEach(s=>m.createEl("option",{value:s}));const w=e.createEl("datalist");w.id="think-fields-list",i.forEach(s=>w.createEl("option",{value:s}));const S=e.createEl("select");for(const s of this.plugin.dashboards){const _=S.createEl("option",{text:s.name});_.value=s.name,s.name===this.selectedDashName&&(_.selected=!0)}S.onchange=()=>{this.selectedDashName=S.value,this.display()};const x=e.createEl("button",{text:"新建仪表盘"});if(x.style.marginLeft="8px",x.onclick=()=>{let s="新仪表盘",_=s,g=1;for(;this.plugin.dashboards.find(k=>k.name===_);)_=s+g++;const y={name:_,modules:[]};this.plugin.dashboards.push(y),this.selectedDashName=_,this.plugin.saveData({dashboards:this.plugin.dashboards}),new $.Notice("已添加新仪表盘配置"),this.display()},this.plugin.dashboards.length>0){const s=e.createEl("button",{text:"删除当前仪表盘"});s.style.marginLeft="8px",s.onclick=()=>{const _=this.plugin.dashboards.findIndex(g=>g.name===this.selectedDashName);_>=0&&(this.plugin.dashboards.splice(_,1),new $.Notice(`已删除配置：${this.selectedDashName}`),this.selectedDashName=this.plugin.dashboards.length?this.plugin.dashboards[0].name:"",this.plugin.saveData({dashboards:this.plugin.dashboards}),this.display())}}e.createEl("hr");const v=this.plugin.dashboards.find(s=>s.name===this.selectedDashName);if(!v)return;const b=e.createEl("fieldset");b.createEl("legend",{text:"基础设置"}),new $.Setting(b).setName("仪表盘名称").addText(s=>{s.setValue(v.name).onChange(_=>{v.name=_.trim()})}),new $.Setting(b).setName("数据源路径").addText(s=>{s.setValue(v.path||"").onChange(_=>{v.path=_.trim()})}),new $.Setting(b).setName("标签 (用逗号分隔)").addText(s=>{const _=Array.isArray(v.tags)?v.tags.join(","):v.tags||"";s.setValue(_).onChange(g=>{v.tags=g.split(/[,，]/).map(y=>y.trim()).filter(y=>y)})}),new $.Setting(b).setName("初始视图").addDropdown(s=>{["年","季","月","周","天"].forEach(g=>s.addOption(g,g)),s.setValue(v.initialView||"月"),s.onChange(g=>{v.initialView=g})});const Y=new Date,M=`${Y.getFullYear()}-${String(Y.getMonth()+1).padStart(2,"0")}-${String(Y.getDate()).padStart(2,"0")}`,R=v.initialDate||M;v.initialDate||(v.initialDate=R),new $.Setting(b).setName("初始日期").addText(s=>{s.inputEl.type="date",s.setValue(R).onChange(_=>{v.initialDate=_})}),e.createEl("h3",{text:"模块列表"}),v.modules.forEach((s,_)=>{const g=e.createEl("fieldset");g.style.border="1px solid #ccc",g.style.padding="8px",g.style.marginBottom="8px",g.dataset.index=_.toString(),g.createEl("legend",{text:`${s.title||"模块"} (${s.view})`}),new $.Setting(g).setName("模块标题").addText(E=>{E.setValue(s.title).onChange(C=>s.title=C)}),new $.Setting(g).setName("视图类型").addDropdown(E=>{Ue.forEach(C=>E.addOption(C,C)),E.setValue(s.view),E.onChange(C=>{s.view=C,this.display()})}),new $.Setting(g).addToggle(E=>{E.setValue(!!s.collapsed).onChange(C=>{s.collapsed=C})}).setName("默认折叠"),s.view==="TableView"&&(new $.Setting(g).setName("行字段 (rowField)").addText(E=>{E.setValue(s.props?.rowField||"").onChange(C=>{s.props||(s.props={}),s.props.rowField=C.trim()}),E.inputEl.setAttr("list","think-fields-list")}),new $.Setting(g).setName("列字段 (colField)").addText(E=>{E.setValue(s.props?.colField||"").onChange(C=>{s.props||(s.props={}),s.props.colField=C.trim()}),E.inputEl.setAttr("list","think-fields-list")})),(s.view==="BlockView"||s.view==="TimelineView")&&new $.Setting(g).setName("分组字段").addText(E=>{E.setValue(s.group||"").onChange(C=>{s.group=C.trim()||void 0}),E.inputEl.setAttr("list","think-fields-list")}),s.view!=="TableView"&&s.view!=="ChartView"&&s.view!=="CalendarView"&&new $.Setting(g).setName("显示字段 (用逗号分隔)").addText(E=>{const C=s.fields?s.fields.join(","):"";E.setPlaceholder("如 title,tags,date").setValue(C).onChange(W=>{const H=W.split(/[,，]/).map(q=>q.trim()).filter(q=>q);s.fields=H.length>0?H:void 0}),E.inputEl.setAttr("list","think-fields-list")});const y=g.createDiv();y.style.borderTop="1px dashed #ccc",y.style.marginTop="6px",y.style.paddingTop="6px",y.createEl("strong",{text:"过滤规则"}),(s.filters||[]).forEach((E,C)=>{const W=y.createDiv({cls:"filter-row"});W.style.display="flex",W.style.marginBottom="4px";const H=W.createEl("input");H.type="text",H.style.flex="0 0 30%",H.value=E.field,H.setAttr("list","think-fields-list");const q=W.createEl("select");mt.forEach(j=>{q.add(new Option(j,j,!1,j===E.op))}),q.onchange=()=>{E.op=q.value};const U=W.createEl("input");U.type="text",U.style.flex="0 0 30%",U.value=String(E.value);const Z=()=>{U.removeAttribute("list");const j=H.value.trim();j==="tags"?U.setAttr("list","think-tags-list"):j==="category"?U.setAttr("list","think-category-list"):j==="status"?U.setAttr("list","think-status-list"):j==="recurrence"?U.setAttr("list","think-recurrence-list"):j==="type"&&U.setAttr("list","think-type-list")};Z(),H.onchange=()=>{E.field=H.value.trim(),Z()},U.onchange=()=>{E.value=U.value};const _e=W.createEl("button",{text:"删除"});_e.onclick=()=>{s.filters.splice(C,1),this.display()}});const k=y.createEl("button",{text:"+ 添加过滤条件"});k.onclick=()=>{s.filters||(s.filters=[]),s.filters.push({field:"",op:"=",value:""}),this.display()};const D=g.createDiv();D.style.borderTop="1px dashed #ccc",D.style.marginTop="6px",D.style.paddingTop="6px",D.createEl("strong",{text:"排序规则"}),(s.sort||[]).forEach((E,C)=>{const W=D.createDiv({cls:"sort-row"});W.style.display="flex",W.style.marginBottom="4px";const H=W.createEl("input");H.type="text",H.style.flex="0 0 40%",H.value=E.field,H.setAttr("list","think-fields-list"),H.onchange=()=>E.field=H.value.trim();const q=W.createEl("select");[["asc","升序"],["desc","降序"]].forEach(([Z,_e])=>{q.add(new Option(_e,Z,!1,Z===E.dir))}),q.onchange=()=>{E.dir=q.value};const U=W.createEl("button",{text:"删除"});U.style.marginLeft="4px",U.onclick=()=>{s.sort.splice(C,1),this.display()}});const T=D.createEl("button",{text:"+ 添加排序条件"});T.onclick=()=>{s.sort||(s.sort=[]),s.sort.push({field:"",dir:"asc"}),this.display()};const N=g.createDiv({cls:"module-actions"});if(N.style.textAlign="right",_>0){const E=N.createEl("button",{text:"↑ 上移"});E.onclick=()=>{const C=v.modules;[C[_-1],C[_]]=[C[_],C[_-1]],this.display()}}if(_<v.modules.length-1){const E=N.createEl("button",{text:"↓ 下移"});E.onclick=()=>{const C=v.modules;[C[_+1],C[_]]=[C[_],C[_+1]],this.display()}}const ct=N.createEl("button",{text:"删除模块"});ct.onclick=()=>{v.modules.splice(_,1),this.display()}});const I=e.createDiv(),P=I.createEl("select");Ue.forEach(s=>{P.add(new Option(s,s))});const V=I.createEl("button",{text:"添加模块"});V.style.marginLeft="6px",V.onclick=()=>{const _={view:P.value,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};v.modules.push(_),this.display()},e.createEl("hr");const F=e.createEl("button",{text:"保存配置"});F.onclick=()=>{if(v.name!==this.selectedDashName&&this.plugin.dashboards.some(s=>s!==v&&s.name===v.name)){new $.Notice("配置名称已存在，请更换名称");return}this.plugin.saveData({dashboards:this.plugin.dashboards}).then(()=>{new $.Notice("仪表盘配置已保存"),this.plugin.refreshAllDashboards(),this.selectedDashName=v.name,this.display()})}}}class Zt{constructor(e,n){this.plugin=e,this.dataStore=n,this.registerEvents()}registerEvents(){const{app:e}=this.plugin,n=e.vault.on.bind(e.vault),i=r=>this.dataStore.scanFile(r).then(()=>this.dataStore.notifyChange());this.plugin.registerEvent(n("modify",r=>{r instanceof $.TFile&&r.extension==="md"&&i(r)})),this.plugin.registerEvent(n("create",r=>{r instanceof $.TFile&&r.extension==="md"&&i(r)})),this.plugin.registerEvent(n("delete",r=>{r instanceof $.TFile&&r.extension==="md"&&(this.dataStore.removeFileItems(r.path),this.dataStore.notifyChange())})),this.plugin.registerEvent(n("rename",(r,a)=>{r instanceof $.TFile&&r.extension==="md"&&(this.dataStore.removeFileItems(a),i(r))}))}}function me({module:t,children:e}){const[n,i]=K(!!t.collapsed),r=Kt(null),a=()=>i(d=>!d),l=d=>{if(d.metaKey||d.ctrlKey){const h=!n,p=new CustomEvent("think-toggle-all",{detail:h});document.querySelectorAll(".think-module").forEach(f=>f.dispatchEvent(p))}else a()};return be(()=>{const d=p=>{const f=p.detail;i(f)},h=r.current;if(h)return h.addEventListener("think-toggle-all",d),()=>h.removeEventListener("think-toggle-all",d)},[]),o("div",{class:"think-module",ref:r,children:[o("div",{class:"module-header",onClick:l,title:"点击折叠/展开；Ctrl/⌘ + 点击：全部折叠/展开",children:[o("span",{class:"module-title",children:t.title}),o("span",{class:"module-toggle",children:n?"▶":"▼"})]}),!n&&o("div",{class:"module-content",children:e})]})}const en=["一","二","三","四"];function tn({config:t,dataStore:e,plugin:n}){const i=window.moment,r=t.initialView||"月",a=t.initialDate?i(t.initialDate,"YYYY-MM-DD"):i(),[l,d]=K(r),[h,p]=K(a),[f,c]=K(!1),[u,m]=K(null),[w,S]=K("TableView"),[x,v]=K(0),[b,Y]=K("");be(()=>{const s=()=>v(_=>_+1);return e.subscribe(s),()=>e.unsubscribe(s)},[e]),be(()=>{f?(m((_=>typeof structuredClone=="function"?structuredClone(_):JSON.parse(JSON.stringify(_)))(t)),S("TableView")):m(null)},[f,t]),$e(h,l);const M=(s,_)=>{switch(_){case"年":return s.format("YYYY年");case"季":{const g=s.quarter();return`${s.year()}年${en[g-1]}季度`}case"月":return s.format("YYYY-MM");case"周":return s.format("YYYY-[W]WW");case"天":return s.format("YYYY-MM-DD");default:return s.format("YYYY-MM-DD")}},R=()=>{switch(l){case"年":p(h.clone().subtract(1,"year"));break;case"季":p(h.clone().subtract(1,"quarter"));break;case"月":p(h.clone().subtract(1,"month"));break;case"周":p(h.clone().subtract(1,"week"));break;case"天":p(h.clone().subtract(1,"day"));break}},I=()=>{switch(l){case"年":p(h.clone().add(1,"year"));break;case"季":p(h.clone().add(1,"quarter"));break;case"月":p(h.clone().add(1,"month"));break;case"周":p(h.clone().add(1,"week"));break;case"天":p(h.clone().add(1,"day"));break}},P=()=>p(i()),V=s=>{if(s.view==="SettingsFormView"){const k=se[s.view];return o(me,{module:s,children:o(k,{plugin:n,storageKey:"inputSettings"})})}let _=e.queryItems(s.filters||[],s.sort||[]);if(t.tags?.length&&(_=_.filter(k=>k.tags.some(D=>t.tags.some(T=>D.includes(T))))),t.path&&t.path.trim()!==""){const k=t.path.trim(),D=J.instance.app.vault.getAbstractFileByPath(k);if(D){if(D instanceof $.TFolder){const T=k.endsWith("/")?k:k+"/";_=_.filter(N=>N.id.startsWith(T))}else if(D instanceof $.TFile){const T=k+"#";_=_.filter(N=>N.id.startsWith(T))}}else{const T=k.endsWith("/")?k:k+"/";_=_.filter(N=>N.id.startsWith(T))}}if(l&&h){const{startDate:k,endDate:D}=$e(h,l);_=_.filter(T=>{if(!T.date)return!0;const N=i(T.date,"YYYY-MM-DD");return N.isSameOrAfter(k)&&N.isSameOrBefore(D)})}if(b.trim()){const k=b.toLowerCase();_=_.filter(D=>(D.title+" "+D.content).toLowerCase().includes(k))}const g=se[s.view];if(!g)return o(me,{module:s,children:o("div",{children:["未知视图: ",s.view]})});const y={...s.props||{}};return s.group&&(y.groupField=s.group),s.fields&&(y.fields=s.fields),o(me,{module:s,children:o(g,{items:_,...y})})},F=()=>{if(!u)return;const s=t.name,_=u.name.trim();if(_===""){new $.Notice("名称不能为空");return}if(_!==s&&n.dashboards.some(y=>y!==t&&y.name===_)){new $.Notice("配置名称已存在，请更换名称");return}t.name=_,t.path=u.path||"",t.tags=u.tags||[],t.initialView=u.initialView||"月",t.initialDate=u.initialDate||i().format("YYYY-MM-DD"),t.modules=u.modules,_!==s&&n.activeDashboards.forEach(y=>{y.configName===s&&(y.configName=_)});const g=n.persistAll?n.persistAll():n.saveData({dashboards:n.dashboards,inputSettings:n.inputSettings});Promise.resolve(g).then(()=>{new $.Notice("仪表盘配置已保存"),n.refreshAllDashboards()}),c(!1)};return o("div",{children:[o("div",{class:"tp-toolbar",style:"margin-bottom:8px;",children:[["年","季","月","周","天"].map(s=>o("button",{onClick:()=>d(s),class:s===l?"active":"",children:s})),o("button",{disabled:!0,style:"font-weight:bold;margin:0 4px;background:#fff;cursor:default;",children:M(h,l)}),o("button",{onClick:R,children:"←"}),o("button",{onClick:I,children:"→"}),o("button",{onClick:P,children:"＝"}),o("input",{placeholder:"快速过滤…",style:"margin-left:4px;",value:b,onInput:s=>Y(s.target.value)}),o("button",{onClick:()=>c(!f),style:"margin-left:4px;",children:"⚙︎"})]}),f&&u&&o("div",{style:"border:1px solid #eee;padding:12px;margin-bottom:12px;border-radius:8px;background:#fcfcfc;",children:[o("h3",{style:"margin-top:0;",children:"编辑配置"}),o("fieldset",{style:"margin-bottom:10px;",children:[o("legend",{children:"基础设置"}),o("label",{children:["配置名称:",o("input",{type:"text",value:u.name,onInput:s=>m({...u,name:s.target.value})})]}),o("br",{}),o("label",{children:["数据源路径:",o("input",{type:"text",value:u.path||"",onInput:s=>m({...u,path:s.target.value})})]}),o("br",{}),o("label",{children:["标签(逗号分隔):",o("input",{type:"text",value:Array.isArray(u.tags)?u.tags.join(","):u.tags||"",onInput:s=>{const g=s.target.value.split(/[,，]/).map(y=>y.trim()).filter(Boolean);m({...u,tags:g})}})]}),o("br",{}),o("label",{children:["初始视图:",o("select",{value:u.initialView||"月",onChange:s=>m({...u,initialView:s.target.value}),children:["年","季","月","周","天"].map(s=>o("option",{value:s,children:s}))})]}),o("br",{}),o("label",{children:["初始日期:",o("input",{type:"date",value:u.initialDate||i().format("YYYY-MM-DD"),onChange:s=>m({...u,initialDate:s.target.value})})]}),o("br",{})]}),o("div",{id:"modulesArea",children:[u.modules.map((s,_)=>o("fieldset",{style:"border:1px solid #ccc;padding:8px;margin-bottom:8px;",children:[o("legend",{children:[s.title||"模块"," (",s.view,")"]}),o("div",{children:o("label",{children:["模块标题:",o("input",{type:"text",value:s.title,onInput:g=>{const y=[...u.modules];y[_]={...s,title:g.target.value},m({...u,modules:y})}})]})}),o("div",{children:o("label",{children:["视图类型:",o("select",{value:s.view,onChange:g=>{const y=[...u.modules];y[_]={...s,view:g.target.value},m({...u,modules:y})},children:Object.keys(se).map(g=>o("option",{value:g,children:g}))})]})}),o("div",{children:o("label",{children:["默认折叠:",o("input",{type:"checkbox",checked:!!s.collapsed,onChange:g=>{const y=[...u.modules];y[_]={...s,collapsed:g.target.checked},m({...u,modules:y})}})]})}),s.view==="TableView"&&o("div",{children:[o("label",{children:["行字段:",o("input",{type:"text",value:s.props?.rowField||"",onInput:g=>{const y=[...u.modules];y[_]={...s,props:{...s.props,rowField:g.target.value}},m({...u,modules:y})}})]}),o("br",{}),o("label",{children:["列字段:",o("input",{type:"text",value:s.props?.colField||"",onInput:g=>{const y=[...u.modules];y[_]={...s,props:{...s.props,colField:g.target.value}},m({...u,modules:y})}})]})]}),(s.view==="BlockView"||s.view==="TimelineView")&&o("div",{children:o("label",{children:["分组字段:",o("input",{type:"text",value:s.group||"",onInput:g=>{const y=[...u.modules];y[_]={...s,group:g.target.value||void 0},m({...u,modules:y})}})]})}),s.view!=="TableView"&&s.view!=="ChartView"&&s.view!=="CalendarView"&&o("div",{children:o("label",{children:["显示字段(逗号分隔 / * 为动态):",o("input",{type:"text",placeholder:"如 title,tags,date 或 *",value:s.fields?s.fields.join(","):"",onInput:g=>{const y=g.target.value,k=y.trim()==="*"?["*"]:y.split(/[,，]/).map(T=>T.trim()).filter(Boolean),D=[...u.modules];D[_]={...s,fields:k.length?k:void 0},m({...u,modules:D})}})]})}),o("div",{style:"border-top:1px dashed #ccc;margin-top:6px;padding-top:6px;",children:[o("strong",{children:"过滤规则"}),(s.filters||[]).map((g,y)=>o("div",{style:"display:flex;margin-bottom:4px;",children:[o("input",{type:"text",style:"flex:0 0 30%;",value:g.field,onInput:k=>{const D=k.target.value,T=[...s.filters||[]];T[y]={...g,field:D};const N=[...u.modules];N[_]={...s,filters:T},m({...u,modules:N})}}),o("select",{value:g.op,onChange:k=>{const D=k.target.value,T=[...s.filters||[]];T[y]={...g,op:D};const N=[...u.modules];N[_]={...s,filters:T},m({...u,modules:N})},children:["=","!=","includes","regex",">","<"].map(k=>o("option",{value:k,children:k}))}),o("input",{type:"text",style:"flex:0 0 30%;",value:String(g.value),onInput:k=>{const D=k.target.value,T=[...s.filters||[]];T[y]={...g,value:D};const N=[...u.modules];N[_]={...s,filters:T},m({...u,modules:N})}}),o("button",{onClick:()=>{const k=[...s.filters||[]];k.splice(y,1);const D=[...u.modules];D[_]={...s,filters:k},m({...u,modules:D})},children:"删除"})]})),o("button",{onClick:()=>{const g=[...s.filters||[],{field:"",op:"=",value:""}],y=[...u.modules];y[_]={...s,filters:g},m({...u,modules:y})},children:"+ 添加过滤条件"})]}),o("div",{style:"border-top:1px dashed #ccc;margin-top:6px;padding-top:6px;",children:[o("strong",{children:"排序规则"}),(s.sort||[]).map((g,y)=>o("div",{style:"display:flex;margin-bottom:4px;",children:[o("input",{type:"text",style:"flex:0 0 40%;",value:g.field,onInput:k=>{const D=k.target.value,T=[...s.sort||[]];T[y]={...g,field:D};const N=[...u.modules];N[_]={...s,sort:T},m({...u,modules:N})}}),o("select",{value:g.dir,onChange:k=>{const D=k.target.value,T=[...s.sort||[]];T[y]={...g,dir:D};const N=[...u.modules];N[_]={...s,sort:T},m({...u,modules:N})},children:[o("option",{value:"asc",children:"升序"}),o("option",{value:"desc",children:"降序"})]}),o("button",{style:"margin-left:4px;",onClick:()=>{const k=[...s.sort||[]];k.splice(y,1);const D=[...u.modules];D[_]={...s,sort:k},m({...u,modules:D})},children:"删除"})]})),o("button",{onClick:()=>{const g=[...s.sort||[],{field:"",dir:"asc"}],y=[...u.modules];y[_]={...s,sort:g},m({...u,modules:y})},children:"+ 添加排序条件"})]}),o("div",{style:"text-align:right;",children:[_>0&&o("button",{onClick:()=>{const g=[...u.modules];[g[_-1],g[_]]=[g[_],g[_-1]],m({...u,modules:g})},children:"↑ 上移"}),_<u.modules.length-1&&o("button",{onClick:()=>{const g=[...u.modules];[g[_],g[_+1]]=[g[_+1],g[_]],m({...u,modules:g})},children:"↓ 下移"}),o("button",{onClick:()=>{const g=[...u.modules];g.splice(_,1),m({...u,modules:g})},children:"删除模块"})]})]})),o("div",{children:[o("select",{value:w,onChange:s=>S(s.target.value),children:Object.keys(se).map(s=>o("option",{value:s,children:s}))}),o("button",{style:"margin-left:6px;",onClick:()=>{const s={view:w,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};m({...u,modules:[...u.modules,s]})},children:"添加模块"})]})]}),o("hr",{}),o("button",{onClick:F,children:"保存配置"}),o("button",{style:"margin-left:8px;",onClick:()=>c(!1),children:"取消"}),o("datalist",{id:"fields-list",children:ke(e.query()).map(s=>o("option",{value:s}))})]}),!f&&t.modules.map(s=>V(s))]})}class nn{constructor(e,n){this.plugin=e,this.dataStore=n,this.registerProcessor()}registerProcessor(){this.plugin.registerMarkdownCodeBlockProcessor(gt,(e,n)=>{let i,r;try{const l=e.trim()?JSON.parse(e):{};Array.isArray(l.modules)?r={name:l.name||"__inline__",path:l.path||"",tags:l.tags||[],initialView:l.initialView||"月",initialDate:l.initialDate||"",modules:l.modules}:i=l.config||l.dashboard||l.name}catch(l){console.warn("ThinkPlugin: 仪表盘代码块 JSON 解析失败",l)}if(r)return this.mount(n,r);!i&&this.plugin.dashboards.length&&(i=this.plugin.dashboards[0].name);const a=this.plugin.dashboards.find(l=>l.name===i);if(!a){n.createDiv({text:`找不到名称为 "${i}" 的仪表盘配置`});return}this.mount(n,a)})}mount(e,n){It(Ge(tn,{config:n,dataStore:this.dataStore,plugin:this.plugin}),e),this.plugin.activeDashboards.push({container:e,configName:n.name})}}class sn extends $.Plugin{constructor(){super(...arguments),this.dashboards=[],this.activeDashboards=[],this.inputSettings={}}async onload(){console.log("ThinkPlugin 加载 - 重构版");const e=await this.loadData();e?.dashboards&&(this.dashboards=e.dashboards),this.dashboards.length||this._createDefaultDashboard(),this.inputSettings=e?.inputSettings??{},this.dashboards.forEach(n=>n.modules.forEach(i=>{i.view==="ListView"&&(i.view="BlockView")})),this.dataStore=new J(this.app),await this.dataStore.scanAll(),new Zt(this,this.dataStore),new nn(this,this.dataStore),this._injectStyles(),this.addSettingTab(new Qt(this.app,this))}onunload(){document.getElementById(fe)?.remove(),console.log("ThinkPlugin 卸载")}async persistAll(){await this.saveData({dashboards:this.dashboards,inputSettings:this.inputSettings})}_createDefaultDashboard(){const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i={name:"默认仪表盘",path:"",tags:[],initialView:"月",initialDate:n,modules:[{view:"BlockView",title:"未完成任务",filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"open"}],sort:[],collapsed:!1,props:{}},{view:"BlockView",title:"已完成任务",filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"done"}],sort:[{field:"date",dir:"desc"}],collapsed:!0,props:{}}]};this.dashboards.push(i)}_injectStyles(){if(document.getElementById(fe))return;const e=document.createElement("style");e.id=fe,e.textContent=vt,document.head.appendChild(e)}}module.exports=sn;
//# sourceMappingURL=main.js.map
