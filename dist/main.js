"use strict";const Y=require("obsidian");var ce,F,je,G,Ce,Ke,ze,Je,ke,me,ye,te={},Xe=[],dt=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,de=Array.isArray;function J(t,e){for(var n in e)t[n]=e[n];return t}function xe(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function ve(t,e,n){var i,s,r,o={};for(r in e)r=="key"?i=e[r]:r=="ref"?s=e[r]:o[r]=e[r];if(arguments.length>2&&(o.children=arguments.length>3?ce.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(r in t.defaultProps)o[r]===void 0&&(o[r]=t.defaultProps[r]);return se(t,o,i,s,null)}function se(t,e,n,i,s){var r={type:t,props:e,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:s??++je,__i:-1,__u:0};return s==null&&F.vnode!=null&&F.vnode(r),r}function ue(t){return t.children}function re(t,e){this.props=t,this.context=e}function Z(t,e){if(e==null)return t.__?Z(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Z(t):null}function Ge(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Ge(t)}}function Te(t){(!t.__d&&(t.__d=!0)&&G.push(t)&&!le.__r++||Ce!=F.debounceRendering)&&((Ce=F.debounceRendering)||Ke)(le)}function le(){for(var t,e,n,i,s,r,o,d=1;G.length;)G.length>d&&G.sort(ze),t=G.shift(),d=G.length,t.__d&&(n=void 0,s=(i=(e=t).__v).__e,r=[],o=[],e.__P&&((n=J({},i)).__v=i.__v+1,F.vnode&&F.vnode(n),De(e.__P,n,i,e.__n,e.__P.namespaceURI,32&i.__u?[s]:null,r,s??Z(i),!!(32&i.__u),o),n.__v=i.__v,n.__.__k[n.__i]=n,et(r,n,o),n.__e!=s&&Ge(n)));le.__r=0}function Qe(t,e,n,i,s,r,o,d,u,h,c){var l,_,y,w,k,v,f=i&&i.__k||Xe,m=e.length;for(u=ut(n,e,f,u,m),l=0;l<m;l++)(y=n.__k[l])!=null&&(_=y.__i==-1?te:f[y.__i]||te,y.__i=l,v=De(t,y,_,s,r,o,d,u,h,c),w=y.__e,y.ref&&_.ref!=y.ref&&(_.ref&&Ee(_.ref,null,y),c.push(y.ref,y.__c||w,y)),k==null&&w!=null&&(k=w),4&y.__u||_.__k===y.__k?u=Ze(y,u,t):typeof y.type=="function"&&v!==void 0?u=v:w&&(u=w.nextSibling),y.__u&=-7);return n.__e=k,u}function ut(t,e,n,i,s){var r,o,d,u,h,c=n.length,l=c,_=0;for(t.__k=new Array(s),r=0;r<s;r++)(o=e[r])!=null&&typeof o!="boolean"&&typeof o!="function"?(u=r+_,(o=t.__k[r]=typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?se(null,o,null,null,null):de(o)?se(ue,{children:o},null,null,null):o.constructor==null&&o.__b>0?se(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=t,o.__b=t.__b+1,d=null,(h=o.__i=ht(o,n,u,l))!=-1&&(l--,(d=n[h])&&(d.__u|=2)),d==null||d.__v==null?(h==-1&&(s>c?_--:s<c&&_++),typeof o.type!="function"&&(o.__u|=4)):h!=u&&(h==u-1?_--:h==u+1?_++:(h>u?_--:_++,o.__u|=4))):t.__k[r]=null;if(l)for(r=0;r<c;r++)(d=n[r])!=null&&(2&d.__u)==0&&(d.__e==i&&(i=Z(d)),nt(d,d));return i}function Ze(t,e,n){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=Ze(i[s],e,n));return e}t.__e!=e&&(e&&t.type&&!n.contains(e)&&(e=Z(t)),n.insertBefore(t.__e,e||null),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function ht(t,e,n,i){var s,r,o=t.key,d=t.type,u=e[n];if(u===null&&t.key==null||u&&o==u.key&&d==u.type&&(2&u.__u)==0)return n;if(i>(u!=null&&(2&u.__u)==0?1:0))for(s=n-1,r=n+1;s>=0||r<e.length;){if(s>=0){if((u=e[s])&&(2&u.__u)==0&&o==u.key&&d==u.type)return s;s--}if(r<e.length){if((u=e[r])&&(2&u.__u)==0&&o==u.key&&d==u.type)return r;r++}}return-1}function Ne(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||dt.test(e)?n:n+"px"}function ie(t,e,n,i,s){var r,o;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof i=="string"&&(t.style.cssText=i=""),i)for(e in i)n&&e in n||Ne(t.style,e,"");if(n)for(e in n)i&&n[e]==i[e]||Ne(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")r=e!=(e=e.replace(Je,"$1")),o=e.toLowerCase(),e=o in t||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+r]=n,n?i?n.u=i.u:(n.u=ke,t.addEventListener(e,r?ye:me,r)):t.removeEventListener(e,r?ye:me,r);else{if(s=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function $e(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=ke++;else if(e.t<n.u)return;return n(F.event?F.event(e):e)}}}function De(t,e,n,i,s,r,o,d,u,h){var c,l,_,y,w,k,v,f,m,x,C,S,$,M,A,D,a,g=e.type;if(e.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),r=[d=e.__e=n.__e]),(c=F.__b)&&c(e);e:if(typeof g=="function")try{if(f=e.props,m="prototype"in g&&g.prototype.render,x=(c=g.contextType)&&i[c.__c],C=c?x?x.props.value:c.__:i,n.__c?v=(l=e.__c=n.__c).__=l.__E:(m?e.__c=l=new g(f,C):(e.__c=l=new re(f,C),l.constructor=g,l.render=pt),x&&x.sub(l),l.props=f,l.state||(l.state={}),l.context=C,l.__n=i,_=l.__d=!0,l.__h=[],l._sb=[]),m&&l.__s==null&&(l.__s=l.state),m&&g.getDerivedStateFromProps!=null&&(l.__s==l.state&&(l.__s=J({},l.__s)),J(l.__s,g.getDerivedStateFromProps(f,l.__s))),y=l.props,w=l.state,l.__v=e,_)m&&g.getDerivedStateFromProps==null&&l.componentWillMount!=null&&l.componentWillMount(),m&&l.componentDidMount!=null&&l.__h.push(l.componentDidMount);else{if(m&&g.getDerivedStateFromProps==null&&f!==y&&l.componentWillReceiveProps!=null&&l.componentWillReceiveProps(f,C),!l.__e&&l.shouldComponentUpdate!=null&&l.shouldComponentUpdate(f,l.__s,C)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(l.props=f,l.state=l.__s,l.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(b){b&&(b.__=e)}),S=0;S<l._sb.length;S++)l.__h.push(l._sb[S]);l._sb=[],l.__h.length&&o.push(l);break e}l.componentWillUpdate!=null&&l.componentWillUpdate(f,l.__s,C),m&&l.componentDidUpdate!=null&&l.__h.push(function(){l.componentDidUpdate(y,w,k)})}if(l.context=C,l.props=f,l.__P=t,l.__e=!1,$=F.__r,M=0,m){for(l.state=l.__s,l.__d=!1,$&&$(e),c=l.render(l.props,l.state,l.context),A=0;A<l._sb.length;A++)l.__h.push(l._sb[A]);l._sb=[]}else do l.__d=!1,$&&$(e),c=l.render(l.props,l.state,l.context),l.state=l.__s;while(l.__d&&++M<25);l.state=l.__s,l.getChildContext!=null&&(i=J(J({},i),l.getChildContext())),m&&!_&&l.getSnapshotBeforeUpdate!=null&&(k=l.getSnapshotBeforeUpdate(y,w)),D=c,c!=null&&c.type===ue&&c.key==null&&(D=tt(c.props.children)),d=Qe(t,de(D)?D:[D],e,n,i,s,r,o,d,u,h),l.base=e.__e,e.__u&=-161,l.__h.length&&o.push(l),v&&(l.__E=l.__=null)}catch(b){if(e.__v=null,u||r!=null)if(b.then){for(e.__u|=u?160:128;d&&d.nodeType==8&&d.nextSibling;)d=d.nextSibling;r[r.indexOf(d)]=null,e.__e=d}else for(a=r.length;a--;)xe(r[a]);else e.__e=n.__e,e.__k=n.__k;F.__e(b,e,n)}else r==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):d=e.__e=_t(n.__e,e,n,i,s,r,o,u,h);return(c=F.diffed)&&c(e),128&e.__u?void 0:d}function et(t,e,n){for(var i=0;i<n.length;i++)Ee(n[i],n[++i],n[++i]);F.__c&&F.__c(e,t),t.some(function(s){try{t=s.__h,s.__h=[],t.some(function(r){r.call(s)})}catch(r){F.__e(r,s.__v)}})}function tt(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:de(t)?t.map(tt):J({},t)}function _t(t,e,n,i,s,r,o,d,u){var h,c,l,_,y,w,k,v=n.props,f=e.props,m=e.type;if(m=="svg"?s="http://www.w3.org/2000/svg":m=="math"?s="http://www.w3.org/1998/Math/MathML":s||(s="http://www.w3.org/1999/xhtml"),r!=null){for(h=0;h<r.length;h++)if((y=r[h])&&"setAttribute"in y==!!m&&(m?y.localName==m:y.nodeType==3)){t=y,r[h]=null;break}}if(t==null){if(m==null)return document.createTextNode(f);t=document.createElementNS(s,m,f.is&&f),d&&(F.__m&&F.__m(e,r),d=!1),r=null}if(m==null)v===f||d&&t.data==f||(t.data=f);else{if(r=r&&ce.call(t.childNodes),v=n.props||te,!d&&r!=null)for(v={},h=0;h<t.attributes.length;h++)v[(y=t.attributes[h]).name]=y.value;for(h in v)if(y=v[h],h!="children"){if(h=="dangerouslySetInnerHTML")l=y;else if(!(h in f)){if(h=="value"&&"defaultValue"in f||h=="checked"&&"defaultChecked"in f)continue;ie(t,h,null,y,s)}}for(h in f)y=f[h],h=="children"?_=y:h=="dangerouslySetInnerHTML"?c=y:h=="value"?w=y:h=="checked"?k=y:d&&typeof y!="function"||v[h]===y||ie(t,h,y,v[h],s);if(c)d||l&&(c.__html==l.__html||c.__html==t.innerHTML)||(t.innerHTML=c.__html),e.__k=[];else if(l&&(t.innerHTML=""),Qe(e.type=="template"?t.content:t,de(_)?_:[_],e,n,i,m=="foreignObject"?"http://www.w3.org/1999/xhtml":s,r,o,r?r[0]:n.__k&&Z(n,0),d,u),r!=null)for(h=r.length;h--;)xe(r[h]);d||(h="value",m=="progress"&&w==null?t.removeAttribute("value"):w!=null&&(w!==t[h]||m=="progress"&&!w||m=="option"&&w!=v[h])&&ie(t,h,w,v[h],s),h="checked",k!=null&&k!=t[h]&&ie(t,h,k,v[h],s))}return t}function Ee(t,e,n){try{if(typeof t=="function"){var i=typeof t.__u=="function";i&&t.__u(),i&&e==null||(t.__u=t(e))}else t.current=e}catch(s){F.__e(s,n)}}function nt(t,e,n){var i,s;if(F.unmount&&F.unmount(t),(i=t.ref)&&(i.current&&i.current!=t.__e||Ee(i,null,e)),(i=t.__c)!=null){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(r){F.__e(r,e)}i.base=i.__P=null}if(i=t.__k)for(s=0;s<i.length;s++)i[s]&&nt(i[s],e,n||typeof t.type!="function");n||xe(t.__e),t.__c=t.__=t.__e=void 0}function pt(t,e,n){return this.constructor(t,n)}function Ae(t,e,n){var i,s,r,o;e==document&&(e=document.documentElement),F.__&&F.__(t,e),s=(i=!1)?null:e.__k,r=[],o=[],De(e,t=e.__k=ve(ue,null,[t]),s||te,te,e.namespaceURI,s?null:e.firstChild?ce.call(e.childNodes):null,r,s?s.__e:e.firstChild,i,o),et(r,t,o)}ce=Xe.slice,F={__e:function(t,e,n,i){for(var s,r,o;e=e.__;)if((s=e.__c)&&!s.__)try{if((r=s.constructor)&&r.getDerivedStateFromError!=null&&(s.setState(r.getDerivedStateFromError(t)),o=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(t,i||{}),o=s.__d),o)return s.__E=s}catch(d){t=d}throw t}},je=0,re.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=J({},this.state),typeof t=="function"&&(t=t(J({},n),this.props)),t&&J(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Te(this))},re.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Te(this))},re.prototype.render=ue,G=[],Ke=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,ze=function(t,e){return t.__v.__b-e.__v.__b},le.__r=0,Je=/(PointerCapture)$|Capture$/i,ke=0,me=$e(!1),ye=$e(!0);const ft=["id","title","content","type","status","category","tags","recurrence","date","header","icon","priority","createdDate","scheduledDate","startDate","dueDate","doneDate","cancelledDate","created","modified","filename"];function it(t){const e=new Set(ft);for(const n of t)Object.keys(n.extra||{}).forEach(i=>e.add("extra."+i));return Array.from(e)}function q(t,e){if(e.startsWith("extra.")){const n=e.substring(6);return t.extra?.[n]}return t[e]}const gt="\\d{4}[-/]\\d{2}[-/]\\d{2}",mt=new RegExp(gt),Fe=/#([\p{L}\p{N}_\/-]+)/gu,yt=/\(([^:：]+)::\s*([^)]+)\)/g,vt=/\([^:：]+::\s*[^)]+\)/g,Ye=/^\s*-\s*\[[ xX-]\]/,bt=/^\s*-\s*\[x\]/i,wt=/^\s*-\s*\[-\]/;function st(t){return t.replace(/\//g,"-")}const kt="think",X={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕",repeat:"🔁"},Me="无日期",_e="think-dashboard-style",xt=`
.think-table{width:100%;border:1px solid #ccc;border-collapse:collapse;}
.think-table th,.think-table td{border:1px solid #ccc;padding:4px;}
.think-table th{background:#f0f0f0;text-align:center;}
.think-table td{text-align:left;}
.think-table td.empty{background:#f9f9f9;}
.tag-pill{background:#e0e0e0;border-radius:4px;padding:0 6px;margin-right:6px;font-size:90%;display:inline-block;}
.task-done{text-decoration:line-through;color:gray;}
.module-header{display:flex;align-items:center;padding:4px 8px;background:#eee;cursor:pointer;}
.module-title{flex:1;font-weight:bold;}
.module-toggle{margin-left:4px;}
.module-content{padding:6px 8px;}
.think-module a{color:black;text-decoration:none;}
`.trim();function Dt(t){if(t.includes("🔺"))return"highest";if(t.includes("⏫"))return"high";if(t.includes("🔼"))return"medium";if(t.includes("🔽"))return"low";if(t.includes("⏬"))return"lowest"}function Et(t,e,n,i){const s=e;if(!Ye.test(s))return null;let r="open";bt.test(s)?r="done":wt.test(s)&&(r="cancelled");const d=(s.match(Fe)||[]).map(D=>D.replace("#",""));let u="none";const h=s.indexOf(X.repeat);if(h!==-1){let D=s.substring(h);const a=D.search(/[➕⏳🛫📅✅❌]/);a!==-1&&(D=D.substring(0,a)),D=D.replace(/^🔁\s*/,"").trim(),D&&(u=D)}const c={};let l;for(;(l=yt.exec(s))!==null;){const D=l[1].trim(),a=l[2].trim(),g=D.toLowerCase();if(["主题","标签","tag","tags"].includes(g))a.split(/[,，]/).forEach(b=>{const T=b.trim().replace(/^#/,"");T&&d.push(T)});else{const b=Number(a);let T=a;a!==""&&!isNaN(b)?T=b:/^(true|false)$/i.test(a)&&(T=a.toLowerCase()==="true"),c[D]=T}}const _=D=>{const a=s.match(new RegExp(`${D}\\s*(${mt.source})`));return a?st(a[1]):void 0},y=_(X.done),w=_(X.cancelled),k=_(X.due),v=_(X.scheduled),f=_(X.start),m=_(X.created),x=Dt(s);let C;const S=s.replace(Ye,"").trim(),$=S.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let M=S;$&&(C=$[1],M=M.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),M=M.replace(Fe,"").replace(vt,"").replace(/[📅⏳🛫➕]\s*\d{4}[-/]\d{2}[-/]\d{2}/g,"").replace(/[✅❌]\s*\d{4}[-/]\d{2}[-/]\d{2}/g,"").replace(/[🔺⏫🔼🔽⏬]/g,"").replace(/🔁.*?(?=(➕|⏳|🛫|📅|✅|❌|$))/,"").replace(/\s\s+/g," ").trim();const A={id:`${t}#${n}`,title:M||"",content:s.trim(),type:"task",status:r,category:"任务",tags:Array.from(new Set(d)),recurrence:u,date:void 0,created:0,modified:0,extra:{}};return C&&(A.icon=C,c.图标=C),x&&(A.priority=x),m&&(A.createdDate=m),v&&(A.scheduledDate=v),f&&(A.startDate=f),k&&(A.dueDate=k),y&&(A.doneDate=y,r==="done"&&(A.date=y)),w&&(A.cancelledDate=w,r==="cancelled"&&(A.date=w)),r==="open"&&(A.date=k||v||f||m),A.extra=c,A}function St(t,e,n,i,s){const r=e.slice(n+1,i);let o="",d=null,u,h;const c=[],l={};let _=null,y="",w=!1,k=null;for(let f=0;f<r.length;f++){const m=r[f],x=m.trim();if(w)y+=(y?`
`:"")+m;else{if(x==="")continue;const C=x.match(/^([^:：]{1,20})::\s*(.*)$/);if(C){const S=C[1].trim(),$=C[2]||"",M=S.toLowerCase();if(["分类","类别","category"].includes(M))d=$.trim();else if(["主题","标签","tag","tags"].includes(M))_=$.trim();else if(["状态","status"].includes(M))u=$.trim();else if(["日期","date"].includes(M))h=st($.trim());else if(["内容","content"].includes(M))w=!0,y=$;else if(["图标","icon"].includes(M))k=$.trim(),l.图标=k;else{const A=Number($.trim());let D=$.trim();D!==""&&!isNaN(A)?D=A:/^(true|false)$/i.test(D)&&(D=D.toLowerCase()==="true"),l[S]=D}}else w=!0,y=m}}_&&_.split(/[,，]/).map(f=>f.trim()).filter(Boolean).forEach(f=>c.push(f.replace(/^#/,""))),y.trim()!==""?o=y.trim().split(/\r?\n/)[0]:_&&(o=_.split(/[,，]/).map(f=>f.trim()).filter(Boolean).join(", ")),o=o.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),o&&(o=o.slice(0,10)),d||(d=s||"");const v={id:`${t}#${n+1}`,title:o||"",content:y.trim(),type:"block",status:u,category:d,tags:Array.from(new Set(c)),recurrence:"none",date:h,created:0,modified:0,extra:l};return k&&(v.icon=k),v}function Ct(t,e=250){let n=0,i=null;return function(...s){const r=Date.now();r-n>=e?(n=r,t.apply(this,s)):(clearTimeout(i),i=setTimeout(()=>{n=Date.now(),t.apply(this,s)},e-(r-n)))}}class Q{constructor(e){this.items=[],this.fileIndex=new Map,this.changeListeners=new Set,this._emitThrottled=Ct(()=>this._emitChange(),250),this.app=e,Q.instance=this}async scanAll(){this.items=[],this.fileIndex.clear();const e=this.app.vault.getMarkdownFiles();for(const n of e)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(e){try{const i=(await this.app.vault.read(e)).split(/\r?\n/),s=e.path,r=e.parent?.name||"",o=[],u=this.app.metadataCache.getFileCache(e)?.headings||[];let h=0,c=[],l="";for(let _=0;_<i.length;_++){const y=i[_];if(h<u.length&&u[h].position.start.line===_){const v=u[h].heading,f=v.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];c=f.map(x=>x.replace("#","")).filter(Boolean);let m=v;for(const x of f)m=m.replace(x,"").trim();l=m||"",h++;continue}if(y.trim()==="<!-- start -->"){const k=i.indexOf("<!-- end -->",_+1);if(k!==-1){const v=St(s,i,_,k,r);if(v){v.created=e.stat.ctime,v.modified=e.stat.mtime,l&&(v.header=l),v.tags=Array.from(new Set([...c,...v.tags]));let f=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;v.filename=f,o.push(v)}_=k;continue}}const w=Et(s,y,_+1,r);if(w){w.tags=Array.from(new Set([...c,...w.tags])),w.created=e.stat.ctime,w.modified=e.stat.mtime,l&&(w.header=l);let k=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;w.filename=k,o.push(w)}}return this.fileIndex.has(s)&&(this.items=this.items.filter(_=>_.id&&!_.id.startsWith(s+"#"))),this.fileIndex.set(s,o),this.items.push(...o),o}catch(n){return console.error("ThinkPlugin: 扫描文件失败",e.path,n),[]}}removeFileItems(e){this.fileIndex.has(e)&&(this.fileIndex.delete(e),this.items=this.items.filter(n=>!n.id.startsWith(e+"#")))}removeFile(e){this.removeFileItems(e)}queryItems(e=[],n=[]){let i=this.items.filter(s=>(e||[]).every(r=>this._matchItem(s,r)));return n.length>0&&i.sort((s,r)=>{for(const o of n){const d=q(s,o.field),u=q(r,o.field);if(!(d==null&&u==null)){if(d==null)return o.dir==="asc"?1:-1;if(u==null)return o.dir==="asc"?-1:1;if(typeof d=="number"&&typeof u=="number"){if(d!==u)return o.dir==="asc"?d-u:u-d}else{const h=String(d),c=String(u);if(h!==c)return o.dir==="asc"?h.localeCompare(c):c.localeCompare(h)}}}return 0}),i}query(e=[],n=[]){return this.queryItems(e,n)}async markItemDone(e){const n=e.split("#"),i=n[0],s=Number(n[1])||0,r=this.app.vault.getAbstractFileByPath(i);if(r instanceof Y.TFile)try{const d=(await this.app.vault.read(r)).split(/\r?\n/);if(s<=0||s>d.length)return;const u=d[s-1];if(!/^\s*-\s*\[ \]/.test(u))return;const h=window.moment,c=h().format("YYYY-MM-DD"),l=h().format("HH:mm");let _=u;if(_=_.replace(/(\s|^)(时长::[^\s\(\)]+)/g,(w,k,v)=>w.includes("(")&&w.includes(")")?w:`${k}(${v})`),/\(时长::[^\)]+\)/.test(_)?_=_.replace(/\((时长::[^\)]+)\)/,`(时间::${l}) ($1)`):/时长::[^\s]+/.test(_)?_=_.replace(/(时长::[^\s]+)/,`(时间::${l}) ($1)`):/🔁/.test(_)?_=_.replace(/(🔁)/,`(时间::${l}) $1`):_=_+` (时间::${l})`,_=_.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(_)||(_="- [x] "+_.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")),_=_.replace(/\s*✅\s*\d{4}-\d{2}-\d{2}$/,""),_=_.trim()+` ✅ ${c}`,u.includes("🔁")){const w=v=>{let f=v;f=f.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]"),f=f.replace(/\s*✅\s*\d{4}[-/]\d{2}[-/]\d{2}/,""),f=f.replace(/\(时间::\d{2}:\d{2}\)/,"");const m=v.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/),x=window.moment;let C=1,S="day",$=!1;m&&(m[1]&&(C=parseInt(m[1])),S=m[2],S.endsWith("s")&&(S=S.slice(0,-1)),$=!!m[3]);const D=($?x():(()=>{const a=v.match(/📅\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(a)return x(a[1],["YYYY-MM-DD","YYYY/MM/DD"]);const g=v.match(/⏳\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(g)return x(g[1],["YYYY-MM-DD","YYYY/MM/DD"]);const b=v.match(/🛫\s*(\d{4}[-/]\d{2}[-/]\d{2})/);return b?x(b[1],["YYYY-MM-DD","YYYY/MM/DD"]):x()})()).clone().add(C,S+(C>1?"s":"")).format("YYYY-MM-DD");return/📅\s*\d{4}-\d{2}-\d{2}/.test(f)&&(f=f.replace(/📅\s*\d{4}[-/]\d{2}[-/]\d{2}/,`📅 ${D}`)),/⏳\s*\d{4}-\d{2}-\d{2}/.test(f)&&(f=f.replace(/⏳\s*\d{4}[-/]\d{2}[-/]\d{2}/,`⏳ ${D}`)),/🛫\s*\d{4}-\d{2}-\d{2}/.test(f)&&(f=f.replace(/🛫\s*\d{4}[-/]\d{2}[-/]\d{2}/,`🛫 ${D}`)),f=f.trim(),f};d[s-1]=_;const k=w(u);d.splice(s,0,k)}else d[s-1]=_;await this.app.vault.modify(r,d.join(`
`)),await this.scanFile(r),this._emitChange()}catch(o){console.error("ThinkPlugin: 标记任务完成时发生错误",o)}}_emitChange(){this.changeListeners.forEach(e=>{try{e()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}subscribe(e){this.changeListeners.add(e)}unsubscribe(e){this.changeListeners.delete(e)}notifyChange(){this._emitThrottled()}_matchItem(e,n){const i=q(e,n.field),s=n.value;if(n.op==="="||n.op==="!="){const r=i!=null&&s!=null&&String(i)===String(s);return n.op==="="?r:!r}if(n.op==="includes")return i==null?!1:Array.isArray(i)?i.some(r=>String(r).includes(String(s))):String(i).includes(String(s));if(n.op==="regex"){if(i==null)return!1;try{const r=new RegExp(String(s));return Array.isArray(i)?i.some(o=>r.test(String(o))):r.test(String(i))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",s),!1}}if(n.op===">"||n.op==="<"){if(i==null)return!1;const r=Number(i),o=Number(s);if(!isNaN(r)&&!isNaN(o))return n.op===">"?r>o:r<o;const d=Date.parse(String(i)),u=Date.parse(String(s));if(!isNaN(d)&&!isNaN(u))return n.op===">"?d>u:d<u;const h=String(i),c=String(s);return n.op===">"?h>c:h<c}return!1}}var Tt=0;function p(t,e,n,i,s,r){e||(e={});var o,d,u=e;if("ref"in u)for(d in u={},e)d=="ref"?o=e[d]:u[d]=e[d];var h={type:t,props:u,key:n,ref:o,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Tt,__i:-1,__u:0,__source:s,__self:r};if(typeof t=="function"&&(o=t.defaultProps))for(d in o)u[d]===void 0&&(u[d]=o[d]);return F.vnode&&F.vnode(h),h}function K(t){const e=t.lastIndexOf("#"),n=e>=0?t.substring(0,e):t,i=e>=0?t.substring(e+1):"";return`obsidian://advanced-uri?vault=${encodeURIComponent(Q.instance.app.vault.getName())}&filepath=${encodeURIComponent(n)}${i?"&line="+i:""}`}function Nt({items:t,rowField:e,colField:n}){if(!e||!n)return p("div",{children:"（TableView 需要配置 rowField 和 colField）"});const i=[],s=[],r={};for(const o of t){const d=q(o,e)??Me,u=q(o,n)??Me,h=String(d),c=String(u);r[h]||(r[h]={},i.push(h)),r[h][c]||(r[h][c]=[]),r[h][c].push(o),s.includes(c)||s.push(c)}return i.sort(),s.sort(),p("table",{class:"think-table",children:[p("thead",{children:p("tr",{children:[p("th",{children:e}),s.map(o=>p("th",{children:o},o))]})}),p("tbody",{children:i.map(o=>p("tr",{children:[p("td",{children:p("strong",{children:o})}),s.map(d=>{const u=r[o]?.[d]||[];return u.length===0?p("td",{class:"empty"},d):p("td",{children:u.map(h=>p("div",{children:$t(h)},h.id))},d)})]},o))})]})}function $t(t){if(t.type==="task"){const e=t.status==="done",n="cb-"+t.id.replace(/[^a-zA-Z0-9]/g,"_");return p("span",{children:[!e&&p("input",{type:"checkbox",id:n,class:"task-checkbox",onChange:s=>{s.currentTarget.checked&&Q.instance.markItemDone(t.id)}}),e&&p("input",{type:"checkbox",id:n,class:"task-checkbox done",checked:!0,onClick:s=>s.preventDefault()}),p("a",{href:K(t.id),target:"_blank",rel:"noopener",children:t.title})]})}return p("a",{href:K(t.id),target:"_blank",rel:"noopener",children:t.title})}const At={打卡:"#d2cceb",任务:"#caebf3",计划:"#d8ecb2",总结:"#E5D5B9",事件:"#94e2d6",感受:"#93daf0",思考:"#f09393"};function pe(t){return At[t]||"#e0e0e0"}function Ft(t){const{groupField:e,showMeta:n=!0,fields:i}=t;let{items:s}=t,r=s;i&&i.length>0&&(r=s.filter(c=>i.some(l=>{const _=q(c,l);return _!=null&&String(_).trim()!==""})));let o=null,d=[];if(e){o={};for(const c of r){const l=String(q(c,e)??"(none)");o[l]||(o[l]=[],d.push(l)),o[l].push(c)}d.sort()}const u=c=>{if(c.type!=="task")return null;const l=c.status==="done";return p("input",{type:"checkbox",class:`task-checkbox ${l?"done":""}`,checked:l,onClick:l?_=>_.preventDefault():void 0,onChange:async _=>{_.target.checked&&!l&&await Q.instance.markItemDone(c.id)}})},h=c=>{if(i&&i.length>0){const l=i.includes("title"),_=i.includes("content"),y=["category","date","icon"];if(i.some(m=>y.includes(m))&&(l||_)){const m=[];i.forEach(S=>{if(!y.includes(S))return;const $=q(c,S);$==null||String($).trim()===""||(S==="category"?m.push(p("span",{class:"tag-pill",style:`background:${pe(c.category)};`,children:c.category},"cat")):S==="date"?m.push(p("span",{class:"tag-pill",children:c.date},"date")):S==="icon"&&m.push(p("span",{class:"tag-pill",children:c.icon},"icon")))});const x=()=>{if(l){const S=_?p("span",{children:c.title}):p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",children:c.title});return p("div",{style:"line-height:1.5;margin-bottom:2px;",children:[u(c),S]})}return _?p("div",{style:"line-height:1.5;margin-bottom:2px;",children:[u(c),p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:c.content})]}):null},C=l&&_?p("div",{style:"white-space:pre-wrap;line-height:1.5;",children:p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",children:c.content})}):null;return p("div",{style:`\r
              display:grid;\r
              grid-template-columns:auto minmax(180px,1fr);\r
              gap:8px;\r
              align-items:start;\r
              margin-bottom:8px;\r
            `,children:[p("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:m}),p("div",{children:[x(),C]})]})}const v=[];let f=!1;return i.forEach((m,x)=>{const C=q(c,m);if(!f&&c.type==="task"&&(m==="title"||m==="content")&&(v.push(u(c)),f=!0),m==="content")v.push(p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:c.content},x));else if(m==="title")i.includes("content")?v.push(p("span",{children:c.title},x)):v.push(p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",children:c.title},x));else if(m==="tags")v.push(p("span",{children:c.tags.map(S=>p("span",{class:"tag-pill",children:S},S))},"tags"));else if(m==="category")v.push(p("span",{class:"tag-pill",style:`background:${pe(c.category)};`,children:c.category},x));else if(m==="icon")c.icon&&v.push(p("span",{class:"tag-pill",children:c.icon},x));else{if(C==null)return;const S=Array.isArray(C)?C.join(", "):String(C);v.push(p("span",{class:"tag-pill",children:S},x))}}),p("div",{style:"margin-bottom:8px;line-height:1.5;",children:v.map((m,x)=>p("span",{children:m},x))})}if(c.type==="task"){const l=c.status==="done";return p("div",{style:"margin-bottom:4px;line-height:1.5;",children:[u(c),p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",class:l?"task-done":"",children:c.title}),c.icon&&p("span",{class:"tag-pill",children:c.icon}),c.tags.map(_=>p("span",{class:"tag-pill",children:_},_))]})}else return p("div",{style:`\r
            display:grid;\r
            grid-template-columns:auto minmax(180px,1fr);\r
            align-items:start;\r
            gap:8px;\r
            margin-bottom:8px;\r
          `,children:[n&&p("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:[p("span",{class:"tag-pill",style:`background:${pe(c.category)};`,children:c.category}),c.date&&p("span",{class:"tag-pill",children:c.date}),c.extra.图标&&p("span",{class:"tag-pill",children:c.extra.图标})]}),p("div",{style:"white-space:pre-wrap;line-height:1.5;",children:p("a",{href:`${K(c.id)}`,target:"_blank",rel:"noopener",children:c.content})})]})};return p("div",{children:o?d.map(c=>p("div",{children:[p("h5",{children:c}),o[c].map(l=>h(l))]})):r.map(c=>h(c))})}function Yt(t){return p("div",{children:"（Timeline 视图暂未实现）"})}function Mt(t){return p("div",{children:"（Calendar 日视图暂未实现）"})}function Vt(t){return p("div",{children:"（Chart 图表视图暂未实现）"})}function It(t){return Array.isArray(t)?t.join(", "):t==null?"":String(t)}function Lt({items:t,fields:e}){const n=e&&e.length?e:it(t);return p("div",{children:p("table",{class:"think-table",style:"min-width:100%; white-space:nowrap;",children:[p("thead",{children:p("tr",{children:n.map(i=>p("th",{children:i},i))})}),p("tbody",{children:t.map(i=>p("tr",{children:n.map(s=>p("td",{children:It(q(i,s))},s))},i.id))})]})})}var ne,V,fe,Ve,oe=0,rt=[],L=F,Ie=L.__b,Le=L.__r,Pe=L.diffed,Oe=L.__c,Be=L.unmount,He=L.__;function Se(t,e){L.__h&&L.__h(V,t,oe||e),oe=0;var n=V.__H||(V.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function z(t){return oe=1,Pt(lt,t)}function Pt(t,e,n){var i=Se(ne++,2);if(i.t=t,!i.__c&&(i.__=[lt(void 0,e),function(d){var u=i.__N?i.__N[0]:i.__[0],h=i.t(u,d);u!==h&&(i.__N=[h,i.__[1]],i.__c.setState({}))}],i.__c=V,!V.__f)){var s=function(d,u,h){if(!i.__c.__H)return!0;var c=i.__c.__H.__.filter(function(_){return!!_.__c});if(c.every(function(_){return!_.__N}))return!r||r.call(this,d,u,h);var l=i.__c.props!==d;return c.forEach(function(_){if(_.__N){var y=_.__[0];_.__=_.__N,_.__N=void 0,y!==_.__[0]&&(l=!0)}}),r&&r.call(this,d,u,h)||l};V.__f=!0;var r=V.shouldComponentUpdate,o=V.componentWillUpdate;V.componentWillUpdate=function(d,u,h){if(this.__e){var c=r;r=void 0,s(d,u,h),r=c}o&&o.call(this,d,u,h)},V.shouldComponentUpdate=s}return i.__N||i.__}function be(t,e){var n=Se(ne++,3);!L.__s&&at(n.__H,e)&&(n.__=t,n.u=e,V.__H.__h.push(n))}function Ot(t){return oe=5,Bt(function(){return{current:t}},[])}function Bt(t,e){var n=Se(ne++,7);return at(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Ht(){for(var t;t=rt.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(ae),t.__H.__h.forEach(we),t.__H.__h=[]}catch(e){t.__H.__h=[],L.__e(e,t.__v)}}L.__b=function(t){V=null,Ie&&Ie(t)},L.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),He&&He(t,e)},L.__r=function(t){Le&&Le(t),ne=0;var e=(V=t.__c).__H;e&&(fe===V?(e.__h=[],V.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(ae),e.__h.forEach(we),e.__h=[],ne=0)),fe=V},L.diffed=function(t){Pe&&Pe(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(rt.push(e)!==1&&Ve===L.requestAnimationFrame||((Ve=L.requestAnimationFrame)||Rt)(Ht)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),fe=V=null},L.__c=function(t,e){e.some(function(n){try{n.__h.forEach(ae),n.__h=n.__h.filter(function(i){return!i.__||we(i)})}catch(i){e.some(function(s){s.__h&&(s.__h=[])}),e=[],L.__e(i,n.__v)}}),Oe&&Oe(t,e)},L.unmount=function(t){Be&&Be(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{ae(i)}catch(s){e=s}}),n.__H=void 0,e&&L.__e(e,n.__v))};var Re=typeof requestAnimationFrame=="function";function Rt(t){var e,n=function(){clearTimeout(i),Re&&cancelAnimationFrame(e),setTimeout(t)},i=setTimeout(n,35);Re&&(e=requestAnimationFrame(n))}function ae(t){var e=V,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),V=e}function we(t){var e=V;t.__c=t.__(),V=e}function at(t,e){return!t||t.length!==e.length||e.some(function(n,i){return n!==t[i]})}function lt(t,e){return typeof e=="function"?e(t):e}function Wt({storageKey:t="inputSettings",plugin:e}){const n=e[t]||{},[i,s]=z(typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))),r=(d,u)=>s(h=>({...h,[d]:u})),o=async()=>{e[t]=i,await e.persistAll(),alert("已保存配置")};return p("div",{style:"display:flex;flex-direction:column;gap:6px;max-width:420px;",children:[p("label",{children:["主题 (可层级“生活/健康”)：",p("input",{value:i.topic||"",onInput:d=>r("topic",d.target.value)})]}),p("label",{children:["图标 (emoji)：",p("input",{value:i.icon||"",onInput:d=>r("icon",d.target.value),placeholder:"✨"})]}),p("label",{children:["任务字段清单 (逗号分隔)：",p("input",{value:i.taskFields||"",onInput:d=>r("taskFields",d.target.value),placeholder:"status,icon,repeat,…"})]}),p("label",{children:["Block 字段清单 (逗号分隔)：",p("input",{value:i.blockFields||"",onInput:d=>r("blockFields",d.target.value),placeholder:"分类,周期,日期,主题,图标,内容"})]}),p("button",{style:"margin-top:8px;",onClick:o,children:"💾 保存配置"})]})}const ot={TableView:Nt,BlockView:Ft,TimelineView:Yt,CalendarView:Mt,ChartView:Vt,ExcelView:Lt,SettingsFormView:Wt},We=ot,Ue=Object.keys(ot);class Ut extends Y.PluginSettingTab{constructor(e,n){super(e,n),this.selectedDashName="",this.plugin=n,n.dashboards.length>0&&(this.selectedDashName=n.dashboards[0].name)}display(){const{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Think 仪表盘 配置编辑"});const n=this.plugin.dataStore.queryItems(),i=it(n),s=new Set,r=new Set,o=new Set,d=new Set,u=new Set;for(const a of n)(a.tags||[]).forEach(g=>g&&s.add(g)),a.category&&r.add(a.category),a.status&&o.add(a.status),a.recurrence&&d.add(a.recurrence),a.type&&u.add(a.type);const h=e.createEl("datalist");h.id="think-tags-list",Array.from(s).forEach(a=>h.createEl("option",{value:a}));const c=e.createEl("datalist");c.id="think-category-list",Array.from(r).forEach(a=>c.createEl("option",{value:a}));const l=e.createEl("datalist");l.id="think-status-list",Array.from(o).forEach(a=>l.createEl("option",{value:a}));const _=e.createEl("datalist");_.id="think-recurrence-list",Array.from(d).forEach(a=>_.createEl("option",{value:a}));const y=e.createEl("datalist");y.id="think-type-list",Array.from(u).forEach(a=>y.createEl("option",{value:a}));const w=e.createEl("datalist");w.id="think-fields-list",i.forEach(a=>w.createEl("option",{value:a}));const k=e.createEl("select");for(const a of this.plugin.dashboards){const g=k.createEl("option",{text:a.name});g.value=a.name,a.name===this.selectedDashName&&(g.selected=!0)}k.onchange=()=>{this.selectedDashName=k.value,this.display()};const v=e.createEl("button",{text:"新建仪表盘"});if(v.style.marginLeft="8px",v.onclick=()=>{let a="新仪表盘",g=a,b=1;for(;this.plugin.dashboards.find(I=>I.name===g);)g=a+b++;const T={name:g,modules:[]};this.plugin.dashboards.push(T),this.selectedDashName=g,this.plugin.saveData({dashboards:this.plugin.dashboards}),new Y.Notice("已添加新仪表盘配置"),this.display()},this.plugin.dashboards.length>0){const a=e.createEl("button",{text:"删除当前仪表盘"});a.style.marginLeft="8px",a.onclick=()=>{const g=this.plugin.dashboards.findIndex(b=>b.name===this.selectedDashName);g>=0&&(this.plugin.dashboards.splice(g,1),new Y.Notice(`已删除配置：${this.selectedDashName}`),this.selectedDashName=this.plugin.dashboards.length?this.plugin.dashboards[0].name:"",this.plugin.saveData({dashboards:this.plugin.dashboards}),this.display())}}e.createEl("hr");const f=this.plugin.dashboards.find(a=>a.name===this.selectedDashName);if(!f)return;const m=e.createEl("fieldset");m.createEl("legend",{text:"基础设置"}),new Y.Setting(m).setName("仪表盘名称").addText(a=>{a.setValue(f.name).onChange(g=>{f.name=g.trim()})}),new Y.Setting(m).setName("数据源路径").addText(a=>{a.setValue(f.path||"").onChange(g=>{f.path=g.trim()})}),new Y.Setting(m).setName("标签 (用逗号分隔)").addText(a=>{const g=Array.isArray(f.tags)?f.tags.join(","):f.tags||"";a.setValue(g).onChange(b=>{f.tags=b.split(/[,，]/).map(T=>T.trim()).filter(T=>T)})}),new Y.Setting(m).setName("初始视图").addDropdown(a=>{["年","季","月","周","天"].forEach(b=>a.addOption(b,b)),a.setValue(f.initialView||"月"),a.onChange(b=>{f.initialView=b})});const x=new Date,C=`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`,S=f.initialDate||C;f.initialDate||(f.initialDate=S),new Y.Setting(m).setName("初始日期").addText(a=>{a.inputEl.type="date",a.setValue(S).onChange(g=>{f.initialDate=g})}),e.createEl("h3",{text:"模块列表"}),f.modules.forEach((a,g)=>{const b=e.createEl("fieldset");b.style.border="1px solid #ccc",b.style.padding="8px",b.style.marginBottom="8px",b.dataset.index=g.toString(),b.createEl("legend",{text:`${a.title||"模块"} (${a.view})`}),new Y.Setting(b).setName("模块标题").addText(E=>{E.setValue(a.title).onChange(N=>a.title=N)}),new Y.Setting(b).setName("视图类型").addDropdown(E=>{Ue.forEach(N=>E.addOption(N,N)),E.setValue(a.view),E.onChange(N=>{a.view=N,this.display()})}),new Y.Setting(b).addToggle(E=>{E.setValue(!!a.collapsed).onChange(N=>{a.collapsed=N})}).setName("默认折叠"),a.view==="TableView"&&(new Y.Setting(b).setName("行字段 (rowField)").addText(E=>{E.setValue(a.props?.rowField||"").onChange(N=>{a.props||(a.props={}),a.props.rowField=N.trim()}),E.inputEl.setAttr("list","think-fields-list")}),new Y.Setting(b).setName("列字段 (colField)").addText(E=>{E.setValue(a.props?.colField||"").onChange(N=>{a.props||(a.props={}),a.props.colField=N.trim()}),E.inputEl.setAttr("list","think-fields-list")})),(a.view==="BlockView"||a.view==="TimelineView")&&new Y.Setting(b).setName("分组字段").addText(E=>{E.setValue(a.group||"").onChange(N=>{a.group=N.trim()||void 0}),E.inputEl.setAttr("list","think-fields-list")}),a.view!=="TableView"&&a.view!=="ChartView"&&a.view!=="CalendarView"&&new Y.Setting(b).setName("显示字段 (用逗号分隔)").addText(E=>{const N=a.fields?a.fields.join(","):"";E.setPlaceholder("如 title,tags,date").setValue(N).onChange(B=>{const O=B.split(/[,，]/).map(U=>U.trim()).filter(U=>U);a.fields=O.length>0?O:void 0}),E.inputEl.setAttr("list","think-fields-list")});const T=b.createDiv();T.style.borderTop="1px dashed #ccc",T.style.marginTop="6px",T.style.paddingTop="6px",T.createEl("strong",{text:"过滤规则"}),(a.filters||[]).forEach((E,N)=>{const B=T.createDiv({cls:"filter-row"});B.style.display="flex",B.style.marginBottom="4px";const O=B.createEl("input");O.type="text",O.style.flex="0 0 30%",O.value=E.field,O.setAttr("list","think-fields-list");const U=B.createEl("select");["=","!=","includes","regex",">","<"].forEach(j=>{U.add(new Option(j,j,!1,j===E.op))}),U.onchange=()=>{E.op=U.value};const H=B.createEl("input");H.type="text",H.style.flex="0 0 30%",H.value=String(E.value);const ee=()=>{H.removeAttribute("list");const j=O.value.trim();j==="tags"?H.setAttr("list","think-tags-list"):j==="category"?H.setAttr("list","think-category-list"):j==="status"?H.setAttr("list","think-status-list"):j==="recurrence"?H.setAttr("list","think-recurrence-list"):j==="type"&&H.setAttr("list","think-type-list")};ee(),O.onchange=()=>{E.field=O.value.trim(),ee()},H.onchange=()=>{E.value=H.value};const he=B.createEl("button",{text:"删除"});he.onclick=()=>{a.filters.splice(N,1),this.display()}});const I=T.createEl("button",{text:"+ 添加过滤条件"});I.onclick=()=>{a.filters||(a.filters=[]),a.filters.push({field:"",op:"=",value:""}),this.display()};const P=b.createDiv();P.style.borderTop="1px dashed #ccc",P.style.marginTop="6px",P.style.paddingTop="6px",P.createEl("strong",{text:"排序规则"}),(a.sort||[]).forEach((E,N)=>{const B=P.createDiv({cls:"sort-row"});B.style.display="flex",B.style.marginBottom="4px";const O=B.createEl("input");O.type="text",O.style.flex="0 0 40%",O.value=E.field,O.setAttr("list","think-fields-list"),O.onchange=()=>E.field=O.value.trim();const U=B.createEl("select");[["asc","升序"],["desc","降序"]].forEach(([ee,he])=>{U.add(new Option(he,ee,!1,ee===E.dir))}),U.onchange=()=>{E.dir=U.value};const H=B.createEl("button",{text:"删除"});H.style.marginLeft="4px",H.onclick=()=>{a.sort.splice(N,1),this.display()}});const W=P.createEl("button",{text:"+ 添加排序条件"});W.onclick=()=>{a.sort||(a.sort=[]),a.sort.push({field:"",dir:"asc"}),this.display()};const R=b.createDiv({cls:"module-actions"});if(R.style.textAlign="right",g>0){const E=R.createEl("button",{text:"↑ 上移"});E.onclick=()=>{const N=f.modules;[N[g-1],N[g]]=[N[g],N[g-1]],this.display()}}if(g<f.modules.length-1){const E=R.createEl("button",{text:"↓ 下移"});E.onclick=()=>{const N=f.modules;[N[g+1],N[g]]=[N[g],N[g+1]],this.display()}}const ct=R.createEl("button",{text:"删除模块"});ct.onclick=()=>{f.modules.splice(g,1),this.display()}});const $=e.createDiv(),M=$.createEl("select");Ue.forEach(a=>{M.add(new Option(a,a))});const A=$.createEl("button",{text:"添加模块"});A.style.marginLeft="6px",A.onclick=()=>{const g={view:M.value,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};f.modules.push(g),this.display()},e.createEl("hr");const D=e.createEl("button",{text:"保存配置"});D.onclick=()=>{if(f.name!==this.selectedDashName&&this.plugin.dashboards.some(a=>a!==f&&a.name===f.name)){new Y.Notice("配置名称已存在，请更换名称");return}this.plugin.saveData({dashboards:this.plugin.dashboards}).then(()=>{new Y.Notice("仪表盘配置已保存"),this.plugin.refreshAllDashboards(),this.selectedDashName=f.name,this.display()})}}}function ge({module:t,children:e}){const[n,i]=z(!!t.collapsed),s=Ot(null),r=()=>i(d=>!d),o=d=>{if(d.metaKey||d.ctrlKey){const u=!n,h=new CustomEvent("think-toggle-all",{detail:u});document.querySelectorAll(".think-module").forEach(c=>c.dispatchEvent(h))}else r()};return be(()=>{const d=h=>{const c=h.detail;i(c)},u=s.current;if(u)return u.addEventListener("think-toggle-all",d),()=>u.removeEventListener("think-toggle-all",d)},[]),p("div",{class:"think-module",ref:s,children:[p("div",{class:"module-header",onClick:o,title:"点击折叠/展开；Ctrl/⌘ + 点击：全部折叠/展开",children:[p("span",{class:"module-title",children:t.title}),p("span",{class:"module-toggle",children:n?"▶":"▼"})]}),!n&&p("div",{class:"module-content",children:e})]})}const qt=["一","二","三","四"];function qe({config:t,dataStore:e,plugin:n}){const i=window.moment,s=t.initialView||"月",r=t.initialDate?i(t.initialDate,"YYYY-MM-DD"):i(),[o,d]=z(s),[u,h]=z(r),[c,l]=z(!1),[_,y]=z(null),[w,k]=z("TableView"),[v,f]=z(0),[m,x]=z("");be(()=>{const a=()=>f(g=>g+1);return e.subscribe(a),()=>e.unsubscribe(a)},[e]),be(()=>{c?(y((g=>typeof structuredClone=="function"?structuredClone(g):JSON.parse(JSON.stringify(g)))(t)),k("TableView")):y(null)},[c,t]);const C=(a,g)=>{let b=a.clone(),T=a.clone();switch(g){case"年":b=a.clone().startOf("year"),T=a.clone().endOf("year");break;case"季":b=a.clone().startOf("quarter"),T=a.clone().endOf("quarter");break;case"月":b=a.clone().startOf("month"),T=a.clone().endOf("month");break;case"周":b=a.clone().startOf("week"),T=a.clone().endOf("week");break;case"天":b=a.clone().startOf("day"),T=a.clone().endOf("day");break}return{startDate:b,endDate:T}},S=(a,g)=>{switch(g){case"年":return a.format("YYYY年");case"季":{const b=a.quarter();return`${a.year()}年${qt[b-1]}季度`}case"月":return a.format("YYYY-MM");case"周":return a.format("YYYY-[W]WW");case"天":return a.format("YYYY-MM-DD");default:return a.format("YYYY-MM-DD")}},$=()=>{switch(o){case"年":h(u.clone().subtract(1,"year"));break;case"季":h(u.clone().subtract(1,"quarter"));break;case"月":h(u.clone().subtract(1,"month"));break;case"周":h(u.clone().subtract(1,"week"));break;case"天":h(u.clone().subtract(1,"day"));break}},M=()=>{switch(o){case"年":h(u.clone().add(1,"year"));break;case"季":h(u.clone().add(1,"quarter"));break;case"月":h(u.clone().add(1,"month"));break;case"周":h(u.clone().add(1,"week"));break;case"天":h(u.clone().add(1,"day"));break}},A=()=>h(i()),D=a=>{if(a.view==="SettingsFormView"){const I=We[a.view];return p(ge,{module:a,children:p(I,{plugin:n,storageKey:"inputSettings"})})}let g=e.queryItems(a.filters||[],a.sort||[]);if(t.tags?.length&&(g=g.filter(I=>I.tags.some(P=>t.tags.some(W=>P.includes(W))))),t.path&&t.path.trim()!==""){const I=t.path.trim(),P=Q.instance.app.vault.getAbstractFileByPath(I);if(P){if(P instanceof Y.TFolder){const W=I.endsWith("/")?I:I+"/";g=g.filter(R=>R.id.startsWith(W))}else if(P instanceof Y.TFile){const W=I+"#";g=g.filter(R=>R.id.startsWith(W))}}else{const W=I.endsWith("/")?I:I+"/";g=g.filter(R=>R.id.startsWith(W))}}if(o&&u){const{startDate:I,endDate:P}=C(u,o);g=g.filter(W=>{if(!W.date)return!1;const R=i(W.date,"YYYY-MM-DD");return R.isSameOrAfter(I)&&R.isSameOrBefore(P)})}if(m.trim()){const I=m.toLowerCase();g=g.filter(P=>(P.title+" "+P.content).toLowerCase().includes(I))}const b=We[a.view];if(!b)return p(ge,{module:a,children:p("div",{children:["未知视图: ",a.view]})});const T={...a.props||{}};return a.group&&(T.groupField=a.group),a.fields&&(T.fields=a.fields),p(ge,{module:a,children:p(b,{items:g,...T})})};return p("div",{children:[p("div",{class:"tp-toolbar",style:"margin-bottom:8px;",children:[["年","季","月","周","天"].map(a=>p("button",{onClick:()=>d(a),class:a===o?"active":"",children:a})),p("button",{disabled:!0,style:"font-weight:bold;margin:0 4px;background:#fff;cursor:default;",children:S(u,o)}),p("button",{onClick:$,children:"←"}),p("button",{onClick:M,children:"→"}),p("button",{onClick:A,children:"＝"}),p("input",{placeholder:"快速过滤…",style:"margin-left:4px;",value:m,onInput:a=>x(a.target.value)}),p("button",{onClick:()=>l(!c),style:"margin-left:4px;",children:"⚙︎"})]}),c&&_&&p("div",{style:"border:1px solid #eee;padding:12px;margin-bottom:12px;border-radius:8px;background:#fcfcfc;"}),!c&&t.modules.map(a=>D(a))]})}class jt extends Y.Plugin{constructor(){super(...arguments),this.dashboards=[],this.activeDashboards=[],this.inputSettings={}}async onload(){console.log("ThinkPlugin 加载 - 重构版");const e=await this.loadData();e?.dashboards&&(this.dashboards=e.dashboards),this.dashboards.length===0&&this._createDefaultDashboard(),this.inputSettings=e?.inputSettings??{};for(const s of this.dashboards)for(const r of s.modules)r.view==="ListView"&&(r.view="BlockView");this.dataStore=new Q(this.app),await this.dataStore.scanAll();const n=this.app.vault.on.bind(this.app.vault),i=s=>this.dataStore.scanFile(s).then(()=>this.dataStore.notifyChange());this.registerEvent(n("modify",s=>{s instanceof Y.TFile&&s.extension==="md"&&i(s)})),this.registerEvent(n("create",s=>{s instanceof Y.TFile&&s.extension==="md"&&i(s)})),this.registerEvent(n("delete",s=>{s instanceof Y.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(s.path),this.dataStore.notifyChange())})),this.registerEvent(n("rename",(s,r)=>{s instanceof Y.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(r),i(s))})),this.registerMarkdownCodeBlockProcessor(kt,(s,r)=>{let o;try{const u=s.trim()?JSON.parse(s):{};o=u.config||u.dashboard||u.name}catch(u){console.warn("ThinkPlugin: 仪表盘代码块 JSON 解析失败，使用默认",u)}!o&&this.dashboards.length&&(o=this.dashboards[0].name);const d=this.dashboards.find(u=>u.name===o);if(!d){r.createDiv({text:`找不到名称为 "${o}" 的仪表盘配置`});return}Ae(ve(qe,{config:d,dataStore:this.dataStore,plugin:this}),r),this.activeDashboards.push({container:r,configName:d.name})}),this._injectStyles(),this.addSettingTab(new Ut(this.app,this))}onunload(){const e=document.getElementById(_e);e&&e.remove(),console.log("ThinkPlugin 卸载")}refreshAllDashboards(){this.activeDashboards=this.activeDashboards.filter(e=>document.body.contains(e.container));for(const e of this.activeDashboards){const n=this.dashboards.find(i=>i.name===e.configName);n&&Ae(ve(qe,{config:n,dataStore:this.dataStore,plugin:this}),e.container)}}async persistAll(){const e={dashboards:this.dashboards,inputSettings:this.inputSettings};await this.saveData(e)}_createDefaultDashboard(){const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i={name:"默认仪表盘",path:"",tags:[],initialView:"月",initialDate:n,modules:[{view:"BlockView",title:"未完成任务",collapsed:!1,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"open"}],sort:[],props:{}},{view:"BlockView",title:"已完成任务",collapsed:!0,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"done"}],sort:[{field:"date",dir:"desc"}],props:{}}]};this.dashboards.push(i)}_injectStyles(){if(document.getElementById(_e))return;const e=document.createElement("style");e.id=_e,e.textContent=xt,document.head.appendChild(e)}}module.exports=jt;
//# sourceMappingURL=main.js.map
