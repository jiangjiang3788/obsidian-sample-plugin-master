"use strict";const Z=require("obsidian");class De{constructor(t){this.app=t}async readFile(t){return this.app.vault.read(t)}getMarkdownFiles(){return this.app.vault.getMarkdownFiles()}async writeFile(t,n){return this.app.vault.modify(t,n)}getByPath(t){return this.app.vault.getAbstractFileByPath(t)??null}async ensureFile(t,n=""){const r=this.getByPath(t);return r instanceof TFile?r:this.app.vault.create(t,n)}onVault(t,n){return this.app.vault.on(t,n)}}function It(e,t){return t.startsWith("extra.")?e.extra?.[t.slice(6)]:e[t]}const Te="\\d{4}[-/]\\d{2}[-/]\\d{2}",wt=new RegExp(Te),Oe=/#([\p{L}\p{N}_\/-]+)/gu,Ce=/\(([^:：]+)::\s*([^)]+)\)/g,Zt=/^\s*-\s*\[[ xX-]\]/,Ye=/^\s*-\s*\[x\]/i,Ee=/^\s*-\s*\[-\]/;function xt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var dt={exports:{}},Fe=dt.exports,Qt;function Ie(){return Qt||(Qt=1,function(e,t){(function(n,r){e.exports=r()})(Fe,function(){var n=1e3,r=6e4,s=36e5,i="millisecond",a="second",l="minute",u="hour",c="day",f="week",o="month",y="quarter",p="year",M="date",Y="Invalid Date",h=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,_=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,v={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(d){var k=["th","st","nd","rd"],m=d%100;return"["+d+(k[(m-20)%10]||k[m]||k[0])+"]"}},b=function(d,k,m){var $=String(d);return!$||$.length>=k?d:""+Array(k+1-$.length).join(m)+d},L={s:b,z:function(d){var k=-d.utcOffset(),m=Math.abs(k),$=Math.floor(m/60),w=m%60;return(k<=0?"+":"-")+b($,2,"0")+":"+b(w,2,"0")},m:function d(k,m){if(k.date()<m.date())return-d(m,k);var $=12*(m.year()-k.year())+(m.month()-k.month()),w=k.clone().add($,o),D=m-w<0,T=k.clone().add($+(D?-1:1),o);return+(-($+(m-w)/(D?w-T:T-w))||0)},a:function(d){return d<0?Math.ceil(d)||0:Math.floor(d)},p:function(d){return{M:o,y:p,w:f,d:c,D:M,h:u,m:l,s:a,ms:i,Q:y}[d]||String(d||"").toLowerCase().replace(/s$/,"")},u:function(d){return d===void 0}},N="en",C={};C[N]=v;var g="$isDayjsObject",I=function(d){return d instanceof P||!(!d||!d[g])},O=function d(k,m,$){var w;if(!k)return N;if(typeof k=="string"){var D=k.toLowerCase();C[D]&&(w=D),m&&(C[D]=m,w=D);var T=k.split("-");if(!w&&T.length>1)return d(T[0])}else{var E=k.name;C[E]=k,w=E}return!$&&w&&(N=w),w||!$&&N},F=function(d,k){if(I(d))return d.clone();var m=typeof k=="object"?k:{};return m.date=d,m.args=arguments,new P(m)},x=L;x.l=O,x.i=I,x.w=function(d,k){return F(d,{locale:k.$L,utc:k.$u,x:k.$x,$offset:k.$offset})};var P=function(){function d(m){this.$L=O(m.locale,null,!0),this.parse(m),this.$x=this.$x||m.x||{},this[g]=!0}var k=d.prototype;return k.parse=function(m){this.$d=function($){var w=$.date,D=$.utc;if(w===null)return new Date(NaN);if(x.u(w))return new Date;if(w instanceof Date)return new Date(w);if(typeof w=="string"&&!/Z$/i.test(w)){var T=w.match(h);if(T){var E=T[2]-1||0,H=(T[7]||"0").substring(0,3);return D?new Date(Date.UTC(T[1],E,T[3]||1,T[4]||0,T[5]||0,T[6]||0,H)):new Date(T[1],E,T[3]||1,T[4]||0,T[5]||0,T[6]||0,H)}}return new Date(w)}(m),this.init()},k.init=function(){var m=this.$d;this.$y=m.getFullYear(),this.$M=m.getMonth(),this.$D=m.getDate(),this.$W=m.getDay(),this.$H=m.getHours(),this.$m=m.getMinutes(),this.$s=m.getSeconds(),this.$ms=m.getMilliseconds()},k.$utils=function(){return x},k.isValid=function(){return this.$d.toString()!==Y},k.isSame=function(m,$){var w=F(m);return this.startOf($)<=w&&w<=this.endOf($)},k.isAfter=function(m,$){return F(m)<this.startOf($)},k.isBefore=function(m,$){return this.endOf($)<F(m)},k.$g=function(m,$,w){return x.u(m)?this[$]:this.set(w,m)},k.unix=function(){return Math.floor(this.valueOf()/1e3)},k.valueOf=function(){return this.$d.getTime()},k.startOf=function(m,$){var w=this,D=!!x.u($)||$,T=x.p(m),E=function(K,V){var J=x.w(w.$u?Date.UTC(w.$y,V,K):new Date(w.$y,V,K),w);return D?J:J.endOf(c)},H=function(K,V){return x.w(w.toDate()[K].apply(w.toDate("s"),(D?[0,0,0,0]:[23,59,59,999]).slice(V)),w)},B=this.$W,j=this.$M,X=this.$D,st="set"+(this.$u?"UTC":"");switch(T){case p:return D?E(1,0):E(31,11);case o:return D?E(1,j):E(0,j+1);case f:var tt=this.$locale().weekStart||0,at=(B<tt?B+7:B)-tt;return E(D?X-at:X+(6-at),j);case c:case M:return H(st+"Hours",0);case u:return H(st+"Minutes",1);case l:return H(st+"Seconds",2);case a:return H(st+"Milliseconds",3);default:return this.clone()}},k.endOf=function(m){return this.startOf(m,!1)},k.$set=function(m,$){var w,D=x.p(m),T="set"+(this.$u?"UTC":""),E=(w={},w[c]=T+"Date",w[M]=T+"Date",w[o]=T+"Month",w[p]=T+"FullYear",w[u]=T+"Hours",w[l]=T+"Minutes",w[a]=T+"Seconds",w[i]=T+"Milliseconds",w)[D],H=D===c?this.$D+($-this.$W):$;if(D===o||D===p){var B=this.clone().set(M,1);B.$d[E](H),B.init(),this.$d=B.set(M,Math.min(this.$D,B.daysInMonth())).$d}else E&&this.$d[E](H);return this.init(),this},k.set=function(m,$){return this.clone().$set(m,$)},k.get=function(m){return this[x.p(m)]()},k.add=function(m,$){var w,D=this;m=Number(m);var T=x.p($),E=function(j){var X=F(D);return x.w(X.date(X.date()+Math.round(j*m)),D)};if(T===o)return this.set(o,this.$M+m);if(T===p)return this.set(p,this.$y+m);if(T===c)return E(1);if(T===f)return E(7);var H=(w={},w[l]=r,w[u]=s,w[a]=n,w)[T]||1,B=this.$d.getTime()+m*H;return x.w(B,this)},k.subtract=function(m,$){return this.add(-1*m,$)},k.format=function(m){var $=this,w=this.$locale();if(!this.isValid())return w.invalidDate||Y;var D=m||"YYYY-MM-DDTHH:mm:ssZ",T=x.z(this),E=this.$H,H=this.$m,B=this.$M,j=w.weekdays,X=w.months,st=w.meridiem,tt=function(V,J,et,it){return V&&(V[J]||V($,D))||et[J].slice(0,it)},at=function(V){return x.s(E%12||12,V,"0")},K=st||function(V,J,et){var it=V<12?"AM":"PM";return et?it.toLowerCase():it};return D.replace(_,function(V,J){return J||function(et){switch(et){case"YY":return String($.$y).slice(-2);case"YYYY":return x.s($.$y,4,"0");case"M":return B+1;case"MM":return x.s(B+1,2,"0");case"MMM":return tt(w.monthsShort,B,X,3);case"MMMM":return tt(X,B);case"D":return $.$D;case"DD":return x.s($.$D,2,"0");case"d":return String($.$W);case"dd":return tt(w.weekdaysMin,$.$W,j,2);case"ddd":return tt(w.weekdaysShort,$.$W,j,3);case"dddd":return j[$.$W];case"H":return String(E);case"HH":return x.s(E,2,"0");case"h":return at(1);case"hh":return at(2);case"a":return K(E,H,!0);case"A":return K(E,H,!1);case"m":return String(H);case"mm":return x.s(H,2,"0");case"s":return String($.$s);case"ss":return x.s($.$s,2,"0");case"SSS":return x.s($.$ms,3,"0");case"Z":return T}return null}(V)||T.replace(":","")})},k.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},k.diff=function(m,$,w){var D,T=this,E=x.p($),H=F(m),B=(H.utcOffset()-this.utcOffset())*r,j=this-H,X=function(){return x.m(T,H)};switch(E){case p:D=X()/12;break;case o:D=X();break;case y:D=X()/3;break;case f:D=(j-B)/6048e5;break;case c:D=(j-B)/864e5;break;case u:D=j/s;break;case l:D=j/r;break;case a:D=j/n;break;default:D=j}return w?D:x.a(D)},k.daysInMonth=function(){return this.endOf(o).$D},k.$locale=function(){return C[this.$L]},k.locale=function(m,$){if(!m)return this.$L;var w=this.clone(),D=O(m,$,!0);return D&&(w.$L=D),w},k.clone=function(){return x.w(this.$d,this)},k.toDate=function(){return new Date(this.valueOf())},k.toJSON=function(){return this.isValid()?this.toISOString():null},k.toISOString=function(){return this.$d.toISOString()},k.toString=function(){return this.$d.toUTCString()},d}(),z=P.prototype;return F.prototype=z,[["$ms",i],["$s",a],["$m",l],["$H",u],["$W",c],["$M",o],["$y",p],["$D",M]].forEach(function(d){z[d[1]]=function(k){return this.$g(k,d[0],d[1])}}),F.extend=function(d,k){return d.$i||(d(k,P,F),d.$i=!0),F},F.locale=O,F.isDayjs=I,F.unix=function(d){return F(1e3*d)},F.en=C[N],F.Ls=C,F.p={},F})}(dt)),dt.exports}var Le=Ie();const rt=xt(Le);var pt={exports:{}},Pe=pt.exports,Xt;function Ne(){return Xt||(Xt=1,function(e,t){(function(n,r){e.exports=r()})(Pe,function(){var n="month",r="quarter";return function(s,i){var a=i.prototype;a.quarter=function(c){return this.$utils().u(c)?Math.ceil((this.month()+1)/3):this.month(this.month()%3+3*(c-1))};var l=a.add;a.add=function(c,f){return c=Number(c),this.$utils().p(f)===r?this.add(3*c,n):l.bind(this)(c,f)};var u=a.startOf;a.startOf=function(c,f){var o=this.$utils(),y=!!o.u(f)||f;if(o.p(c)===r){var p=this.quarter()-1;return y?this.month(3*p).startOf(n).startOf("day"):this.month(3*p+2).endOf(n).endOf("day")}return u.bind(this)(c,f)}}})}(pt)),pt.exports}var Ae=Ne();const He=xt(Ae);var mt={exports:{}},Be=mt.exports,Jt;function qe(){return Jt||(Jt=1,function(e,t){(function(n,r){e.exports=r()})(Be,function(){var n="week",r="year";return function(s,i,a){var l=i.prototype;l.week=function(u){if(u===void 0&&(u=null),u!==null)return this.add(7*(u-this.week()),"day");var c=this.$locale().yearStart||1;if(this.month()===11&&this.date()>25){var f=a(this).startOf(r).add(1,r).date(c),o=a(this).endOf(n);if(f.isBefore(o))return 1}var y=a(this).startOf(r).date(c).startOf(n).subtract(1,"millisecond"),p=this.diff(y,n,!0);return p<0?a(this).startOf("week").week():Math.ceil(p)},l.weeks=function(u){return u===void 0&&(u=null),this.week(u)}}})}(mt)),mt.exports}var Re=qe();const We=xt(Re);var gt={exports:{}},je=gt.exports,Kt;function Ue(){return Kt||(Kt=1,function(e,t){(function(n,r){e.exports=r()})(je,function(){var n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},r=/(\[[^[]*\])|([-_:/.,()\s]+)|(A|a|Q|YYYY|YY?|ww?|MM?M?M?|Do|DD?|hh?|HH?|mm?|ss?|S{1,3}|z|ZZ?)/g,s=/\d/,i=/\d\d/,a=/\d\d?/,l=/\d*[^-_:/,()\s\d]+/,u={},c=function(h){return(h=+h)+(h>68?1900:2e3)},f=function(h){return function(_){this[h]=+_}},o=[/[+-]\d\d:?(\d\d)?|Z/,function(h){(this.zone||(this.zone={})).offset=function(_){if(!_||_==="Z")return 0;var v=_.match(/([+-]|\d\d)/g),b=60*v[1]+(+v[2]||0);return b===0?0:v[0]==="+"?-b:b}(h)}],y=function(h){var _=u[h];return _&&(_.indexOf?_:_.s.concat(_.f))},p=function(h,_){var v,b=u.meridiem;if(b){for(var L=1;L<=24;L+=1)if(h.indexOf(b(L,0,_))>-1){v=L>12;break}}else v=h===(_?"pm":"PM");return v},M={A:[l,function(h){this.afternoon=p(h,!1)}],a:[l,function(h){this.afternoon=p(h,!0)}],Q:[s,function(h){this.month=3*(h-1)+1}],S:[s,function(h){this.milliseconds=100*+h}],SS:[i,function(h){this.milliseconds=10*+h}],SSS:[/\d{3}/,function(h){this.milliseconds=+h}],s:[a,f("seconds")],ss:[a,f("seconds")],m:[a,f("minutes")],mm:[a,f("minutes")],H:[a,f("hours")],h:[a,f("hours")],HH:[a,f("hours")],hh:[a,f("hours")],D:[a,f("day")],DD:[i,f("day")],Do:[l,function(h){var _=u.ordinal,v=h.match(/\d+/);if(this.day=v[0],_)for(var b=1;b<=31;b+=1)_(b).replace(/\[|\]/g,"")===h&&(this.day=b)}],w:[a,f("week")],ww:[i,f("week")],M:[a,f("month")],MM:[i,f("month")],MMM:[l,function(h){var _=y("months"),v=(y("monthsShort")||_.map(function(b){return b.slice(0,3)})).indexOf(h)+1;if(v<1)throw new Error;this.month=v%12||v}],MMMM:[l,function(h){var _=y("months").indexOf(h)+1;if(_<1)throw new Error;this.month=_%12||_}],Y:[/[+-]?\d+/,f("year")],YY:[i,function(h){this.year=c(h)}],YYYY:[/\d{4}/,f("year")],Z:o,ZZ:o};function Y(h){var _,v;_=h,v=u&&u.formats;for(var b=(h=_.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(F,x,P){var z=P&&P.toUpperCase();return x||v[P]||n[P]||v[z].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(d,k,m){return k||m.slice(1)})})).match(r),L=b.length,N=0;N<L;N+=1){var C=b[N],g=M[C],I=g&&g[0],O=g&&g[1];b[N]=O?{regex:I,parser:O}:C.replace(/^\[|\]$/g,"")}return function(F){for(var x={},P=0,z=0;P<L;P+=1){var d=b[P];if(typeof d=="string")z+=d.length;else{var k=d.regex,m=d.parser,$=F.slice(z),w=k.exec($)[0];m.call(x,w),F=F.replace(w,"")}}return function(D){var T=D.afternoon;if(T!==void 0){var E=D.hours;T?E<12&&(D.hours+=12):E===12&&(D.hours=0),delete D.afternoon}}(x),x}}return function(h,_,v){v.p.customParseFormat=!0,h&&h.parseTwoDigitYear&&(c=h.parseTwoDigitYear);var b=_.prototype,L=b.parse;b.parse=function(N){var C=N.date,g=N.utc,I=N.args;this.$u=g;var O=I[1];if(typeof O=="string"){var F=I[2]===!0,x=I[3]===!0,P=F||x,z=I[2];x&&(z=I[2]),u=this.$locale(),!F&&z&&(u=v.Ls[z]),this.$d=function($,w,D,T){try{if(["x","X"].indexOf(w)>-1)return new Date((w==="X"?1e3:1)*$);var E=Y(w)($),H=E.year,B=E.month,j=E.day,X=E.hours,st=E.minutes,tt=E.seconds,at=E.milliseconds,K=E.zone,V=E.week,J=new Date,et=j||(H||B?1:J.getDate()),it=H||J.getFullYear(),ht=0;H&&!B||(ht=B>0?B-1:J.getMonth());var ft,Ct=X||0,Yt=st||0,Et=tt||0,Ft=at||0;return K?new Date(Date.UTC(it,ht,et,Ct,Yt,Et,Ft+60*K.offset*1e3)):D?new Date(Date.UTC(it,ht,et,Ct,Yt,Et,Ft)):(ft=new Date(it,ht,et,Ct,Yt,Et,Ft),V&&(ft=T(ft).week(V).toDate()),ft)}catch{return new Date("")}}(C,O,g,v),this.init(),z&&z!==!0&&(this.$L=this.locale(z).$L),P&&C!=this.format(O)&&(this.$d=new Date("")),u={}}else if(O instanceof Array)for(var d=O.length,k=1;k<=d;k+=1){I[1]=O[k-1];var m=v.apply(this,I);if(m.isValid()){this.$d=m.$d,this.$L=m.$L,this.init();break}k===d&&(this.$d=new Date(""))}else L.call(this,N)}}})}(gt)),gt.exports}var Ve=Ue();const ze=xt(Ve);rt.extend(He);rt.extend(We);rt.extend(ze);const qt=()=>rt().format("YYYY-MM-DD"),Ze=()=>rt().format("HH:mm");function St(e){const t=(e||"").replace(/\//g,"-"),n=rt(t,["YYYY-MM-DD","YYYY-M-D","YYYY/MM/DD","YYYY/M/D"],!0);return n.isValid()?n.format("YYYY-MM-DD"):t}const Qe="(\\d{4}[-/]\\d{2}[-/]\\d{2})";function Xe(e,t){const n=Array.isArray(t)?t:[t];for(const r of n){const s=e.match(new RegExp(`${r}\\s*${Qe}`));if(s)return St(s[1])}}const U={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕",repeat:"🔁"};function Je(e){let t=e.replace(/^\s*-\s*\[[ xX-]\]\s*/,"").trim();t=t.replace(/#[\p{L}\p{N}_-]+/gu,"");let n=t.split(/[\s(]/).find(r=>r&&r.trim());return n=n?.replace(new RegExp("^\\p{Extended_Pictographic}\\uFE0F?","u"),"").trim(),n?n.trim():""}function ct(e,t){return Xe(e,t)}function Ke(e){if(e.includes("🔺"))return"highest";if(e.includes("⏫"))return"high";if(e.includes("🔼"))return"medium";if(e.includes("🔽"))return"low";if(e.includes("⏬"))return"lowest"}function Ge(e,t,n,r){const s=t;if(!Zt.test(s))return null;let i="open";Ye.test(s)?i="done":Ee.test(s)&&(i="cancelled");const l=(s.match(Oe)||[]).map(I=>I.replace("#",""));let u="none";const c=s.match(/🔁\s*([^\n📅⏳🛫➕✅❌]*)/);c&&c[1]&&(u=c[1].trim());const f={};let o;for(;(o=Ce.exec(s))!==null;){const I=o[1].trim(),O=o[2].trim(),F=I.toLowerCase();if(["主题","标签","tag","tags"].includes(F))O.split(/[,，]/).forEach(x=>{const P=x.trim().replace(/^#/,"");P&&l.push(P)});else{const x=Number(O);let P=O;O!==""&&!isNaN(x)?P=x:/^(true|false)$/i.test(O)&&(P=O.toLowerCase()==="true"),f[I]=P}}const y=ct(s,U.done),p=ct(s,U.cancelled),M=ct(s,U.due),Y=ct(s,U.scheduled),h=ct(s,U.start),_=ct(s,U.created),v=Ke(s);let b;const L=s.replace(Zt,"").trim(),N=L.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let C=L;N&&(b=N[1],C=C.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),C=Je(C);const g={id:`${e}#${n}`,title:C||"",content:s.trim(),type:"task",status:i,category:"任务",tags:Array.from(new Set(l)),recurrence:u,created:0,modified:0,extra:f};return b&&(g.icon=b),v&&(g.priority=v),_&&(g.createdDate=_),Y&&(g.scheduledDate=Y),h&&(g.startDate=h),M&&(g.dueDate=M),y&&(g.doneDate=y),p&&(g.cancelledDate=p),g.startISO=h||Y||M||_,g.endISO=y||p||M,!g.startISO&&g.status==="open"&&(g.startISO=g.date=g.dueDate||g.scheduledDate||g.startDate||g.createdDate),g.endISO||(g.endISO=g.startISO),g.startISO&&(g.startMs=Date.parse(g.startISO)),g.endISO&&(g.endMs=Date.parse(g.endISO)),i==="done"?g.date=y:i==="cancelled"&&(g.date=p),g}function tn(e,t,n,r,s){const i=t.slice(n+1,r);let a="",l=null,u,c;const f=[],o={};let y=null,p="",M=!1,Y=null;for(let _=0;_<i.length;_++){const v=i[_],b=v.trim();if(M)p+=(p?`
`:"")+v;else{if(b==="")continue;const L=b.match(/^([^:：]{1,20})::\s*(.*)$/);if(L){const N=L[1].trim(),C=L[2]||"",g=N.toLowerCase();if(["分类","类别","category"].includes(g))l=C.trim();else if(["主题","标签","tag","tags"].includes(g))y=C.trim();else if(["状态","status"].includes(g))u=C.trim();else if(["日期","date"].includes(g))c=St(C.trim());else if(["内容","content"].includes(g))M=!0,p=C;else if(["图标","icon"].includes(g))Y=C.trim(),o.图标=Y;else{const I=Number(C.trim());let O=C.trim();O!==""&&!isNaN(I)?O=I:/^(true|false)$/i.test(O)&&(O=O.toLowerCase()==="true"),o[N]=O}}else M=!0,p=v}}y&&y.split(/[,，]/).map(_=>_.trim()).filter(Boolean).forEach(_=>f.push(_.replace(/^#/,""))),p.trim()!==""?a=p.trim().split(/\r?\n/)[0]:y&&(a=y.split(/[,，]/).map(_=>_.trim()).filter(Boolean).join(", ")),a=a.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),a&&(a=a.slice(0,10)),l||(l=s||"");const h={id:`${e}#${n+1}`,title:a||"",content:p.trim(),type:"block",status:u,category:l,tags:Array.from(new Set(f)),recurrence:"none",created:0,modified:0,extra:o};return Y&&(h.icon=Y),h.startISO=c,h.endISO=c,h.startISO&&(h.startMs=Date.parse(h.startISO)),h.endISO&&(h.endMs=h.startMs),h.date=c,h}function en(e,t=250){let n=0,r=null;return function(...s){const i=Date.now();i-n>=t?(n=i,e.apply(this,s)):(clearTimeout(r),r=setTimeout(()=>{n=Date.now(),e.apply(this,s)},t-(i-n)))}}function nn(e,t,n){let r=e;return r=r.replace(/(\s|^)(时长::[^\s()]+)/g,(s,i)=>s.includes("(")?s:`${i}(${s.trim()})`),/\(时长::[^\)]+\)/.test(r)?r=r.replace(/\((时长::[^\)]+)\)/,`(时间::${n}) ($1)`):/时长::[^\s]+/.test(r)?r=r.replace(/(时长::[^\s]+)/,`(时间::${n}) ($1)`):r.includes(U.repeat)?r=r.replace(U.repeat,`(时间::${n}) ${U.repeat}`):r=`${r} (时间::${n})`,r=r.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(r)||(r=`- [x] ${r.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")}`),r=r.replace(new RegExp(`\\s*${U.done}\\s*${wt.source}$`),""),`${r.trim()} ${U.done} ${t}`}function he(e){const t=e.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/i);if(!t)return null;const n=t[1]?parseInt(t[1],10):1,r=t[2].toLowerCase(),s=!!t[3];return{interval:n,unit:r,whenDone:s}}function rn(e,t,n){if(t)return n;const r=s=>{const i=new RegExp(`${s}\\s*(${wt.source})`),a=e.match(i);return a?St(a[1]):null};return r(U.due)||r(U.scheduled)||r(U.start)||n}function sn(e,t){let n=e.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]").replace(new RegExp(`\\s*${U.done}\\s*${wt.source}`),"").replace(/\(时间::\d{2}:\d{2}\)/,"");const r=he(e);if(!r)return n.trim();const a=rt(t,["YYYY-MM-DD","YYYY/MM/DD"]).add(r.interval,r.unit).format("YYYY-MM-DD"),l=u=>{const c=new RegExp(`${u}\\s*${wt.source}`);c.test(n)&&(n=n.replace(c,`${u} ${a}`))};return l(U.due),l(U.scheduled),l(U.start),n.trim()}function an(e,t,n){const r=nn(e,t,n),s=he(e);if(!s)return{completedLine:r};const i=rn(e,s.whenDone,t),a=sn(e,i);return{completedLine:r,nextTaskLine:a}}class on{static async completeTask(t){const n=Mt.instance;if(!n)throw new Error("DataStore not ready");const[r,s]=t.split("#"),i=Number(s),a=n.platform.app.vault.getAbstractFileByPath(r);if(!(a instanceof n.platform.app.vault.constructor.TFile))return;const u=(await n.platform.readFile(a)).split(/\r?\n/);if(i<1||i>u.length)return;const c=u[i-1];if(!/^\s*-\s*\[ \]/.test(c))return;const f=rt().format("YYYY-MM-DD"),o=rt().format("HH:mm"),{completedLine:y,nextTaskLine:p}=an(c,f,o);u[i-1]=y,p&&u.splice(i,0,p),await n.platform.writeFile(a,u.join(`
`)),await n.scanFile(a),n.notifyChange()}}class Mt{static instance;platform;get app(){return this.platform.app}constructor(t){this.platform=t,Mt.instance=this}items=[];fileIndex=new Map;changeListeners=new Set;async scanAll(){this.items=[],this.fileIndex.clear();const t=this.platform.getMarkdownFiles();for(const n of t)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(t){try{const r=(await this.platform.readFile(t)).split(/\r?\n/),s=t.path,i=t.parent?.name||"",a=[],u=this.app.metadataCache.getFileCache(t)?.headings||[];let c=0,f=[],o="";for(let y=0;y<r.length;y++){const p=r[y];if(c<u.length&&u[c].position.start.line===y){const h=u[c].heading,_=h.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];f=_.map(b=>b.replace("#","")).filter(Boolean);let v=h;for(const b of _)v=v.replace(b,"").trim();o=v||"",c++;continue}if(p.trim()==="<!-- start -->"){const Y=r.indexOf("<!-- end -->",y+1);if(Y!==-1){const h=tn(s,r,y,Y,i);if(h){h.created=t.stat.ctime,h.modified=t.stat.mtime,o&&(h.header=o),h.tags=Array.from(new Set([...f,...h.tags]));const _=t.name.toLowerCase().endsWith(".md")?t.name.slice(0,-3):t.name;h.filename=_,a.push(h)}y=Y;continue}}const M=Ge(s,p,y+1,i);if(M){M.tags=Array.from(new Set([...f,...M.tags])),M.created=t.stat.ctime,M.modified=t.stat.mtime,o&&(M.header=o);const Y=t.name.toLowerCase().endsWith(".md")?t.name.slice(0,-3):t.name;M.filename=Y,a.push(M)}}return this.fileIndex.has(s)&&(this.items=this.items.filter(y=>y.id&&!y.id.startsWith(s+"#"))),this.fileIndex.set(s,a),this.items.push(...a),a}catch(n){return console.error("ThinkPlugin: 扫描文件失败",t.path,n),[]}}removeFileItems(t){this.fileIndex.has(t)&&(this.fileIndex.delete(t),this.items=this.items.filter(n=>!n.id.startsWith(t+"#")))}removeFile(t){this.removeFileItems(t)}queryItems(t=[],n=[]){let r=this.items.filter(s=>(t||[]).every(i=>this._matchItem(s,i)));return n.length>0&&r.sort((s,i)=>{for(const a of n){const l=It(s,a.field),u=It(i,a.field);if(!(l==null&&u==null)){if(l==null)return a.dir==="asc"?1:-1;if(u==null)return a.dir==="asc"?-1:1;if(typeof l=="number"&&typeof u=="number"){if(l!==u)return a.dir==="asc"?l-u:u-l}else{const c=String(l),f=String(u);if(c!==f)return a.dir==="asc"?c.localeCompare(f):f.localeCompare(c)}}}return 0}),r}query(t=[],n=[]){return this.queryItems(t,n)}async markItemDone(t){await on.completeTask(t)}_emitChange(){this.changeListeners.forEach(t=>{try{t()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}_emitThrottled=en(()=>this._emitChange(),250);subscribe(t){this.changeListeners.add(t)}unsubscribe(t){this.changeListeners.delete(t)}notifyChange(){this._emitThrottled()}_matchItem(t,n){const r=It(t,n.field),s=n.value;if(n.op==="="||n.op==="!="){const i=r!=null&&s!=null&&String(r)===String(s);return n.op==="="?i:!i}if(n.op==="includes")return r==null?!1:Array.isArray(r)?r.some(i=>String(i).includes(String(s))):String(r).includes(String(s));if(n.op==="regex"){if(r==null)return!1;try{const i=new RegExp(String(s));return Array.isArray(r)?r.some(a=>i.test(String(a))):i.test(String(r))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",s),!1}}if(n.op===">"||n.op==="<"){if(r==null)return!1;const i=Number(r),a=Number(s);if(!isNaN(i)&&!isNaN(a))return n.op===">"?i>a:i<a;const l=Date.parse(String(r)),u=Date.parse(String(s));if(!isNaN(l)&&!isNaN(u))return n.op===">"?l>u:l<u;const c=String(r),f=String(s);return n.op===">"?c>f:c<f}return!1}}var Dt,A,fe,ot,Gt,_e,de,pe,Rt,Pt,Nt,ut={},me=[],cn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Tt=Array.isArray;function nt(e,t){for(var n in t)e[n]=t[n];return e}function Wt(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function ln(e,t,n){var r,s,i,a={};for(i in t)i=="key"?r=t[i]:i=="ref"?s=t[i]:a[i]=t[i];if(arguments.length>2&&(a.children=arguments.length>3?Dt.call(arguments,2):n),typeof e=="function"&&e.defaultProps!=null)for(i in e.defaultProps)a[i]===void 0&&(a[i]=e.defaultProps[i]);return yt(e,a,r,s,null)}function yt(e,t,n,r,s){var i={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:s??++fe,__i:-1,__u:0};return s==null&&A.vnode!=null&&A.vnode(i),i}function Ot(e){return e.children}function vt(e,t){this.props=e,this.context=t}function lt(e,t){if(t==null)return e.__?lt(e.__,e.__i+1):null;for(var n;t<e.__k.length;t++)if((n=e.__k[t])!=null&&n.__e!=null)return n.__e;return typeof e.type=="function"?lt(e):null}function ge(e){var t,n;if((e=e.__)!=null&&e.__c!=null){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if((n=e.__k[t])!=null&&n.__e!=null){e.__e=e.__c.base=n.__e;break}return ge(e)}}function te(e){(!e.__d&&(e.__d=!0)&&ot.push(e)&&!$t.__r++||Gt!=A.debounceRendering)&&((Gt=A.debounceRendering)||_e)($t)}function $t(){for(var e,t,n,r,s,i,a,l=1;ot.length;)ot.length>l&&ot.sort(de),e=ot.shift(),l=ot.length,e.__d&&(n=void 0,s=(r=(t=e).__v).__e,i=[],a=[],t.__P&&((n=nt({},r)).__v=r.__v+1,A.vnode&&A.vnode(n),jt(t.__P,n,r,t.__n,t.__P.namespaceURI,32&r.__u?[s]:null,i,s??lt(r),!!(32&r.__u),a),n.__v=r.__v,n.__.__k[n.__i]=n,ke(i,n,a),n.__e!=s&&ge(n)));$t.__r=0}function ye(e,t,n,r,s,i,a,l,u,c,f){var o,y,p,M,Y,h,_=r&&r.__k||me,v=t.length;for(u=un(n,t,_,u,v),o=0;o<v;o++)(p=n.__k[o])!=null&&(y=p.__i==-1?ut:_[p.__i]||ut,p.__i=o,h=jt(e,p,y,s,i,a,l,u,c,f),M=p.__e,p.ref&&y.ref!=p.ref&&(y.ref&&Ut(y.ref,null,p),f.push(p.ref,p.__c||M,p)),Y==null&&M!=null&&(Y=M),4&p.__u||y.__k===p.__k?u=ve(p,u,e):typeof p.type=="function"&&h!==void 0?u=h:M&&(u=M.nextSibling),p.__u&=-7);return n.__e=Y,u}function un(e,t,n,r,s){var i,a,l,u,c,f=n.length,o=f,y=0;for(e.__k=new Array(s),i=0;i<s;i++)(a=t[i])!=null&&typeof a!="boolean"&&typeof a!="function"?(u=i+y,(a=e.__k[i]=typeof a=="string"||typeof a=="number"||typeof a=="bigint"||a.constructor==String?yt(null,a,null,null,null):Tt(a)?yt(Ot,{children:a},null,null,null):a.constructor==null&&a.__b>0?yt(a.type,a.props,a.key,a.ref?a.ref:null,a.__v):a).__=e,a.__b=e.__b+1,l=null,(c=a.__i=hn(a,n,u,o))!=-1&&(o--,(l=n[c])&&(l.__u|=2)),l==null||l.__v==null?(c==-1&&(s>f?y--:s<f&&y++),typeof a.type!="function"&&(a.__u|=4)):c!=u&&(c==u-1?y--:c==u+1?y++:(c>u?y--:y++,a.__u|=4))):e.__k[i]=null;if(o)for(i=0;i<f;i++)(l=n[i])!=null&&(2&l.__u)==0&&(l.__e==r&&(r=lt(l)),$e(l,l));return r}function ve(e,t,n){var r,s;if(typeof e.type=="function"){for(r=e.__k,s=0;r&&s<r.length;s++)r[s]&&(r[s].__=e,t=ve(r[s],t,n));return t}e.__e!=t&&(t&&e.type&&!n.contains(t)&&(t=lt(e)),n.insertBefore(e.__e,t||null),t=e.__e);do t=t&&t.nextSibling;while(t!=null&&t.nodeType==8);return t}function hn(e,t,n,r){var s,i,a,l=e.key,u=e.type,c=t[n],f=c!=null&&(2&c.__u)==0;if(c===null&&e.key==null||f&&l==c.key&&u==c.type)return n;if(r>(f?1:0)){for(s=n-1,i=n+1;s>=0||i<t.length;)if((c=t[a=s>=0?s--:i++])!=null&&(2&c.__u)==0&&l==c.key&&u==c.type)return a}return-1}function ee(e,t,n){t[0]=="-"?e.setProperty(t,n??""):e[t]=n==null?"":typeof n!="number"||cn.test(t)?n:n+"px"}function _t(e,t,n,r,s){var i,a;t:if(t=="style")if(typeof n=="string")e.style.cssText=n;else{if(typeof r=="string"&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||ee(e.style,t,"");if(n)for(t in n)r&&n[t]==r[t]||ee(e.style,t,n[t])}else if(t[0]=="o"&&t[1]=="n")i=t!=(t=t.replace(pe,"$1")),a=t.toLowerCase(),t=a in e||t=="onFocusOut"||t=="onFocusIn"?a.slice(2):t.slice(2),e.l||(e.l={}),e.l[t+i]=n,n?r?n.u=r.u:(n.u=Rt,e.addEventListener(t,i?Nt:Pt,i)):e.removeEventListener(t,i?Nt:Pt,i);else{if(s=="http://www.w3.org/2000/svg")t=t.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(t!="width"&&t!="height"&&t!="href"&&t!="list"&&t!="form"&&t!="tabIndex"&&t!="download"&&t!="rowSpan"&&t!="colSpan"&&t!="role"&&t!="popover"&&t in e)try{e[t]=n??"";break t}catch{}typeof n=="function"||(n==null||n===!1&&t[4]!="-"?e.removeAttribute(t):e.setAttribute(t,t=="popover"&&n==1?"":n))}}function ne(e){return function(t){if(this.l){var n=this.l[t.type+e];if(t.t==null)t.t=Rt++;else if(t.t<n.u)return;return n(A.event?A.event(t):t)}}}function jt(e,t,n,r,s,i,a,l,u,c){var f,o,y,p,M,Y,h,_,v,b,L,N,C,g,I,O,F,x=t.type;if(t.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),i=[l=t.__e=n.__e]),(f=A.__b)&&f(t);t:if(typeof x=="function")try{if(_=t.props,v="prototype"in x&&x.prototype.render,b=(f=x.contextType)&&r[f.__c],L=f?b?b.props.value:f.__:r,n.__c?h=(o=t.__c=n.__c).__=o.__E:(v?t.__c=o=new x(_,L):(t.__c=o=new vt(_,L),o.constructor=x,o.render=_n),b&&b.sub(o),o.props=_,o.state||(o.state={}),o.context=L,o.__n=r,y=o.__d=!0,o.__h=[],o._sb=[]),v&&o.__s==null&&(o.__s=o.state),v&&x.getDerivedStateFromProps!=null&&(o.__s==o.state&&(o.__s=nt({},o.__s)),nt(o.__s,x.getDerivedStateFromProps(_,o.__s))),p=o.props,M=o.state,o.__v=t,y)v&&x.getDerivedStateFromProps==null&&o.componentWillMount!=null&&o.componentWillMount(),v&&o.componentDidMount!=null&&o.__h.push(o.componentDidMount);else{if(v&&x.getDerivedStateFromProps==null&&_!==p&&o.componentWillReceiveProps!=null&&o.componentWillReceiveProps(_,L),!o.__e&&o.shouldComponentUpdate!=null&&o.shouldComponentUpdate(_,o.__s,L)===!1||t.__v==n.__v){for(t.__v!=n.__v&&(o.props=_,o.state=o.__s,o.__d=!1),t.__e=n.__e,t.__k=n.__k,t.__k.some(function(P){P&&(P.__=t)}),N=0;N<o._sb.length;N++)o.__h.push(o._sb[N]);o._sb=[],o.__h.length&&a.push(o);break t}o.componentWillUpdate!=null&&o.componentWillUpdate(_,o.__s,L),v&&o.componentDidUpdate!=null&&o.__h.push(function(){o.componentDidUpdate(p,M,Y)})}if(o.context=L,o.props=_,o.__P=e,o.__e=!1,C=A.__r,g=0,v){for(o.state=o.__s,o.__d=!1,C&&C(t),f=o.render(o.props,o.state,o.context),I=0;I<o._sb.length;I++)o.__h.push(o._sb[I]);o._sb=[]}else do o.__d=!1,C&&C(t),f=o.render(o.props,o.state,o.context),o.state=o.__s;while(o.__d&&++g<25);o.state=o.__s,o.getChildContext!=null&&(r=nt(nt({},r),o.getChildContext())),v&&!y&&o.getSnapshotBeforeUpdate!=null&&(Y=o.getSnapshotBeforeUpdate(p,M)),O=f,f!=null&&f.type===Ot&&f.key==null&&(O=we(f.props.children)),l=ye(e,Tt(O)?O:[O],t,n,r,s,i,a,l,u,c),o.base=t.__e,t.__u&=-161,o.__h.length&&a.push(o),h&&(o.__E=o.__=null)}catch(P){if(t.__v=null,u||i!=null)if(P.then){for(t.__u|=u?160:128;l&&l.nodeType==8&&l.nextSibling;)l=l.nextSibling;i[i.indexOf(l)]=null,t.__e=l}else{for(F=i.length;F--;)Wt(i[F]);At(t)}else t.__e=n.__e,t.__k=n.__k,P.then||At(t);A.__e(P,t,n)}else i==null&&t.__v==n.__v?(t.__k=n.__k,t.__e=n.__e):l=t.__e=fn(n.__e,t,n,r,s,i,a,u,c);return(f=A.diffed)&&f(t),128&t.__u?void 0:l}function At(e){e&&e.__c&&(e.__c.__e=!0),e&&e.__k&&e.__k.forEach(At)}function ke(e,t,n){for(var r=0;r<n.length;r++)Ut(n[r],n[++r],n[++r]);A.__c&&A.__c(t,e),e.some(function(s){try{e=s.__h,s.__h=[],e.some(function(i){i.call(s)})}catch(i){A.__e(i,s.__v)}})}function we(e){return typeof e!="object"||e==null||e.__b&&e.__b>0?e:Tt(e)?e.map(we):nt({},e)}function fn(e,t,n,r,s,i,a,l,u){var c,f,o,y,p,M,Y,h=n.props,_=t.props,v=t.type;if(v=="svg"?s="http://www.w3.org/2000/svg":v=="math"?s="http://www.w3.org/1998/Math/MathML":s||(s="http://www.w3.org/1999/xhtml"),i!=null){for(c=0;c<i.length;c++)if((p=i[c])&&"setAttribute"in p==!!v&&(v?p.localName==v:p.nodeType==3)){e=p,i[c]=null;break}}if(e==null){if(v==null)return document.createTextNode(_);e=document.createElementNS(s,v,_.is&&_),l&&(A.__m&&A.__m(t,i),l=!1),i=null}if(v==null)h===_||l&&e.data==_||(e.data=_);else{if(i=i&&Dt.call(e.childNodes),h=n.props||ut,!l&&i!=null)for(h={},c=0;c<e.attributes.length;c++)h[(p=e.attributes[c]).name]=p.value;for(c in h)if(p=h[c],c!="children"){if(c=="dangerouslySetInnerHTML")o=p;else if(!(c in _)){if(c=="value"&&"defaultValue"in _||c=="checked"&&"defaultChecked"in _)continue;_t(e,c,null,p,s)}}for(c in _)p=_[c],c=="children"?y=p:c=="dangerouslySetInnerHTML"?f=p:c=="value"?M=p:c=="checked"?Y=p:l&&typeof p!="function"||h[c]===p||_t(e,c,p,h[c],s);if(f)l||o&&(f.__html==o.__html||f.__html==e.innerHTML)||(e.innerHTML=f.__html),t.__k=[];else if(o&&(e.innerHTML=""),ye(t.type=="template"?e.content:e,Tt(y)?y:[y],t,n,r,v=="foreignObject"?"http://www.w3.org/1999/xhtml":s,i,a,i?i[0]:n.__k&&lt(n,0),l,u),i!=null)for(c=i.length;c--;)Wt(i[c]);l||(c="value",v=="progress"&&M==null?e.removeAttribute("value"):M!=null&&(M!==e[c]||v=="progress"&&!M||v=="option"&&M!=h[c])&&_t(e,c,M,h[c],s),c="checked",Y!=null&&Y!=e[c]&&_t(e,c,Y,h[c],s))}return e}function Ut(e,t,n){try{if(typeof e=="function"){var r=typeof e.__u=="function";r&&e.__u(),r&&t==null||(e.__u=e(t))}else e.current=t}catch(s){A.__e(s,n)}}function $e(e,t,n){var r,s;if(A.unmount&&A.unmount(e),(r=e.ref)&&(r.current&&r.current!=e.__e||Ut(r,null,t)),(r=e.__c)!=null){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(i){A.__e(i,t)}r.base=r.__P=null}if(r=e.__k)for(s=0;s<r.length;s++)r[s]&&$e(r[s],t,n||typeof e.type!="function");n||Wt(e.__e),e.__c=e.__=e.__e=void 0}function _n(e,t,n){return this.constructor(e,n)}function Vt(e,t,n){var r,s,i,a;t==document&&(t=document.documentElement),A.__&&A.__(e,t),s=(r=!1)?null:t.__k,i=[],a=[],jt(t,e=t.__k=ln(Ot,null,[e]),s||ut,ut,t.namespaceURI,s?null:t.firstChild?Dt.call(t.childNodes):null,i,s?s.__e:t.firstChild,r,a),ke(i,e,a)}Dt=me.slice,A={__e:function(e,t,n,r){for(var s,i,a;t=t.__;)if((s=t.__c)&&!s.__)try{if((i=s.constructor)&&i.getDerivedStateFromError!=null&&(s.setState(i.getDerivedStateFromError(e)),a=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(e,r||{}),a=s.__d),a)return s.__E=s}catch(l){e=l}throw e}},fe=0,vt.prototype.setState=function(e,t){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=nt({},this.state),typeof e=="function"&&(e=e(nt({},n),this.props)),e&&nt(n,e),e!=null&&this.__v&&(t&&this._sb.push(t),te(this))},vt.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),te(this))},vt.prototype.render=Ot,ot=[],_e=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,de=function(e,t){return e.__v.__b-t.__v.__b},$t.__r=0,pe=/(PointerCapture)$|Capture$/i,Rt=0,Pt=ne(!1),Nt=ne(!0);var dn=0;function S(e,t,n,r,s,i){t||(t={});var a,l,u=t;if("ref"in u)for(l in u={},t)l=="ref"?a=t[l]:u[l]=t[l];var c={type:e,props:u,key:n,ref:a,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--dn,__i:-1,__u:0,__source:s,__self:i};if(typeof e=="function"&&(a=e.defaultProps))for(l in a)u[l]===void 0&&(u[l]=a[l]);return A.vnode&&A.vnode(c),c}var bt,q,Lt,re,Ht=0,be=[],R=A,se=R.__b,ie=R.__r,ae=R.diffed,oe=R.__c,ce=R.unmount,le=R.__;function xe(e,t){R.__h&&R.__h(q,e,Ht||t),Ht=0;var n=q.__H||(q.__H={__:[],__h:[]});return e>=n.__.length&&n.__.push({}),n.__[e]}function W(e){return Ht=1,pn(Se,e)}function pn(e,t,n){var r=xe(bt++,2);if(r.t=e,!r.__c&&(r.__=[Se(void 0,t),function(l){var u=r.__N?r.__N[0]:r.__[0],c=r.t(u,l);u!==c&&(r.__N=[c,r.__[1]],r.__c.setState({}))}],r.__c=q,!q.__f)){var s=function(l,u,c){if(!r.__c.__H)return!0;var f=r.__c.__H.__.filter(function(y){return!!y.__c});if(f.every(function(y){return!y.__N}))return!i||i.call(this,l,u,c);var o=r.__c.props!==l;return f.forEach(function(y){if(y.__N){var p=y.__[0];y.__=y.__N,y.__N=void 0,p!==y.__[0]&&(o=!0)}}),i&&i.call(this,l,u,c)||o};q.__f=!0;var i=q.shouldComponentUpdate,a=q.componentWillUpdate;q.componentWillUpdate=function(l,u,c){if(this.__e){var f=i;i=void 0,s(l,u,c),i=f}a&&a.call(this,l,u,c)},q.shouldComponentUpdate=s}return r.__N||r.__}function mn(e,t){var n=xe(bt++,3);!R.__s&&vn(n.__H,t)&&(n.__=e,n.u=t,q.__H.__h.push(n))}function gn(){for(var e;e=be.shift();)if(e.__P&&e.__H)try{e.__H.__h.forEach(kt),e.__H.__h.forEach(Bt),e.__H.__h=[]}catch(t){e.__H.__h=[],R.__e(t,e.__v)}}R.__b=function(e){q=null,se&&se(e)},R.__=function(e,t){e&&t.__k&&t.__k.__m&&(e.__m=t.__k.__m),le&&le(e,t)},R.__r=function(e){ie&&ie(e),bt=0;var t=(q=e.__c).__H;t&&(Lt===q?(t.__h=[],q.__h=[],t.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(t.__h.forEach(kt),t.__h.forEach(Bt),t.__h=[],bt=0)),Lt=q},R.diffed=function(e){ae&&ae(e);var t=e.__c;t&&t.__H&&(t.__H.__h.length&&(be.push(t)!==1&&re===R.requestAnimationFrame||((re=R.requestAnimationFrame)||yn)(gn)),t.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),Lt=q=null},R.__c=function(e,t){t.some(function(n){try{n.__h.forEach(kt),n.__h=n.__h.filter(function(r){return!r.__||Bt(r)})}catch(r){t.some(function(s){s.__h&&(s.__h=[])}),t=[],R.__e(r,n.__v)}}),oe&&oe(e,t)},R.unmount=function(e){ce&&ce(e);var t,n=e.__c;n&&n.__H&&(n.__H.__.forEach(function(r){try{kt(r)}catch(s){t=s}}),n.__H=void 0,t&&R.__e(t,n.__v))};var ue=typeof requestAnimationFrame=="function";function yn(e){var t,n=function(){clearTimeout(r),ue&&cancelAnimationFrame(t),setTimeout(e)},r=setTimeout(n,35);ue&&(t=requestAnimationFrame(n))}function kt(e){var t=q,n=e.__c;typeof n=="function"&&(e.__c=void 0,n()),q=t}function Bt(e){var t=q;e.__c=e.__(),q=t}function vn(e,t){return!e||e.length!==t.length||t.some(function(n,r){return n!==e[r]})}function Se(e,t){return typeof t=="function"?t(e):t}function kn(e){return(e||"").split("/").filter(Boolean).pop()||e||""}function wn(e){const{template:t="{{前缀}}{{内容}}",fields:n}=e,r={};Object.entries(n||{}).forEach(([l,u])=>{r[l]=u==null?"":String(u)}),"前缀"in r||(r.前缀=""),"任务前缀"in r||(r.任务前缀=r.前缀);const s=/\{\{\s*@?([^}]+?)\s*\}\}/g;let i=t.replace(s,(l,u)=>{const c=String(u).trim();return c in r?r[c]:""});return!/\{\{\s*@?(?:前缀|任务前缀)\s*\}\}/.test(t)&&!i.startsWith("- [")&&(i=(r.前缀||"- [ ] ")+i),i.replace(/[ \t]+/g," ").trim()}function Me(e){const t=e.fieldsOrder??["分类","日期","主题","图标","标签","周期","分类","内容"],n={分类:e.category,日期:e.dateISO?St(e.dateISO):"",主题:e.themeLabel??"",图标:e.icon??"",标签:e.tags?.join(", ")??"",...e.extra,内容:(e.content||"").trim()},r=(i,a)=>a?`${i}:: ${a}`:"",s=["<!-- start -->"];return t.forEach(i=>{if(i==="内容"&&n.内容.includes(`
`)){const[a,...l]=n.内容.split(`
`);s.push("内容:: "+a,...l)}else{const a=r(i,n[i]);a&&s.push(a)}}),s.push("<!-- end -->"),s.join(`
`)}class zt{constructor(t,n){this.app=t,this.plugin=n}get settings(){return this.plugin.inputSettings||{base:{},themes:[]}}apply(t,n){return t.replace(/\{\{\s*主题\s*\}\}/g,kn(n))}resolveFilePath(t,n,r){const s=this.settings,i=(s.themes||[]).find(c=>c.path===t)||null;if(n==="task"){const c=i?.task?.file??s.base?.task?.file;return c?this.apply(c,t):null}const a=i?.blocks?.[r],l=s.base?.blocks?.[r],u=a?.file??l?.file;return u?this.apply(u,t):null}async ensureFolder(t){const n=t.split("/").filter(Boolean);let r="";for(const s of n){r=r?`${r}/${s}`:s;const i=this.app.vault.getAbstractFileByPath(r);if(!i)await this.app.vault.createFolder(r).catch(()=>{});else if(i instanceof Z.TFile)throw new Error(`路径冲突：${r} 是文件`)}}async getOrCreateFile(t){const n=this.app.vault.getAbstractFileByPath(t);if(n instanceof Z.TFile)return n;if(n instanceof Z.TFolder)throw new Error(`目标是文件夹：${t}`);const r=t.includes("/")?t.slice(0,t.lastIndexOf("/")):"";return r&&await this.ensureFolder(r),await this.app.vault.create(t,"")}async appendUnderHeader(t,n,r){const s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`^##\\s+${s}\\s*$`,"m"),a=await this.app.vault.read(t),l=a.split(`
`);i.test(a)||(l.length&&l[l.length-1].trim()!==""&&l.push(""),l.push(`## ${n}`,""));let c=l.findIndex(f=>i.test(f))+1;for(;c<l.length&&!/^##\s+/.test(l[c]);)c++;l.splice(c,0,r),await this.app.vault.modify(t,l.join(`
`))}async writeTask(t,n,r){const s=n??this.resolveFilePath(t,"task");if(!s)throw new Error("未配置任务写入文件路径");const i=await this.getOrCreateFile(s);return await this.appendUnderHeader(i,t,r),s}async writeBlock(t,n,r,s){const i=r??this.resolveFilePath(t,"block",n);if(!i)throw new Error(`未配置 ${n} 写入文件路径`);const a=await this.getOrCreateFile(i);return await this.appendUnderHeader(a,t,s),i}getTaskTopCategories(){const t=new Set;return(this.settings.themes||[]).forEach(n=>{n.task?.enabled&&t.add(n.path.split("/")[0])}),[...t].sort((n,r)=>n.localeCompare(r,"zh"))}getBlockTopCategories(t){const n=new Set;return(this.settings.themes||[]).forEach(r=>{r.blocks?.[t]?.enabled===!0&&n.add(r.path.split("/")[0])}),[...n].sort((r,s)=>r.localeCompare(s,"zh"))}listTaskThemesByTop(t){const{themes:n=[],base:r={}}=this.settings,s=r.task??{};return n.filter(i=>(i.path===t||i.path.startsWith(t+"/"))&&(i.task?.enabled??!1)).map(i=>{const a=i.task??{};return{path:i.path,icon:i.icon,file:a.file??s.file??`${i.path}.md`,fields:a.fields??s.fields??[],fieldOptions:a.fieldOptions??s.fieldOptions??{},template:a.template??s.template}})}listBlockThemesByTop(t,n){return(this.settings.themes||[]).filter(r=>(r.path===t||r.path.startsWith(t+"/"))&&(r.blocks?.[n]?.enabled??!1)).map(r=>({path:r.path,icon:r.icon})).sort((r,s)=>r.path.localeCompare(s.path,"zh"))}}function Q({label:e,children:t}){return S("div",{style:"margin-bottom:12px;width:100%;",children:[S("div",{style:"margin-bottom:4px;font-weight:600;",children:e}),S("div",{style:"display:flex;flex-wrap:wrap;gap:8px;width:100%;",children:t})]})}function G({value:e,checked:t,onChange:n,label:r,name:s}){return S("label",{style:"display:flex;align-items:center;gap:4px;cursor:pointer;",children:[S("input",{type:"radio",name:s,value:e,checked:t,onChange:n,style:"appearance:radio;-webkit-appearance:radio;"}),S("span",{children:r??e})]})}class $n extends Z.Modal{constructor(t){super(t.app),this.plugin=t}onOpen(){Vt(S(bn,{app:this.app,plugin:this.plugin,close:()=>this.close()}),this.contentEl)}onClose(){this.contentEl.empty()}}function bn({app:e,plugin:t,close:n}){const r=new zt(e,t),[s,i]=W(r.getTaskTopCategories()[0]||""),[a,l]=W(r.listTaskThemesByTop(s)),[u,c]=W(a[0]||null),f=u?.fieldOptions??{},o={};(u?.fields||[]).forEach(h=>{o[h]=h==="日期"?qt():h==="时间"?Ze():f[h]?.[0]??""});const[y,p]=W(o),M=(h,_)=>p(v=>({...v,[h]:_}));async function Y(){if(!(y.内容?.trim()||y.任务内容?.trim())){new Z.Notice("请填写任务内容");return}let _="";switch(y.任务状态){case"✅":_="- [x] ";break;case"📅":case"🛫":_="- [ ] ";break;default:_=""}const v=wn({themePath:u.path,template:u?.template,fields:{...y,任务前缀:_,前缀:_,icon:u?.icon??""}});try{const b=await r.writeTask(u.path,null,v);new Z.Notice(`✅ 已保存任务 → ${b}`),t.dataStore?.notifyChange?.(),n()}catch(b){new Z.Notice(`❌ 保存失败：${b.message??b}`)}}return S("div",{class:"think-modal",children:[S("h3",{style:"margin-bottom:1rem;",children:"快速录入 · 任务"}),S(Q,{label:"大类",children:r.getTaskTopCategories().map(h=>S(G,{value:h,label:h,checked:s===h,onChange:()=>{i(h);const _=r.listTaskThemesByTop(h);l(_),c(_[0]||null)}},h))}),u&&S(Q,{label:"主题",children:a.map(h=>S(G,{name:"theme",value:h.path,label:h.path.split("/").pop()??h.path,checked:u.path===h.path,onChange:()=>c(h)},h.path))}),u?.fields.map(h=>{const _=f[h];return S(Q,{label:h,children:_?.length?_.map(v=>S(G,{name:h,value:v,label:v,checked:y[h]===v,onChange:()=>M(h,v)},v)):S("input",{style:"width:100%;",type:h==="日期"?"date":h==="时间"?"time":"text",value:y[h],onInput:v=>M(h,v.target.value)})},h)}),S("div",{style:"display:flex;justify-content:flex-end;margin-top:1rem;gap:.5rem;",children:[S("button",{class:"mod-cta",onClick:Y,children:"提交 ↩︎"}),S("button",{onClick:n,children:"取消"})]})]})}const xn=e=>e.split("/").pop()??e;class Sn extends Z.Modal{constructor(t){super(t.app),this.plugin=t}onOpen(){Vt(S(Mn,{app:this.app,plugin:this.plugin,close:()=>this.close()}),this.contentEl)}onClose(){this.contentEl.empty()}}function Mn({app:e,plugin:t,close:n}){const r=new zt(e,t),[s,i]=W("思考"),[a,l]=W(r.getBlockTopCategories(s)),[u,c]=W(a[0]??""),f=()=>r.listBlockThemesByTop(u,s),[o,y]=W(f()),[p,M]=W(o[0]?.path||u),Y=o.find(d=>d.path===p)?.icon??"",_=(t.inputSettings?.base?.blocks?.[s]??{}).fieldOptions??{},v=Array.isArray(_.周期)?_.周期:[],b=Array.isArray(_.分类)?_.分类:[],[L,N]=W(qt()),[C,g]=W(""),[I,O]=W(s!=="思考"&&v.includes("周")?"周":""),[F,x]=W(s==="思考"&&b.includes("思考")?"思考":""),P=(d=s,k=null)=>{const m=r.getBlockTopCategories(d);l(m);const $=k??m[0]??"";c($);const w=r.listBlockThemesByTop($,d);y(w),M(w[0]?.path||$),O(d!=="思考"&&v.includes("周")?"周":""),x(d==="思考"&&b.includes("思考")?"思考":"")};async function z(){if(!C.trim()){new Z.Notice("请填写内容");return}const d={};s!=="思考"&&I&&(d.周期=I),s==="思考"&&F&&(d.分类=F);const k=Me({category:s,dateISO:L,themeLabel:u,icon:Y,content:C,extra:d});try{await r.writeBlock(p,s,null,k),new Z.Notice("✅ 已保存"),t.dataStore?.notifyChange?.(),n()}catch(m){new Z.Notice("❌ 保存失败："+(m.message??m))}}return S("div",{class:"think-modal",children:[S("h3",{style:"margin-bottom:1rem;",children:["快速录入 · ",s]}),S(Q,{label:"类别",children:["计划","总结","思考"].map(d=>S(G,{checked:s===d,label:d,onChange:()=>{i(d),P(d,null)}},d))}),S(Q,{label:"大类",children:a.map(d=>S(G,{checked:u===d,label:d,onChange:()=>{c(d),P(s,d)}},d))}),S(Q,{label:"主题",children:o.map(d=>S(G,{name:"theme",checked:p===d.path,label:xn(d.path),onChange:()=>M(d.path)},d.path))}),s!=="思考"&&v.length>0&&S(Q,{label:"周期",children:v.map(d=>S(G,{name:"period",checked:I===d,label:d,onChange:()=>O(d)},d))}),s==="思考"&&b.length>0&&S(Q,{label:"思考分类",children:b.map(d=>S(G,{name:"type",checked:F===d,label:d,onChange:()=>x(d)},d))}),S(Q,{label:"日期",children:S("input",{type:"date",value:L,onChange:d=>N(d.target.value),style:"min-width:140px;"})}),S(Q,{label:"内容",children:S("textarea",{rows:6,style:"width:100%;",placeholder:"输入内容…",value:C,onInput:d=>g(d.target.value)})}),S("div",{style:"display:flex;gap:8px;justify-content:flex-end;margin-top:8px;",children:[S("button",{class:"mod-cta",onClick:z,children:"提交 ↩︎"}),S("button",{onClick:n,children:"取消"})]})]})}const Dn=e=>e.split("/").pop()??e;class Tn extends Z.Modal{constructor(t){super(t.app),this.plugin=t}onOpen(){Vt(S(On,{app:this.app,plugin:this.plugin,close:()=>this.close()}),this.contentEl)}onClose(){this.contentEl.empty()}}function On({app:e,plugin:t,close:n}){const r=new zt(e,t),s=r.getBlockTopCategories("打卡"),[i,a]=W(s[0]??""),l=()=>r.listBlockThemesByTop(i,"打卡"),[u,c]=W(l()),[f,o]=W(u[0]?.path||i);function y(g){const O=(t.inputSettings?.themes||[]).find(F=>F.path===g)?.blocks?.打卡||{};return typeof O.starCount=="number"?O.starCount:Array.isArray(O.emojiMapping)?O.emojiMapping.length:Array.isArray(O.imageMapping)?O.imageMapping.length:5}const[p,M]=W(y(f)),[Y,h]=W(qt()),[_,v]=W(""),[b,L]=W(1);mn(()=>{const g=y(f);M(g),b>g&&L(g)},[f]);function N(g){a(g);const I=r.listBlockThemesByTop(g,"打卡");c(I),o(I[0]?.path||g)}async function C(){if(!_.trim()){new Z.Notice("请填写内容");return}const g=Me({category:"打卡",dateISO:Y,themeLabel:i,content:_,extra:{评分:String(b)}});try{await r.writeBlock(f,"打卡",null,g),new Z.Notice("✅ 已保存打卡"),t.dataStore?.notifyChange?.(),n()}catch(I){new Z.Notice("❌ 保存失败："+(I.message??I))}}return S("div",{class:"think-modal",children:[S("h3",{style:"margin-bottom:1rem;",children:"快速录入 · 打卡"}),S(Q,{label:"大类",children:s.map(g=>S(G,{value:g,checked:i===g,onChange:()=>N(g),label:g},g))}),S(Q,{label:"主题",children:u.map(g=>S(G,{name:"theme",value:g.path,label:Dn(g.path),checked:f===g.path,onChange:()=>o(g.path)},g.path))}),S(Q,{label:"日期",children:S("input",{type:"date",value:Y,onChange:g=>h(g.target.value),style:{width:"100%"}})}),S(Q,{label:`评分 (1~${p})`,children:S("input",{type:"number",min:1,max:p,value:b,onInput:g=>L(Number(g.target.value)),style:{width:"100%"}})}),S(Q,{label:"内容",children:S("textarea",{rows:5,placeholder:"备注…",style:{width:"100%"},value:_,onInput:g=>v(g.target.value)})}),S("div",{style:"display:flex;gap:8px;justify-content:flex-end;margin-top:8px;",children:[S("button",{class:"mod-cta",onClick:C,children:"提交 ↩︎"}),S("button",{onClick:n,children:"取消"})]})]})}function Cn(e){const{plugin:t}=e;t.addCommand({id:"think-quick-input-task",name:"快速录入 · 任务",callback:()=>new $n(t).open()}),t.addCommand({id:"think-quick-input-block",name:"快速录入 · 计划/总结/思考",callback:()=>new Sn(t).open()}),t.addCommand({id:"think-quick-input-habit",name:"快速录入 · 打卡",callback:()=>new Tn(t).open()})}function Yn(e){Cn(e)}class En extends Z.Plugin{platform;dataStore;async onload(){console.log("ThinkPlugin 加载 (refactor)"),this.platform=new De(this.app),this.dataStore=new Mt(this.platform),await this.dataStore.scanAll();const t={app:this.app,plugin:this,platform:this.platform,dataStore:this.dataStore};Yn(t),Promise.resolve().then(()=>require("./styles-Dyvby5gX.js"))}onunload(){console.log("ThinkPlugin 卸载")}}module.exports=En;
//# sourceMappingURL=main.js.map
