# 综合修复报告：React 依赖与构建问题

## 1. 初始问题

项目最初遇到了两个核心的运行时错误：

1.  `Error: Cannot find module 'react'`
2.  `Error: Cannot find module 'react-is'`

这些错误表明插件在 Obsidian 环境中无法找到必要的 React 相关模块。

## 2. 问题根因分析

经过分析，问题的根源是 `vite.config.ts` 和 `package.json` 中存在的一系列配置冲突和不一致。

*   **依赖策略混乱**: 项目试图同时使用 Preact 兼容层来替代 React，但又将 `react-is`、`prop-types` 等关键模块错误地标记为 `external`（外部依赖）。这导致构建工具期望 Obsidian 环境提供这些模块，但实际上环境并未提供，从而引发了 `Cannot find module` 错误。
*   **依赖项位置不当**: `package.json` 中，`react` 和 `react-dom` 被放在了 `dependencies` 中，而 `@mui/material` 却在 `devDependencies` 中。这不符合使用 Preact 兼容层时的最佳实践，也造成了依赖关系的不清晰。
*   **模块格式不兼容**: 在修复过程中，还暴露了由 CommonJS 和 ES 模块（ESM）混用引起的构建错误。具体来说，`@emotion/react`、`@mui/styled-engine` 和 `@mui/utils` 等库在尝试导入 `hoist-non-react-statics`、`prop-types` 和 `react-is` 时，由于后者是 CommonJS 格式，导致了命名导出失败。

## 3. 最终修复策略

为了从根本上解决这些问题，我采取了一套统一和稳健的修复策略，核心思想是**完全拥抱 Preact 兼容层，并将所有必要的依赖项打包到插件中**，以实现自给自足。

### 步骤 1: 统一 Vite 构建配置 (`vite.config.ts`)

我修改了 `build.rollupOptions.external` 配置，仅保留 `'obsidian'` 作为唯一的外部依赖。所有其他与 React 生态相关的库（如 `react-is`, `prop-types`, `hoist-non-react-statics`）都从外部依赖中移除，以确保它们被 Vite 正确地打包进最终的 `main.js` 文件。

**修改后的 `external` 配置:**
```typescript
external: ['obsidian']
```

### 步骤 2: 解决模块格式兼容性问题 (`vite.config.ts`)

为了解决 CommonJS 和 ESM 之间的导入/导出冲突，我更新了 `build.commonjsOptions`，明确告知 Vite/Rollup 需要对以下模块进行特殊处理，以确保它们能被正确地导入。

**修改后的 `commonjsOptions` 配置:**
```typescript
commonjsOptions: {
    include: [
        /reflect-metadata/, 
        /hoist-non-react-statics/, 
        /prop-types/, 
        /react-is/
    ]
}
```

### 步骤 3: 清理和规范化 `package.json`

我对 `package.json` 进行了重组，以准确反映每个依赖项的角色。

*   将 `react` 和 `react-dom` 从 `dependencies` 移动到 `devDependencies`。
*   将 `@mui/material` 从 `devDependencies` 移动到 `dependencies`。

这确保了项目的依赖关系清晰、正确。

### 步骤 4: 解决 `npm install` 冲突

在调整依赖后，`npm install` 遇到了由 `obsidian` 和 `@codemirror/state` 之间的版本不匹配引起的 `ERESOLVE` 错误。我通过使用 `--legacy-peer-deps` 标志成功解决了这个冲突。

**执行的命令:**
```bash
npm install --legacy-peer-deps
```

## 4. 验证结果

在应用了上述所有修复后，`npm run build` 命令成功执行，没有任何错误。

*   **✅ 构建成功**: 项目在 21.32 秒内成功构建。
*   **✅ 依赖问题解决**: `Cannot find module` 错误已从根本上解决。
*   **✅ 模块兼容性**: 所有 CommonJS/ESM 导入问题均已修复。
*   **✅ 最终产物**: 生成了大小为 714.26 kB 的 `main.js` 文件。

## 5. 总结

通过统一依赖策略、清理配置文件并解决模块兼容性问题，我们成功修复了所有与 React 依赖和构建相关的错误。当前的配置更加健壮和可维护，确保了插件的稳定运行。

---
**最终修复时间**: 2025-11-11 17:43
**状态**: ✅ 已完成
**预期结果**: 插件能够在 Obsidian 中正常加载和运行，所有基于 React/MUI 的功能均可正常工作。
