# 主题系统重构实施计划

> 文档创建日期：2025年10月7日  
> 项目：Think OS Obsidian插件  
> 目标：重构主题管理系统，统一数据处理

## 一、项目背景与目标

### 当前问题
1. **主题和标签概念混淆**：设置中的主题用于输入，但在数据中变成了标签
2. **缺少统一管理**：主题路径直接变成标签，没有中间转换层  
3. **数据筛选依赖tags**：所有筛选都基于tags字段，不够直观

### 改进目标
1. **统一主题管理**：所有主题（预定义+发现的）在一个地方管理
2. **数据结构优化**：添加独立的theme字段，不再依赖tags
3. **智能主题提取**：
   - 任务(task)：从标题提取主题
   - 块(block)：从"主题::"字段提取

## 二、核心设计方案

### 2.1 数据流架构
```
[输入端] 预定义主题 → 快速输入选择 → 生成数据
                                    ↓
[数据端] 数据存储 → 提取主题字段 → 用于筛选展示
                ↓
         [主题发现] → 添加到主题池 → 可激活为输入主题
```

### 2.2 主题提取规则

#### 任务类型（task）
```markdown
- [ ] 整理房间
```
提取结果：`theme = "整理房间"`

#### 块类型（block）
```markdown
<!-- start -->
分类:: 计划
主题:: 生活/日常
内容:: 具体内容
<!-- end -->
```
提取结果：`theme = "生活/日常"`

## 三、实施步骤（5天计划）

### Day 1：数据结构设计与测试基线

#### 1.1 任务清单
- [ ] 创建 `src/core/domain/theme.ts` - 定义Theme接口
- [ ] 更新 `src/core/domain/schema.ts` - 添加theme字段到Item
- [ ] 创建测试文件 `test/unit/theme.test.ts`
- [ ] 运行现有测试，确保基线正常（57/57通过）

#### 1.2 具体改动

**文件：src/core/domain/theme.ts**
```typescript
export interface Theme {
  id: string;
  path: string;           // 主题路径（唯一标识）
  name: string;           // 显示名称
  icon?: string;          // 图标
  parentId: string | null; // 父主题ID（支持层级）
  status: 'active' | 'inactive'; // 是否在快速输入中显示
  source: 'predefined' | 'discovered'; // 来源
  usageCount: number;     // 使用次数
  lastUsed?: number;      // 最后使用时间
  order: number;          // 排序权重
}
```

**文件：src/core/domain/schema.ts**
```typescript
// 在Item接口中添加
export interface Item {
  // ... 现有字段
  theme?: string;         // 主题字段（新增）
  tags: string[];        // 保留但不再用于主题
  // ...
}

// 更新核心字段列表
export const CORE_FIELDS = [
  'id', 'type', 'title', 'content', 'categoryKey', 
  'tags', 'theme', // 添加theme
  'recurrence', 'icon', 'priority', 'date', 'header', 
  'startTime', 'endTime', 'duration', 'period', 'rating', 
  'pintu', 'folder', 'periodCount'
] as const;
```

#### 1.3 测试计划
```typescript
// test/unit/theme.test.ts
describe('Theme数据结构', () => {
  test('Theme接口应包含所有必需字段', () => {
    // 验证类型定义
  });
  
  test('Item应包含theme字段', () => {
    // 验证Item接口更新
  });
  
  test('CORE_FIELDS应包含theme', () => {
    expect(CORE_FIELDS).toContain('theme');
  });
});
```

---

### Day 2：解析器更新与测试

#### 2.1 任务清单
- [ ] 更新 `src/core/utils/parser.ts` - parseTaskLine函数
- [ ] 更新 `src/core/utils/parser.ts` - parseBlockContent函数
- [ ] 创建测试 `test/unit/parser-theme.test.ts`
- [ ] 运行测试确保解析正确

#### 2.2 具体改动

**parseTaskLine修改**
```typescript
export function parseTaskLine(lineText: string, ...): Item {
  const item = /* 现有解析逻辑 */;
  
  // 新增：任务的主题就是标题
  item.theme = item.title;
  
  return item;
}
```

**parseBlockContent修改**
```typescript
export function parseBlockContent(content: string, ...): Item {
  // ... 现有解析逻辑
  
  // 新增：解析主题字段
  const lines = content.split('\n');
  for (const line of lines) {
    const match = line.match(/^主题::\s*(.+)$/);
    if (match) {
      item.theme = match[1].trim();
      break;
    }
  }
  
  return item;
}
```

#### 2.3 测试计划
```typescript
// test/unit/parser-theme.test.ts
describe('主题解析', () => {
  describe('任务主题提取', () => {
    test('应将任务标题作为主题', () => {
      const result = parseTaskLine('- [ ] 整理房间');
      expect(result.theme).toBe('整理房间');
    });
  });
  
  describe('块主题提取', () => {
    test('应正确解析主题字段', () => {
      const content = `<!-- start -->
主题:: 生活/日常
内容:: 测试内容
<!-- end -->`;
      const result = parseBlockContent(content);
      expect(result.theme).toBe('生活/日常');
    });
  });
});
```

---

### Day 3：主题管理服务实现

#### 3.1 任务清单
- [ ] 创建 `src/core/services/ThemeManager.ts`
- [ ] 实现主题CRUD操作
- [ ] 实现主题发现机制
- [ ] 创建测试 `test/unit/ThemeManager.test.ts`

#### 3.2 核心功能
```typescript
export class ThemeManager {
  // 核心方法：
  - addPredefinedTheme(path: string, icon?: string): Theme
  - discoverTheme(path: string): Theme
  - activateTheme(path: string): void
  - deactivateTheme(path: string): void
  - getActiveThemes(): Theme[]
  - getAllThemes(): { active: Theme[], inactive: Theme[], discovered: Theme[] }
  - extractTheme(item: Item): string | null
  - scanDataForThemes(items: Item[]): void
}
```

#### 3.3 测试计划
```typescript
describe('ThemeManager', () => {
  let manager: ThemeManager;
  
  beforeEach(() => {
    manager = new ThemeManager();
  });
  
  test('应能添加预定义主题', () => {
    const theme = manager.addPredefinedTheme('生活/日常');
    expect(theme.status).toBe('active');
    expect(theme.source).toBe('predefined');
  });
  
  test('应能发现新主题', () => {
    const theme = manager.discoverTheme('工作/会议');
    expect(theme.status).toBe('inactive');
    expect(theme.source).toBe('discovered');
  });
  
  test('应能激活/停用主题', () => {
    const theme = manager.discoverTheme('测试主题');
    manager.activateTheme('测试主题');
    expect(theme.status).toBe('active');
  });
});
```

---

### Day 4：快速输入集成

#### 4.1 任务清单
- [ ] 更新 `src/core/services/inputService.ts`
- [ ] 修改 `src/features/quick-input/ui/QuickInputModal.tsx`
- [ ] 测试快速输入流程
- [ ] 确保主题正确保存

#### 4.2 具体改动

**InputService更新**
```typescript
async executeTemplate(template: BlockTemplate, formData: Record<string, any>, theme?: Theme) {
  // 如果是块类型且选择了主题，添加主题字段
  if (theme && template.name !== '任务') {
    // 在输出中插入主题字段
    const themeField = `主题:: ${theme.path}`;
    // ... 插入逻辑
  }
  
  // 任务类型的主题通过标题处理
  if (template.name === '任务' && theme) {
    formData.title = theme.path;
  }
}
```

#### 4.3 测试计划
```typescript
describe('快速输入主题集成', () => {
  test('任务应使用主题作为标题', async () => {
    // 模拟任务输入
    // 验证生成的任务标题
  });
  
  test('块应添加主题字段', async () => {
    // 模拟块输入
    // 验证生成的内容包含主题字段
  });
});
```

---

### Day 5：全局迁移与集成测试

#### 5.1 任务清单
- [ ] 创建数据迁移脚本
- [ ] 更新所有筛选逻辑（tags → theme）
- [ ] 更新所有视图组件
- [ ] 运行端到端测试
- [ ] 性能测试对比

#### 5.2 数据迁移
```typescript
// src/core/migration/themesMigration.ts
export async function migrateToThemes(items: Item[]) {
  const migrated = [];
  
  for (const item of items) {
    if (!item.theme) {
      if (item.type === 'task') {
        item.theme = item.title;
      } else if (item.type === 'block' && item.tags?.length > 0) {
        item.theme = item.tags[0]; // 使用第一个标签作为主题
      }
    }
    migrated.push(item);
  }
  
  return migrated;
}
```

#### 5.3 集成测试
```typescript
describe('主题系统集成测试', () => {
  test('完整流程测试', async () => {
    // 1. 创建主题
    // 2. 快速输入选择主题
    // 3. 保存数据
    // 4. 验证主题提取
    // 5. 测试筛选功能
  });
  
  test('数据迁移测试', async () => {
    // 1. 准备旧格式数据
    // 2. 运行迁移
    // 3. 验证主题字段
  });
});
```

## 四、测试策略

### 4.1 测试金字塔
```
        /\
       /E2E\      端到端测试（5个）
      /----\
     /集成测试\    集成测试（10个）
    /--------\
   /单元测试    \  单元测试（20个）
  /------------\
```

### 4.2 测试覆盖目标
- 单元测试覆盖率 > 80%
- 关键路径100%覆盖
- 所有现有测试保持通过（57/57）

### 4.3 回归测试
每完成一个Day的任务后：
1. 运行所有现有测试 `npm test`
2. 确保性能不下降
3. 手动测试关键功能

## 五、风险控制

### 5.1 备份策略
- 每天开始前创建git分支
- 每步完成后commit
- 保留原始数据备份

### 5.2 回滚计划
```bash
# 如果出现问题，快速回滚
git checkout -b theme-refactor-backup
git reset --hard HEAD~1
```

### 5.3 渐进式发布
1. 先在开发环境测试
2. 小范围用户测试
3. 收集反馈后全量发布

## 六、成功标准

### 6.1 功能指标
- ✅ 主题字段正确提取
- ✅ 主题管理界面正常工作
- ✅ 快速输入支持主题选择
- ✅ 数据筛选基于主题

### 6.2 质量指标
- ✅ 所有测试通过（新增35个测试）
- ✅ 性能不下降（<50ms操作时间）
- ✅ 无数据丢失
- ✅ TypeScript类型100%覆盖

### 6.3 用户体验
- ✅ 主题概念清晰统一
- ✅ 操作流程简化30%
- ✅ 数据组织更加直观

## 七、时间线

| 日期 | 任务 | 负责人 | 状态 |
|------|------|--------|------|
| Day 1 | 数据结构设计 | - | 待开始 |
| Day 2 | 解析器更新 | - | 待开始 |
| Day 3 | 主题管理服务 | - | 待开始 |
| Day 4 | 快速输入集成 | - | 待开始 |
| Day 5 | 全局迁移测试 | - | 待开始 |

## 八、注意事项

1. **保持向后兼容**：旧数据必须能正常读取
2. **增量开发**：每步都要可独立测试
3. **文档同步**：代码改动同步更新文档
4. **用户通知**：重大改动需要通知用户

## 九、相关文档

- [项目规划说明](./项目规划说明_20251007_1542.md)
- [测试报告](../test-report.json)
- [性能基准](../performance-report.json)

---

*文档创建时间：2025年10月7日 16:12*  
*预计完成时间：2025年10月12日*  
*文档状态：待执行*

## 附录：快速命令参考

```bash
# 运行测试
npm test

# 运行特定测试
npm test -- --testNamePattern="主题"

# 性能测试
npm run test:performance

# 构建项目
npm run build

# 开发模式
npm run dev
