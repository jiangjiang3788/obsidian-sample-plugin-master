# 启动加速与查询优化 — 实施对照与落地计划

版本：v0.1  
日期：2025-10-20  
适用范围：Obsidian 插件（Think/样例插件代码库）

## 1. 审计范围与依据
- 依据文档：《docs/启动加速与查询优化实施方案.md》
- 覆盖代码：`src/core/services/dataStore.ts`、`src/features/logic/VaultWatcher.ts`、`src/main.ts`、`src/platform/obsidian.ts`、`src/state/AppStore.ts` 等
- 目标：核对阶段 0–8 的实现与差距，形成落地计划并开始 M1 改造

## 2. 阶段对照与当前状态

- 阶段 0：性能基线（埋点 + 输出）
  - 现状：`main.ts` 有 `console.time` 埋点（总启动、数据服务加载/扫描、UI 特性加载）；未见首屏就绪埋点；未见文件级扫描统计；未见 `performance-report.json` 写入逻辑
  - 结论：部分完成（console.time），缺少首屏就绪与持久化报告

- 阶段 1：存储接口与注入（IPluginStorage）
  - 现状：未实现（设置使用 `loadData/saveData`，无缓存存储抽象）
  - 结论：未完成（建议使用独立文件方式避免与设置互相覆盖）

- 阶段 2：缓存模型（CacheV1 / CachedItem / indexes）
  - 现状：未实现
  - 结论：未完成

- 阶段 3：DataStore 暖启动（warmStart → initialScan）
  - 现状：`initialScan()` 仍全量 `scanAll()`；无缓存对比/落盘
  - 结论：未完成

- 阶段 4：预归一化字段 + 查询缓存
  - 现状：已有 `normalizeItemDates`；未见 `titleLower/contentLower/tagsLower/themePathNormalized`；无查询缓存（dataVersion）
  - 结论：部分完成（时间归一化），其余未完成

- 阶段 5：增量更新 + 防抖写入
  - 现状：`VaultWatcher` 已监听 `create/modify/delete/rename` 并联动内存；`notifyChange` 带节流；未见“缓存写入防抖”
  - 结论：内存级增量具备；缓存落盘未完成

- 阶段 6（可选）：持久化索引（byDateSorted / byTag / byTheme）
  - 现状：未实现
  - 结论：未完成

- 阶段 7：调用方迁移与体验优化
  - 现状：UI 广泛 `queryItems()` 后再 O(n) 过滤/排序；未提供快捷查询；未见大列表虚拟化
  - 结论：未完成

- 阶段 8：观测与回退
  - 现状：未见缓存/索引开关、清空缓存入口与指标
  - 结论：未完成

## 3. 落地路线（按里程碑）

- M1（阶段 0–3）
  1) 阶段 0：完善基线埋点
     - 在 `DataStore.scanAll/scanFile` 添加计数与耗时统计
     - 追加“首屏就绪”埋点（Dashboard 首次渲染完成后打点，临时先使用 Dashboard 加载完成时间近似）
     - 写入报告文件（建议：Vault 内 `Think/performance-report.json`；数组形式追加）
  2) 阶段 1：存储抽象
     - 定义 `IPluginStorage`（后续可切换不同后端，如 `loadData/saveData` vs. Vault 文件）
  3) 阶段 2：缓存模型
     - 定义 `CacheV1`/`CachedItem`/`indexes` 类型
  4) 阶段 3：暖启动
     - 新增 `warmStart()`：cache 读取 → 目录 `mtime/size` 对比 → 仅扫描变更 → 合并内存 → 防抖写回
     - `initialScan()` 指向 `warmStart()`

- M2（阶段 4–5）
  5) 预处理字段：`titleLower/contentLower/tagsLower/themePathNormalized`；`dateMs` 明确化
  6) 查询缓存：`key=hash(filters,sort)+dataVersion`；变更后 `dataVersion++`
  7) 缓存写入防抖：独立于 UI 通知，1–3 秒聚合写

- M3（阶段 6–7，可选）
  8) 持久化索引：`byDateSorted/byTag/byTheme` 构建/维护/落盘/启动复原
  9) 调用迁移：提供 `queryByDateRange/queryByTheme/queryByTags` 等；迁移高频页面；必要时引入虚拟化

- 持续（阶段 8）
  10) 设置与观测：开关/清空缓存/异常自愈；指标（命中率/增量扫描数/耗时）

## 4. 已开始的代码修改（M1/阶段 0 初版）
- 修复：`src/core/services/types.ts` 增补 `import type { App } from 'obsidian'`，保证注入令牌类型来源明确
- 修复：`src/core/services/index.ts` 导出大小写统一（`'./DataStore'` → `'./dataStore'`），避免大小写敏感环境问题
- 埋点：`src/core/services/dataStore.ts`
  - 新增扫描统计与耗时采集（`_perf`）
  - `scanAll()`/`scanFile()` 计数/耗时累计
  - 新增 `writePerformanceReport()`：将本次扫描统计以条目方式追加写入 Vault 中 `Think/performance-report.json`
- 调用：`src/main.ts`
  - 在初次扫描完成后，调用 `dataStore.writePerformanceReport({ stage: 'initialScan' })`

注意：首屏就绪的精确埋点将在 Dashboard 首次完成渲染处追加（后续改动）。

## 5. 下一步（即将提交）
- 新增 `IPluginStorage`（文件后端默认使用 Vault 路径，后续可插拔）
- 定义 `CacheV1/CachedItem/indexes` 类型（`src/core/domain/cache.ts`）
- `DataStore.warmStart()` 初版（仅对比 mtime/size 增量扫描），并将 `initialScan()` 重定向至 `warmStart()`
- 在 Dashboard 首次渲染完成处加入“首屏就绪”埋点并纳入报告

--- 

若需产出更细的任务看板（PR 切分/文件级改动清单），可在本文件继续维护。
