# Think OS 插件项目整理与架构改进计划

## 一、文件整理梳理

### 1. 当前项目结构分析

```
obsidian-sample-plugin-master/
├── src/                    # 源代码目录
│   ├── core/              # 核心功能模块
│   ├── features/          # 功能模块
│   ├── platform/          # 平台相关代码
│   ├── shared/            # 共享资源
│   ├── state/             # 状态管理
│   ├── main.ts            # 主入口文件
│   └── main2.ts           # 重复的主文件（需要处理）
├── test/                  # 测试目录（已整理）
│   ├── unit/              # 单元测试
│   ├── integration/       # 集成测试
│   ├── e2e/              # 端到端测试
│   ├── performance/       # 性能测试
│   ├── fixtures/          # 测试数据
│   ├── helpers/           # 测试辅助工具
│   ├── configs/           # 测试配置
│   └── utils/             # 测试工具
├── dist/                  # 构建输出
└── 根目录配置文件

### 2. 需要整理的问题

#### 2.1 重复文件
- **main.ts vs main2.ts**: 需要合并或删除重复代码
- **main.js**: 构建产物，应该在.gitignore中

#### 2.2 测试文件整理（已完成）
- ✅ 所有测试文件已统一放在test目录
- ✅ 删除了旧的tests/, test-configs/, test-utils/目录

#### 2.3 路径别名（已完成）
- ✅ 已配置路径别名：@core, @state, @platform, @features, @shared
- ✅ 已创建桶文件(index.ts)简化导入

### 3. 文件功能说明

#### 核心模块 (src/core/)
- **domain/**: 领域模型定义（Item, Field, Schema等）
- **services/**: 核心服务（DataStore, EventBus等）
- **utils/**: 工具函数（parser, formatter等）

#### 功能模块 (src/features/)
- **quick-input/**: 快速输入功能
- **dashboard/**: 仪表板视图
- **timer/**: 计时器功能
- **logic/**: 业务逻辑处理

#### 平台模块 (src/platform/)
- Obsidian平台适配层

#### 共享资源 (src/shared/)
- **styles/**: 全局样式和主题
- **components/**: 共享组件
- **utils/**: 共享工具函数

#### 状态管理 (src/state/)
- **AppStore**: 全局状态存储
- **storeRegistry**: 状态注册管理

## 二、核心架构问题分析与改进方案

### 问题优先级排序（按重要程度和性价比）

#### 1. 🔴 高优先级 - 主题管理混乱问题
**问题描述**：
- 主题设置与数据源视图布局脱节，过于数据化
- 数据查询的主题和tags混淆
- 主题录入没有按一级主题分组
- 对有主题但不记录的主题缺乏管理

**改进方案**：
```typescript
// 1. 创建统一的主题管理器
interface ThemeManager {
  // 主题定义
  themes: Map<string, Theme>;
  // 主题层级结构
  hierarchy: ThemeHierarchy;
  // 主题-标签映射
  themeTagMapping: Map<string, Set<string>>;
}

// 2. 重构主题结构
interface Theme {
  id: string;
  name: string;
  parent?: string;        // 父主题
  level: number;          // 层级
  isActive: boolean;      // 是否记录
  tags: string[];         // 关联标签
  viewConfig?: ViewConfig; // 视图配置
}

// 3. 主题录入改进
- 添加主题选择器组件，支持层级选择
- 区分"活动主题"和"参考主题"
- 提供主题模板功能
```

#### 2. 🟠 中高优先级 - 视图配置难度高
**问题描述**：
- 视图没有为主题服务，配置难度高
- 不能在视图中直接配置
- 配置要求太高，不够直观

**改进方案**：
```typescript
// 1. 视图配置可视化
interface ViewBuilder {
  // 拖拽式布局配置
  layoutDesigner: LayoutDesigner;
  // 实时预览
  preview: PreviewComponent;
  // 配置模板
  templates: ViewTemplate[];
}

// 2. 简化配置流程
- 提供预设视图模板
- 支持在视图内右键配置
- 添加配置向导
```

#### 3. 🟡 中优先级 - Block配置层级过深
**问题描述**：
- Block配置的继承、覆写、禁用层级太深
- 配置复杂度高，难以理解

**改进方案**：
```typescript
// 1. 扁平化配置结构
interface BlockConfig {
  base: BaseConfig;           // 基础配置
  overrides?: OverrideConfig;  // 覆盖配置（简化为单层）
  enabled: boolean;            // 启用状态
}

// 2. 配置继承简化
- 最多支持2层继承（全局->主题）
- 提供配置合并预览
- 添加配置冲突检测
```

#### 4. 🟢 低优先级 - 时间查询逻辑混乱
**问题描述**：
- 查询时间、周期、概览视图逻辑不清晰
- 时间相关功能分散

**改进方案**：
```typescript
// 1. 统一时间管理
interface TimeManager {
  // 时间查询器
  queryBuilder: TimeQueryBuilder;
  // 周期管理
  periodManager: PeriodManager;
  // 时间视图
  timeViews: Map<string, TimeView>;
}

// 2. 清晰的时间逻辑
- 创建时间查询DSL
- 统一周期定义
- 提供时间轴视图
```

## 三、实施计划

### 第一阶段：基础整理（1-2天）
1. ✅ 整理测试文件结构
2. ✅ 配置路径别名和桶文件
3. ✅ 处理main.ts和main2.ts重复问题（已删除main2.ts，保留优化版main.ts）
4. ✅ 完善所有模块的桶文件（已创建features主桶文件）

### 第二阶段：主题系统重构（3-5天）
1. 设计新的主题数据结构
2. 实现主题管理器
3. 重构主题录入界面
4. 统一主题和标签的关系

### 第三阶段：视图系统改进（3-4天）
1. 创建视图配置器
2. 实现视图模板系统
3. 添加视图内配置功能
4. 优化视图布局

### 第四阶段：配置简化（2-3天）
1. 简化Block配置层级
2. 实现配置可视化
3. 添加配置向导

### 第五阶段：时间系统优化（2天）
1. 统一时间查询逻辑
2. 优化周期管理
3. 改进时间相关视图

## 四、代码规范建议

### 1. 命名规范
- 文件名：kebab-case (如 theme-manager.ts)
- 类名：PascalCase (如 ThemeManager)
- 函数/变量：camelCase (如 getThemeById)
- 常量：UPPER_SNAKE_CASE (如 MAX_THEME_LEVEL)

### 2. 文件组织规范
```
feature/
├── index.ts           # 桶文件，导出公共API
├── types.ts           # 类型定义
├── components/        # UI组件
├── hooks/            # React hooks
├── logic/            # 业务逻辑
├── utils/            # 工具函数
└── styles/           # 样式文件
```

### 3. Import规范
```typescript
// 1. 外部依赖
import { Notice } from 'obsidian';

// 2. 内部模块（使用路径别名）
import { DataStore } from '@core';
import { AppStore } from '@state';

// 3. 相对导入（仅用于同一功能模块内）
import { LocalComponent } from './components';
```

### 4. TypeScript规范
- 优先使用interface而非type（除非需要联合类型）
- 避免使用any，使用unknown代替
- 为所有公共API添加JSDoc注释
- 使用严格模式（strict: true）

### 5. 错误处理规范
```typescript
// 使用自定义错误类
class ThemeNotFoundError extends Error {
  constructor(themeId: string) {
    super(`Theme not found: ${themeId}`);
    this.name = 'ThemeNotFoundError';
  }
}

// 统一错误处理
try {
  // 业务逻辑
} catch (error) {
  if (error instanceof ThemeNotFoundError) {
    // 特定错误处理
  } else {
    // 通用错误处理
    console.error('Unexpected error:', error);
  }
}
```

## 五、下一步行动

1. **立即执行**：
   - 合并或删除main2.ts
   - 完善所有模块的桶文件
   - 运行测试确保功能正常

2. **短期目标**（本周）：
   - 开始主题系统重构
   - 设计新的数据结构

3. **中期目标**（两周内）：
   - 完成视图配置改进
   - 简化Block配置

4. **长期目标**（一个月内）：
   - 完成所有架构改进
   - 编写完整的开发文档
