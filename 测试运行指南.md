# Obsidian 插件测试运行指南

## 📋 概述

本文档详细介绍了 Obsidian Sample Plugin 项目的完整测试体系，包括各种测试类型的运行方法、配置说明和最佳实践。

## 🗂️ 测试架构

### 测试框架
- **Jest** - 单元测试、集成测试、性能测试
- **WebdriverIO** - 端到端测试
- **自定义测试运行器** - 统一的测试管理界面

### 目录结构
```
├── tests/                    # Jest 测试目录
│   ├── unit/                # 单元测试
│   ├── integration/         # 集成测试
│   ├── performance/         # 性能测试
│   ├── fixtures/            # 测试数据
│   └── helpers/             # 测试辅助函数
├── test/                    # WebdriverIO 测试目录
│   ├── specs/               # E2E 测试规范
│   │   └── test.e2e.ts     # 端到端测试文件
│   └── vaults/              # 测试用的 Obsidian 库
├── test-configs/            # 测试配置
│   └── jest.config.js       # Jest 配置
├── test-utils/              # 测试工具
│   └── setup/               # 环境设置
├── run-tests.js            # 自定义测试运行器
├── wdio.conf.mts           # WebdriverIO 配置
└── 1测试指令.js 运行测试    # 快速测试指令
```

## 🚀 快速开始

### 推荐的测试流程

1. **开发阶段快速验证**
   ```bash
   node run-tests.js vscode  # VSCode 性能测试
   node run-tests.js quick   # 快速测试（单元 + 构建）
   ```

2. **功能开发完成**
   ```bash
   node run-tests.js unit    # 单元测试
   node run-tests.js e2e     # 端到端测试
   ```

3. **发布前完整测试**
   ```bash
   node run-tests.js all     # 完整测试套件
   ```

## 📝 详细测试命令

### 1. Jest 单元测试

#### 基础命令
```bash
# 运行所有单元测试
npm run test

# 监听模式（文件变化时自动重新运行）
npm run test:watch

# 生成覆盖率报告
npm run test:coverage
```

#### 分类测试
```bash
# 只运行单元测试
npm run test:unit

# 运行集成测试
npm run test:integration

# 运行性能测试
npm run test:performance
```

#### Jest 配置特点
- **测试环境**: jsdom（模拟浏览器环境）
- **支持语言**: TypeScript + JavaScript
- **路径别名**: 
  - `@/` → `src/`
  - `@tests/` → `tests/`
  - `@test-utils/` → `test-utils/`
- **超时设置**: 10秒
- **覆盖率**: 排除 `.d.ts` 和 `.stories` 文件

### 2. WebdriverIO 端到端测试

#### 基础命令
```bash
# 运行 E2E 测试
npm run test:e2e

# 运行所有测试（单元 + E2E）
npm run test:all
```

#### WebdriverIO 配置特点
- **测试框架**: Mocha
- **并行实例**: 最多4个（可通过环境变量 `WDIO_MAX_INSTANCES` 调整）
- **支持平台**: 
  - 桌面版 Obsidian
  - 移动端模拟（390x844 分辨率）
- **测试库**: `test/vaults/simple`
- **超时设置**: 60秒

### 3. 自定义测试运行器 (run-tests.js)

这是推荐的测试管理方式，提供统一的界面和额外的功能。

#### 基础用法
```bash
# 查看帮助信息
node run-tests.js help

# 快速测试（推荐日常使用）
node run-tests.js quick

# VSCode 性能测试（推荐）
node run-tests.js vscode
```

#### 完整命令列表
```bash
node run-tests.js unit      # 运行单元测试
node run-tests.js e2e       # 运行端到端测试
node run-tests.js build     # 构建项目
node run-tests.js perf      # 显示性能测试说明
node run-tests.js manual    # 显示手动测试清单
node run-tests.js vscode    # VSCode终端性能测试
node run-tests.js quick     # 快速测试（单元测试 + 构建）
node run-tests.js all       # 运行完整测试套件
node run-tests.js help      # 显示帮助信息
```

#### 功能特点
- ✅ 自动检查必要文件
- 🎨 彩色输出和进度提示
- 📊 详细的错误信息
- 🚀 智能的测试流程管理

### 4. 性能测试

#### 自动化性能测试
```bash
# VSCode 终端性能测试（推荐）
node run-tests.js vscode

# 或直接运行
node vscode-performance-test.js
```

#### 手动性能测试
```bash
# 查看性能测试说明
node run-tests.js perf
```

手动测试步骤：
1. 打开 Obsidian
2. 按 `Ctrl+Shift+I` 打开开发者工具
3. 切换到 Console 标签
4. 复制 `真实性能测试.js` 的内容
5. 粘贴到控制台并运行
6. 执行 `thinkPluginTests.runFullTestSuite()`

## 🔧 测试配置详解

### Jest 配置 (test-configs/jest.config.js)
```javascript
module.exports = {
  testEnvironment: 'jsdom',
  roots: ['../tests'],
  testMatch: [
    '**/tests/**/*.test.js',
    '**/tests/**/*.test.ts',
    '**/tests/**/*.spec.js',
    '**/tests/**/*.spec.ts'
  ],
  // ... 更多配置
};
```

### WebdriverIO 配置 (wdio.conf.mts)
- 支持多版本 Obsidian 测试
- 自动下载和管理 Obsidian 版本
- 移动端模拟支持
- 并行测试执行

## 📊 测试报告

### 覆盖率报告
运行 `npm run test:coverage` 后，覆盖率报告将生成在：
- **控制台输出**: 文本格式的覆盖率摘要
- **HTML 报告**: `coverage/lcov-report/index.html`
- **LCOV 文件**: `coverage/lcov.info`

### E2E 测试报告
- 使用 `obsidian-reporter` 显示 Obsidian 版本信息
- 详细的测试步骤和结果
- 失败时的截图和错误信息

## 🛠️ 开发工作流

### 日常开发
```bash
# 1. 快速验证
node run-tests.js vscode

# 2. 单元测试
node run-tests.js unit

# 3. 构建验证
node run-tests.js build
```

### 功能开发完成
```bash
# 1. 完整自动化测试
node run-tests.js all

# 2. 手动测试清单
node run-tests.js manual

# 3. 性能回归测试
node run-tests.js perf
```

### 发布前检查
```bash
# 1. 清理环境
npm run clean  # 如果有此命令

# 2. 完整测试
node run-tests.js all

# 3. 检查覆盖率
npm run test:coverage

# 4. 最终构建
npm run build
```

## 🐛 故障排除

### 常见问题

#### 1. Jest 测试失败
```bash
# 检查配置
node run-tests.js help

# 查看详细输出
npm run test -- --verbose

# 调试模式
npm run test -- --detectOpenHandles
```

#### 2. E2E 测试失败
```bash
# 检查 Obsidian 版本
# 查看 wdio.conf.mts 中的版本配置

# 单独运行 E2E 测试
npm run test:e2e

# 检查测试库
ls test/vaults/
```

#### 3. 性能测试问题
```bash
# 检查性能测试文件
ls -la 真实性能测试.js

# 查看 VSCode 性能测试
node vscode-performance-test.js
```

### 环境要求
- **Node.js**: 推荐 18+ 版本
- **npm**: 最新版本
- **Obsidian**: 用于 E2E 测试
- **VSCode**: 用于性能测试（可选）

## 📚 最佳实践

### 1. 测试编写
- 使用描述性的测试名称
- 遵循 AAA 模式（Arrange, Act, Assert）
- 保持测试的独立性
- 使用合适的断言库

### 2. 测试组织
- 按功能模块组织测试文件
- 使用 `fixtures` 目录管理测试数据
- 在 `helpers` 中定义可重用的测试工具

### 3. 持续集成
- 在 CI/CD 中运行完整测试套件
- 设置覆盖率阈值
- 自动化性能回归检测

### 4. 性能监控
- 定期运行性能测试
- 监控关键指标变化
- 建立性能基线

## 🔗 相关文件

- **package.json**: 包含所有测试脚本
- **run-tests.js**: 自定义测试运行器
- **test-configs/jest.config.js**: Jest 配置
- **wdio.conf.mts**: WebdriverIO 配置
- **真实性能测试.js**: 手动性能测试脚本
- **vscode-performance-test.js**: VSCode 性能测试

## 📞 获取帮助

如果遇到问题：
1. 运行 `node run-tests.js help` 查看可用选项
2. 检查测试配置文件
3. 查看测试输出中的错误信息
4. 参考项目文档和示例

---

*最后更新: 2025年10月6日*
