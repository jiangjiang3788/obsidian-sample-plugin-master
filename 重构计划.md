基于完整的src目录架构分析，我制定一个更全面和现实的重构计划。

## 现有架构分析

### 优势保留
- **清晰的分层架构**：core(核心) -> features(特性) -> shared(共享) -> platform(平台)
- **依赖注入体系**：使用tsyringe管理服务生命周期
- **服务管理器**：ServiceManager已经实现了模块化加载
- **性能优化**：懒加载、渐进式初始化

### 核心问题
- **features层边界混乱**：功能模块职责不清晰
- **组件耦合严重**：巨型组件包含多种职责
- **代码复用度低**：相似功能重复实现
- **跨模块依赖**：直接引用其他模块组件

## 完善重构计划

### 第一阶段：Shared层增强 (1周)

#### 1.1 扩展共享UI组件库
```
src/shared/ui/
├── components/           # 基础组件
│   ├── Modal/           
│   │   ├── BaseModal.tsx        # 模态框基类  
│   │   ├── ModalProvider.tsx    # 模态框提供者
│   │   └── ModalService.ts      # 模态框服务
│   ├── Form/
│   │   ├── FormField.tsx        # 通用表单字段
│   │   ├── TimeInput.tsx        # 时间输入组件
│   │   ├── DynamicForm.tsx      # 动态表单
│   │   └── ValidationHooks.ts   # 验证Hooks
│   ├── DataDisplay/
│   │   ├── ProgressBar.tsx      # 通用进度条
│   │   ├── DataTable.tsx        # 通用数据表格
│   │   ├── Chart.tsx            # 通用图表基类
│   │   └── SummaryCard.tsx      # 汇总卡片
│   └── Layout/
│       ├── Container.tsx        # 容器组件
│       ├── Grid.tsx             # 网格布局
│       └── FlexBox.tsx          # 弹性布局
├── hooks/               # 增强共享Hooks
│   ├── useModal.ts              # 模态框管理
│   ├── useFormState.ts          # 表单状态管理
│   ├── useDataVisualization.ts  # 数据可视化Hooks
│   ├── useTimeCalculation.ts    # 时间计算Hooks
│   └── useAsyncOperation.ts     # 异步操作Hooks
└── services/            # 共享服务
    ├── ModalService.ts          # 全局模态框服务
    ├── NotificationService.ts   # 通知服务
    └── EventBus.ts              # 事件总线
```

#### 1.2 抽取通用工具函数
```
src/shared/utils/
├── data/
│   ├── aggregator.ts           # 数据聚合工具
│   ├── formatter.ts            # 数据格式化
│   └── validator.ts            # 数据验证
├── ui/
│   ├── chart-helpers.ts        # 图表辅助工具
│   ├── responsive.ts           # 响应式工具
│   └── theme-utils.ts          # 主题工具
└── time/
    ├── calculator.ts           # 时间计算
    ├── parser.ts               # 时间解析
    └── formatter.ts            # 时间格式化
```

### 第二阶段：Features层重新组织 (2-3周)

#### 2.1 按领域边界重新划分features
```
src/features/
├── data-visualization/         # 数据可视化领域
│   ├── index.ts
│   ├── components/
│   │   ├── charts/            # 图表组件
│   │   │   ├── ProgressBlock.tsx     # 从TimelineView抽取
│   │   │   ├── HeatmapCell.tsx      # 从HeatmapView抽取
│   │   │   ├── TimeAxis.tsx         # 时间轴组件
│   │   │   └── SummaryTable.tsx     # 汇总表格
│   │   ├── views/             # 视图组件（拆分后的）
│   │   │   ├── TimelineView/        # Timeline拆分为目录
│   │   │   │   ├── TimelineView.tsx
│   │   │   │   ├── DayColumn.tsx
│   │   │   │   └── MonthView.tsx
│   │   │   ├── HeatmapView/         # Heatmap拆分为目录
│   │   │   │   ├── HeatmapView.tsx
│   │   │   │   ├── ThemeHeader.tsx
│   │   │   │   └── LevelProgress.tsx
│   │   │   ├── TableView.tsx
│   │   │   ├── ExcelView.tsx
│   │   │   ├── StatisticsView.tsx
│   │   │   └── BlockView.tsx
│   │   └── navigation/         # 导航组件
│   │       ├── TimeNavigator.tsx
│   │       └── ViewSettingsModal.tsx
│   ├── hooks/
│   │   ├── useTimelineData.ts       # Timeline数据处理
│   │   ├── useHeatmapData.ts        # Heatmap数据处理
│   │   ├── useChartInteraction.ts   # 图表交互
│   │   └── useViewState.ts          # 视图状态管理
│   ├── utils/
│   │   ├── timeline-parser.ts       # 从原文件移动
│   │   ├── data-processor.ts        # 数据处理器
│   │   └── chart-builder.ts         # 图表构建器
│   └── services/
│       └── VisualizationService.ts  # 可视化服务
├── user-interaction/           # 用户交互领域
│   ├── index.ts
│   ├── components/
│   │   ├── modals/            # 模态框组件
│   │   │   ├── QuickInputModal/     # 拆分QuickInput为目录
│   │   │   │   ├── QuickInputModal.tsx
│   │   │   │   ├── FormRenderer.tsx
│   │   │   │   ├── ThemeSelector.tsx
│   │   │   │   └── TimeCalculator.tsx
│   │   │   ├── EditTaskModal.tsx
│   │   │   └── TemplateModal.tsx
│   │   ├── inputs/            # 输入组件
│   │   │   ├── DynamicField.tsx
│   │   │   ├── RatingInput.tsx
│   │   │   └── TimeFieldGroup.tsx
│   │   └── widgets/           # 小部件组件
│   │       └── FloatingTimer.tsx
│   ├── hooks/
│   │   ├── useFormValidation.ts     # 表单验证
│   │   ├── useKeyboardDetection.ts  # 键盘检测（从QuickInput抽取）
│   │   ├── useModalState.ts         # 模态框状态
│   │   └── useInputHandlers.ts      # 输入处理
│   └── services/
│       ├── InputService.ts          # 输入服务（移动到此处）
│       └── InteractionService.ts    # 交互服务
├── time-management/            # 时间管理领域
│   ├── index.ts
│   ├── components/
│   │   ├── timers/            # 计时器组件
│   │   │   ├── TimerWidget.ts       # 移动原有组件
│   │   │   ├── FloatingTimer.ts
│   │   │   └── TimerControls.tsx
│   │   └── displays/          # 时间显示组件
│   │       ├── TimeDisplay.tsx
│   │       └── DurationDisplay.tsx
│   ├── hooks/
│   │   ├── useTimer.ts              # 计时器Hook
│   │   └── useTimeSync.ts           # 时间同步
│   ├── services/
│   │   ├── TimerService.ts          # 移动并拆分
│   │   ├── TimerStateService.ts     # 保持现有
│   │   └── TimeTrackingService.ts   # 时间跟踪服务
│   └── utils/
│       └── time-helpers.ts          # 时间辅助工具
├── content-management/         # 内容管理领域
│   ├── index.ts
│   ├── components/
│   │   ├── editors/           # 编辑器组件
│   │   ├── templates/         # 模板组件
│   │   └── themes/            # 主题组件（移动theme模块内容）
│   ├── services/
│   │   ├── TemplateService.ts
│   │   ├── ThemeService.ts
│   │   └── ContentService.ts
│   └── utils/
│       └── content-helpers.ts
├── system-configuration/       # 系统配置领域
│   ├── index.ts
│   ├── components/
│   │   ├── panels/            # 设置面板（移动settings内容）
│   │   └── editors/           # 配置编辑器
│   ├── stores/
│   │   └── SettingsStore.ts         # 移动现有Store
│   └── services/
│       └── ConfigurationService.ts
└── layout-rendering/           # 布局渲染领域
    ├── index.ts
    ├── components/
    │   └── renderers/         # 渲染器组件
    ├── stores/
    │   └── LayoutStore.ts           # 移动现有Store
    └── services/
        ├── RendererService.ts       # 保持现有
        └── LayoutService.ts
```

### 第三阶段：服务层优化 (1-2周)

#### 3.1 扩展ServiceManager支持新架构
```typescript
// src/core/services/ServiceManager.ts 增强
export class ServiceManager {
  // 新增领域服务管理
  async loadVisualizationServices(): Promise<void>
  async loadInteractionServices(): Promise<void>
  async loadContentServices(): Promise<void>
  
  // 模块间通信优化
  setupInterModuleCommunication(): void
}
```

#### 3.2 建立EventBus解耦模块间依赖
```typescript
// src/shared/services/EventBus.ts
export class EventBus {
  // 替换直接的模态框调用
  openModal(type: string, data: any): void
  
  // 替换直接的服务调用
  executeAction(action: string, payload: any): void
}
```

### 第四阶段：Core层增强 (1周)

#### 4.1 扩展核心服务
```
src/core/services/
├── coordination/              # 服务协调
│   ├── ServiceCoordinator.ts       # 服务协调器
│   └── ModuleBridge.ts             # 模块桥接器
├── data/                     # 数据服务
│   ├── DataStore.ts               # 保持现有
│   ├── CacheService.ts            # 缓存服务
│   └── SyncService.ts             # 同步服务
└── integration/              # 集成服务
    ├── PluginIntegration.ts       # 插件集成
    └── PlatformBridge.ts          # 平台桥接
```

## 实施策略

### 渐进式迁移原则
1. **向后兼容**：保持所有现有的导出接口不变
2. **逐个模块迁移**：一次只重构一个模块，完整验证后继续
3. **增量测试**：每个阶段完成后进行完整功能测试

### 具体执行步骤
1. **Week 1**: 建设shared层基础设施，抽取通用组件
2. **Week 2-3**: 重构data-visualization领域，拆分TimelineView和HeatmapView
3. **Week 4-5**: 重构user-interaction领域，拆分QuickInputModal
4. **Week 6**: 重构其他领域，优化服务层
5. **Week 7**: 整体测试和优化

### 预期收益
- **边界清晰**：每个领域职责明确，文件组织合理
- **低耦合**：通过EventBus和服务接口通信，减少直接依赖
- **高复用**：共享组件和工具函数可在多处复用
- **易维护**：清晰的分层架构便于后续开发和维护

这个方案充分利用现有的优秀架构基础，专注解决features层的问题，同时增强shared层的复用能力。需要我详细展开某个具体领域的重构方案吗？