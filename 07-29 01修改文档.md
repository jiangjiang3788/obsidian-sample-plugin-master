# Think Plugin 重构说明（H1–H5）

**日期：** 2025-07-29
**范围：** 消除重复逻辑、统一行为与常量、轻度性能优化，不改变对外功能与数据结构。

**目标：**

* 抽离任务完成与周期任务生成逻辑，避免多处修改不一致。
* 统一各视图中的复选框交互与样式。
* 把日期范围计算集中到工具函数。
* 统一 emoji、运算符来源，消除“魔法字符串”。
* 减少设置面板的无谓重渲染，缓解卡顿。

---

## 1. 改动摘要

| 编号 | 目标                  | 结果                                                                                                               |
| -- | ------------------- | ---------------------------------------------------------------------------------------------------------------- |
| H1 | **任务完成 & 周期任务逻辑重复** | 在 `data/mark.ts` 新增高层封装 `markTaskDone()`，`DataStore.markItemDone()` 改为调用该函数，删除原有内嵌的重复实现。                         |
| H2 | **多视图复选框行为不一致**     | 新增通用组件 `views/common/TaskCheckbox.tsx`，`BlockView` 与 `TableView` 统一使用，勾选后调用 `DataStore.instance.markItemDone()`。 |
| H3 | **日期范围函数分散**        | 在 `utils/date.ts` 新增 `getDateRange()`，`Dashboard.tsx` 改为引用工具函数，删除内部同名函数。                                         |
| H4 | **Settings 面板卡顿**   | 统一运算符常量引用，减少重绘时的构造工作；为后续缓存与 memo 留出入口（本次为轻度优化，不涉及行为变化）。                                                          |
| H5 | **emoji 与运算符常量重复**  | 所有处统一使用 `config/constants.ts` 的 `EMOJI` 与 `OPS`。                                                                 |

---

## 2. 变更文件清单

| 变更类型     | 文件路径                                | 说明                                                                                                                 |
| -------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **覆盖**   | `src/data/mark.ts`                  | 整合：提供 `toggleToDone`、`parseRecurrence`、`findBaseDateForRecurring`、`generateNextRecurringTask`，以及高层 `markTaskDone`。 |
| **覆盖**   | `src/data/store.ts`                 | `markItemDone()` 改为调用 `markTaskDone()`；删除内嵌的重复逻辑；其它扫描/查询逻辑不变。                                                      |
| **覆盖**   | `src/utils/date.ts`                 | 新增 `getDateRange()`，保留 `normalizeDateStr()`。                                                                       |
| **新增**   | `src/views/common/TaskCheckbox.tsx` | 通用复选框组件，封装勾选交互。                                                                                                    |
| **覆盖**   | `src/views/BlockView.tsx`           | 使用 `TaskCheckbox`；精简重复代码。                                                                                          |
| **覆盖**   | `src/views/TableView.tsx`           | 使用 `TaskCheckbox`；精简重复代码。                                                                                          |
| **局部修改** | `src/views/Dashboard.tsx`           | 引入 `getDateRange`，删除组件内 `getDateRange`。                                                                            |
| **局部修改** | `src/ui/SettingsTab.ts`             | 将硬编码的运算符数组替换为 `OPS` 常量；为后续缓存留出空间。                                                                                  |

> 说明：其余文件未改动。`config/constants.ts` 中的 `EMOJI`、`OPS` 没有变更，只是被更多文件统一引用。

---

## 3. 关键逻辑说明

### 3.1 任务完成与周期任务（H1）

* **之前**：`data/mark.ts` 与 `DataStore.markItemDone()` 内部分别维护了一套“完成标记 + 周期生成”实现，正则和步骤不完全一致。
* **现在**：统一在 `data/mark.ts`：

  * `markTaskDone(rawLine, todayISO, nowTime)` 返回 `{ completedLine, nextTaskLine? }`。
  * `DataStore.markItemDone()` 只负责读写文件与触发刷新。
* **收益**：修改日期格式/正则/顺序时，只需改一处；易于编写针对性的单元测试。

### 3.2 复选框行为统一（H2）

* 新增 `TaskCheckbox`：

  * `done=true`：显示完成勾选、阻止再次点击。
  * `done=false`：勾选后触发 `onMarkDone()`，由 `DataStore` 完成落盘与刷新。
* `BlockView` 与 `TableView` 统一复用该组件，视觉与交互一致。

### 3.3 日期范围统一（H3）

* `utils/date.ts` 新增：

```ts
export function getDateRange(date: any, viewType: string) {
  // 处理 年/季/月/周/天 起止
  return { startDate, endDate };
}
```

* `Dashboard.tsx` 调用该工具函数，不再内嵌实现。

### 3.4 常量统一（H5）

* 统一使用：

  * `EMOJI`: 📅、⏳、🛫、✅、🔁 等。
  * `OPS`: `'=', '!=', 'includes', 'regex', '>', '<'`。
* 引入方式：

```ts
import { EMOJI, OPS } from '../config/constants';
```

### 3.5 Settings 面板轻度优化（H4）

* 把硬编码运算符数组替换为 `OPS`，消除散落常量，便于后续新增运算符。
* 后续可进一步引入 memo/caching 以减少 `display()` 的全量重建（本次不改变行为）。

---

## 4. 兼容性与迁移

* **数据兼容**：不改变 `PersistData` / `DashboardConfig` / `Item` 结构。
* **界面兼容**：视觉与交互保持一致；复选框样式统一为 `.task-checkbox`（原样式仍适用）。
* **API 兼容**：外部只使用 `DataStore.markItemDone()` 的地方无需修改；内部改为 `markTaskDone()` 实现。

---

## 5. 回滚方案

如需回滚：

1. 将以下文件恢复到重构前版本：

   * `src/data/mark.ts`
   * `src/data/store.ts`
   * `src/views/BlockView.tsx`
   * `src/views/TableView.tsx`
   * `src/views/Dashboard.tsx`
   * `src/utils/date.ts`
   * `src/ui/SettingsTab.ts`
2. 删除新增文件：

   * `src/views/common/TaskCheckbox.tsx`

---

## 6. 测试清单

### 6.1 任务完成 / 周期任务

* [ ] 勾选单次任务：插入 `(时间::HH:MM)`，勾选框变为完成，尾部追加 `✅ YYYY-MM-DD`。
* [ ] 勾选周期任务 `🔁 every day`：原行写入完成信息，并在下一行插入新任务；新任务的 📅/⏳/🛫 日期顺延 1 天。
* [ ] 勾选 `🔁 every 2 weeks when done`：以完成当天为基准顺延 2 周。
* [ ] 含 `(时长::30)`：完成后保留且顺序为 `(时间::HH:MM) (时长::30)`。
* [ ] 行末已有旧 `✅` 日期：应被替换为当天日期。
* [ ] `/` 日期写回后统一为 `YYYY-MM-DD`。

### 6.2 复选框一致性

* [ ] `BlockView` 与 `TableView` 勾选行为一致；完成后 UI 自动刷新。
* [ ] 已完成任务的复选框不可再次点击（CSS 与逻辑双重保障）。

### 6.3 日期范围过滤

* [ ] 在 Dashboard 顶部切换“年/季/月/周/天”均能正确筛选 `item.date`；**无日期项仍显示**。
* [ ] “周”视图的周起始与原先表现一致（依赖 moment 设置）。

### 6.4 Settings 面板

* [ ] 过滤条件运算符下拉框来自 `OPS`，保存后刷新仍正确。
* [ ] 添加/删除过滤与排序规则后，配置可保存并刷新对应模块。

---

## 7. 已知限制与后续工作

* **SettingsTab 性能**：当前仅做常量统一。若数据规模大，建议：

  * 将 `queryItems()` 的全量计算改为在 `dataStore` 变更时刷新；
  * 对 `getAllFields(items)` 结果做 memo；
  * datalist 只在需要时重建。
* **周期任务日期键扩展**：目前支持 📅/⏳/🛫。若需要更多日期键，可在 `mark.ts` 的 `replaceIf()` 里扩展。
* **moment 依赖**：仍通过 `window.moment`。若迁移至 dayjs，集中修改 `mark.ts` 与 `utils/date.ts`。
* **`DataStore.instance['app']`**：为保持兼容，本次未改动。建议后续提供 `getApp()` 或依赖注入，去除索引访问。

---

## 8. 建议的提交顺序（Commits）

1. **feat(mark): add unified markTaskDone & recurrence helpers**
2. **refactor(store): use markTaskDone in markItemDone**
3. **feat(views): add TaskCheckbox and unify checkbox behavior**
4. **refactor(block/table): use TaskCheckbox, remove duplicates**
5. **feat(date): add getDateRange and use in Dashboard**
6. **chore(settings): use OPS constant; light refresh**
7. **docs: add refactor H1–H5 changelog**
