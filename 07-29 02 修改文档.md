# ThinkPlugin 重构补丁说明

（适用于 2025‑07‑29 提供的 **“重复逻辑精简 & 结构拆分”** 代码包）

---

## 1 · 目标与收益

| 目标     | 说明                                                |
| ------ | ------------------------------------------------- |
| 消除重复逻辑 | `任务完成 / 周期任务生成` 仅保留 **一份**实现，避免两处维护               |
| 职责分层   | 数据层（DataStore） ↔ 业务服务层（TaskService） ↔ 界面层；主入口不再臃肿 |
| 代码可维护性 | 新人可快速定位：监听、渲染、业务、工具分别在哪个目录                        |
| 未来可扩展  | 后续要做撤销、批量操作或单元测试时，无需再触碰视图和存储层                     |

---

## 2 · 文件变动清单

| 路径                                | 类型     | 关键用途                                             |
| --------------------------------- | ------ | ------------------------------------------------ |
| **src/utils/text.ts**             | **新增** | 通用 `cleanTaskText()`，避免在多处 parser 复制             |
| **src/services/taskService.ts**   | **新增** | 单一业务入口：`TaskService.completeTask()`              |
| **src/core/VaultWatcher.ts**      | **新增** | 监听 Vault 变化并调用 DataStore（解耦 main.ts）             |
| **src/core/CodeblockEmbedder.ts** | **新增** | 处理 \`\`\`think 代码块→Dashboard 渲染                  |
| **src/data/parser.ts**            | **替换** | 复用 `cleanTaskText()`；保持块解析部分原样                   |
| **src/data/store.ts**             | **替换** | 删除 200+ 行 `markItemDone` 逻辑→调用 `TaskService`     |
| **src/main.ts**                   | **替换** | 精简为生命周期 + 注入；引用 VaultWatcher & CodeblockEmbedder |
| （其余文件）                            | 未改动    | 与旧版保持二进制兼容                                       |

> **提示**：旧版 `views/common/TaskCheckbox.tsx`、`data/mark.ts` 等无任何接口变更，继续沿用。

---

## 3 · 关键改动详解

### 3.1 消除重复的“任务完成”代码

* **删除**：`DataStore.markItemDone()` 内部全部业务细节
* **保留**：文件‑I/O & 数据刷新调用
* **新增**：`TaskService.completeTask()`

  * 调用 `markTaskDone()`（保持原算法）
  * 负责写回文件、插入下一条周期任务、触发重扫
  * **未来扩展点**：加入 Undo、Hook、日志等

### 3.2 主入口瘦身

| 旧                                                               | 新                                               |
| --------------------------------------------------------------- | ----------------------------------------------- |
| main.ts 负责：<br>– Vault 监听<br>– Codeblock 渲染<br>– 样式注入<br>– 生命周期 | main.ts 仅保留 **生命周期 + 样式注入 + SettingTab**        |
| 监听逻辑散落                                                          | `core/VaultWatcher.ts` 统一实现，内部节流仍由 DataStore 提供 |
| 代码块处理散落                                                         | `core/CodeblockEmbedder.ts` 统一实现                |

### 3.3 解析器统一

* `cleanTaskText()` 提升到 `utils/text.ts`
* `data/parser.ts` 调整以引用公共函数，防止下次实现冲突

---

## 4 · 集成步骤

1. **备份**

   ```bash
   cd your-vault/.obsidian/plugins/think-plugin
   git add . && git commit -m "backup before refactor"
   ```

2. **覆盖/添加文件**
   将补丁包中的 7 个文件按原路径复制（可直接粘贴覆盖）。

3. **检查 import 路径**
   如果你的项目构建工具未启用 *path aliases*，确保所有 `import` 路径仍然正确（相对路径已按照官方脚手架组织，无需修改）。

4. **重新构建插件**

   ```bash
   npm run build    # 或 yarn build / pnpm build
   ```

5. **在 Obsidian 中重载插件**
   设置 → 社区插件 → 关闭再开启 “ThinkPlugin”。

---

## 5 · 回滚策略

* 任何异常（编译失败、运行报错）

  ```bash
  git reset --hard  <backup‑commit‑hash>
  npm run build
  ```
* 若使用的是 zip 形式部署，直接还原备份文件夹即可。

---

## 6 · 测试清单

| 场景         | 操作                           | 期望                                                    |
| ---------- | ---------------------------- | ----------------------------------------------------- |
| **普通任务完成** | 勾选非周期任务                      | ✔️ 打上 ✅ 日期，文件写回，Dashboard 自动刷新                        |
| **周期任务完成** | 勾选「- \[ ] … 🔁 every 1 week」 | ✔️ 旧任务变 ✅<br>✔️ 同行下插入下一周期<br>✔️ 刷新后 Dashboard 中仅显示新任务 |
| **代码块仪表盘** | 在任意笔记插入 \`\`\`think {}       |                                                       |

```| ✔️ 默认仪表盘渲染；Ctrl/Cmd+点击折叠正常 |
| **Vault 文件修改** | 外部编辑器保存 Markdown | ✔️ Dashboard 数据 250 ms 内自动刷新 |
| **设置面板** | SettingTab 保存配置 | ✔️ 立即反映，无重复数据 |

> 建议使用 **开发者工具 Console** 观察 “ThinkPlugin 加载 - 重构版” 日志确认新版本已启用。

---

## 7 · FAQ

| 问题 | 解决方案 |
|------|----------|
| 构建时报找不到 `../services/taskService` | 确认 `src/services` 目录已创建且文件名大小写正确 |
| 周期任务未插入下一条 | 检查原行是否包含 `🔁 …` 及合法语法；`mark.ts` 的算法未修改 |
| 想扩展更多业务 | 直接在 `services/` 下创建新服务，UI 调用 Service 而非 DataStore |

---

如需进一步协助，欢迎留言或提 Issue。祝重构顺利！
```
