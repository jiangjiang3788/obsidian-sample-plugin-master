# Think OS æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

Think OS æ˜¯ä¸€ä¸ªåŸºäº Preact çš„ Obsidian æ’ä»¶ï¼Œé‡‡ç”¨æ¨¡å—åŒ–ã€åˆ†å±‚çš„æ¶æ„è®¾è®¡ï¼Œä½¿ç”¨æœåŠ¡ç®¡ç†å™¨æ¨¡å¼å®ç°æ‡’åŠ è½½å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Obsidian Platform                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Plugin Entry                        â”‚
â”‚                       (main.ts)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Service Manager                       â”‚
â”‚              (æ‡’åŠ è½½å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Features    â”‚  â”‚     Core      â”‚  â”‚    State      â”‚
â”‚   - Dashboard â”‚  â”‚   - Services  â”‚  â”‚  - AppStore   â”‚
â”‚   - QuickInputâ”‚  â”‚   - Domain    â”‚  â”‚  - Registry   â”‚
â”‚   - Timer     â”‚  â”‚   - Utils     â”‚  â”‚               â”‚
â”‚   - Settings  â”‚  â”‚               â”‚  â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                  â†‘                   â†‘
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Shared Resources                      â”‚
â”‚              (Components, Utils, Types)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—

### 1. Plugin Entry (`src/main.ts`)
æ’ä»¶çš„å…¥å£ç‚¹ï¼Œè´Ÿè´£ï¼š
- åˆå§‹åŒ– ServiceManager
- åˆ†é˜¶æ®µåŠ è½½æœåŠ¡ï¼ˆæ ¸å¿ƒæœåŠ¡ â†’ è®¡æ—¶å™¨æœåŠ¡ â†’ æ•°æ®æœåŠ¡ â†’ UIç‰¹æ€§ï¼‰
- ç®¡ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
- åŠ è½½å’Œä¿å­˜æ’ä»¶é…ç½®

```typescript
export default class ThinkPlugin extends Plugin {
    private serviceManager!: ServiceManager;
    
    async onload() {
        // æ­¥éª¤ 1: åŸºç¡€åˆå§‹åŒ–
        const settings = await this.loadSettings();
        
        // æ­¥éª¤ 2: åˆå§‹åŒ–æœåŠ¡ç®¡ç†å™¨
        this.serviceManager = new ServiceManager(this);
        await this.serviceManager.initializeCore();
        
        // æ­¥éª¤ 3: ç«‹å³åŠ è½½è®¡æ—¶å™¨æœåŠ¡
        await this.serviceManager.loadTimerServices();
        
        // æ­¥éª¤ 4: å»¶è¿ŸåŠ è½½å…¶ä»–æœåŠ¡
        this.loadRemainingServicesAsync();
    }
}
```

### 2. Service Manager
æœåŠ¡ç®¡ç†å™¨è´Ÿè´£æœåŠ¡çš„æ‡’åŠ è½½å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

```typescript
class ServiceManager {
    private services: Partial<{
        appStore: AppStore;
        dataStore: DataStore;
        rendererService: RendererService;
        actionService: ActionService;
        timerService: TimerService;
        timerStateService: TimerStateService;
        inputService: InputService;
        timerWidget: FloatingTimerWidget;
        taskService: TaskService;
    }> = {};
    
    // åˆ†é˜¶æ®µåŠ è½½æ–¹æ³•
    async initializeCore(): Promise<void>
    async loadTimerServices(): Promise<void>
    async loadDataServices(): Promise<void>
    async loadUIFeatures(): Promise<void>
}
```

### 3. Core Module (`src/core/`)

#### 3.1 Domain (`src/core/domain/`)
é¢†åŸŸæ¨¡å‹å®šä¹‰ï¼Œä¸»è¦åŒ…å« schema å®šä¹‰ï¼š
- **ThinkSettings** - æ’ä»¶è®¾ç½®
- **DataSource** - æ•°æ®æºé…ç½®
- **ViewInstance** - è§†å›¾å®ä¾‹
- **Layout** - å¸ƒå±€é…ç½®
- **TimerState** - è®¡æ—¶å™¨çŠ¶æ€

#### 3.2 Services (`src/core/services/`)
æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼š
- **DataStore** - æ•°æ®å­˜å‚¨ç®¡ç†
- **ActionService** - ç”¨æˆ·æ“ä½œå¤„ç†
- **RendererService** - æ¸²æŸ“æœåŠ¡
- **TimerService** - è®¡æ—¶å™¨ç®¡ç†
- **TimerStateService** - è®¡æ—¶å™¨çŠ¶æ€æŒä¹…åŒ–
- **InputService** - è¾“å…¥å¤„ç†
- **TaskService** - ä»»åŠ¡ç®¡ç†
- **ThemeManager** - ä¸»é¢˜ç®¡ç†

#### 3.3 Utils (`src/core/utils/`)
é€šç”¨å·¥å…·å‡½æ•°ï¼š
- **array** - æ•°ç»„æ“ä½œå·¥å…·
- å…¶ä»–å·¥å…·å‡½æ•°

### 4. Features Module (`src/features/`)

æ¯ä¸ªåŠŸèƒ½æ¨¡å—éƒ½æ˜¯ç‹¬ç«‹çš„å­ç³»ç»Ÿï¼š

#### 4.1 Dashboard (`src/features/dashboard/`)
ä»ªè¡¨æ¿åŠŸèƒ½ï¼Œä¸»è¦åŒ…å«åˆå§‹åŒ–é€»è¾‘ï¼š
```typescript
features/dashboard/
â”œâ”€â”€ index.ts            # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ hooks/             # è‡ªå®šä¹‰ Hooks
â”œâ”€â”€ styles/           # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ ui/              # UI ç»„ä»¶
â””â”€â”€ views/           # è§†å›¾ç»„ä»¶
```

å®é™…çš„æ ¸å¿ƒç»„ä»¶ä½äº `features/logic/`ï¼š
- **VaultWatcher** - ç›‘æ§ Vault å˜åŒ–
- **CodeblockEmbedder** - ä»£ç å—åµŒå…¥å¤„ç†

#### 4.2 Quick Input (`src/features/quick-input/`)
å¿«é€Ÿè¾“å…¥åŠŸèƒ½ï¼Œæä¾›é«˜æ•ˆçš„æ•°æ®å½•å…¥ç•Œé¢ã€‚

#### 4.3 Timer (`src/features/timer/`)
è®¡æ—¶å™¨åŠŸèƒ½ï¼š
```typescript
features/timer/
â”œâ”€â”€ index.ts                   # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ FloatingTimerWidget.ts     # æµ®åŠ¨è®¡æ—¶å™¨
â””â”€â”€ ui/                       # UI ç»„ä»¶
    â”œâ”€â”€ TimerView.tsx         # è®¡æ—¶å™¨è§†å›¾
    â””â”€â”€ TimerRow.tsx          # è®¡æ—¶å™¨è¡Œç»„ä»¶
```

#### 4.4 Settings (`src/features/settings/`)
è®¾ç½®ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸»é¢˜çŸ©é˜µé…ç½®ã€æ’ä»¶é…ç½®ç­‰ã€‚

### 5. State Management (`src/state/`)

é‡‡ç”¨ç®€å•çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼å®ç°çŠ¶æ€ç®¡ç†ã€‚

#### 5.1 AppStore (`src/state/AppStore.ts`)
å…¨å±€çŠ¶æ€å­˜å‚¨ï¼Œç®¡ç†ï¼š
```typescript
interface AppState {
    settings: ThinkSettings;        // æ’ä»¶è®¾ç½®
    timers: TimerState[];           // è®¡æ—¶å™¨åˆ—è¡¨
    activeTimer?: TimerState;       // å½“å‰æ´»åŠ¨è®¡æ—¶å™¨
    isTimerWidgetVisible: boolean; // æ‚¬æµ®è®¡æ—¶å™¨å¯è§æ€§
}
```

æ ¸å¿ƒæ–¹æ³•ï¼š
- `getState()` - è·å–å½“å‰çŠ¶æ€
- `getSettings()` - è·å–è®¾ç½®
- `subscribe(listener)` - è®¢é˜…çŠ¶æ€å˜åŒ–
- `_updateSettingsAndPersist()` - æ›´æ–°å¹¶æŒä¹…åŒ–è®¾ç½®
- `_updateEphemeralState()` - æ›´æ–°ä¸´æ—¶çŠ¶æ€

#### 5.2 Store Registry (`src/state/storeRegistry.ts`)
æœåŠ¡æ³¨å†Œè¡¨ï¼Œç”¨äºå…¨å±€è®¿é—®æœåŠ¡å®ä¾‹ã€‚

### 6. Platform Adaptation (`src/platform/`)

å¹³å°é€‚é…å±‚ï¼Œå¤„ç†ä¸ Obsidian API çš„äº¤äº’ï¼š
- **ObsidianPlatform** - Obsidian å¹³å°é€‚é…å™¨

### 7. Shared Resources (`src/shared/`)

å…±äº«èµ„æºï¼Œä¾›æ‰€æœ‰æ¨¡å—ä½¿ç”¨ï¼š
- Components - é€šç”¨ UI ç»„ä»¶
- Utils - é€šç”¨å·¥å…·å‡½æ•°
- Types - å…±äº«ç±»å‹å®šä¹‰

## ğŸ”„ æ•°æ®æµ

### å•å‘æ•°æ®æµ
```
User Action â†’ Command/Event â†’ Service â†’ State Update â†’ UI Re-render
     â†‘                                                        â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI Feedback â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æ›´æ–°æµç¨‹
1. ç”¨æˆ·è§¦å‘æ“ä½œï¼ˆç‚¹å‡»ã€è¾“å…¥ç­‰ï¼‰
2. UI ç»„ä»¶è°ƒç”¨æœåŠ¡æ–¹æ³•
3. æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘
4. æœåŠ¡æ›´æ–° AppStore çŠ¶æ€
5. AppStore é€šçŸ¥è®¢é˜…è€…
6. è®¢é˜…ç»„ä»¶æ¥æ”¶æ›´æ–°å¹¶é‡æ–°æ¸²æŸ“

## ğŸ’‰ ä¾èµ–æ³¨å…¥ (TSyringe)

### ç®€åŒ–çš„ä¾èµ–æ³¨å…¥ä½¿ç”¨

é¡¹ç›®ä½¿ç”¨ TSyringeï¼Œä½†é‡‡ç”¨äº†ç®€åŒ–çš„æ–¹å¼ï¼š

```typescript
// ä»… AppStore ä½¿ç”¨å•ä¾‹æ³¨å†Œ
import { container, singleton } from 'tsyringe';

@singleton()
export class AppStore {
    // ...
}

container.registerSingleton(AppStore);

// å…¶ä»–æœåŠ¡é€šè¿‡ ServiceManager æ‰‹åŠ¨ç®¡ç†
this.services.dataStore = container.resolve(DataStore);
this.services.rendererService = container.resolve(RendererService);
```

æ³¨å†Œçš„ä»¤ç‰Œï¼š
- `AppToken` - Obsidian App å®ä¾‹
- `SETTINGS_TOKEN` - æ’ä»¶è®¾ç½®

## ğŸ¨ UI æ¶æ„ (Preact)

### ç»„ä»¶å±‚æ¬¡
```
App
â”œâ”€â”€ QuickInputModal
â”œâ”€â”€ DashboardView
â”œâ”€â”€ SettingsTab
â”‚   â””â”€â”€ ThemeMatrix
â””â”€â”€ FloatingTimerWidget
    â””â”€â”€ TimerView
        â””â”€â”€ TimerRow[]
```

### ç»„ä»¶è®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£** - æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¯å¤ç”¨æ€§** - é€šè¿‡ props å®ç°ç»„ä»¶å¤ç”¨
3. **æ— çŠ¶æ€ä¼˜å…ˆ** - ä¼˜å…ˆä½¿ç”¨å‡½æ•°ç»„ä»¶
4. **æ™ºèƒ½/å±•ç¤ºåˆ†ç¦»** - å®¹å™¨ç»„ä»¶å¤„ç†é€»è¾‘ï¼Œå±•ç¤ºç»„ä»¶è´Ÿè´£UI

### Hooks ä½¿ç”¨
```typescript
// useStore Hook - è®¢é˜…çŠ¶æ€å˜åŒ–
export function useStore<T>(selector: (state: AppState) => T): T {
    const [state, setState] = useState(() => selector(appStore.getState()));
    
    useEffect(() => {
        const unsubscribe = appStore.subscribe(() => {
            const newStateSlice = selector(appStore.getState());
            setState(newStateSlice);
        });
        return unsubscribe;
    }, [selector]);
    
    return state;
}
```

## ğŸ“¦ æ„å»ºå’Œæ‰“åŒ…

### Vite æ„å»ºé…ç½®
```typescript
// vite.config.ts
export default defineConfig({
    plugins: [preact()],
    build: {
        lib: {
            entry: 'src/main.ts',
            formats: ['cjs'],
            fileName: 'main'
        },
        rollupOptions: {
            external: ['obsidian']
        }
    }
});
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ‡’åŠ è½½ç­–ç•¥
1. **æ ¸å¿ƒæœåŠ¡ä¼˜å…ˆ** - å…ˆåŠ è½½å¿…éœ€çš„ AppStore å’Œ TimerStateService
2. **è®¡æ—¶å™¨æœåŠ¡å¿«é€ŸåŠ è½½** - ç”¨æˆ·ä½“éªŒå…³é”®åŠŸèƒ½ä¼˜å…ˆ
3. **æ•°æ®æœåŠ¡å¼‚æ­¥åŠ è½½** - åå°æ‰«ææ•°æ®ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
4. **UIç‰¹æ€§å»¶è¿ŸåŠ è½½** - ä½¿ç”¨ setTimeout é”™å¼€åŠ è½½æ—¶æœº

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§
```typescript
// å»¶è¿ŸåŠ è½½ç¤ºä¾‹
private loadQuickInputFeature(): void {
    setTimeout(() => {
        console.time('[ThinkPlugin] QuickInputç‰¹æ€§åŠ è½½');
        QuickInputFeature.setup?.({
            plugin: this.plugin,
            appStore: this.services.appStore!
        });
        console.timeEnd('[ThinkPlugin] QuickInputç‰¹æ€§åŠ è½½');
    }, 100);
}
```

## ğŸ§ª æµ‹è¯•æ¶æ„

### æµ‹è¯•å±‚çº§
1. **å•å…ƒæµ‹è¯•** - æµ‹è¯•ç‹¬ç«‹æ¨¡å—
2. **é›†æˆæµ‹è¯•** - æµ‹è¯•æ¨¡å—é—´äº¤äº’
3. **E2Eæµ‹è¯•** - æµ‹è¯•å®Œæ•´ç”¨æˆ·æµç¨‹

## ğŸ“ æ¶æ„å†³ç­–è®°å½• (ADR)

### ADR-001: é€‰æ‹© Preact è€Œé React
- **å†³ç­–**ï¼šä½¿ç”¨ Preact ä½œä¸º UI æ¡†æ¶
- **åŸå› **ï¼šæ›´å°çš„åŒ…ä½“ç§¯ï¼Œæ›´å¿«çš„è¿è¡Œé€Ÿåº¦
- **å½±å“**ï¼šéœ€è¦ç¡®ä¿ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§

### ADR-002: ä½¿ç”¨ ServiceManager æ¨¡å¼
- **å†³ç­–**ï¼šé‡‡ç”¨ ServiceManager ç®¡ç†æœåŠ¡ç”Ÿå‘½å‘¨æœŸ
- **åŸå› **ï¼šæ›´å¥½çš„æ‡’åŠ è½½æ§åˆ¶ï¼Œä¼˜åŒ–å¯åŠ¨æ€§èƒ½
- **å½±å“**ï¼šæœåŠ¡åˆå§‹åŒ–é¡ºåºéœ€è¦ä»”ç»†ç®¡ç†

### ADR-003: ç®€åŒ–çš„çŠ¶æ€ç®¡ç†
- **å†³ç­–**ï¼šä½¿ç”¨ç®€å•çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼è€Œéå¤æ‚çš„çŠ¶æ€ç®¡ç†åº“
- **åŸå› **ï¼šé™ä½å¤æ‚åº¦ï¼Œæ»¡è¶³å½“å‰éœ€æ±‚
- **å½±å“**ï¼šå¤§è§„æ¨¡åº”ç”¨å¯èƒ½éœ€è¦é‡æ–°è€ƒè™‘

## ğŸ”® æœªæ¥æ¶æ„æ¼”è¿›

### çŸ­æœŸç›®æ ‡
- [ ] å®Œå–„æµ‹è¯•è¦†ç›–
- [ ] ä¼˜åŒ–æ‰“åŒ…ä½“ç§¯
- [ ] æ”¹è¿›é”™è¯¯å¤„ç†

### é•¿æœŸç›®æ ‡
- [ ] æ”¯æŒæ’ä»¶æ‰©å±•
- [ ] å®ç°æ›´å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æ”¯æŒè¿œç¨‹é…ç½®

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼š2.0.0*  
*æœ€åæ›´æ–°ï¼š2025å¹´10æœˆ7æ—¥*  
*ç»´æŠ¤è€…ï¼šThink OS Team*
