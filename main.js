"use strict";const A=require("obsidian");var ue,F,je,X,Ae,Ke,Xe,Je,De,be,we,ee={},ze=[],dt=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,he=Array.isArray;function K(t,e){for(var n in e)t[n]=e[n];return t}function Se(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function se(t,e,n){var s,r,a,d={};for(a in e)a=="key"?s=e[a]:a=="ref"?r=e[a]:d[a]=e[a];if(arguments.length>2&&(d.children=arguments.length>3?ue.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(a in t.defaultProps)d[a]===void 0&&(d[a]=t.defaultProps[a]);return re(t,d,s,r,null)}function re(t,e,n,s,r){var a={type:t,props:e,key:n,ref:s,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:r??++je,__i:-1,__u:0};return r==null&&F.vnode!=null&&F.vnode(a),a}function pe(t){return t.children}function ae(t,e){this.props=t,this.context=e}function Q(t,e){if(e==null)return t.__?Q(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Q(t):null}function Ge(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Ge(t)}}function Ye(t){(!t.__d&&(t.__d=!0)&&X.push(t)&&!oe.__r++||Ae!=F.debounceRendering)&&((Ae=F.debounceRendering)||Ke)(oe)}function oe(){for(var t,e,n,s,r,a,d,u=1;X.length;)X.length>u&&X.sort(Xe),t=X.shift(),u=X.length,t.__d&&(n=void 0,r=(s=(e=t).__v).__e,a=[],d=[],e.__P&&((n=K({},s)).__v=s.__v+1,F.vnode&&F.vnode(n),Ee(e.__P,n,s,e.__n,e.__P.namespaceURI,32&s.__u?[r]:null,a,r??Q(s),!!(32&s.__u),d),n.__v=s.__v,n.__.__k[n.__i]=n,et(a,n,d),n.__e!=r&&Ge(n)));oe.__r=0}function Qe(t,e,n,s,r,a,d,u,p,h,m){var c,l,v,k,D,w,g=s&&s.__k||ze,b=e.length;for(p=ut(n,e,g,p,b),c=0;c<b;c++)(v=n.__k[c])!=null&&(l=v.__i==-1?ee:g[v.__i]||ee,v.__i=c,w=Ee(t,v,l,r,a,d,u,p,h,m),k=v.__e,v.ref&&l.ref!=v.ref&&(l.ref&&Ce(l.ref,null,v),m.push(v.ref,v.__c||k,v)),D==null&&k!=null&&(D=k),4&v.__u||l.__k===v.__k?p=Ze(v,p,t):typeof v.type=="function"&&w!==void 0?p=w:k&&(p=k.nextSibling),v.__u&=-7);return n.__e=D,p}function ut(t,e,n,s,r){var a,d,u,p,h,m=n.length,c=m,l=0;for(t.__k=new Array(r),a=0;a<r;a++)(d=e[a])!=null&&typeof d!="boolean"&&typeof d!="function"?(p=a+l,(d=t.__k[a]=typeof d=="string"||typeof d=="number"||typeof d=="bigint"||d.constructor==String?re(null,d,null,null,null):he(d)?re(pe,{children:d},null,null,null):d.constructor==null&&d.__b>0?re(d.type,d.props,d.key,d.ref?d.ref:null,d.__v):d).__=t,d.__b=t.__b+1,u=null,(h=d.__i=ht(d,n,p,c))!=-1&&(c--,(u=n[h])&&(u.__u|=2)),u==null||u.__v==null?(h==-1&&(r>m?l--:r<m&&l++),typeof d.type!="function"&&(d.__u|=4)):h!=p&&(h==p-1?l--:h==p+1?l++:(h>p?l--:l++,d.__u|=4))):t.__k[a]=null;if(c)for(a=0;a<m;a++)(u=n[a])!=null&&(2&u.__u)==0&&(u.__e==s&&(s=Q(u)),nt(u,u));return s}function Ze(t,e,n){var s,r;if(typeof t.type=="function"){for(s=t.__k,r=0;s&&r<s.length;r++)s[r]&&(s[r].__=t,e=Ze(s[r],e,n));return e}t.__e!=e&&(e&&t.type&&!n.contains(e)&&(e=Q(t)),n.insertBefore(t.__e,e||null),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function ht(t,e,n,s){var r,a,d=t.key,u=t.type,p=e[n];if(p===null&&t.key==null||p&&d==p.key&&u==p.type&&(2&p.__u)==0)return n;if(s>(p!=null&&(2&p.__u)==0?1:0))for(r=n-1,a=n+1;r>=0||a<e.length;){if(r>=0){if((p=e[r])&&(2&p.__u)==0&&d==p.key&&u==p.type)return r;r--}if(a<e.length){if((p=e[a])&&(2&p.__u)==0&&d==p.key&&u==p.type)return a;a++}}return-1}function Ve(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||dt.test(e)?n:n+"px"}function ne(t,e,n,s,r){var a,d;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof s=="string"&&(t.style.cssText=s=""),s)for(e in s)n&&e in n||Ve(t.style,e,"");if(n)for(e in n)s&&n[e]==s[e]||Ve(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")a=e!=(e=e.replace(Je,"$1")),d=e.toLowerCase(),e=d in t||e=="onFocusOut"||e=="onFocusIn"?d.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+a]=n,n?s?n.u=s.u:(n.u=De,t.addEventListener(e,a?we:be,a)):t.removeEventListener(e,a?we:be,a);else{if(r=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function $e(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=De++;else if(e.t<n.u)return;return n(F.event?F.event(e):e)}}}function Ee(t,e,n,s,r,a,d,u,p,h){var m,c,l,v,k,D,w,g,b,Y,I,L,M,P,V,$,i,_=e.type;if(e.constructor!=null)return null;128&n.__u&&(p=!!(32&n.__u),a=[u=e.__e=n.__e]),(m=F.__b)&&m(e);e:if(typeof _=="function")try{if(g=e.props,b="prototype"in _&&_.prototype.render,Y=(m=_.contextType)&&s[m.__c],I=m?Y?Y.props.value:m.__:s,n.__c?w=(c=e.__c=n.__c).__=c.__E:(b?e.__c=c=new _(g,I):(e.__c=c=new ae(g,I),c.constructor=_,c.render=_t),Y&&Y.sub(c),c.props=g,c.state||(c.state={}),c.context=I,c.__n=s,l=c.__d=!0,c.__h=[],c._sb=[]),b&&c.__s==null&&(c.__s=c.state),b&&_.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=K({},c.__s)),K(c.__s,_.getDerivedStateFromProps(g,c.__s))),v=c.props,k=c.state,c.__v=e,l)b&&_.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),b&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(b&&_.getDerivedStateFromProps==null&&g!==v&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(g,I),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(g,c.__s,I)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(c.props=g,c.state=c.__s,c.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(f){f&&(f.__=e)}),L=0;L<c._sb.length;L++)c.__h.push(c._sb[L]);c._sb=[],c.__h.length&&d.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(g,c.__s,I),b&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(v,k,D)})}if(c.context=I,c.props=g,c.__P=t,c.__e=!1,M=F.__r,P=0,b){for(c.state=c.__s,c.__d=!1,M&&M(e),m=c.render(c.props,c.state,c.context),V=0;V<c._sb.length;V++)c.__h.push(c._sb[V]);c._sb=[]}else do c.__d=!1,M&&M(e),m=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++P<25);c.state=c.__s,c.getChildContext!=null&&(s=K(K({},s),c.getChildContext())),b&&!l&&c.getSnapshotBeforeUpdate!=null&&(D=c.getSnapshotBeforeUpdate(v,k)),$=m,m!=null&&m.type===pe&&m.key==null&&($=tt(m.props.children)),u=Qe(t,he($)?$:[$],e,n,s,r,a,d,u,p,h),c.base=e.__e,e.__u&=-161,c.__h.length&&d.push(c),w&&(c.__E=c.__=null)}catch(f){if(e.__v=null,p||a!=null)if(f.then){for(e.__u|=p?160:128;u&&u.nodeType==8&&u.nextSibling;)u=u.nextSibling;a[a.indexOf(u)]=null,e.__e=u}else for(i=a.length;i--;)Se(a[i]);else e.__e=n.__e,e.__k=n.__k;F.__e(f,e,n)}else a==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):u=e.__e=pt(n.__e,e,n,s,r,a,d,p,h);return(m=F.diffed)&&m(e),128&e.__u?void 0:u}function et(t,e,n){for(var s=0;s<n.length;s++)Ce(n[s],n[++s],n[++s]);F.__c&&F.__c(e,t),t.some(function(r){try{t=r.__h,r.__h=[],t.some(function(a){a.call(r)})}catch(a){F.__e(a,r.__v)}})}function tt(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:he(t)?t.map(tt):K({},t)}function pt(t,e,n,s,r,a,d,u,p){var h,m,c,l,v,k,D,w=n.props,g=e.props,b=e.type;if(b=="svg"?r="http://www.w3.org/2000/svg":b=="math"?r="http://www.w3.org/1998/Math/MathML":r||(r="http://www.w3.org/1999/xhtml"),a!=null){for(h=0;h<a.length;h++)if((v=a[h])&&"setAttribute"in v==!!b&&(b?v.localName==b:v.nodeType==3)){t=v,a[h]=null;break}}if(t==null){if(b==null)return document.createTextNode(g);t=document.createElementNS(r,b,g.is&&g),u&&(F.__m&&F.__m(e,a),u=!1),a=null}if(b==null)w===g||u&&t.data==g||(t.data=g);else{if(a=a&&ue.call(t.childNodes),w=n.props||ee,!u&&a!=null)for(w={},h=0;h<t.attributes.length;h++)w[(v=t.attributes[h]).name]=v.value;for(h in w)if(v=w[h],h!="children"){if(h=="dangerouslySetInnerHTML")c=v;else if(!(h in g)){if(h=="value"&&"defaultValue"in g||h=="checked"&&"defaultChecked"in g)continue;ne(t,h,null,v,r)}}for(h in g)v=g[h],h=="children"?l=v:h=="dangerouslySetInnerHTML"?m=v:h=="value"?k=v:h=="checked"?D=v:u&&typeof v!="function"||w[h]===v||ne(t,h,v,w[h],r);if(m)u||c&&(m.__html==c.__html||m.__html==t.innerHTML)||(t.innerHTML=m.__html),e.__k=[];else if(c&&(t.innerHTML=""),Qe(e.type=="template"?t.content:t,he(l)?l:[l],e,n,s,b=="foreignObject"?"http://www.w3.org/1999/xhtml":r,a,d,a?a[0]:n.__k&&Q(n,0),u,p),a!=null)for(h=a.length;h--;)Se(a[h]);u||(h="value",b=="progress"&&k==null?t.removeAttribute("value"):k!=null&&(k!==t[h]||b=="progress"&&!k||b=="option"&&k!=w[h])&&ne(t,h,k,w[h],r),h="checked",D!=null&&D!=t[h]&&ne(t,h,D,w[h],r))}return t}function Ce(t,e,n){try{if(typeof t=="function"){var s=typeof t.__u=="function";s&&t.__u(),s&&e==null||(t.__u=t(e))}else t.current=e}catch(r){F.__e(r,n)}}function nt(t,e,n){var s,r;if(F.unmount&&F.unmount(t),(s=t.ref)&&(s.current&&s.current!=t.__e||Ce(s,null,e)),(s=t.__c)!=null){if(s.componentWillUnmount)try{s.componentWillUnmount()}catch(a){F.__e(a,e)}s.base=s.__P=null}if(s=t.__k)for(r=0;r<s.length;r++)s[r]&&nt(s[r],e,n||typeof t.type!="function");n||Se(t.__e),t.__c=t.__=t.__e=void 0}function _t(t,e,n){return this.constructor(t,n)}function fe(t,e,n){var s,r,a,d;e==document&&(e=document.documentElement),F.__&&F.__(t,e),r=(s=!1)?null:e.__k,a=[],d=[],Ee(e,t=e.__k=se(pe,null,[t]),r||ee,ee,e.namespaceURI,r?null:e.firstChild?ue.call(e.childNodes):null,a,r?r.__e:e.firstChild,s,d),et(a,t,d)}ue=ze.slice,F={__e:function(t,e,n,s){for(var r,a,d;e=e.__;)if((r=e.__c)&&!r.__)try{if((a=r.constructor)&&a.getDerivedStateFromError!=null&&(r.setState(a.getDerivedStateFromError(t)),d=r.__d),r.componentDidCatch!=null&&(r.componentDidCatch(t,s||{}),d=r.__d),d)return r.__E=r}catch(u){t=u}throw t}},je=0,ae.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=K({},this.state),typeof t=="function"&&(t=t(K({},n),this.props)),t&&K(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Ye(this))},ae.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Ye(this))},ae.prototype.render=pe,X=[],Ke=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Xe=function(t,e){return t.__v.__b-e.__v.__b},oe.__r=0,Je=/(PointerCapture)$|Capture$/i,De=0,be=$e(!1),we=$e(!0);const ft=["id","title","content","type","status","category","tags","recurrence","date","header","icon","priority","createdDate","scheduledDate","startDate","dueDate","doneDate","cancelledDate","created","modified","filename"];function Te(t){const e=new Set(ft);for(const n of t)Object.keys(n.extra||{}).forEach(s=>e.add("extra."+s));return Array.from(e)}function J(t,e){if(e.startsWith("extra.")){const n=e.substring(6);return t.extra?.[n]}return t[e]}const mt="\\d{4}[-/]\\d{2}[-/]\\d{2}",gt=new RegExp(mt),vt=/#([\p{L}\p{N}_\/-]+)/gu,yt=/\(([^:：]+)::\s*([^)]+)\)/g,Fe=/^\s*-\s*\[[ xX-]\]/,bt=/^\s*-\s*\[x\]/i,wt=/^\s*-\s*\[-\]/;function it(t){return t.replace(/\//g,"-")}function Ie(t,e){let n=t.clone(),s=t.clone();switch(e){case"年":n=t.clone().startOf("year"),s=t.clone().endOf("year");break;case"季":n=t.clone().startOf("quarter"),s=t.clone().endOf("quarter");break;case"月":n=t.clone().startOf("month"),s=t.clone().endOf("month");break;case"周":n=t.clone().startOf("week"),s=t.clone().endOf("week");break;case"天":default:n=t.clone().startOf("day"),s=t.clone().endOf("day")}return{startDate:n,endDate:s}}const kt="think",xt=["=","!=","includes","regex",">","<"],G={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕"},Me="无日期",me="think-dashboard-style",Dt=`
.think-table{width:100%;border:1px solid #ccc;border-collapse:collapse;}
.think-table th,.think-table td{border:1px solid #ccc;padding:4px;}
.think-table th{background:#f0f0f0;text-align:center;}
.think-table td{text-align:left;}
.think-table td.empty{background:#f9f9f9;}
.tag-pill{background:#e0e0e0;border-radius:4px;padding:0 6px;margin-right:6px;font-size:90%;display:inline-block;}
.task-done{text-decoration:line-through;color:gray;}
.module-header{display:flex;align-items:center;padding:4px 8px;background:#eee;cursor:pointer;}
.module-title{flex:1;font-weight:bold;}
.module-toggle{margin-left:4px;}
.module-content{padding:6px 8px;}
.think-module a{color:black;text-decoration:none;}
`.trim();function St(t){let e=t.replace(/^\s*-\s*\[[ xX]\]\s*/,"").trim();e=e.replace(/#[\p{L}\p{N}_-]+/gu,"");let n=e.split(/[\s(]/).find(s=>s&&s.trim());return n=n?.replace(new RegExp("^\\p{Extended_Pictographic}\\uFE0F?","u"),"").trim(),n?n.trim():""}function Et(t){if(t.includes("🔺"))return"highest";if(t.includes("⏫"))return"high";if(t.includes("🔼"))return"medium";if(t.includes("🔽"))return"low";if(t.includes("⏬"))return"lowest"}function Ct(t,e,n,s){const r=e;if(!Fe.test(r))return null;let a="open";bt.test(r)?a="done":wt.test(r)&&(a="cancelled");const u=(r.match(vt)||[]).map($=>$.replace("#",""));let p="none";const h=r.match(/🔁\s*([^\n📅⏳🛫➕✅❌]*)/);h&&h[1]&&(p=h[1].trim());const m={};let c;for(;(c=yt.exec(r))!==null;){const $=c[1].trim(),i=c[2].trim(),_=$.toLowerCase();if(["主题","标签","tag","tags"].includes(_))i.split(/[,，]/).forEach(f=>{const y=f.trim().replace(/^#/,"");y&&u.push(y)});else{const f=Number(i);let y=i;i!==""&&!isNaN(f)?y=f:/^(true|false)$/i.test(i)&&(y=i.toLowerCase()==="true"),m[$]=y}}const l=$=>{const i=r.match(new RegExp(`${$}\\s*(${gt.source})`));return i?it(i[1]):void 0},v=l(G.done),k=l(G.cancelled),D=l(G.due),w=l(G.scheduled),g=l(G.start),b=l(G.created),Y=Et(r);let I;const L=r.replace(Fe,"").trim(),M=L.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let P=L;M&&(I=M[1],P=P.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),P=St(P);const V={id:`${t}#${n}`,title:P||"",content:r.trim(),type:"task",status:a,category:"任务",tags:Array.from(new Set(u)),recurrence:p,date:void 0,created:0,modified:0,extra:{}};return I&&(V.icon=I,m.图标=I),Y&&(V.priority=Y),b&&(V.createdDate=b),w&&(V.scheduledDate=w),g&&(V.startDate=g),D&&(V.dueDate=D),v&&(V.doneDate=v,a==="done"&&(V.date=v)),k&&(V.cancelledDate=k,a==="cancelled"&&(V.date=k)),a==="open"&&(V.date=D||w||g||b),V.extra=m,V}function Tt(t,e,n,s,r){const a=e.slice(n+1,s);let d="",u=null,p,h;const m=[],c={};let l=null,v="",k=!1,D=null;for(let g=0;g<a.length;g++){const b=a[g],Y=b.trim();if(k)v+=(v?`
`:"")+b;else{if(Y==="")continue;const I=Y.match(/^([^:：]{1,20})::\s*(.*)$/);if(I){const L=I[1].trim(),M=I[2]||"",P=L.toLowerCase();if(["分类","类别","category"].includes(P))u=M.trim();else if(["主题","标签","tag","tags"].includes(P))l=M.trim();else if(["状态","status"].includes(P))p=M.trim();else if(["日期","date"].includes(P))h=it(M.trim());else if(["内容","content"].includes(P))k=!0,v=M;else if(["图标","icon"].includes(P))D=M.trim(),c.图标=D;else{const V=Number(M.trim());let $=M.trim();$!==""&&!isNaN(V)?$=V:/^(true|false)$/i.test($)&&($=$.toLowerCase()==="true"),c[L]=$}}else k=!0,v=b}}l&&l.split(/[,，]/).map(g=>g.trim()).filter(Boolean).forEach(g=>m.push(g.replace(/^#/,""))),v.trim()!==""?d=v.trim().split(/\r?\n/)[0]:l&&(d=l.split(/[,，]/).map(g=>g.trim()).filter(Boolean).join(", ")),d=d.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),d&&(d=d.slice(0,10)),u||(u=r||"");const w={id:`${t}#${n+1}`,title:d||"",content:v.trim(),type:"block",status:p,category:u,tags:Array.from(new Set(m)),recurrence:"none",date:h,created:0,modified:0,extra:c};return D&&(w.icon=D),w}function Nt(t,e=250){let n=0,s=null;return function(...r){const a=Date.now();a-n>=e?(n=a,t.apply(this,r)):(clearTimeout(s),s=setTimeout(()=>{n=Date.now(),t.apply(this,r)},e-(a-n)))}}class z{constructor(e){this.items=[],this.fileIndex=new Map,this.changeListeners=new Set,this._emitThrottled=Nt(()=>this._emitChange(),250),this.app=e,z.instance=this}async scanAll(){this.items=[],this.fileIndex.clear();const e=this.app.vault.getMarkdownFiles();for(const n of e)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(e){try{const s=(await this.app.vault.read(e)).split(/\r?\n/),r=e.path,a=e.parent?.name||"",d=[],p=this.app.metadataCache.getFileCache(e)?.headings||[];let h=0,m=[],c="";for(let l=0;l<s.length;l++){const v=s[l];if(h<p.length&&p[h].position.start.line===l){const w=p[h].heading,g=w.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];m=g.map(Y=>Y.replace("#","")).filter(Boolean);let b=w;for(const Y of g)b=b.replace(Y,"").trim();c=b||"",h++;continue}if(v.trim()==="<!-- start -->"){const D=s.indexOf("<!-- end -->",l+1);if(D!==-1){const w=Tt(r,s,l,D,a);if(w){w.created=e.stat.ctime,w.modified=e.stat.mtime,c&&(w.header=c),w.tags=Array.from(new Set([...m,...w.tags]));let g=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;w.filename=g,d.push(w)}l=D;continue}}const k=Ct(r,v,l+1,a);if(k){k.tags=Array.from(new Set([...m,...k.tags])),k.created=e.stat.ctime,k.modified=e.stat.mtime,c&&(k.header=c);let D=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;k.filename=D,d.push(k)}}return this.fileIndex.has(r)&&(this.items=this.items.filter(l=>l.id&&!l.id.startsWith(r+"#"))),this.fileIndex.set(r,d),this.items.push(...d),d}catch(n){return console.error("ThinkPlugin: 扫描文件失败",e.path,n),[]}}removeFileItems(e){this.fileIndex.has(e)&&(this.fileIndex.delete(e),this.items=this.items.filter(n=>!n.id.startsWith(e+"#")))}removeFile(e){this.removeFileItems(e)}queryItems(e=[],n=[]){let s=this.items.filter(r=>(e||[]).every(a=>this._matchItem(r,a)));return n.length>0&&s.sort((r,a)=>{for(const d of n){const u=J(r,d.field),p=J(a,d.field);if(!(u==null&&p==null)){if(u==null)return d.dir==="asc"?1:-1;if(p==null)return d.dir==="asc"?-1:1;if(typeof u=="number"&&typeof p=="number"){if(u!==p)return d.dir==="asc"?u-p:p-u}else{const h=String(u),m=String(p);if(h!==m)return d.dir==="asc"?h.localeCompare(m):m.localeCompare(h)}}}return 0}),s}query(e=[],n=[]){return this.queryItems(e,n)}async markItemDone(e){const n=e.split("#"),s=n[0],r=Number(n[1])||0,a=this.app.vault.getAbstractFileByPath(s);if(a instanceof A.TFile)try{const u=(await this.app.vault.read(a)).split(/\r?\n/);if(r<=0||r>u.length)return;const p=u[r-1];if(!/^\s*-\s*\[ \]/.test(p))return;const h=window.moment,m=h().format("YYYY-MM-DD"),c=h().format("HH:mm");let l=p;if(l=l.replace(/(\s|^)(时长::[^\s\(\)]+)/g,(k,D,w)=>k.includes("(")&&k.includes(")")?k:`${D}(${w})`),/\(时长::[^\)]+\)/.test(l)?l=l.replace(/\((时长::[^\)]+)\)/,`(时间::${c}) ($1)`):/时长::[^\s]+/.test(l)?l=l.replace(/(时长::[^\s]+)/,`(时间::${c}) ($1)`):/🔁/.test(l)?l=l.replace(/(🔁)/,`(时间::${c}) $1`):l=l+` (时间::${c})`,l=l.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(l)||(l="- [x] "+l.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")),l=l.replace(/\s*✅\s*\d{4}-\d{2}-\d{2}$/,""),l=l.trim()+` ✅ ${m}`,p.includes("🔁")){const k=w=>{let g=w;g=g.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]"),g=g.replace(/\s*✅\s*\d{4}[-/]\d{2}[-/]\d{2}/,""),g=g.replace(/\(时间::\d{2}:\d{2}\)/,"");const b=w.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/),Y=window.moment;let I=1,L="day",M=!1;b&&(b[1]&&(I=parseInt(b[1])),L=b[2],L.endsWith("s")&&(L=L.slice(0,-1)),M=!!b[3]);const $=(M?Y():(()=>{const i=w.match(/📅\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(i)return Y(i[1],["YYYY-MM-DD","YYYY/MM/DD"]);const _=w.match(/⏳\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(_)return Y(_[1],["YYYY-MM-DD","YYYY/MM/DD"]);const f=w.match(/🛫\s*(\d{4}[-/]\d{2}[-/]\d{2})/);return f?Y(f[1],["YYYY-MM-DD","YYYY/MM/DD"]):Y()})()).clone().add(I,L+(I>1?"s":"")).format("YYYY-MM-DD");return/📅\s*\d{4}-\d{2}-\d{2}/.test(g)&&(g=g.replace(/📅\s*\d{4}[-/]\d{2}[-/]\d{2}/,`📅 ${$}`)),/⏳\s*\d{4}-\d{2}-\d{2}/.test(g)&&(g=g.replace(/⏳\s*\d{4}[-/]\d{2}[-/]\d{2}/,`⏳ ${$}`)),/🛫\s*\d{4}-\d{2}-\d{2}/.test(g)&&(g=g.replace(/🛫\s*\d{4}[-/]\d{2}[-/]\d{2}/,`🛫 ${$}`)),g=g.trim(),g};u[r-1]=l;const D=k(p);u.splice(r,0,D)}else u[r-1]=l;await this.app.vault.modify(a,u.join(`
`)),await this.scanFile(a),this._emitChange()}catch(d){console.error("ThinkPlugin: 标记任务完成时发生错误",d)}}_emitChange(){this.changeListeners.forEach(e=>{try{e()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}subscribe(e){this.changeListeners.add(e)}unsubscribe(e){this.changeListeners.delete(e)}notifyChange(){this._emitThrottled()}_matchItem(e,n){const s=J(e,n.field),r=n.value;if(n.op==="="||n.op==="!="){const a=s!=null&&r!=null&&String(s)===String(r);return n.op==="="?a:!a}if(n.op==="includes")return s==null?!1:Array.isArray(s)?s.some(a=>String(a).includes(String(r))):String(s).includes(String(r));if(n.op==="regex"){if(s==null)return!1;try{const a=new RegExp(String(r));return Array.isArray(s)?s.some(d=>a.test(String(d))):a.test(String(s))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",r),!1}}if(n.op===">"||n.op==="<"){if(s==null)return!1;const a=Number(s),d=Number(r);if(!isNaN(a)&&!isNaN(d))return n.op===">"?a>d:a<d;const u=Date.parse(String(s)),p=Date.parse(String(r));if(!isNaN(u)&&!isNaN(p))return n.op===">"?u>p:u<p;const h=String(s),m=String(r);return n.op===">"?h>m:h<m}return!1}}var At=0;function o(t,e,n,s,r,a){e||(e={});var d,u,p=e;if("ref"in p)for(u in p={},e)u=="ref"?d=e[u]:p[u]=e[u];var h={type:t,props:p,key:n,ref:d,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--At,__i:-1,__u:0,__source:r,__self:a};if(typeof t=="function"&&(d=t.defaultProps))for(u in d)p[u]===void 0&&(p[u]=d[u]);return F.vnode&&F.vnode(h),h}function ce(t){const e=t.lastIndexOf("#"),n=e>=0?t.substring(0,e):t,s=e>=0?t.substring(e+1):"";return`obsidian://advanced-uri?vault=${encodeURIComponent(z.instance.app.vault.getName())}&filepath=${encodeURIComponent(n)}${s?"&line="+s:""}`}function st({done:t,onMarkDone:e}){const n="task-checkbox"+(t?" done":"");return o("input",{type:"checkbox",class:n,checked:t,onClick:t?r=>r.preventDefault():void 0,onChange:r=>{!t&&e&&e()}})}function Yt({items:t,rowField:e,colField:n}){if(!e||!n)return o("div",{children:"（TableView 需要配置 rowField 和 colField）"});const s=[],r=[],a={};return t.forEach(d=>{const u=String(J(d,e)??Me),p=String(J(d,n)??Me);a[u]||(a[u]={},s.push(u)),a[u][p]||(a[u][p]=[]),a[u][p].push(d),r.includes(p)||r.push(p)}),s.sort(),r.sort(),o("table",{class:"think-table",children:[o("thead",{children:o("tr",{children:[o("th",{children:e}),r.map(d=>o("th",{children:d},d))]})}),o("tbody",{children:s.map(d=>o("tr",{children:[o("td",{children:o("strong",{children:d})}),r.map(u=>{const p=a[d]?.[u]||[];return p.length?o("td",{children:p.map(h=>o("div",{children:Vt(h)},h.id))},u):o("td",{class:"empty"},u)})]},d))})]})}function Vt(t){if(t.type==="task"){const e=t.status==="done";return o("span",{children:[o(st,{done:e,onMarkDone:()=>z.instance.markItemDone(t.id)}),t.icon&&o("span",{class:"task-icon",children:t.icon}),o("a",{href:ce(t.id),target:"_blank",rel:"noopener",children:t.title})]})}return o("a",{href:ce(t.id),target:"_blank",rel:"noopener",children:t.title})}const $t={打卡:"#d2cceb",任务:"#caebf3",计划:"#d8ecb2",总结:"#E5D5B9",事件:"#94e2d6",感受:"#93daf0",思考:"#f09393"};function Ft(t){return $t[t]||"#e0e0e0"}function It(t){const{groupField:e,showMeta:n=!0,fields:s}=t;let r=t.items,a=null,d=[];if(e){a={};for(const m of r){const c=String(J(m,e)??"(none)");a[c]||(a[c]=[],d.push(c)),a[c].push(m)}d.sort()}const u=m=>{const c=m.status==="done";return o("div",{style:"margin-bottom:4px;line-height:1.5;",children:[o(st,{done:c,onMarkDone:()=>z.instance.markItemDone(m.id)}),o("a",{href:ce(m.id),target:"_blank",rel:"noopener",class:c?"task-done":"",children:m.title}),m.icon&&o("span",{class:"tag-pill",children:m.icon}),m.tags.map(l=>o("span",{class:"tag-pill",children:l},l))]})},p=m=>o("div",{style:`\r
        display:grid;\r
        grid-template-columns:auto minmax(180px,1fr);\r
        align-items:start;\r
        gap:8px;\r
        margin-bottom:8px;\r
      `,children:[n&&o("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:[o("span",{class:"tag-pill",style:`background:${Ft(m.category)};`,children:m.category}),m.date&&o("span",{class:"tag-pill",children:m.date}),m.extra.图标&&o("span",{class:"tag-pill",children:m.extra.图标})]}),o("div",{style:"white-space:pre-wrap;line-height:1.5;",children:o("a",{href:ce(m.id),target:"_blank",rel:"noopener",children:m.content})})]}),h=m=>m.type==="task"?u(m):p(m);return o("div",{children:a?d.map(m=>o("div",{children:[o("h5",{children:m}),a[m].map(h)]},m)):r.map(h)})}function Mt(t){return o("div",{children:"（Timeline 视图暂未实现）"})}function Lt(t){return o("div",{children:"（Calendar 日视图暂未实现）"})}function Pt(t){return o("div",{children:"（Chart 图表视图暂未实现）"})}function Ot(t){return Array.isArray(t)?t.join(", "):t==null?"":String(t)}function Bt({items:t,fields:e}){const n=e&&e.length?e:Te(t);return o("div",{children:o("table",{class:"think-table",style:"min-width:100%; white-space:nowrap;",children:[o("thead",{children:o("tr",{children:n.map(s=>o("th",{children:s},s))})}),o("tbody",{children:t.map(s=>o("tr",{children:n.map(r=>o("td",{children:Ot(J(s,r))},r))},s.id))})]})})}var te,O,ge,Le,de=0,rt=[],B=F,Pe=B.__b,Oe=B.__r,Be=B.diffed,He=B.__c,Re=B.unmount,We=B.__;function Ne(t,e){B.__h&&B.__h(O,t,de||e),de=0;var n=O.__H||(O.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function j(t){return de=1,Ht(lt,t)}function Ht(t,e,n){var s=Ne(te++,2);if(s.t=t,!s.__c&&(s.__=[lt(void 0,e),function(u){var p=s.__N?s.__N[0]:s.__[0],h=s.t(p,u);p!==h&&(s.__N=[h,s.__[1]],s.__c.setState({}))}],s.__c=O,!O.__f)){var r=function(u,p,h){if(!s.__c.__H)return!0;var m=s.__c.__H.__.filter(function(l){return!!l.__c});if(m.every(function(l){return!l.__N}))return!a||a.call(this,u,p,h);var c=s.__c.props!==u;return m.forEach(function(l){if(l.__N){var v=l.__[0];l.__=l.__N,l.__N=void 0,v!==l.__[0]&&(c=!0)}}),a&&a.call(this,u,p,h)||c};O.__f=!0;var a=O.shouldComponentUpdate,d=O.componentWillUpdate;O.componentWillUpdate=function(u,p,h){if(this.__e){var m=a;a=void 0,r(u,p,h),a=m}d&&d.call(this,u,p,h)},O.shouldComponentUpdate=r}return s.__N||s.__}function ke(t,e){var n=Ne(te++,3);!B.__s&&at(n.__H,e)&&(n.__=t,n.u=e,O.__H.__h.push(n))}function Rt(t){return de=5,Wt(function(){return{current:t}},[])}function Wt(t,e){var n=Ne(te++,7);return at(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Ut(){for(var t;t=rt.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(le),t.__H.__h.forEach(xe),t.__H.__h=[]}catch(e){t.__H.__h=[],B.__e(e,t.__v)}}B.__b=function(t){O=null,Pe&&Pe(t)},B.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),We&&We(t,e)},B.__r=function(t){Oe&&Oe(t),te=0;var e=(O=t.__c).__H;e&&(ge===O?(e.__h=[],O.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(le),e.__h.forEach(xe),e.__h=[],te=0)),ge=O},B.diffed=function(t){Be&&Be(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(rt.push(e)!==1&&Le===B.requestAnimationFrame||((Le=B.requestAnimationFrame)||qt)(Ut)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),ge=O=null},B.__c=function(t,e){e.some(function(n){try{n.__h.forEach(le),n.__h=n.__h.filter(function(s){return!s.__||xe(s)})}catch(s){e.some(function(r){r.__h&&(r.__h=[])}),e=[],B.__e(s,n.__v)}}),He&&He(t,e)},B.unmount=function(t){Re&&Re(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(s){try{le(s)}catch(r){e=r}}),n.__H=void 0,e&&B.__e(e,n.__v))};var Ue=typeof requestAnimationFrame=="function";function qt(t){var e,n=function(){clearTimeout(s),Ue&&cancelAnimationFrame(e),setTimeout(t)},s=setTimeout(n,35);Ue&&(e=requestAnimationFrame(n))}function le(t){var e=O,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),O=e}function xe(t){var e=O;t.__c=t.__(),O=e}function at(t,e){return!t||t.length!==e.length||e.some(function(n,s){return n!==t[s]})}function lt(t,e){return typeof e=="function"?e(t):e}function jt({storageKey:t="inputSettings",plugin:e}){const n=e[t]||{},[s,r]=j(typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))),a=(u,p)=>r(h=>({...h,[u]:p})),d=async()=>{e[t]=s,await e.persistAll(),alert("已保存配置")};return o("div",{style:"display:flex;flex-direction:column;gap:6px;max-width:420px;",children:[o("label",{children:["主题 (可层级“生活/健康”)：",o("input",{value:s.topic||"",onInput:u=>a("topic",u.target.value)})]}),o("label",{children:["图标 (emoji)：",o("input",{value:s.icon||"",onInput:u=>a("icon",u.target.value),placeholder:"✨"})]}),o("label",{children:["任务字段清单 (逗号分隔)：",o("input",{value:s.taskFields||"",onInput:u=>a("taskFields",u.target.value),placeholder:"status,icon,repeat,…"})]}),o("label",{children:["Block 字段清单 (逗号分隔)：",o("input",{value:s.blockFields||"",onInput:u=>a("blockFields",u.target.value),placeholder:"分类,周期,日期,主题,图标,内容"})]}),o("button",{style:"margin-top:8px;",onClick:d,children:"💾 保存配置"})]})}const ot={TableView:Yt,BlockView:It,TimelineView:Mt,CalendarView:Lt,ChartView:Pt,ExcelView:Bt,SettingsFormView:jt},ie=ot,qe=Object.keys(ot);class Kt extends A.PluginSettingTab{constructor(e,n){super(e,n),this.selectedDashName="",this.plugin=n,n.dashboards.length>0&&(this.selectedDashName=n.dashboards[0].name)}display(){const{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Think 仪表盘 配置编辑"});const n=this.plugin.dataStore.queryItems(),s=Te(n),r=new Set,a=new Set,d=new Set,u=new Set,p=new Set;for(const i of n)(i.tags||[]).forEach(_=>_&&r.add(_)),i.category&&a.add(i.category),i.status&&d.add(i.status),i.recurrence&&u.add(i.recurrence),i.type&&p.add(i.type);const h=e.createEl("datalist");h.id="think-tags-list",Array.from(r).forEach(i=>h.createEl("option",{value:i}));const m=e.createEl("datalist");m.id="think-category-list",Array.from(a).forEach(i=>m.createEl("option",{value:i}));const c=e.createEl("datalist");c.id="think-status-list",Array.from(d).forEach(i=>c.createEl("option",{value:i}));const l=e.createEl("datalist");l.id="think-recurrence-list",Array.from(u).forEach(i=>l.createEl("option",{value:i}));const v=e.createEl("datalist");v.id="think-type-list",Array.from(p).forEach(i=>v.createEl("option",{value:i}));const k=e.createEl("datalist");k.id="think-fields-list",s.forEach(i=>k.createEl("option",{value:i}));const D=e.createEl("select");for(const i of this.plugin.dashboards){const _=D.createEl("option",{text:i.name});_.value=i.name,i.name===this.selectedDashName&&(_.selected=!0)}D.onchange=()=>{this.selectedDashName=D.value,this.display()};const w=e.createEl("button",{text:"新建仪表盘"});if(w.style.marginLeft="8px",w.onclick=()=>{let i="新仪表盘",_=i,f=1;for(;this.plugin.dashboards.find(x=>x.name===_);)_=i+f++;const y={name:_,modules:[]};this.plugin.dashboards.push(y),this.selectedDashName=_,this.plugin.saveData({dashboards:this.plugin.dashboards}),new A.Notice("已添加新仪表盘配置"),this.display()},this.plugin.dashboards.length>0){const i=e.createEl("button",{text:"删除当前仪表盘"});i.style.marginLeft="8px",i.onclick=()=>{const _=this.plugin.dashboards.findIndex(f=>f.name===this.selectedDashName);_>=0&&(this.plugin.dashboards.splice(_,1),new A.Notice(`已删除配置：${this.selectedDashName}`),this.selectedDashName=this.plugin.dashboards.length?this.plugin.dashboards[0].name:"",this.plugin.saveData({dashboards:this.plugin.dashboards}),this.display())}}e.createEl("hr");const g=this.plugin.dashboards.find(i=>i.name===this.selectedDashName);if(!g)return;const b=e.createEl("fieldset");b.createEl("legend",{text:"基础设置"}),new A.Setting(b).setName("仪表盘名称").addText(i=>{i.setValue(g.name).onChange(_=>{g.name=_.trim()})}),new A.Setting(b).setName("数据源路径").addText(i=>{i.setValue(g.path||"").onChange(_=>{g.path=_.trim()})}),new A.Setting(b).setName("标签 (用逗号分隔)").addText(i=>{const _=Array.isArray(g.tags)?g.tags.join(","):g.tags||"";i.setValue(_).onChange(f=>{g.tags=f.split(/[,，]/).map(y=>y.trim()).filter(y=>y)})}),new A.Setting(b).setName("初始视图").addDropdown(i=>{["年","季","月","周","天"].forEach(f=>i.addOption(f,f)),i.setValue(g.initialView||"月"),i.onChange(f=>{g.initialView=f})});const Y=new Date,I=`${Y.getFullYear()}-${String(Y.getMonth()+1).padStart(2,"0")}-${String(Y.getDate()).padStart(2,"0")}`,L=g.initialDate||I;g.initialDate||(g.initialDate=L),new A.Setting(b).setName("初始日期").addText(i=>{i.inputEl.type="date",i.setValue(L).onChange(_=>{g.initialDate=_})}),e.createEl("h3",{text:"模块列表"}),g.modules.forEach((i,_)=>{const f=e.createEl("fieldset");f.style.border="1px solid #ccc",f.style.padding="8px",f.style.marginBottom="8px",f.dataset.index=_.toString(),f.createEl("legend",{text:`${i.title||"模块"} (${i.view})`}),new A.Setting(f).setName("模块标题").addText(E=>{E.setValue(i.title).onChange(C=>i.title=C)}),new A.Setting(f).setName("视图类型").addDropdown(E=>{qe.forEach(C=>E.addOption(C,C)),E.setValue(i.view),E.onChange(C=>{i.view=C,this.display()})}),new A.Setting(f).addToggle(E=>{E.setValue(!!i.collapsed).onChange(C=>{i.collapsed=C})}).setName("默认折叠"),i.view==="TableView"&&(new A.Setting(f).setName("行字段 (rowField)").addText(E=>{E.setValue(i.props?.rowField||"").onChange(C=>{i.props||(i.props={}),i.props.rowField=C.trim()}),E.inputEl.setAttr("list","think-fields-list")}),new A.Setting(f).setName("列字段 (colField)").addText(E=>{E.setValue(i.props?.colField||"").onChange(C=>{i.props||(i.props={}),i.props.colField=C.trim()}),E.inputEl.setAttr("list","think-fields-list")})),(i.view==="BlockView"||i.view==="TimelineView")&&new A.Setting(f).setName("分组字段").addText(E=>{E.setValue(i.group||"").onChange(C=>{i.group=C.trim()||void 0}),E.inputEl.setAttr("list","think-fields-list")}),i.view!=="TableView"&&i.view!=="ChartView"&&i.view!=="CalendarView"&&new A.Setting(f).setName("显示字段 (用逗号分隔)").addText(E=>{const C=i.fields?i.fields.join(","):"";E.setPlaceholder("如 title,tags,date").setValue(C).onChange(R=>{const H=R.split(/[,，]/).map(U=>U.trim()).filter(U=>U);i.fields=H.length>0?H:void 0}),E.inputEl.setAttr("list","think-fields-list")});const y=f.createDiv();y.style.borderTop="1px dashed #ccc",y.style.marginTop="6px",y.style.paddingTop="6px",y.createEl("strong",{text:"过滤规则"}),(i.filters||[]).forEach((E,C)=>{const R=y.createDiv({cls:"filter-row"});R.style.display="flex",R.style.marginBottom="4px";const H=R.createEl("input");H.type="text",H.style.flex="0 0 30%",H.value=E.field,H.setAttr("list","think-fields-list");const U=R.createEl("select");xt.forEach(q=>{U.add(new Option(q,q,!1,q===E.op))}),U.onchange=()=>{E.op=U.value};const W=R.createEl("input");W.type="text",W.style.flex="0 0 30%",W.value=String(E.value);const Z=()=>{W.removeAttribute("list");const q=H.value.trim();q==="tags"?W.setAttr("list","think-tags-list"):q==="category"?W.setAttr("list","think-category-list"):q==="status"?W.setAttr("list","think-status-list"):q==="recurrence"?W.setAttr("list","think-recurrence-list"):q==="type"&&W.setAttr("list","think-type-list")};Z(),H.onchange=()=>{E.field=H.value.trim(),Z()},W.onchange=()=>{E.value=W.value};const _e=R.createEl("button",{text:"删除"});_e.onclick=()=>{i.filters.splice(C,1),this.display()}});const x=y.createEl("button",{text:"+ 添加过滤条件"});x.onclick=()=>{i.filters||(i.filters=[]),i.filters.push({field:"",op:"=",value:""}),this.display()};const S=f.createDiv();S.style.borderTop="1px dashed #ccc",S.style.marginTop="6px",S.style.paddingTop="6px",S.createEl("strong",{text:"排序规则"}),(i.sort||[]).forEach((E,C)=>{const R=S.createDiv({cls:"sort-row"});R.style.display="flex",R.style.marginBottom="4px";const H=R.createEl("input");H.type="text",H.style.flex="0 0 40%",H.value=E.field,H.setAttr("list","think-fields-list"),H.onchange=()=>E.field=H.value.trim();const U=R.createEl("select");[["asc","升序"],["desc","降序"]].forEach(([Z,_e])=>{U.add(new Option(_e,Z,!1,Z===E.dir))}),U.onchange=()=>{E.dir=U.value};const W=R.createEl("button",{text:"删除"});W.style.marginLeft="4px",W.onclick=()=>{i.sort.splice(C,1),this.display()}});const T=S.createEl("button",{text:"+ 添加排序条件"});T.onclick=()=>{i.sort||(i.sort=[]),i.sort.push({field:"",dir:"asc"}),this.display()};const N=f.createDiv({cls:"module-actions"});if(N.style.textAlign="right",_>0){const E=N.createEl("button",{text:"↑ 上移"});E.onclick=()=>{const C=g.modules;[C[_-1],C[_]]=[C[_],C[_-1]],this.display()}}if(_<g.modules.length-1){const E=N.createEl("button",{text:"↓ 下移"});E.onclick=()=>{const C=g.modules;[C[_+1],C[_]]=[C[_],C[_+1]],this.display()}}const ct=N.createEl("button",{text:"删除模块"});ct.onclick=()=>{g.modules.splice(_,1),this.display()}});const M=e.createDiv(),P=M.createEl("select");qe.forEach(i=>{P.add(new Option(i,i))});const V=M.createEl("button",{text:"添加模块"});V.style.marginLeft="6px",V.onclick=()=>{const _={view:P.value,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};g.modules.push(_),this.display()},e.createEl("hr");const $=e.createEl("button",{text:"保存配置"});$.onclick=()=>{if(g.name!==this.selectedDashName&&this.plugin.dashboards.some(i=>i!==g&&i.name===g.name)){new A.Notice("配置名称已存在，请更换名称");return}this.plugin.saveData({dashboards:this.plugin.dashboards}).then(()=>{new A.Notice("仪表盘配置已保存"),this.plugin.refreshAllDashboards(),this.selectedDashName=g.name,this.display()})}}}function ve({module:t,children:e}){const[n,s]=j(!!t.collapsed),r=Rt(null),a=()=>s(u=>!u),d=u=>{if(u.metaKey||u.ctrlKey){const p=!n,h=new CustomEvent("think-toggle-all",{detail:p});document.querySelectorAll(".think-module").forEach(m=>m.dispatchEvent(h))}else a()};return ke(()=>{const u=h=>{const m=h.detail;s(m)},p=r.current;if(p)return p.addEventListener("think-toggle-all",u),()=>p.removeEventListener("think-toggle-all",u)},[]),o("div",{class:"think-module",ref:r,children:[o("div",{class:"module-header",onClick:d,title:"点击折叠/展开；Ctrl/⌘ + 点击：全部折叠/展开",children:[o("span",{class:"module-title",children:t.title}),o("span",{class:"module-toggle",children:n?"▶":"▼"})]}),!n&&o("div",{class:"module-content",children:e})]})}const Xt=["一","二","三","四"];function ye({config:t,dataStore:e,plugin:n}){const s=window.moment,r=t.initialView||"月",a=t.initialDate?s(t.initialDate,"YYYY-MM-DD"):s(),[d,u]=j(r),[p,h]=j(a),[m,c]=j(!1),[l,v]=j(null),[k,D]=j("TableView"),[w,g]=j(0),[b,Y]=j("");ke(()=>{const i=()=>g(_=>_+1);return e.subscribe(i),()=>e.unsubscribe(i)},[e]),ke(()=>{m?(v((_=>typeof structuredClone=="function"?structuredClone(_):JSON.parse(JSON.stringify(_)))(t)),D("TableView")):v(null)},[m,t]),Ie(p,d);const I=(i,_)=>{switch(_){case"年":return i.format("YYYY年");case"季":{const f=i.quarter();return`${i.year()}年${Xt[f-1]}季度`}case"月":return i.format("YYYY-MM");case"周":return i.format("YYYY-[W]WW");case"天":return i.format("YYYY-MM-DD");default:return i.format("YYYY-MM-DD")}},L=()=>{switch(d){case"年":h(p.clone().subtract(1,"year"));break;case"季":h(p.clone().subtract(1,"quarter"));break;case"月":h(p.clone().subtract(1,"month"));break;case"周":h(p.clone().subtract(1,"week"));break;case"天":h(p.clone().subtract(1,"day"));break}},M=()=>{switch(d){case"年":h(p.clone().add(1,"year"));break;case"季":h(p.clone().add(1,"quarter"));break;case"月":h(p.clone().add(1,"month"));break;case"周":h(p.clone().add(1,"week"));break;case"天":h(p.clone().add(1,"day"));break}},P=()=>h(s()),V=i=>{if(i.view==="SettingsFormView"){const x=ie[i.view];return o(ve,{module:i,children:o(x,{plugin:n,storageKey:"inputSettings"})})}let _=e.queryItems(i.filters||[],i.sort||[]);if(t.tags?.length&&(_=_.filter(x=>x.tags.some(S=>t.tags.some(T=>S.includes(T))))),t.path&&t.path.trim()!==""){const x=t.path.trim(),S=z.instance.app.vault.getAbstractFileByPath(x);if(S){if(S instanceof A.TFolder){const T=x.endsWith("/")?x:x+"/";_=_.filter(N=>N.id.startsWith(T))}else if(S instanceof A.TFile){const T=x+"#";_=_.filter(N=>N.id.startsWith(T))}}else{const T=x.endsWith("/")?x:x+"/";_=_.filter(N=>N.id.startsWith(T))}}if(d&&p){const{startDate:x,endDate:S}=Ie(p,d);_=_.filter(T=>{if(!T.date)return!0;const N=s(T.date,"YYYY-MM-DD");return N.isSameOrAfter(x)&&N.isSameOrBefore(S)})}if(b.trim()){const x=b.toLowerCase();_=_.filter(S=>(S.title+" "+S.content).toLowerCase().includes(x))}const f=ie[i.view];if(!f)return o(ve,{module:i,children:o("div",{children:["未知视图: ",i.view]})});const y={...i.props||{}};return i.group&&(y.groupField=i.group),i.fields&&(y.fields=i.fields),o(ve,{module:i,children:o(f,{items:_,...y})})},$=()=>{if(!l)return;const i=t.name,_=l.name.trim();if(_===""){new A.Notice("名称不能为空");return}if(_!==i&&n.dashboards.some(y=>y!==t&&y.name===_)){new A.Notice("配置名称已存在，请更换名称");return}t.name=_,t.path=l.path||"",t.tags=l.tags||[],t.initialView=l.initialView||"月",t.initialDate=l.initialDate||s().format("YYYY-MM-DD"),t.modules=l.modules,_!==i&&n.activeDashboards.forEach(y=>{y.configName===i&&(y.configName=_)});const f=n.persistAll?n.persistAll():n.saveData({dashboards:n.dashboards,inputSettings:n.inputSettings});Promise.resolve(f).then(()=>{new A.Notice("仪表盘配置已保存"),n.refreshAllDashboards()}),c(!1)};return o("div",{children:[o("div",{class:"tp-toolbar",style:"margin-bottom:8px;",children:[["年","季","月","周","天"].map(i=>o("button",{onClick:()=>u(i),class:i===d?"active":"",children:i})),o("button",{disabled:!0,style:"font-weight:bold;margin:0 4px;background:#fff;cursor:default;",children:I(p,d)}),o("button",{onClick:L,children:"←"}),o("button",{onClick:M,children:"→"}),o("button",{onClick:P,children:"＝"}),o("input",{placeholder:"快速过滤…",style:"margin-left:4px;",value:b,onInput:i=>Y(i.target.value)}),o("button",{onClick:()=>c(!m),style:"margin-left:4px;",children:"⚙︎"})]}),m&&l&&o("div",{style:"border:1px solid #eee;padding:12px;margin-bottom:12px;border-radius:8px;background:#fcfcfc;",children:[o("h3",{style:"margin-top:0;",children:"编辑配置"}),o("fieldset",{style:"margin-bottom:10px;",children:[o("legend",{children:"基础设置"}),o("label",{children:["配置名称:",o("input",{type:"text",value:l.name,onInput:i=>v({...l,name:i.target.value})})]}),o("br",{}),o("label",{children:["数据源路径:",o("input",{type:"text",value:l.path||"",onInput:i=>v({...l,path:i.target.value})})]}),o("br",{}),o("label",{children:["标签(逗号分隔):",o("input",{type:"text",value:Array.isArray(l.tags)?l.tags.join(","):l.tags||"",onInput:i=>{const f=i.target.value.split(/[,，]/).map(y=>y.trim()).filter(Boolean);v({...l,tags:f})}})]}),o("br",{}),o("label",{children:["初始视图:",o("select",{value:l.initialView||"月",onChange:i=>v({...l,initialView:i.target.value}),children:["年","季","月","周","天"].map(i=>o("option",{value:i,children:i}))})]}),o("br",{}),o("label",{children:["初始日期:",o("input",{type:"date",value:l.initialDate||s().format("YYYY-MM-DD"),onChange:i=>v({...l,initialDate:i.target.value})})]}),o("br",{})]}),o("div",{id:"modulesArea",children:[l.modules.map((i,_)=>o("fieldset",{style:"border:1px solid #ccc;padding:8px;margin-bottom:8px;",children:[o("legend",{children:[i.title||"模块"," (",i.view,")"]}),o("div",{children:o("label",{children:["模块标题:",o("input",{type:"text",value:i.title,onInput:f=>{const y=[...l.modules];y[_]={...i,title:f.target.value},v({...l,modules:y})}})]})}),o("div",{children:o("label",{children:["视图类型:",o("select",{value:i.view,onChange:f=>{const y=[...l.modules];y[_]={...i,view:f.target.value},v({...l,modules:y})},children:Object.keys(ie).map(f=>o("option",{value:f,children:f}))})]})}),o("div",{children:o("label",{children:["默认折叠:",o("input",{type:"checkbox",checked:!!i.collapsed,onChange:f=>{const y=[...l.modules];y[_]={...i,collapsed:f.target.checked},v({...l,modules:y})}})]})}),i.view==="TableView"&&o("div",{children:[o("label",{children:["行字段:",o("input",{type:"text",value:i.props?.rowField||"",onInput:f=>{const y=[...l.modules];y[_]={...i,props:{...i.props,rowField:f.target.value}},v({...l,modules:y})}})]}),o("br",{}),o("label",{children:["列字段:",o("input",{type:"text",value:i.props?.colField||"",onInput:f=>{const y=[...l.modules];y[_]={...i,props:{...i.props,colField:f.target.value}},v({...l,modules:y})}})]})]}),(i.view==="BlockView"||i.view==="TimelineView")&&o("div",{children:o("label",{children:["分组字段:",o("input",{type:"text",value:i.group||"",onInput:f=>{const y=[...l.modules];y[_]={...i,group:f.target.value||void 0},v({...l,modules:y})}})]})}),i.view!=="TableView"&&i.view!=="ChartView"&&i.view!=="CalendarView"&&o("div",{children:o("label",{children:["显示字段(逗号分隔 / * 为动态):",o("input",{type:"text",placeholder:"如 title,tags,date 或 *",value:i.fields?i.fields.join(","):"",onInput:f=>{const y=f.target.value,x=y.trim()==="*"?["*"]:y.split(/[,，]/).map(T=>T.trim()).filter(Boolean),S=[...l.modules];S[_]={...i,fields:x.length?x:void 0},v({...l,modules:S})}})]})}),o("div",{style:"border-top:1px dashed #ccc;margin-top:6px;padding-top:6px;",children:[o("strong",{children:"过滤规则"}),(i.filters||[]).map((f,y)=>o("div",{style:"display:flex;margin-bottom:4px;",children:[o("input",{type:"text",style:"flex:0 0 30%;",value:f.field,onInput:x=>{const S=x.target.value,T=[...i.filters||[]];T[y]={...f,field:S};const N=[...l.modules];N[_]={...i,filters:T},v({...l,modules:N})}}),o("select",{value:f.op,onChange:x=>{const S=x.target.value,T=[...i.filters||[]];T[y]={...f,op:S};const N=[...l.modules];N[_]={...i,filters:T},v({...l,modules:N})},children:["=","!=","includes","regex",">","<"].map(x=>o("option",{value:x,children:x}))}),o("input",{type:"text",style:"flex:0 0 30%;",value:String(f.value),onInput:x=>{const S=x.target.value,T=[...i.filters||[]];T[y]={...f,value:S};const N=[...l.modules];N[_]={...i,filters:T},v({...l,modules:N})}}),o("button",{onClick:()=>{const x=[...i.filters||[]];x.splice(y,1);const S=[...l.modules];S[_]={...i,filters:x},v({...l,modules:S})},children:"删除"})]})),o("button",{onClick:()=>{const f=[...i.filters||[],{field:"",op:"=",value:""}],y=[...l.modules];y[_]={...i,filters:f},v({...l,modules:y})},children:"+ 添加过滤条件"})]}),o("div",{style:"border-top:1px dashed #ccc;margin-top:6px;padding-top:6px;",children:[o("strong",{children:"排序规则"}),(i.sort||[]).map((f,y)=>o("div",{style:"display:flex;margin-bottom:4px;",children:[o("input",{type:"text",style:"flex:0 0 40%;",value:f.field,onInput:x=>{const S=x.target.value,T=[...i.sort||[]];T[y]={...f,field:S};const N=[...l.modules];N[_]={...i,sort:T},v({...l,modules:N})}}),o("select",{value:f.dir,onChange:x=>{const S=x.target.value,T=[...i.sort||[]];T[y]={...f,dir:S};const N=[...l.modules];N[_]={...i,sort:T},v({...l,modules:N})},children:[o("option",{value:"asc",children:"升序"}),o("option",{value:"desc",children:"降序"})]}),o("button",{style:"margin-left:4px;",onClick:()=>{const x=[...i.sort||[]];x.splice(y,1);const S=[...l.modules];S[_]={...i,sort:x},v({...l,modules:S})},children:"删除"})]})),o("button",{onClick:()=>{const f=[...i.sort||[],{field:"",dir:"asc"}],y=[...l.modules];y[_]={...i,sort:f},v({...l,modules:y})},children:"+ 添加排序条件"})]}),o("div",{style:"text-align:right;",children:[_>0&&o("button",{onClick:()=>{const f=[...l.modules];[f[_-1],f[_]]=[f[_],f[_-1]],v({...l,modules:f})},children:"↑ 上移"}),_<l.modules.length-1&&o("button",{onClick:()=>{const f=[...l.modules];[f[_],f[_+1]]=[f[_+1],f[_]],v({...l,modules:f})},children:"↓ 下移"}),o("button",{onClick:()=>{const f=[...l.modules];f.splice(_,1),v({...l,modules:f})},children:"删除模块"})]})]})),o("div",{children:[o("select",{value:k,onChange:i=>D(i.target.value),children:Object.keys(ie).map(i=>o("option",{value:i,children:i}))}),o("button",{style:"margin-left:6px;",onClick:()=>{const i={view:k,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};v({...l,modules:[...l.modules,i]})},children:"添加模块"})]})]}),o("hr",{}),o("button",{onClick:$,children:"保存配置"}),o("button",{style:"margin-left:8px;",onClick:()=>c(!1),children:"取消"}),o("datalist",{id:"fields-list",children:Te(e.query()).map(i=>o("option",{value:i}))})]}),!m&&t.modules.map(i=>V(i))]})}class Jt extends A.Plugin{constructor(){super(...arguments),this.dashboards=[],this.activeDashboards=[],this.inputSettings={}}async onload(){console.log("ThinkPlugin 加载 - 重构版");const e=await this.loadData();e?.dashboards&&(this.dashboards=e.dashboards),this.dashboards.length===0&&this._createDefaultDashboard(),this.inputSettings=e?.inputSettings??{};for(const r of this.dashboards)for(const a of r.modules)a.view==="ListView"&&(a.view="BlockView");this.dataStore=new z(this.app),await this.dataStore.scanAll();const n=this.app.vault.on.bind(this.app.vault),s=r=>this.dataStore.scanFile(r).then(()=>this.dataStore.notifyChange());this.registerEvent(n("modify",r=>{r instanceof A.TFile&&r.extension==="md"&&s(r)})),this.registerEvent(n("create",r=>{r instanceof A.TFile&&r.extension==="md"&&s(r)})),this.registerEvent(n("delete",r=>{r instanceof A.TFile&&r.extension==="md"&&(this.dataStore.removeFileItems(r.path),this.dataStore.notifyChange())})),this.registerEvent(n("rename",(r,a)=>{r instanceof A.TFile&&r.extension==="md"&&(this.dataStore.removeFileItems(a),s(r))})),this.registerMarkdownCodeBlockProcessor(kt,(r,a)=>{let d,u;try{const h=r.trim()?JSON.parse(r):{};Array.isArray(h.modules)?u={name:h.name||"__inline__",path:h.path||"",tags:h.tags||[],initialView:h.initialView||"月",initialDate:h.initialDate||"",modules:h.modules}:d=h.config||h.dashboard||h.name}catch(h){console.warn("ThinkPlugin: 仪表盘代码块 JSON 解析失败，使用默认",h)}if(u){fe(se(ye,{config:u,dataStore:this.dataStore,plugin:this}),a),this.activeDashboards.push({container:a,configName:u.name});return}!d&&this.dashboards.length&&(d=this.dashboards[0].name);const p=this.dashboards.find(h=>h.name===d);if(!p){a.createDiv({text:`找不到名称为 "${d}" 的仪表盘配置`});return}fe(se(ye,{config:p,dataStore:this.dataStore,plugin:this}),a),this.activeDashboards.push({container:a,configName:p.name})}),this._injectStyles(),this.addSettingTab(new Kt(this.app,this))}onunload(){const e=document.getElementById(me);e&&e.remove(),console.log("ThinkPlugin 卸载")}refreshAllDashboards(){this.activeDashboards=this.activeDashboards.filter(e=>document.body.contains(e.container));for(const e of this.activeDashboards){const n=this.dashboards.find(s=>s.name===e.configName);n&&fe(se(ye,{config:n,dataStore:this.dataStore,plugin:this}),e.container)}}async persistAll(){const e={dashboards:this.dashboards,inputSettings:this.inputSettings};await this.saveData(e)}_createDefaultDashboard(){const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,s={name:"默认仪表盘",path:"",tags:[],initialView:"月",initialDate:n,modules:[{view:"BlockView",title:"未完成任务",collapsed:!1,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"open"}],sort:[],props:{}},{view:"BlockView",title:"已完成任务",collapsed:!0,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"done"}],sort:[{field:"date",dir:"desc"}],props:{}}]};this.dashboards.push(s)}_injectStyles(){if(document.getElementById(me))return;const e=document.createElement("style");e.id=me,e.textContent=Dt,document.head.appendChild(e)}}module.exports=Jt;
//# sourceMappingURL=main.js.map
