"use strict";const W=require("obsidian");class Ie{constructor(t){this.app=t}async readFile(t){return this.app.vault.read(t)}getMarkdownFiles(){return this.app.vault.getMarkdownFiles()}async writeFile(t,n){return this.app.vault.modify(t,n)}getByPath(t){return this.app.vault.getAbstractFileByPath(t)??null}async ensureFile(t,n=""){const r=this.getByPath(t);return r instanceof TFile?r:this.app.vault.create(t,n)}onVault(t,n){return this.app.vault.on(t,n)}}const Ne=["id","title","content","type","status","category","tags","recurrence","startISO","endISO","startMs","endMs","header","icon","priority","createdDate","scheduledDate","startDate","dueDate","doneDate","cancelledDate","created","modified","filename"];function Ae(e){const t=new Set(Ne);return e.forEach(n=>Object.keys(n.extra||{}).forEach(r=>t.add("extra."+r))),Array.from(t)}function et(e,t){return t.startsWith("extra.")?e.extra?.[t.slice(6)]:e[t]}const Le="\\d{4}[-/]\\d{2}[-/]\\d{2}",xt=new RegExp(Le),Pe=/#([\p{L}\p{N}_\/-]+)/gu,He=/\(([^:：]+)::\s*([^)]+)\)/g,Kt=/^\s*-\s*\[[ xX-]\]/,Be=/^\s*-\s*\[x\]/i,Re=/^\s*-\s*\[-\]/;function Tt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var gt={exports:{}},We=gt.exports,Jt;function qe(){return Jt||(Jt=1,function(e,t){(function(n,r){e.exports=r()})(We,function(){var n=1e3,r=6e4,s=36e5,i="millisecond",a="second",l="minute",u="hour",c="day",h="week",o="month",g="quarter",m="year",M="date",$="Invalid Date",d=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,p=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,y={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(_){var b=["th","st","nd","rd"],v=_%100;return"["+_+(b[(v-20)%10]||b[v]||b[0])+"]"}},x=function(_,b,v){var D=String(_);return!D||D.length>=b?_:""+Array(b+1-D.length).join(v)+_},F={s:x,z:function(_){var b=-_.utcOffset(),v=Math.abs(b),D=Math.floor(v/60),w=v%60;return(b<=0?"+":"-")+x(D,2,"0")+":"+x(w,2,"0")},m:function _(b,v){if(b.date()<v.date())return-_(v,b);var D=12*(v.year()-b.year())+(v.month()-b.month()),w=b.clone().add(D,o),T=v-w<0,Y=b.clone().add(D+(T?-1:1),o);return+(-(D+(v-w)/(T?w-Y:Y-w))||0)},a:function(_){return _<0?Math.ceil(_)||0:Math.floor(_)},p:function(_){return{M:o,y:m,w:h,d:c,D:M,h:u,m:l,s:a,ms:i,Q:g}[_]||String(_||"").toLowerCase().replace(/s$/,"")},u:function(_){return _===void 0}},A="en",C={};C[A]=y;var k="$isDayjsObject",N=function(_){return _ instanceof L||!(!_||!_[k])},O=function _(b,v,D){var w;if(!b)return A;if(typeof b=="string"){var T=b.toLowerCase();C[T]&&(w=T),v&&(C[T]=v,w=T);var Y=b.split("-");if(!w&&Y.length>1)return _(Y[0])}else{var E=b.name;C[E]=b,w=E}return!D&&w&&(A=w),w||!D&&A},I=function(_,b){if(N(_))return _.clone();var v=typeof b=="object"?b:{};return v.date=_,v.args=arguments,new L(v)},S=F;S.l=O,S.i=N,S.w=function(_,b){return I(_,{locale:b.$L,utc:b.$u,x:b.$x,$offset:b.$offset})};var L=function(){function _(v){this.$L=O(v.locale,null,!0),this.parse(v),this.$x=this.$x||v.x||{},this[k]=!0}var b=_.prototype;return b.parse=function(v){this.$d=function(D){var w=D.date,T=D.utc;if(w===null)return new Date(NaN);if(S.u(w))return new Date;if(w instanceof Date)return new Date(w);if(typeof w=="string"&&!/Z$/i.test(w)){var Y=w.match(d);if(Y){var E=Y[2]-1||0,H=(Y[7]||"0").substring(0,3);return T?new Date(Date.UTC(Y[1],E,Y[3]||1,Y[4]||0,Y[5]||0,Y[6]||0,H)):new Date(Y[1],E,Y[3]||1,Y[4]||0,Y[5]||0,Y[6]||0,H)}}return new Date(w)}(v),this.init()},b.init=function(){var v=this.$d;this.$y=v.getFullYear(),this.$M=v.getMonth(),this.$D=v.getDate(),this.$W=v.getDay(),this.$H=v.getHours(),this.$m=v.getMinutes(),this.$s=v.getSeconds(),this.$ms=v.getMilliseconds()},b.$utils=function(){return S},b.isValid=function(){return this.$d.toString()!==$},b.isSame=function(v,D){var w=I(v);return this.startOf(D)<=w&&w<=this.endOf(D)},b.isAfter=function(v,D){return I(v)<this.startOf(D)},b.isBefore=function(v,D){return this.endOf(D)<I(v)},b.$g=function(v,D,w){return S.u(v)?this[D]:this.set(w,v)},b.unix=function(){return Math.floor(this.valueOf()/1e3)},b.valueOf=function(){return this.$d.getTime()},b.startOf=function(v,D){var w=this,T=!!S.u(D)||D,Y=S.p(v),E=function(G,z){var K=S.w(w.$u?Date.UTC(w.$y,z,G):new Date(w.$y,z,G),w);return T?K:K.endOf(c)},H=function(G,z){return S.w(w.toDate()[G].apply(w.toDate("s"),(T?[0,0,0,0]:[23,59,59,999]).slice(z)),w)},R=this.$W,j=this.$M,X=this.$D,it="set"+(this.$u?"UTC":"");switch(Y){case m:return T?E(1,0):E(31,11);case o:return T?E(1,j):E(0,j+1);case h:var nt=this.$locale().weekStart||0,ot=(R<nt?R+7:R)-nt;return E(T?X-ot:X+(6-ot),j);case c:case M:return H(it+"Hours",0);case u:return H(it+"Minutes",1);case l:return H(it+"Seconds",2);case a:return H(it+"Milliseconds",3);default:return this.clone()}},b.endOf=function(v){return this.startOf(v,!1)},b.$set=function(v,D){var w,T=S.p(v),Y="set"+(this.$u?"UTC":""),E=(w={},w[c]=Y+"Date",w[M]=Y+"Date",w[o]=Y+"Month",w[m]=Y+"FullYear",w[u]=Y+"Hours",w[l]=Y+"Minutes",w[a]=Y+"Seconds",w[i]=Y+"Milliseconds",w)[T],H=T===c?this.$D+(D-this.$W):D;if(T===o||T===m){var R=this.clone().set(M,1);R.$d[E](H),R.init(),this.$d=R.set(M,Math.min(this.$D,R.daysInMonth())).$d}else E&&this.$d[E](H);return this.init(),this},b.set=function(v,D){return this.clone().$set(v,D)},b.get=function(v){return this[S.p(v)]()},b.add=function(v,D){var w,T=this;v=Number(v);var Y=S.p(D),E=function(j){var X=I(T);return S.w(X.date(X.date()+Math.round(j*v)),T)};if(Y===o)return this.set(o,this.$M+v);if(Y===m)return this.set(m,this.$y+v);if(Y===c)return E(1);if(Y===h)return E(7);var H=(w={},w[l]=r,w[u]=s,w[a]=n,w)[Y]||1,R=this.$d.getTime()+v*H;return S.w(R,this)},b.subtract=function(v,D){return this.add(-1*v,D)},b.format=function(v){var D=this,w=this.$locale();if(!this.isValid())return w.invalidDate||$;var T=v||"YYYY-MM-DDTHH:mm:ssZ",Y=S.z(this),E=this.$H,H=this.$m,R=this.$M,j=w.weekdays,X=w.months,it=w.meridiem,nt=function(z,K,rt,at){return z&&(z[K]||z(D,T))||rt[K].slice(0,at)},ot=function(z){return S.s(E%12||12,z,"0")},G=it||function(z,K,rt){var at=z<12?"AM":"PM";return rt?at.toLowerCase():at};return T.replace(p,function(z,K){return K||function(rt){switch(rt){case"YY":return String(D.$y).slice(-2);case"YYYY":return S.s(D.$y,4,"0");case"M":return R+1;case"MM":return S.s(R+1,2,"0");case"MMM":return nt(w.monthsShort,R,X,3);case"MMMM":return nt(X,R);case"D":return D.$D;case"DD":return S.s(D.$D,2,"0");case"d":return String(D.$W);case"dd":return nt(w.weekdaysMin,D.$W,j,2);case"ddd":return nt(w.weekdaysShort,D.$W,j,3);case"dddd":return j[D.$W];case"H":return String(E);case"HH":return S.s(E,2,"0");case"h":return ot(1);case"hh":return ot(2);case"a":return G(E,H,!0);case"A":return G(E,H,!1);case"m":return String(H);case"mm":return S.s(H,2,"0");case"s":return String(D.$s);case"ss":return S.s(D.$s,2,"0");case"SSS":return S.s(D.$ms,3,"0");case"Z":return Y}return null}(z)||Y.replace(":","")})},b.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},b.diff=function(v,D,w){var T,Y=this,E=S.p(D),H=I(v),R=(H.utcOffset()-this.utcOffset())*r,j=this-H,X=function(){return S.m(Y,H)};switch(E){case m:T=X()/12;break;case o:T=X();break;case g:T=X()/3;break;case h:T=(j-R)/6048e5;break;case c:T=(j-R)/864e5;break;case u:T=j/s;break;case l:T=j/r;break;case a:T=j/n;break;default:T=j}return w?T:S.a(T)},b.daysInMonth=function(){return this.endOf(o).$D},b.$locale=function(){return C[this.$L]},b.locale=function(v,D){if(!v)return this.$L;var w=this.clone(),T=O(v,D,!0);return T&&(w.$L=T),w},b.clone=function(){return S.w(this.$d,this)},b.toDate=function(){return new Date(this.valueOf())},b.toJSON=function(){return this.isValid()?this.toISOString():null},b.toISOString=function(){return this.$d.toISOString()},b.toString=function(){return this.$d.toUTCString()},_}(),Z=L.prototype;return I.prototype=Z,[["$ms",i],["$s",a],["$m",l],["$H",u],["$W",c],["$M",o],["$y",m],["$D",M]].forEach(function(_){Z[_[1]]=function(b){return this.$g(b,_[0],_[1])}}),I.extend=function(_,b){return _.$i||(_(b,L,I),_.$i=!0),I},I.locale=O,I.isDayjs=N,I.unix=function(_){return I(1e3*_)},I.en=C[A],I.Ls=C,I.p={},I})}(gt)),gt.exports}var Ue=qe();const J=Tt(Ue);var yt={exports:{}},je=yt.exports,Gt;function Ve(){return Gt||(Gt=1,function(e,t){(function(n,r){e.exports=r()})(je,function(){var n="month",r="quarter";return function(s,i){var a=i.prototype;a.quarter=function(c){return this.$utils().u(c)?Math.ceil((this.month()+1)/3):this.month(this.month()%3+3*(c-1))};var l=a.add;a.add=function(c,h){return c=Number(c),this.$utils().p(h)===r?this.add(3*c,n):l.bind(this)(c,h)};var u=a.startOf;a.startOf=function(c,h){var o=this.$utils(),g=!!o.u(h)||h;if(o.p(c)===r){var m=this.quarter()-1;return g?this.month(3*m).startOf(n).startOf("day"):this.month(3*m+2).endOf(n).endOf("day")}return u.bind(this)(c,h)}}})}(yt)),yt.exports}var ze=Ve();const Ze=Tt(ze);var vt={exports:{}},Qe=vt.exports,te;function Xe(){return te||(te=1,function(e,t){(function(n,r){e.exports=r()})(Qe,function(){var n="week",r="year";return function(s,i,a){var l=i.prototype;l.week=function(u){if(u===void 0&&(u=null),u!==null)return this.add(7*(u-this.week()),"day");var c=this.$locale().yearStart||1;if(this.month()===11&&this.date()>25){var h=a(this).startOf(r).add(1,r).date(c),o=a(this).endOf(n);if(h.isBefore(o))return 1}var g=a(this).startOf(r).date(c).startOf(n).subtract(1,"millisecond"),m=this.diff(g,n,!0);return m<0?a(this).startOf("week").week():Math.ceil(m)},l.weeks=function(u){return u===void 0&&(u=null),this.week(u)}}})}(vt)),vt.exports}var Ke=Xe();const Je=Tt(Ke);var kt={exports:{}},Ge=kt.exports,ee;function tn(){return ee||(ee=1,function(e,t){(function(n,r){e.exports=r()})(Ge,function(){var n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},r=/(\[[^[]*\])|([-_:/.,()\s]+)|(A|a|Q|YYYY|YY?|ww?|MM?M?M?|Do|DD?|hh?|HH?|mm?|ss?|S{1,3}|z|ZZ?)/g,s=/\d/,i=/\d\d/,a=/\d\d?/,l=/\d*[^-_:/,()\s\d]+/,u={},c=function(d){return(d=+d)+(d>68?1900:2e3)},h=function(d){return function(p){this[d]=+p}},o=[/[+-]\d\d:?(\d\d)?|Z/,function(d){(this.zone||(this.zone={})).offset=function(p){if(!p||p==="Z")return 0;var y=p.match(/([+-]|\d\d)/g),x=60*y[1]+(+y[2]||0);return x===0?0:y[0]==="+"?-x:x}(d)}],g=function(d){var p=u[d];return p&&(p.indexOf?p:p.s.concat(p.f))},m=function(d,p){var y,x=u.meridiem;if(x){for(var F=1;F<=24;F+=1)if(d.indexOf(x(F,0,p))>-1){y=F>12;break}}else y=d===(p?"pm":"PM");return y},M={A:[l,function(d){this.afternoon=m(d,!1)}],a:[l,function(d){this.afternoon=m(d,!0)}],Q:[s,function(d){this.month=3*(d-1)+1}],S:[s,function(d){this.milliseconds=100*+d}],SS:[i,function(d){this.milliseconds=10*+d}],SSS:[/\d{3}/,function(d){this.milliseconds=+d}],s:[a,h("seconds")],ss:[a,h("seconds")],m:[a,h("minutes")],mm:[a,h("minutes")],H:[a,h("hours")],h:[a,h("hours")],HH:[a,h("hours")],hh:[a,h("hours")],D:[a,h("day")],DD:[i,h("day")],Do:[l,function(d){var p=u.ordinal,y=d.match(/\d+/);if(this.day=y[0],p)for(var x=1;x<=31;x+=1)p(x).replace(/\[|\]/g,"")===d&&(this.day=x)}],w:[a,h("week")],ww:[i,h("week")],M:[a,h("month")],MM:[i,h("month")],MMM:[l,function(d){var p=g("months"),y=(g("monthsShort")||p.map(function(x){return x.slice(0,3)})).indexOf(d)+1;if(y<1)throw new Error;this.month=y%12||y}],MMMM:[l,function(d){var p=g("months").indexOf(d)+1;if(p<1)throw new Error;this.month=p%12||p}],Y:[/[+-]?\d+/,h("year")],YY:[i,function(d){this.year=c(d)}],YYYY:[/\d{4}/,h("year")],Z:o,ZZ:o};function $(d){var p,y;p=d,y=u&&u.formats;for(var x=(d=p.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(I,S,L){var Z=L&&L.toUpperCase();return S||y[L]||n[L]||y[Z].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(_,b,v){return b||v.slice(1)})})).match(r),F=x.length,A=0;A<F;A+=1){var C=x[A],k=M[C],N=k&&k[0],O=k&&k[1];x[A]=O?{regex:N,parser:O}:C.replace(/^\[|\]$/g,"")}return function(I){for(var S={},L=0,Z=0;L<F;L+=1){var _=x[L];if(typeof _=="string")Z+=_.length;else{var b=_.regex,v=_.parser,D=I.slice(Z),w=b.exec(D)[0];v.call(S,w),I=I.replace(w,"")}}return function(T){var Y=T.afternoon;if(Y!==void 0){var E=T.hours;Y?E<12&&(T.hours+=12):E===12&&(T.hours=0),delete T.afternoon}}(S),S}}return function(d,p,y){y.p.customParseFormat=!0,d&&d.parseTwoDigitYear&&(c=d.parseTwoDigitYear);var x=p.prototype,F=x.parse;x.parse=function(A){var C=A.date,k=A.utc,N=A.args;this.$u=k;var O=N[1];if(typeof O=="string"){var I=N[2]===!0,S=N[3]===!0,L=I||S,Z=N[2];S&&(Z=N[2]),u=this.$locale(),!I&&Z&&(u=y.Ls[Z]),this.$d=function(D,w,T,Y){try{if(["x","X"].indexOf(w)>-1)return new Date((w==="X"?1e3:1)*D);var E=$(w)(D),H=E.year,R=E.month,j=E.day,X=E.hours,it=E.minutes,nt=E.seconds,ot=E.milliseconds,G=E.zone,z=E.week,K=new Date,rt=j||(H||R?1:K.getDate()),at=H||K.getFullYear(),pt=0;H&&!R||(pt=R>0?R-1:K.getMonth());var _t,It=X||0,Nt=it||0,At=nt||0,Lt=ot||0;return G?new Date(Date.UTC(at,pt,rt,It,Nt,At,Lt+60*G.offset*1e3)):T?new Date(Date.UTC(at,pt,rt,It,Nt,At,Lt)):(_t=new Date(at,pt,rt,It,Nt,At,Lt),z&&(_t=Y(_t).week(z).toDate()),_t)}catch{return new Date("")}}(C,O,k,y),this.init(),Z&&Z!==!0&&(this.$L=this.locale(Z).$L),L&&C!=this.format(O)&&(this.$d=new Date("")),u={}}else if(O instanceof Array)for(var _=O.length,b=1;b<=_;b+=1){N[1]=O[b-1];var v=y.apply(this,N);if(v.isValid()){this.$d=v.$d,this.$L=v.$L,this.init();break}b===_&&(this.$d=new Date(""))}else F.call(this,A)}}})}(kt)),kt.exports}var en=tn();const nn=Tt(en);J.extend(Ze);J.extend(Je);J.extend(nn);const qt=()=>J().format("YYYY-MM-DD"),rn=()=>J().format("HH:mm");function Ct(e){const t=(e||"").replace(/\//g,"-"),n=J(t,["YYYY-MM-DD","YYYY-M-D","YYYY/MM/DD","YYYY/M/D"],!0);return n.isValid()?n.format("YYYY-MM-DD"):t}const sn="(\\d{4}[-/]\\d{2}[-/]\\d{2})";function an(e,t){const n=Array.isArray(t)?t:[t];for(const r of n){const s=e.match(new RegExp(`${r}\\s*${sn}`));if(s)return Ct(s[1])}}function on(e,t){switch(t){case"年":return{startDate:e.startOf("year"),endDate:e.endOf("year")};case"季":return{startDate:e.startOf("quarter"),endDate:e.endOf("quarter")};case"月":return{startDate:e.startOf("month"),endDate:e.endOf("month")};case"周":return{startDate:e.startOf("week"),endDate:e.endOf("week")};default:return{startDate:e.startOf("day"),endDate:e.endOf("day")}}}const ln="think",V={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕",repeat:"🔁"},ne="无日期";function cn(e){let t=e.replace(/^\s*-\s*\[[ xX-]\]\s*/,"").trim();t=t.replace(/#[\p{L}\p{N}_-]+/gu,"");let n=t.split(/[\s(]/).find(r=>r&&r.trim());return n=n?.replace(new RegExp("^\\p{Extended_Pictographic}\\uFE0F?","u"),"").trim(),n?n.trim():""}function ut(e,t){return an(e,t)}function un(e){if(e.includes("🔺"))return"highest";if(e.includes("⏫"))return"high";if(e.includes("🔼"))return"medium";if(e.includes("🔽"))return"low";if(e.includes("⏬"))return"lowest"}function hn(e,t,n,r){const s=t;if(!Kt.test(s))return null;let i="open";Be.test(s)?i="done":Re.test(s)&&(i="cancelled");const l=(s.match(Pe)||[]).map(N=>N.replace("#",""));let u="none";const c=s.match(/🔁\s*([^\n📅⏳🛫➕✅❌]*)/);c&&c[1]&&(u=c[1].trim());const h={};let o;for(;(o=He.exec(s))!==null;){const N=o[1].trim(),O=o[2].trim(),I=N.toLowerCase();if(["主题","标签","tag","tags"].includes(I))O.split(/[,，]/).forEach(S=>{const L=S.trim().replace(/^#/,"");L&&l.push(L)});else{const S=Number(O);let L=O;O!==""&&!isNaN(S)?L=S:/^(true|false)$/i.test(O)&&(L=O.toLowerCase()==="true"),h[N]=L}}const g=ut(s,V.done),m=ut(s,V.cancelled),M=ut(s,V.due),$=ut(s,V.scheduled),d=ut(s,V.start),p=ut(s,V.created),y=un(s);let x;const F=s.replace(Kt,"").trim(),A=F.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let C=F;A&&(x=A[1],C=C.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),C=cn(C);const k={id:`${e}#${n}`,title:C||"",content:s.trim(),type:"task",status:i,category:"任务",tags:Array.from(new Set(l)),recurrence:u,created:0,modified:0,extra:h};return x&&(k.icon=x),y&&(k.priority=y),p&&(k.createdDate=p),$&&(k.scheduledDate=$),d&&(k.startDate=d),M&&(k.dueDate=M),g&&(k.doneDate=g),m&&(k.cancelledDate=m),k.startISO=d||$||M||p,k.endISO=g||m||M,!k.startISO&&k.status==="open"&&(k.startISO=k.date=k.dueDate||k.scheduledDate||k.startDate||k.createdDate),k.endISO||(k.endISO=k.startISO),k.startISO&&(k.startMs=Date.parse(k.startISO)),k.endISO&&(k.endMs=Date.parse(k.endISO)),i==="done"?k.date=g:i==="cancelled"&&(k.date=m),k}function dn(e,t,n,r,s){const i=t.slice(n+1,r);let a="",l=null,u,c;const h=[],o={};let g=null,m="",M=!1,$=null;for(let p=0;p<i.length;p++){const y=i[p],x=y.trim();if(M)m+=(m?`
`:"")+y;else{if(x==="")continue;const F=x.match(/^([^:：]{1,20})::\s*(.*)$/);if(F){const A=F[1].trim(),C=F[2]||"",k=A.toLowerCase();if(["分类","类别","category"].includes(k))l=C.trim();else if(["主题","标签","tag","tags"].includes(k))g=C.trim();else if(["状态","status"].includes(k))u=C.trim();else if(["日期","date"].includes(k))c=Ct(C.trim());else if(["内容","content"].includes(k))M=!0,m=C;else if(["图标","icon"].includes(k))$=C.trim(),o.图标=$;else{const N=Number(C.trim());let O=C.trim();O!==""&&!isNaN(N)?O=N:/^(true|false)$/i.test(O)&&(O=O.toLowerCase()==="true"),o[A]=O}}else M=!0,m=y}}g&&g.split(/[,，]/).map(p=>p.trim()).filter(Boolean).forEach(p=>h.push(p.replace(/^#/,""))),m.trim()!==""?a=m.trim().split(/\r?\n/)[0]:g&&(a=g.split(/[,，]/).map(p=>p.trim()).filter(Boolean).join(", ")),a=a.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),a&&(a=a.slice(0,10)),l||(l=s||"");const d={id:`${e}#${n+1}`,title:a||"",content:m.trim(),type:"block",status:u,category:l,tags:Array.from(new Set(h)),recurrence:"none",created:0,modified:0,extra:o};return $&&(d.icon=$),d.startISO=c,d.endISO=c,d.startISO&&(d.startMs=Date.parse(d.startISO)),d.endISO&&(d.endMs=d.startMs),d.date=c,d}function fn(e,t=250){let n=0,r=null;return function(...s){const i=Date.now();i-n>=t?(n=i,e.apply(this,s)):(clearTimeout(r),r=setTimeout(()=>{n=Date.now(),e.apply(this,s)},t-(i-n)))}}function pn(e,t,n){let r=e;return r=r.replace(/(\s|^)(时长::[^\s()]+)/g,(s,i)=>s.includes("(")?s:`${i}(${s.trim()})`),/\(时长::[^\)]+\)/.test(r)?r=r.replace(/\((时长::[^\)]+)\)/,`(时间::${n}) ($1)`):/时长::[^\s]+/.test(r)?r=r.replace(/(时长::[^\s]+)/,`(时间::${n}) ($1)`):r.includes(V.repeat)?r=r.replace(V.repeat,`(时间::${n}) ${V.repeat}`):r=`${r} (时间::${n})`,r=r.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(r)||(r=`- [x] ${r.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")}`),r=r.replace(new RegExp(`\\s*${V.done}\\s*${xt.source}$`),""),`${r.trim()} ${V.done} ${t}`}function me(e){const t=e.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/i);if(!t)return null;const n=t[1]?parseInt(t[1],10):1,r=t[2].toLowerCase(),s=!!t[3];return{interval:n,unit:r,whenDone:s}}function _n(e,t,n){if(t)return n;const r=s=>{const i=new RegExp(`${s}\\s*(${xt.source})`),a=e.match(i);return a?Ct(a[1]):null};return r(V.due)||r(V.scheduled)||r(V.start)||n}function mn(e,t){let n=e.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]").replace(new RegExp(`\\s*${V.done}\\s*${xt.source}`),"").replace(/\(时间::\d{2}:\d{2}\)/,"");const r=me(e);if(!r)return n.trim();const a=J(t,["YYYY-MM-DD","YYYY/MM/DD"]).add(r.interval,r.unit).format("YYYY-MM-DD"),l=u=>{const c=new RegExp(`${u}\\s*${xt.source}`);c.test(n)&&(n=n.replace(c,`${u} ${a}`))};return l(V.due),l(V.scheduled),l(V.start),n.trim()}function gn(e,t,n){const r=pn(e,t,n),s=me(e);if(!s)return{completedLine:r};const i=_n(e,s.whenDone,t),a=mn(e,i);return{completedLine:r,nextTaskLine:a}}class yn{static async completeTask(t){const n=ct.instance;if(!n)throw new Error("DataStore not ready");const[r,s]=t.split("#"),i=Number(s),a=n.platform.app.vault.getAbstractFileByPath(r);if(!(a instanceof n.platform.app.vault.constructor.TFile))return;const u=(await n.platform.readFile(a)).split(/\r?\n/);if(i<1||i>u.length)return;const c=u[i-1];if(!/^\s*-\s*\[ \]/.test(c))return;const h=J().format("YYYY-MM-DD"),o=J().format("HH:mm"),{completedLine:g,nextTaskLine:m}=gn(c,h,o);u[i-1]=g,m&&u.splice(i,0,m),await n.platform.writeFile(a,u.join(`
`)),await n.scanFile(a),n.notifyChange()}}class ct{static instance;platform;get app(){return this.platform.app}constructor(t){this.platform=t,ct.instance=this}items=[];fileIndex=new Map;changeListeners=new Set;async scanAll(){this.items=[],this.fileIndex.clear();const t=this.platform.getMarkdownFiles();for(const n of t)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(t){try{const r=(await this.platform.readFile(t)).split(/\r?\n/),s=t.path,i=t.parent?.name||"",a=[],u=this.app.metadataCache.getFileCache(t)?.headings||[];let c=0,h=[],o="";for(let g=0;g<r.length;g++){const m=r[g];if(c<u.length&&u[c].position.start.line===g){const d=u[c].heading,p=d.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];h=p.map(x=>x.replace("#","")).filter(Boolean);let y=d;for(const x of p)y=y.replace(x,"").trim();o=y||"",c++;continue}if(m.trim()==="<!-- start -->"){const $=r.indexOf("<!-- end -->",g+1);if($!==-1){const d=dn(s,r,g,$,i);if(d){d.created=t.stat.ctime,d.modified=t.stat.mtime,o&&(d.header=o),d.tags=Array.from(new Set([...h,...d.tags]));const p=t.name.toLowerCase().endsWith(".md")?t.name.slice(0,-3):t.name;d.filename=p,a.push(d)}g=$;continue}}const M=hn(s,m,g+1,i);if(M){M.tags=Array.from(new Set([...h,...M.tags])),M.created=t.stat.ctime,M.modified=t.stat.mtime,o&&(M.header=o);const $=t.name.toLowerCase().endsWith(".md")?t.name.slice(0,-3):t.name;M.filename=$,a.push(M)}}return this.fileIndex.has(s)&&(this.items=this.items.filter(g=>g.id&&!g.id.startsWith(s+"#"))),this.fileIndex.set(s,a),this.items.push(...a),a}catch(n){return console.error("ThinkPlugin: 扫描文件失败",t.path,n),[]}}removeFileItems(t){this.fileIndex.has(t)&&(this.fileIndex.delete(t),this.items=this.items.filter(n=>!n.id.startsWith(t+"#")))}removeFile(t){this.removeFileItems(t)}queryItems(t=[],n=[]){let r=this.items.filter(s=>(t||[]).every(i=>this._matchItem(s,i)));return n.length>0&&r.sort((s,i)=>{for(const a of n){const l=et(s,a.field),u=et(i,a.field);if(!(l==null&&u==null)){if(l==null)return a.dir==="asc"?1:-1;if(u==null)return a.dir==="asc"?-1:1;if(typeof l=="number"&&typeof u=="number"){if(l!==u)return a.dir==="asc"?l-u:u-l}else{const c=String(l),h=String(u);if(c!==h)return a.dir==="asc"?c.localeCompare(h):h.localeCompare(c)}}}return 0}),r}query(t=[],n=[]){return this.queryItems(t,n)}async markItemDone(t){await yn.completeTask(t)}_emitChange(){this.changeListeners.forEach(t=>{try{t()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}_emitThrottled=fn(()=>this._emitChange(),250);subscribe(t){this.changeListeners.add(t)}unsubscribe(t){this.changeListeners.delete(t)}notifyChange(){this._emitThrottled()}_matchItem(t,n){const r=et(t,n.field),s=n.value;if(n.op==="="||n.op==="!="){const i=r!=null&&s!=null&&String(r)===String(s);return n.op==="="?i:!i}if(n.op==="includes")return r==null?!1:Array.isArray(r)?r.some(i=>String(i).includes(String(s))):String(r).includes(String(s));if(n.op==="regex"){if(r==null)return!1;try{const i=new RegExp(String(s));return Array.isArray(r)?r.some(a=>i.test(String(a))):i.test(String(r))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",s),!1}}if(n.op===">"||n.op==="<"){if(r==null)return!1;const i=Number(r),a=Number(s);if(!isNaN(i)&&!isNaN(a))return n.op===">"?i>a:i<a;const l=Date.parse(String(r)),u=Date.parse(String(s));if(!isNaN(l)&&!isNaN(u))return n.op===">"?l>u:l<u;const c=String(r),h=String(s);return n.op===">"?c>h:c<h}return!1}}class vn{plugin;dataStore;constructor(t,n){this.plugin=t,this.dataStore=n,this.registerEvents()}registerEvents(){const{app:t}=this.plugin,n=t.vault.on.bind(t.vault),r=s=>this.dataStore.scanFile(s).then(()=>this.dataStore.notifyChange());this.plugin.registerEvent(n("modify",s=>{s instanceof W.TFile&&s.extension==="md"&&r(s)})),this.plugin.registerEvent(n("create",s=>{s instanceof W.TFile&&s.extension==="md"&&r(s)})),this.plugin.registerEvent(n("delete",s=>{s instanceof W.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(s.path),this.dataStore.notifyChange())})),this.plugin.registerEvent(n("rename",(s,i)=>{s instanceof W.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(i),r(s))}))}}var Yt,P,ge,lt,re,ye,ve,ke,Ut,Ht,Bt,dt={},be=[],kn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,Ot=Array.isArray;function st(e,t){for(var n in t)e[n]=t[n];return e}function jt(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function we(e,t,n){var r,s,i,a={};for(i in t)i=="key"?r=t[i]:i=="ref"?s=t[i]:a[i]=t[i];if(arguments.length>2&&(a.children=arguments.length>3?Yt.call(arguments,2):n),typeof e=="function"&&e.defaultProps!=null)for(i in e.defaultProps)a[i]===void 0&&(a[i]=e.defaultProps[i]);return bt(e,a,r,s,null)}function bt(e,t,n,r,s){var i={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:s??++ge,__i:-1,__u:0};return s==null&&P.vnode!=null&&P.vnode(i),i}function Et(e){return e.children}function wt(e,t){this.props=e,this.context=t}function ht(e,t){if(t==null)return e.__?ht(e.__,e.__i+1):null;for(var n;t<e.__k.length;t++)if((n=e.__k[t])!=null&&n.__e!=null)return n.__e;return typeof e.type=="function"?ht(e):null}function $e(e){var t,n;if((e=e.__)!=null&&e.__c!=null){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if((n=e.__k[t])!=null&&n.__e!=null){e.__e=e.__c.base=n.__e;break}return $e(e)}}function se(e){(!e.__d&&(e.__d=!0)&&lt.push(e)&&!Dt.__r++||re!=P.debounceRendering)&&((re=P.debounceRendering)||ye)(Dt)}function Dt(){for(var e,t,n,r,s,i,a,l=1;lt.length;)lt.length>l&&lt.sort(ve),e=lt.shift(),l=lt.length,e.__d&&(n=void 0,s=(r=(t=e).__v).__e,i=[],a=[],t.__P&&((n=st({},r)).__v=r.__v+1,P.vnode&&P.vnode(n),Vt(t.__P,n,r,t.__n,t.__P.namespaceURI,32&r.__u?[s]:null,i,s??ht(r),!!(32&r.__u),a),n.__v=r.__v,n.__.__k[n.__i]=n,Se(i,n,a),n.__e!=s&&$e(n)));Dt.__r=0}function xe(e,t,n,r,s,i,a,l,u,c,h){var o,g,m,M,$,d,p=r&&r.__k||be,y=t.length;for(u=bn(n,t,p,u,y),o=0;o<y;o++)(m=n.__k[o])!=null&&(g=m.__i==-1?dt:p[m.__i]||dt,m.__i=o,d=Vt(e,m,g,s,i,a,l,u,c,h),M=m.__e,m.ref&&g.ref!=m.ref&&(g.ref&&zt(g.ref,null,m),h.push(m.ref,m.__c||M,m)),$==null&&M!=null&&($=M),4&m.__u||g.__k===m.__k?u=De(m,u,e):typeof m.type=="function"&&d!==void 0?u=d:M&&(u=M.nextSibling),m.__u&=-7);return n.__e=$,u}function bn(e,t,n,r,s){var i,a,l,u,c,h=n.length,o=h,g=0;for(e.__k=new Array(s),i=0;i<s;i++)(a=t[i])!=null&&typeof a!="boolean"&&typeof a!="function"?(u=i+g,(a=e.__k[i]=typeof a=="string"||typeof a=="number"||typeof a=="bigint"||a.constructor==String?bt(null,a,null,null,null):Ot(a)?bt(Et,{children:a},null,null,null):a.constructor==null&&a.__b>0?bt(a.type,a.props,a.key,a.ref?a.ref:null,a.__v):a).__=e,a.__b=e.__b+1,l=null,(c=a.__i=wn(a,n,u,o))!=-1&&(o--,(l=n[c])&&(l.__u|=2)),l==null||l.__v==null?(c==-1&&(s>h?g--:s<h&&g++),typeof a.type!="function"&&(a.__u|=4)):c!=u&&(c==u-1?g--:c==u+1?g++:(c>u?g--:g++,a.__u|=4))):e.__k[i]=null;if(o)for(i=0;i<h;i++)(l=n[i])!=null&&(2&l.__u)==0&&(l.__e==r&&(r=ht(l)),Te(l,l));return r}function De(e,t,n){var r,s;if(typeof e.type=="function"){for(r=e.__k,s=0;r&&s<r.length;s++)r[s]&&(r[s].__=e,t=De(r[s],t,n));return t}e.__e!=t&&(t&&e.type&&!n.contains(t)&&(t=ht(e)),n.insertBefore(e.__e,t||null),t=e.__e);do t=t&&t.nextSibling;while(t!=null&&t.nodeType==8);return t}function wn(e,t,n,r){var s,i,a,l=e.key,u=e.type,c=t[n],h=c!=null&&(2&c.__u)==0;if(c===null&&e.key==null||h&&l==c.key&&u==c.type)return n;if(r>(h?1:0)){for(s=n-1,i=n+1;s>=0||i<t.length;)if((c=t[a=s>=0?s--:i++])!=null&&(2&c.__u)==0&&l==c.key&&u==c.type)return a}return-1}function ie(e,t,n){t[0]=="-"?e.setProperty(t,n??""):e[t]=n==null?"":typeof n!="number"||kn.test(t)?n:n+"px"}function mt(e,t,n,r,s){var i,a;t:if(t=="style")if(typeof n=="string")e.style.cssText=n;else{if(typeof r=="string"&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||ie(e.style,t,"");if(n)for(t in n)r&&n[t]==r[t]||ie(e.style,t,n[t])}else if(t[0]=="o"&&t[1]=="n")i=t!=(t=t.replace(ke,"$1")),a=t.toLowerCase(),t=a in e||t=="onFocusOut"||t=="onFocusIn"?a.slice(2):t.slice(2),e.l||(e.l={}),e.l[t+i]=n,n?r?n.u=r.u:(n.u=Ut,e.addEventListener(t,i?Bt:Ht,i)):e.removeEventListener(t,i?Bt:Ht,i);else{if(s=="http://www.w3.org/2000/svg")t=t.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(t!="width"&&t!="height"&&t!="href"&&t!="list"&&t!="form"&&t!="tabIndex"&&t!="download"&&t!="rowSpan"&&t!="colSpan"&&t!="role"&&t!="popover"&&t in e)try{e[t]=n??"";break t}catch{}typeof n=="function"||(n==null||n===!1&&t[4]!="-"?e.removeAttribute(t):e.setAttribute(t,t=="popover"&&n==1?"":n))}}function ae(e){return function(t){if(this.l){var n=this.l[t.type+e];if(t.t==null)t.t=Ut++;else if(t.t<n.u)return;return n(P.event?P.event(t):t)}}}function Vt(e,t,n,r,s,i,a,l,u,c){var h,o,g,m,M,$,d,p,y,x,F,A,C,k,N,O,I,S=t.type;if(t.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),i=[l=t.__e=n.__e]),(h=P.__b)&&h(t);t:if(typeof S=="function")try{if(p=t.props,y="prototype"in S&&S.prototype.render,x=(h=S.contextType)&&r[h.__c],F=h?x?x.props.value:h.__:r,n.__c?d=(o=t.__c=n.__c).__=o.__E:(y?t.__c=o=new S(p,F):(t.__c=o=new wt(p,F),o.constructor=S,o.render=xn),x&&x.sub(o),o.props=p,o.state||(o.state={}),o.context=F,o.__n=r,g=o.__d=!0,o.__h=[],o._sb=[]),y&&o.__s==null&&(o.__s=o.state),y&&S.getDerivedStateFromProps!=null&&(o.__s==o.state&&(o.__s=st({},o.__s)),st(o.__s,S.getDerivedStateFromProps(p,o.__s))),m=o.props,M=o.state,o.__v=t,g)y&&S.getDerivedStateFromProps==null&&o.componentWillMount!=null&&o.componentWillMount(),y&&o.componentDidMount!=null&&o.__h.push(o.componentDidMount);else{if(y&&S.getDerivedStateFromProps==null&&p!==m&&o.componentWillReceiveProps!=null&&o.componentWillReceiveProps(p,F),!o.__e&&o.shouldComponentUpdate!=null&&o.shouldComponentUpdate(p,o.__s,F)===!1||t.__v==n.__v){for(t.__v!=n.__v&&(o.props=p,o.state=o.__s,o.__d=!1),t.__e=n.__e,t.__k=n.__k,t.__k.some(function(L){L&&(L.__=t)}),A=0;A<o._sb.length;A++)o.__h.push(o._sb[A]);o._sb=[],o.__h.length&&a.push(o);break t}o.componentWillUpdate!=null&&o.componentWillUpdate(p,o.__s,F),y&&o.componentDidUpdate!=null&&o.__h.push(function(){o.componentDidUpdate(m,M,$)})}if(o.context=F,o.props=p,o.__P=e,o.__e=!1,C=P.__r,k=0,y){for(o.state=o.__s,o.__d=!1,C&&C(t),h=o.render(o.props,o.state,o.context),N=0;N<o._sb.length;N++)o.__h.push(o._sb[N]);o._sb=[]}else do o.__d=!1,C&&C(t),h=o.render(o.props,o.state,o.context),o.state=o.__s;while(o.__d&&++k<25);o.state=o.__s,o.getChildContext!=null&&(r=st(st({},r),o.getChildContext())),y&&!g&&o.getSnapshotBeforeUpdate!=null&&($=o.getSnapshotBeforeUpdate(m,M)),O=h,h!=null&&h.type===Et&&h.key==null&&(O=Me(h.props.children)),l=xe(e,Ot(O)?O:[O],t,n,r,s,i,a,l,u,c),o.base=t.__e,t.__u&=-161,o.__h.length&&a.push(o),d&&(o.__E=o.__=null)}catch(L){if(t.__v=null,u||i!=null)if(L.then){for(t.__u|=u?160:128;l&&l.nodeType==8&&l.nextSibling;)l=l.nextSibling;i[i.indexOf(l)]=null,t.__e=l}else{for(I=i.length;I--;)jt(i[I]);Rt(t)}else t.__e=n.__e,t.__k=n.__k,L.then||Rt(t);P.__e(L,t,n)}else i==null&&t.__v==n.__v?(t.__k=n.__k,t.__e=n.__e):l=t.__e=$n(n.__e,t,n,r,s,i,a,u,c);return(h=P.diffed)&&h(t),128&t.__u?void 0:l}function Rt(e){e&&e.__c&&(e.__c.__e=!0),e&&e.__k&&e.__k.forEach(Rt)}function Se(e,t,n){for(var r=0;r<n.length;r++)zt(n[r],n[++r],n[++r]);P.__c&&P.__c(t,e),e.some(function(s){try{e=s.__h,s.__h=[],e.some(function(i){i.call(s)})}catch(i){P.__e(i,s.__v)}})}function Me(e){return typeof e!="object"||e==null||e.__b&&e.__b>0?e:Ot(e)?e.map(Me):st({},e)}function $n(e,t,n,r,s,i,a,l,u){var c,h,o,g,m,M,$,d=n.props,p=t.props,y=t.type;if(y=="svg"?s="http://www.w3.org/2000/svg":y=="math"?s="http://www.w3.org/1998/Math/MathML":s||(s="http://www.w3.org/1999/xhtml"),i!=null){for(c=0;c<i.length;c++)if((m=i[c])&&"setAttribute"in m==!!y&&(y?m.localName==y:m.nodeType==3)){e=m,i[c]=null;break}}if(e==null){if(y==null)return document.createTextNode(p);e=document.createElementNS(s,y,p.is&&p),l&&(P.__m&&P.__m(t,i),l=!1),i=null}if(y==null)d===p||l&&e.data==p||(e.data=p);else{if(i=i&&Yt.call(e.childNodes),d=n.props||dt,!l&&i!=null)for(d={},c=0;c<e.attributes.length;c++)d[(m=e.attributes[c]).name]=m.value;for(c in d)if(m=d[c],c!="children"){if(c=="dangerouslySetInnerHTML")o=m;else if(!(c in p)){if(c=="value"&&"defaultValue"in p||c=="checked"&&"defaultChecked"in p)continue;mt(e,c,null,m,s)}}for(c in p)m=p[c],c=="children"?g=m:c=="dangerouslySetInnerHTML"?h=m:c=="value"?M=m:c=="checked"?$=m:l&&typeof m!="function"||d[c]===m||mt(e,c,m,d[c],s);if(h)l||o&&(h.__html==o.__html||h.__html==e.innerHTML)||(e.innerHTML=h.__html),t.__k=[];else if(o&&(e.innerHTML=""),xe(t.type=="template"?e.content:e,Ot(g)?g:[g],t,n,r,y=="foreignObject"?"http://www.w3.org/1999/xhtml":s,i,a,i?i[0]:n.__k&&ht(n,0),l,u),i!=null)for(c=i.length;c--;)jt(i[c]);l||(c="value",y=="progress"&&M==null?e.removeAttribute("value"):M!=null&&(M!==e[c]||y=="progress"&&!M||y=="option"&&M!=d[c])&&mt(e,c,M,d[c],s),c="checked",$!=null&&$!=e[c]&&mt(e,c,$,d[c],s))}return e}function zt(e,t,n){try{if(typeof e=="function"){var r=typeof e.__u=="function";r&&e.__u(),r&&t==null||(e.__u=e(t))}else e.current=t}catch(s){P.__e(s,n)}}function Te(e,t,n){var r,s;if(P.unmount&&P.unmount(e),(r=e.ref)&&(r.current&&r.current!=e.__e||zt(r,null,t)),(r=e.__c)!=null){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(i){P.__e(i,t)}r.base=r.__P=null}if(r=e.__k)for(s=0;s<r.length;s++)r[s]&&Te(r[s],t,n||typeof e.type!="function");n||jt(e.__e),e.__c=e.__=e.__e=void 0}function xn(e,t,n){return this.constructor(e,n)}function Ft(e,t,n){var r,s,i,a;t==document&&(t=document.documentElement),P.__&&P.__(e,t),s=(r=!1)?null:t.__k,i=[],a=[],Vt(t,e=t.__k=we(Et,null,[e]),s||dt,dt,t.namespaceURI,s?null:t.firstChild?Yt.call(t.childNodes):null,i,s?s.__e:t.firstChild,r,a),Se(i,e,a)}Yt=be.slice,P={__e:function(e,t,n,r){for(var s,i,a;t=t.__;)if((s=t.__c)&&!s.__)try{if((i=s.constructor)&&i.getDerivedStateFromError!=null&&(s.setState(i.getDerivedStateFromError(e)),a=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(e,r||{}),a=s.__d),a)return s.__E=s}catch(l){e=l}throw e}},ge=0,wt.prototype.setState=function(e,t){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=st({},this.state),typeof e=="function"&&(e=e(st({},n),this.props)),e&&st(n,e),e!=null&&this.__v&&(t&&this._sb.push(t),se(this))},wt.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),se(this))},wt.prototype.render=Et,lt=[],ye=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,ve=function(e,t){return e.__v.__b-t.__v.__b},Dt.__r=0,ke=/(PointerCapture)$|Capture$/i,Ut=0,Ht=ae(!1),Bt=ae(!0);var Dn=0;function f(e,t,n,r,s,i){t||(t={});var a,l,u=t;if("ref"in u)for(l in u={},t)l=="ref"?a=t[l]:u[l]=t[l];var c={type:e,props:u,key:n,ref:a,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Dn,__i:-1,__u:0,__source:s,__self:i};if(typeof e=="function"&&(a=e.defaultProps))for(l in a)u[l]===void 0&&(u[l]=a[l]);return P.vnode&&P.vnode(c),c}var ft,q,Pt,oe,St=0,Ce=[],U=P,le=U.__b,ce=U.__r,ue=U.diffed,he=U.__c,de=U.unmount,fe=U.__;function Zt(e,t){U.__h&&U.__h(q,e,St||t),St=0;var n=q.__H||(q.__H={__:[],__h:[]});return e>=n.__.length&&n.__.push({}),n.__[e]}function B(e){return St=1,Sn(Oe,e)}function Sn(e,t,n){var r=Zt(ft++,2);if(r.t=e,!r.__c&&(r.__=[Oe(void 0,t),function(l){var u=r.__N?r.__N[0]:r.__[0],c=r.t(u,l);u!==c&&(r.__N=[c,r.__[1]],r.__c.setState({}))}],r.__c=q,!q.__f)){var s=function(l,u,c){if(!r.__c.__H)return!0;var h=r.__c.__H.__.filter(function(g){return!!g.__c});if(h.every(function(g){return!g.__N}))return!i||i.call(this,l,u,c);var o=r.__c.props!==l;return h.forEach(function(g){if(g.__N){var m=g.__[0];g.__=g.__N,g.__N=void 0,m!==g.__[0]&&(o=!0)}}),i&&i.call(this,l,u,c)||o};q.__f=!0;var i=q.shouldComponentUpdate,a=q.componentWillUpdate;q.componentWillUpdate=function(l,u,c){if(this.__e){var h=i;i=void 0,s(l,u,c),i=h}a&&a.call(this,l,u,c)},q.shouldComponentUpdate=s}return r.__N||r.__}function Qt(e,t){var n=Zt(ft++,3);!U.__s&&Ye(n.__H,t)&&(n.__=e,n.u=t,q.__H.__h.push(n))}function Mn(e){return St=5,Tn(function(){return{current:e}},[])}function Tn(e,t){var n=Zt(ft++,7);return Ye(n.__H,t)&&(n.__=e(),n.__H=t,n.__h=e),n.__}function Cn(){for(var e;e=Ce.shift();)if(e.__P&&e.__H)try{e.__H.__h.forEach($t),e.__H.__h.forEach(Wt),e.__H.__h=[]}catch(t){e.__H.__h=[],U.__e(t,e.__v)}}U.__b=function(e){q=null,le&&le(e)},U.__=function(e,t){e&&t.__k&&t.__k.__m&&(e.__m=t.__k.__m),fe&&fe(e,t)},U.__r=function(e){ce&&ce(e),ft=0;var t=(q=e.__c).__H;t&&(Pt===q?(t.__h=[],q.__h=[],t.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(t.__h.forEach($t),t.__h.forEach(Wt),t.__h=[],ft=0)),Pt=q},U.diffed=function(e){ue&&ue(e);var t=e.__c;t&&t.__H&&(t.__H.__h.length&&(Ce.push(t)!==1&&oe===U.requestAnimationFrame||((oe=U.requestAnimationFrame)||Yn)(Cn)),t.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),Pt=q=null},U.__c=function(e,t){t.some(function(n){try{n.__h.forEach($t),n.__h=n.__h.filter(function(r){return!r.__||Wt(r)})}catch(r){t.some(function(s){s.__h&&(s.__h=[])}),t=[],U.__e(r,n.__v)}}),he&&he(e,t)},U.unmount=function(e){de&&de(e);var t,n=e.__c;n&&n.__H&&(n.__H.__.forEach(function(r){try{$t(r)}catch(s){t=s}}),n.__H=void 0,t&&U.__e(t,n.__v))};var pe=typeof requestAnimationFrame=="function";function Yn(e){var t,n=function(){clearTimeout(r),pe&&cancelAnimationFrame(t),setTimeout(e)},r=setTimeout(n,35);pe&&(t=requestAnimationFrame(n))}function $t(e){var t=q,n=e.__c;typeof n=="function"&&(e.__c=void 0,n()),q=t}function Wt(e){var t=q;e.__c=e.__(),q=t}function Ye(e,t){return!e||e.length!==t.length||t.some(function(n,r){return n!==e[r]})}function Oe(e,t){return typeof t=="function"?t(e):t}function _e({module:e,children:t}){const[n,r]=B(!!e.collapsed),s=Mn(null),i=()=>r(l=>!l),a=l=>{if(l.metaKey||l.ctrlKey){const u=!n,c=new CustomEvent("think-toggle-all",{detail:u});document.querySelectorAll(".think-module").forEach(h=>h.dispatchEvent(c))}else i()};return Qt(()=>{const l=c=>{const h=c.detail;r(h)},u=s.current;if(u)return u.addEventListener("think-toggle-all",l),()=>u.removeEventListener("think-toggle-all",l)},[]),f("div",{class:"think-module",ref:s,children:[f("div",{class:"module-header",onClick:a,title:"点击折叠/展开；Ctrl/⌘ + 点击：全部折叠/展开",children:[f("span",{class:"module-title",children:e.title}),f("span",{class:"module-toggle",children:n?"▶":"▼"})]}),!n&&f("div",{class:"module-content",children:t})]})}function Mt(e){const t=e.lastIndexOf("#"),n=t>=0?e.substring(0,t):e,r=t>=0?e.substring(t+1):"";return`obsidian://advanced-uri?vault=${encodeURIComponent(ct.instance.app.vault.getName())}&filepath=${encodeURIComponent(n)}${r?"&line="+r:""}`}function Ee({done:e,onMarkDone:t}){const n="task-checkbox"+(e?" done":"");return f("input",{type:"checkbox",class:n,checked:e,onClick:e?r=>r.preventDefault():void 0,onChange:()=>!e&&t?.()})}function On({items:e,rowField:t,colField:n}){if(!t||!n)return f("div",{children:"（TableView 需要配置 rowField 和 colField）"});const r=[],s=[],i={};return e.forEach(a=>{const l=String(et(a,t)??ne),u=String(et(a,n)??ne);i[l]||(i[l]={},r.push(l)),i[l][u]||(i[l][u]=[]),i[l][u].push(a),s.includes(u)||s.push(u)}),r.sort(),s.sort(),f("table",{class:"think-table",children:[f("thead",{children:f("tr",{children:[f("th",{children:t}),s.map(a=>f("th",{children:a},a))]})}),f("tbody",{children:r.map(a=>f("tr",{children:[f("td",{children:f("strong",{children:a})}),s.map(l=>{const u=i[a]?.[l]||[];return u.length?f("td",{children:u.map(c=>f("div",{children:En(c)},c.id))},l):f("td",{class:"empty"},l)})]},a))})]})}function En(e){if(e.type==="task"){const t=e.status==="done";return f("span",{children:[f(Ee,{done:t,onMarkDone:()=>ct.instance.markItemDone(e.id)}),e.icon&&f("span",{class:"task-icon",children:e.icon}),f("a",{href:Mt(e.id),target:"_blank",rel:"noopener",children:e.title})]})}return f("a",{href:Mt(e.id),target:"_blank",rel:"noopener",children:e.title})}const Fn={打卡:"#d2cceb",任务:"#caebf3",计划:"#d8ecb2",总结:"#E5D5B9",事件:"#94e2d6",感受:"#93daf0",思考:"#f09393"};function In(e){return Fn[e]||"#e0e0e0"}function Nn(e){const{groupField:t,showMeta:n=!0,fields:r}=e;let s=e.items,i=null,a=[];if(t){i={};for(const h of s){const o=String(et(h,t)??"(none)");i[o]||(i[o]=[],a.push(o)),i[o].push(h)}a.sort()}const l=h=>{const o=h.status==="done";return f("div",{style:"margin-bottom:4px;line-height:1.5;",children:[f(Ee,{done:o,onMarkDone:()=>ct.instance.markItemDone(h.id)}),f("a",{href:Mt(h.id),target:"_blank",rel:"noopener",class:o?"task-done":"",children:h.title}),h.icon&&f("span",{class:"tag-pill",children:h.icon}),h.tags.map(g=>f("span",{class:"tag-pill",children:g},g))]})},u=h=>f("div",{style:`\r
        display:grid;\r
        grid-template-columns:auto minmax(180px,1fr);\r
        align-items:start;\r
        gap:8px;\r
        margin-bottom:8px;\r
      `,children:[n&&f("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:[f("span",{class:"tag-pill",style:`background:${In(h.category)};`,children:h.category}),h.date&&f("span",{class:"tag-pill",children:h.date}),h.extra.图标&&f("span",{class:"tag-pill",children:h.extra.图标})]}),f("div",{style:"white-space:pre-wrap;line-height:1.5;",children:f("a",{href:Mt(h.id),target:"_blank",rel:"noopener",children:h.content})})]}),c=h=>h.type==="task"?l(h):u(h);return f("div",{children:i?a.map(h=>f("div",{children:[f("h5",{children:h}),i[h].map(c)]},h)):s.map(c)})}function An(e){return Array.isArray(e)?e.join(", "):e==null?"":String(e)}function Ln({items:e,fields:t}){const n=t&&t.length?t:Ae(e);return f("div",{children:f("table",{class:"think-table",style:"min-width:100%; white-space:nowrap;",children:[f("thead",{children:f("tr",{children:n.map(r=>f("th",{children:r},r))})}),f("tbody",{children:e.map(r=>f("tr",{children:n.map(s=>f("td",{children:An(et(r,s))},s))},r.id))})]})})}const Pn={TableView:On,BlockView:Nn,ExcelView:Ln},Hn=Pn;function Bn(e,t=[]){return t.length?e.filter(n=>t.every(r=>Rn(n,r))):e}function Rn(e,t){const n=et(e,t.field),r=t.value;switch(t.op){case"=":return String(n)===String(r);case"!=":return String(n)!==String(r);case"includes":return Array.isArray(n)?n.some(s=>String(s).includes(String(r))):String(n).includes(String(r));case"regex":try{return new RegExp(String(r)).test(String(n))}catch{return!1}case">":return String(n)>String(r);case"<":return String(n)<String(r);default:return!1}}function Wn(e,t=[]){return t.length?[...e].sort((n,r)=>{for(const s of t){const i=et(n,s.field),a=et(r,s.field);if(i==null&&a==null)continue;if(i==null)return s.dir==="asc"?1:-1;if(a==null)return s.dir==="asc"?-1:1;const l=String(i).localeCompare(String(a),"zh");if(l!==0)return s.dir==="asc"?l:-l}return 0}):e}function qn(e,t,n){if(!t&&!n)return e;const r=t?Date.parse(t):null,s=n?Date.parse(n):null;return e.filter(i=>{const a=i.startMs??(i.startISO?Date.parse(i.startISO):NaN);return isNaN(a)?!0:!(r!==null&&a<r||s!==null&&a>s)})}function Un(e,t){if(!t.trim())return e;const n=t.trim().toLowerCase();return e.filter(r=>(r.title+" "+r.content).toLowerCase().includes(n))}const jn=["一","二","三","四"];function Vn({config:e,dataStore:t,plugin:n}){const[r,s]=B(e.initialView||"月"),[i,a]=B(e.initialDate?J(e.initialDate):J()),[l,u]=B(""),[,c]=B(0);Qt(()=>{const $=()=>c(d=>d+1);return t.subscribe($),()=>t.unsubscribe($)},[t]);const h=$=>({年:"year",季:"quarter",月:"month",周:"week",天:"day"})[$]??"day",o=($,d)=>d==="年"?$.format("YYYY年"):d==="季"?`${$.year()}年${jn[$.quarter()-1]}季度`:d==="月"?$.format("YYYY-MM"):d==="周"?$.format("YYYY-[W]WW"):$.format("YYYY-MM-DD"),{startDate:g,endDate:m}=on(i,r),M=$=>{const d=Hn[$.view];if(!d)return f(_e,{module:$,children:f("div",{children:["未知视图：",$.view]})});let p=t.queryItems();if(p=Bn(p,$.filters||[]),p=qn(p,g.format("YYYY-MM-DD"),m.format("YYYY-MM-DD")),p=Un(p,l),e.tags?.length&&(p=p.filter(x=>x.tags.some(F=>e.tags.some(A=>F.includes(A))))),e.path?.trim()){const x=e.path.trim(),F=t.app.vault.getAbstractFileByPath(x),A=C=>F instanceof W.TFolder?C.startsWith(x.endsWith("/")?x:x+"/"):F instanceof W.TFile?C.startsWith(x+"#"):C.startsWith(x.endsWith("/")?x:x+"/");p=p.filter(C=>A(C.id))}p=Wn(p,$.sort||[]);const y={...$.props||{}};return $.groups?.length&&(y.groupField=$.groups[0]),$.view==="TableView"&&(y.rowField=$.rowField||"",y.colField=$.colField||""),$.fields?.length&&(y.fields=$.fields),f(_e,{module:$,children:f(d,{items:p,...y})})};return f("div",{children:[f("div",{class:"tp-toolbar",style:"margin-bottom:8px;",children:[["年","季","月","周","天"].map($=>f("button",{onClick:()=>s($),class:$===r?"active":"",children:$})),f("button",{disabled:!0,style:"font-weight:bold;margin:0 4px;background:#fff;",children:o(i,r)}),f("button",{onClick:()=>a(i.clone().subtract(1,h(r))),children:"←"}),f("button",{onClick:()=>a(i.clone().add(1,h(r))),children:"→"}),f("button",{onClick:()=>a(J()),children:"＝"}),f("input",{placeholder:"快速过滤…",style:"margin-left:4px;",value:l,onInput:$=>u($.target.value)}),f("button",{style:"margin-left:4px;",onClick:()=>n.openSettingsForDashboard(e.name),title:"在插件设置中编辑本仪表盘",children:"⚙︎"})]}),e.modules.map(M)]})}class zn{constructor(t,n){this.plugin=t,this.dataStore=n,this.registerProcessor()}registerProcessor(){this.plugin.registerMarkdownCodeBlockProcessor(ln,(t,n)=>{let r,s;try{const a=t.trim()?JSON.parse(t):{};Array.isArray(a.modules)?s={name:a.name||"__inline__",path:a.path||"",tags:a.tags||[],initialView:a.initialView||"月",initialDate:a.initialDate||"",modules:a.modules}:r=a.config||a.dashboard||a.name}catch(a){console.warn("ThinkPlugin: 仪表盘代码块 JSON 解析失败",a)}if(s){this.mount(n,s);return}!r&&this.plugin.dashboards.length&&(r=this.plugin.dashboards[0].name);const i=this.plugin.dashboards.find(a=>a.name===r);if(!i){n.createDiv({text:`找不到名称为 "${r}" 的仪表盘配置`});return}this.mount(n,i)})}mount(t,n){Ft(we(Vn,{config:n,dataStore:this.dataStore,plugin:this.plugin}),t),this.plugin.activeDashboards.push({container:t,configName:n.name})}}function Zn(e){const{plugin:t,dataStore:n}=e;new vn(t,n),new zn(t,n)}function Qn(e){return(e||"").split("/").filter(Boolean).pop()||e||""}function Xn(e){const{template:t="{{前缀}}{{内容}}",fields:n}=e,r={};Object.entries(n||{}).forEach(([l,u])=>{r[l]=u==null?"":String(u)}),"前缀"in r||(r.前缀=""),"任务前缀"in r||(r.任务前缀=r.前缀);const s=/\{\{\s*@?([^}]+?)\s*\}\}/g;let i=t.replace(s,(l,u)=>{const c=String(u).trim();return c in r?r[c]:""});return!/\{\{\s*@?(?:前缀|任务前缀)\s*\}\}/.test(t)&&!i.startsWith("- [")&&(i=(r.前缀||"- [ ] ")+i),i.replace(/[ \t]+/g," ").trim()}function Fe(e){const t=e.fieldsOrder??["分类","日期","主题","图标","标签","周期","分类","内容"],n={分类:e.category,日期:e.dateISO?Ct(e.dateISO):"",主题:e.themeLabel??"",图标:e.icon??"",标签:e.tags?.join(", ")??"",...e.extra,内容:(e.content||"").trim()},r=(i,a)=>a?`${i}:: ${a}`:"",s=["<!-- start -->"];return t.forEach(i=>{if(i==="内容"&&n.内容.includes(`
`)){const[a,...l]=n.内容.split(`
`);s.push("内容:: "+a,...l)}else{const a=r(i,n[i]);a&&s.push(a)}}),s.push("<!-- end -->"),s.join(`
`)}class Xt{constructor(t,n){this.app=t,this.plugin=n}get settings(){return this.plugin.inputSettings||{base:{},themes:[]}}apply(t,n){return t.replace(/\{\{\s*主题\s*\}\}/g,Qn(n))}resolveFilePath(t,n,r){const s=this.settings,i=(s.themes||[]).find(c=>c.path===t)||null;if(n==="task"){const c=i?.task?.file??s.base?.task?.file;return c?this.apply(c,t):null}const a=i?.blocks?.[r],l=s.base?.blocks?.[r],u=a?.file??l?.file;return u?this.apply(u,t):null}async ensureFolder(t){const n=t.split("/").filter(Boolean);let r="";for(const s of n){r=r?`${r}/${s}`:s;const i=this.app.vault.getAbstractFileByPath(r);if(!i)await this.app.vault.createFolder(r).catch(()=>{});else if(i instanceof W.TFile)throw new Error(`路径冲突：${r} 是文件`)}}async getOrCreateFile(t){const n=this.app.vault.getAbstractFileByPath(t);if(n instanceof W.TFile)return n;if(n instanceof W.TFolder)throw new Error(`目标是文件夹：${t}`);const r=t.includes("/")?t.slice(0,t.lastIndexOf("/")):"";return r&&await this.ensureFolder(r),await this.app.vault.create(t,"")}async appendUnderHeader(t,n,r){const s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`^##\\s+${s}\\s*$`,"m"),a=await this.app.vault.read(t),l=a.split(`
`);i.test(a)||(l.length&&l[l.length-1].trim()!==""&&l.push(""),l.push(`## ${n}`,""));let c=l.findIndex(h=>i.test(h))+1;for(;c<l.length&&!/^##\s+/.test(l[c]);)c++;l.splice(c,0,r),await this.app.vault.modify(t,l.join(`
`))}async writeTask(t,n,r){const s=n??this.resolveFilePath(t,"task");if(!s)throw new Error("未配置任务写入文件路径");const i=await this.getOrCreateFile(s);return await this.appendUnderHeader(i,t,r),s}async writeBlock(t,n,r,s){const i=r??this.resolveFilePath(t,"block",n);if(!i)throw new Error(`未配置 ${n} 写入文件路径`);const a=await this.getOrCreateFile(i);return await this.appendUnderHeader(a,t,s),i}getTaskTopCategories(){const t=new Set;return(this.settings.themes||[]).forEach(n=>{n.task?.enabled&&t.add(n.path.split("/")[0])}),[...t].sort((n,r)=>n.localeCompare(r,"zh"))}getBlockTopCategories(t){const n=new Set;return(this.settings.themes||[]).forEach(r=>{r.blocks?.[t]?.enabled===!0&&n.add(r.path.split("/")[0])}),[...n].sort((r,s)=>r.localeCompare(s,"zh"))}listTaskThemesByTop(t){const{themes:n=[],base:r={}}=this.settings,s=r.task??{};return n.filter(i=>(i.path===t||i.path.startsWith(t+"/"))&&(i.task?.enabled??!1)).map(i=>{const a=i.task??{};return{path:i.path,icon:i.icon,file:a.file??s.file??`${i.path}.md`,fields:a.fields??s.fields??[],fieldOptions:a.fieldOptions??s.fieldOptions??{},template:a.template??s.template}})}listBlockThemesByTop(t,n){return(this.settings.themes||[]).filter(r=>(r.path===t||r.path.startsWith(t+"/"))&&(r.blocks?.[n]?.enabled??!1)).map(r=>({path:r.path,icon:r.icon})).sort((r,s)=>r.path.localeCompare(s.path,"zh"))}}function Q({label:e,children:t}){return f("div",{style:"margin-bottom:12px;width:100%;",children:[f("div",{style:"margin-bottom:4px;font-weight:600;",children:e}),f("div",{style:"display:flex;flex-wrap:wrap;gap:8px;width:100%;",children:t})]})}function tt({value:e,checked:t,onChange:n,label:r,name:s}){return f("label",{style:"display:flex;align-items:center;gap:4px;cursor:pointer;",children:[f("input",{type:"radio",name:s,value:e,checked:t,onChange:n,style:"appearance:radio;-webkit-appearance:radio;"}),f("span",{children:r??e})]})}class Kn extends W.Modal{constructor(t){super(t.app),this.plugin=t}onOpen(){Ft(f(Jn,{app:this.app,plugin:this.plugin,close:()=>this.close()}),this.contentEl)}onClose(){this.contentEl.empty()}}function Jn({app:e,plugin:t,close:n}){const r=new Xt(e,t),[s,i]=B(r.getTaskTopCategories()[0]||""),[a,l]=B(r.listTaskThemesByTop(s)),[u,c]=B(a[0]||null),h=u?.fieldOptions??{},o={};(u?.fields||[]).forEach(d=>{o[d]=d==="日期"?qt():d==="时间"?rn():h[d]?.[0]??""});const[g,m]=B(o),M=(d,p)=>m(y=>({...y,[d]:p}));async function $(){if(!(g.内容?.trim()||g.任务内容?.trim())){new W.Notice("请填写任务内容");return}let p="";switch(g.任务状态){case"✅":p="- [x] ";break;case"📅":case"🛫":p="- [ ] ";break;default:p=""}const y=Xn({themePath:u.path,template:u?.template,fields:{...g,任务前缀:p,前缀:p,icon:u?.icon??""}});try{const x=await r.writeTask(u.path,null,y);new W.Notice(`✅ 已保存任务 → ${x}`),t.dataStore?.notifyChange?.(),n()}catch(x){new W.Notice(`❌ 保存失败：${x.message??x}`)}}return f("div",{class:"think-modal",children:[f("h3",{style:"margin-bottom:1rem;",children:"快速录入 · 任务"}),f(Q,{label:"大类",children:r.getTaskTopCategories().map(d=>f(tt,{value:d,label:d,checked:s===d,onChange:()=>{i(d);const p=r.listTaskThemesByTop(d);l(p),c(p[0]||null)}},d))}),u&&f(Q,{label:"主题",children:a.map(d=>f(tt,{name:"theme",value:d.path,label:d.path.split("/").pop()??d.path,checked:u.path===d.path,onChange:()=>c(d)},d.path))}),u?.fields.map(d=>{const p=h[d];return f(Q,{label:d,children:p?.length?p.map(y=>f(tt,{name:d,value:y,label:y,checked:g[d]===y,onChange:()=>M(d,y)},y)):f("input",{style:"width:100%;",type:d==="日期"?"date":d==="时间"?"time":"text",value:g[d],onInput:y=>M(d,y.target.value)})},d)}),f("div",{style:"display:flex;justify-content:flex-end;margin-top:1rem;gap:.5rem;",children:[f("button",{class:"mod-cta",onClick:$,children:"提交 ↩︎"}),f("button",{onClick:n,children:"取消"})]})]})}const Gn=e=>e.split("/").pop()??e;class tr extends W.Modal{constructor(t){super(t.app),this.plugin=t}onOpen(){Ft(f(er,{app:this.app,plugin:this.plugin,close:()=>this.close()}),this.contentEl)}onClose(){this.contentEl.empty()}}function er({app:e,plugin:t,close:n}){const r=new Xt(e,t),[s,i]=B("思考"),[a,l]=B(r.getBlockTopCategories(s)),[u,c]=B(a[0]??""),h=()=>r.listBlockThemesByTop(u,s),[o,g]=B(h()),[m,M]=B(o[0]?.path||u),$=o.find(_=>_.path===m)?.icon??"",p=(t.inputSettings?.base?.blocks?.[s]??{}).fieldOptions??{},y=Array.isArray(p.周期)?p.周期:[],x=Array.isArray(p.分类)?p.分类:[],[F,A]=B(qt()),[C,k]=B(""),[N,O]=B(s!=="思考"&&y.includes("周")?"周":""),[I,S]=B(s==="思考"&&x.includes("思考")?"思考":""),L=(_=s,b=null)=>{const v=r.getBlockTopCategories(_);l(v);const D=b??v[0]??"";c(D);const w=r.listBlockThemesByTop(D,_);g(w),M(w[0]?.path||D),O(_!=="思考"&&y.includes("周")?"周":""),S(_==="思考"&&x.includes("思考")?"思考":"")};async function Z(){if(!C.trim()){new W.Notice("请填写内容");return}const _={};s!=="思考"&&N&&(_.周期=N),s==="思考"&&I&&(_.分类=I);const b=Fe({category:s,dateISO:F,themeLabel:u,icon:$,content:C,extra:_});try{await r.writeBlock(m,s,null,b),new W.Notice("✅ 已保存"),t.dataStore?.notifyChange?.(),n()}catch(v){new W.Notice("❌ 保存失败："+(v.message??v))}}return f("div",{class:"think-modal",children:[f("h3",{style:"margin-bottom:1rem;",children:["快速录入 · ",s]}),f(Q,{label:"类别",children:["计划","总结","思考"].map(_=>f(tt,{checked:s===_,label:_,onChange:()=>{i(_),L(_,null)}},_))}),f(Q,{label:"大类",children:a.map(_=>f(tt,{checked:u===_,label:_,onChange:()=>{c(_),L(s,_)}},_))}),f(Q,{label:"主题",children:o.map(_=>f(tt,{name:"theme",checked:m===_.path,label:Gn(_.path),onChange:()=>M(_.path)},_.path))}),s!=="思考"&&y.length>0&&f(Q,{label:"周期",children:y.map(_=>f(tt,{name:"period",checked:N===_,label:_,onChange:()=>O(_)},_))}),s==="思考"&&x.length>0&&f(Q,{label:"思考分类",children:x.map(_=>f(tt,{name:"type",checked:I===_,label:_,onChange:()=>S(_)},_))}),f(Q,{label:"日期",children:f("input",{type:"date",value:F,onChange:_=>A(_.target.value),style:"min-width:140px;"})}),f(Q,{label:"内容",children:f("textarea",{rows:6,style:"width:100%;",placeholder:"输入内容…",value:C,onInput:_=>k(_.target.value)})}),f("div",{style:"display:flex;gap:8px;justify-content:flex-end;margin-top:8px;",children:[f("button",{class:"mod-cta",onClick:Z,children:"提交 ↩︎"}),f("button",{onClick:n,children:"取消"})]})]})}const nr=e=>e.split("/").pop()??e;class rr extends W.Modal{constructor(t){super(t.app),this.plugin=t}onOpen(){Ft(f(sr,{app:this.app,plugin:this.plugin,close:()=>this.close()}),this.contentEl)}onClose(){this.contentEl.empty()}}function sr({app:e,plugin:t,close:n}){const r=new Xt(e,t),s=r.getBlockTopCategories("打卡"),[i,a]=B(s[0]??""),l=()=>r.listBlockThemesByTop(i,"打卡"),[u,c]=B(l()),[h,o]=B(u[0]?.path||i);function g(k){const O=(t.inputSettings?.themes||[]).find(I=>I.path===k)?.blocks?.打卡||{};return typeof O.starCount=="number"?O.starCount:Array.isArray(O.emojiMapping)?O.emojiMapping.length:Array.isArray(O.imageMapping)?O.imageMapping.length:5}const[m,M]=B(g(h)),[$,d]=B(qt()),[p,y]=B(""),[x,F]=B(1);Qt(()=>{const k=g(h);M(k),x>k&&F(k)},[h]);function A(k){a(k);const N=r.listBlockThemesByTop(k,"打卡");c(N),o(N[0]?.path||k)}async function C(){if(!p.trim()){new W.Notice("请填写内容");return}const k=Fe({category:"打卡",dateISO:$,themeLabel:i,content:p,extra:{评分:String(x)}});try{await r.writeBlock(h,"打卡",null,k),new W.Notice("✅ 已保存打卡"),t.dataStore?.notifyChange?.(),n()}catch(N){new W.Notice("❌ 保存失败："+(N.message??N))}}return f("div",{class:"think-modal",children:[f("h3",{style:"margin-bottom:1rem;",children:"快速录入 · 打卡"}),f(Q,{label:"大类",children:s.map(k=>f(tt,{value:k,checked:i===k,onChange:()=>A(k),label:k},k))}),f(Q,{label:"主题",children:u.map(k=>f(tt,{name:"theme",value:k.path,label:nr(k.path),checked:h===k.path,onChange:()=>o(k.path)},k.path))}),f(Q,{label:"日期",children:f("input",{type:"date",value:$,onChange:k=>d(k.target.value),style:{width:"100%"}})}),f(Q,{label:`评分 (1~${m})`,children:f("input",{type:"number",min:1,max:m,value:x,onInput:k=>F(Number(k.target.value)),style:{width:"100%"}})}),f(Q,{label:"内容",children:f("textarea",{rows:5,placeholder:"备注…",style:{width:"100%"},value:p,onInput:k=>y(k.target.value)})}),f("div",{style:"display:flex;gap:8px;justify-content:flex-end;margin-top:8px;",children:[f("button",{class:"mod-cta",onClick:C,children:"提交 ↩︎"}),f("button",{onClick:n,children:"取消"})]})]})}function ir(e){const{plugin:t}=e;t.addCommand({id:"think-quick-input-task",name:"快速录入 · 任务",callback:()=>new Kn(t).open()}),t.addCommand({id:"think-quick-input-block",name:"快速录入 · 计划/总结/思考",callback:()=>new tr(t).open()}),t.addCommand({id:"think-quick-input-habit",name:"快速录入 · 打卡",callback:()=>new rr(t).open()})}function ar(e){ir(e)}const or={dashboards:[],inputSettings:{base:{},themes:[]}};class lr extends W.Plugin{platform;dataStore;_settings;get dashboards(){return this._settings.dashboards}get inputSettings(){return this._settings.inputSettings}activeDashboards=[];async onload(){console.log("ThinkPlugin load"),await this.loadSettings(),this.platform=new Ie(this.app),this.dataStore=new ct(this.platform),await this.dataStore.initialScan();const t={app:this.app,plugin:this,platform:this.platform,dataStore:this.dataStore};Zn?.(t),ar?.(t)}onunload(){console.log("ThinkPlugin unload"),this.activeDashboards.forEach(({container:t})=>t.empty())}async loadSettings(){const t=await this.loadData();this._settings=Object.assign({},or,t)}async saveSettings(){await this.saveData(this._settings)}async upsertDashboard(t){const n=this._settings.dashboards,r=n.findIndex(s=>s.name===t.name);r>=0?n[r]=t:n.push(t),await this.saveSettings(),new W.Notice(`已保存仪表盘「${t.name}」`)}openSettingsForDashboard(t){this.openSettingTab()}}module.exports=lr;
//# sourceMappingURL=main.js.map
