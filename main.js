"use strict";const Y=require("obsidian");var de,F,qe,J,Ne,je,Ke,ze,De,be,we,te={},Xe=[],ct=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,ue=Array.isArray;function X(t,e){for(var n in e)t[n]=e[n];return t}function Se(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function se(t,e,n){var i,s,r,o={};for(r in e)r=="key"?i=e[r]:r=="ref"?s=e[r]:o[r]=e[r];if(arguments.length>2&&(o.children=arguments.length>3?de.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(r in t.defaultProps)o[r]===void 0&&(o[r]=t.defaultProps[r]);return re(t,o,i,s,null)}function re(t,e,n,i,s){var r={type:t,props:e,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:s??++qe,__i:-1,__u:0};return s==null&&F.vnode!=null&&F.vnode(r),r}function he(t){return t.children}function ae(t,e){this.props=t,this.context=e}function Z(t,e){if(e==null)return t.__?Z(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?Z(t):null}function Je(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Je(t)}}function $e(t){(!t.__d&&(t.__d=!0)&&J.push(t)&&!oe.__r++||Ne!=F.debounceRendering)&&((Ne=F.debounceRendering)||je)(oe)}function oe(){for(var t,e,n,i,s,r,o,u=1;J.length;)J.length>u&&J.sort(Ke),t=J.shift(),u=J.length,t.__d&&(n=void 0,s=(i=(e=t).__v).__e,r=[],o=[],e.__P&&((n=X({},i)).__v=i.__v+1,F.vnode&&F.vnode(n),Ee(e.__P,n,i,e.__n,e.__P.namespaceURI,32&i.__u?[s]:null,r,s??Z(i),!!(32&i.__u),o),n.__v=i.__v,n.__.__k[n.__i]=n,Ze(r,n,o),n.__e!=s&&Je(n)));oe.__r=0}function Ge(t,e,n,i,s,r,o,u,h,c,d){var l,_,y,w,k,v,f=i&&i.__k||Xe,m=e.length;for(h=dt(n,e,f,h,m),l=0;l<m;l++)(y=n.__k[l])!=null&&(_=y.__i==-1?te:f[y.__i]||te,y.__i=l,v=Ee(t,y,_,s,r,o,u,h,c,d),w=y.__e,y.ref&&_.ref!=y.ref&&(_.ref&&Ce(_.ref,null,y),d.push(y.ref,y.__c||w,y)),k==null&&w!=null&&(k=w),4&y.__u||_.__k===y.__k?h=Qe(y,h,t):typeof y.type=="function"&&v!==void 0?h=v:w&&(h=w.nextSibling),y.__u&=-7);return n.__e=k,h}function dt(t,e,n,i,s){var r,o,u,h,c,d=n.length,l=d,_=0;for(t.__k=new Array(s),r=0;r<s;r++)(o=e[r])!=null&&typeof o!="boolean"&&typeof o!="function"?(h=r+_,(o=t.__k[r]=typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?re(null,o,null,null,null):ue(o)?re(he,{children:o},null,null,null):o.constructor==null&&o.__b>0?re(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=t,o.__b=t.__b+1,u=null,(c=o.__i=ut(o,n,h,l))!=-1&&(l--,(u=n[c])&&(u.__u|=2)),u==null||u.__v==null?(c==-1&&(s>d?_--:s<d&&_++),typeof o.type!="function"&&(o.__u|=4)):c!=h&&(c==h-1?_--:c==h+1?_++:(c>h?_--:_++,o.__u|=4))):t.__k[r]=null;if(l)for(r=0;r<d;r++)(u=n[r])!=null&&(2&u.__u)==0&&(u.__e==i&&(i=Z(u)),tt(u,u));return i}function Qe(t,e,n){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=Qe(i[s],e,n));return e}t.__e!=e&&(e&&t.type&&!n.contains(e)&&(e=Z(t)),n.insertBefore(t.__e,e||null),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function ut(t,e,n,i){var s,r,o=t.key,u=t.type,h=e[n];if(h===null&&t.key==null||h&&o==h.key&&u==h.type&&(2&h.__u)==0)return n;if(i>(h!=null&&(2&h.__u)==0?1:0))for(s=n-1,r=n+1;s>=0||r<e.length;){if(s>=0){if((h=e[s])&&(2&h.__u)==0&&o==h.key&&u==h.type)return s;s--}if(r<e.length){if((h=e[r])&&(2&h.__u)==0&&o==h.key&&u==h.type)return r;r++}}return-1}function Ae(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||ct.test(e)?n:n+"px"}function ie(t,e,n,i,s){var r,o;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof i=="string"&&(t.style.cssText=i=""),i)for(e in i)n&&e in n||Ae(t.style,e,"");if(n)for(e in n)i&&n[e]==i[e]||Ae(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")r=e!=(e=e.replace(ze,"$1")),o=e.toLowerCase(),e=o in t||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+r]=n,n?i?n.u=i.u:(n.u=De,t.addEventListener(e,r?we:be,r)):t.removeEventListener(e,r?we:be,r);else{if(s=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Fe(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=De++;else if(e.t<n.u)return;return n(F.event?F.event(e):e)}}}function Ee(t,e,n,i,s,r,o,u,h,c){var d,l,_,y,w,k,v,f,m,x,E,S,N,M,$,A,a,g=e.type;if(e.constructor!=null)return null;128&n.__u&&(h=!!(32&n.__u),r=[u=e.__e=n.__e]),(d=F.__b)&&d(e);e:if(typeof g=="function")try{if(f=e.props,m="prototype"in g&&g.prototype.render,x=(d=g.contextType)&&i[d.__c],E=d?x?x.props.value:d.__:i,n.__c?v=(l=e.__c=n.__c).__=l.__E:(m?e.__c=l=new g(f,E):(e.__c=l=new ae(f,E),l.constructor=g,l.render=_t),x&&x.sub(l),l.props=f,l.state||(l.state={}),l.context=E,l.__n=i,_=l.__d=!0,l.__h=[],l._sb=[]),m&&l.__s==null&&(l.__s=l.state),m&&g.getDerivedStateFromProps!=null&&(l.__s==l.state&&(l.__s=X({},l.__s)),X(l.__s,g.getDerivedStateFromProps(f,l.__s))),y=l.props,w=l.state,l.__v=e,_)m&&g.getDerivedStateFromProps==null&&l.componentWillMount!=null&&l.componentWillMount(),m&&l.componentDidMount!=null&&l.__h.push(l.componentDidMount);else{if(m&&g.getDerivedStateFromProps==null&&f!==y&&l.componentWillReceiveProps!=null&&l.componentWillReceiveProps(f,E),!l.__e&&l.shouldComponentUpdate!=null&&l.shouldComponentUpdate(f,l.__s,E)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(l.props=f,l.state=l.__s,l.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(b){b&&(b.__=e)}),S=0;S<l._sb.length;S++)l.__h.push(l._sb[S]);l._sb=[],l.__h.length&&o.push(l);break e}l.componentWillUpdate!=null&&l.componentWillUpdate(f,l.__s,E),m&&l.componentDidUpdate!=null&&l.__h.push(function(){l.componentDidUpdate(y,w,k)})}if(l.context=E,l.props=f,l.__P=t,l.__e=!1,N=F.__r,M=0,m){for(l.state=l.__s,l.__d=!1,N&&N(e),d=l.render(l.props,l.state,l.context),$=0;$<l._sb.length;$++)l.__h.push(l._sb[$]);l._sb=[]}else do l.__d=!1,N&&N(e),d=l.render(l.props,l.state,l.context),l.state=l.__s;while(l.__d&&++M<25);l.state=l.__s,l.getChildContext!=null&&(i=X(X({},i),l.getChildContext())),m&&!_&&l.getSnapshotBeforeUpdate!=null&&(k=l.getSnapshotBeforeUpdate(y,w)),A=d,d!=null&&d.type===he&&d.key==null&&(A=et(d.props.children)),u=Ge(t,ue(A)?A:[A],e,n,i,s,r,o,u,h,c),l.base=e.__e,e.__u&=-161,l.__h.length&&o.push(l),v&&(l.__E=l.__=null)}catch(b){if(e.__v=null,h||r!=null)if(b.then){for(e.__u|=h?160:128;u&&u.nodeType==8&&u.nextSibling;)u=u.nextSibling;r[r.indexOf(u)]=null,e.__e=u}else for(a=r.length;a--;)Se(r[a]);else e.__e=n.__e,e.__k=n.__k;F.__e(b,e,n)}else r==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):u=e.__e=ht(n.__e,e,n,i,s,r,o,h,c);return(d=F.diffed)&&d(e),128&e.__u?void 0:u}function Ze(t,e,n){for(var i=0;i<n.length;i++)Ce(n[i],n[++i],n[++i]);F.__c&&F.__c(e,t),t.some(function(s){try{t=s.__h,s.__h=[],t.some(function(r){r.call(s)})}catch(r){F.__e(r,s.__v)}})}function et(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:ue(t)?t.map(et):X({},t)}function ht(t,e,n,i,s,r,o,u,h){var c,d,l,_,y,w,k,v=n.props,f=e.props,m=e.type;if(m=="svg"?s="http://www.w3.org/2000/svg":m=="math"?s="http://www.w3.org/1998/Math/MathML":s||(s="http://www.w3.org/1999/xhtml"),r!=null){for(c=0;c<r.length;c++)if((y=r[c])&&"setAttribute"in y==!!m&&(m?y.localName==m:y.nodeType==3)){t=y,r[c]=null;break}}if(t==null){if(m==null)return document.createTextNode(f);t=document.createElementNS(s,m,f.is&&f),u&&(F.__m&&F.__m(e,r),u=!1),r=null}if(m==null)v===f||u&&t.data==f||(t.data=f);else{if(r=r&&de.call(t.childNodes),v=n.props||te,!u&&r!=null)for(v={},c=0;c<t.attributes.length;c++)v[(y=t.attributes[c]).name]=y.value;for(c in v)if(y=v[c],c!="children"){if(c=="dangerouslySetInnerHTML")l=y;else if(!(c in f)){if(c=="value"&&"defaultValue"in f||c=="checked"&&"defaultChecked"in f)continue;ie(t,c,null,y,s)}}for(c in f)y=f[c],c=="children"?_=y:c=="dangerouslySetInnerHTML"?d=y:c=="value"?w=y:c=="checked"?k=y:u&&typeof y!="function"||v[c]===y||ie(t,c,y,v[c],s);if(d)u||l&&(d.__html==l.__html||d.__html==t.innerHTML)||(t.innerHTML=d.__html),e.__k=[];else if(l&&(t.innerHTML=""),Ge(e.type=="template"?t.content:t,ue(_)?_:[_],e,n,i,m=="foreignObject"?"http://www.w3.org/1999/xhtml":s,r,o,r?r[0]:n.__k&&Z(n,0),u,h),r!=null)for(c=r.length;c--;)Se(r[c]);u||(c="value",m=="progress"&&w==null?t.removeAttribute("value"):w!=null&&(w!==t[c]||m=="progress"&&!w||m=="option"&&w!=v[c])&&ie(t,c,w,v[c],s),c="checked",k!=null&&k!=t[c]&&ie(t,c,k,v[c],s))}return t}function Ce(t,e,n){try{if(typeof t=="function"){var i=typeof t.__u=="function";i&&t.__u(),i&&e==null||(t.__u=t(e))}else t.current=e}catch(s){F.__e(s,n)}}function tt(t,e,n){var i,s;if(F.unmount&&F.unmount(t),(i=t.ref)&&(i.current&&i.current!=t.__e||Ce(i,null,e)),(i=t.__c)!=null){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(r){F.__e(r,e)}i.base=i.__P=null}if(i=t.__k)for(s=0;s<i.length;s++)i[s]&&tt(i[s],e,n||typeof t.type!="function");n||Se(t.__e),t.__c=t.__=t.__e=void 0}function _t(t,e,n){return this.constructor(t,n)}function pe(t,e,n){var i,s,r,o;e==document&&(e=document.documentElement),F.__&&F.__(t,e),s=(i=!1)?null:e.__k,r=[],o=[],Ee(e,t=e.__k=se(he,null,[t]),s||te,te,e.namespaceURI,s?null:e.firstChild?de.call(e.childNodes):null,r,s?s.__e:e.firstChild,i,o),Ze(r,t,o)}de=Xe.slice,F={__e:function(t,e,n,i){for(var s,r,o;e=e.__;)if((s=e.__c)&&!s.__)try{if((r=s.constructor)&&r.getDerivedStateFromError!=null&&(s.setState(r.getDerivedStateFromError(t)),o=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(t,i||{}),o=s.__d),o)return s.__E=s}catch(u){t=u}throw t}},qe=0,ae.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=X({},this.state),typeof t=="function"&&(t=t(X({},n),this.props)),t&&X(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),$e(this))},ae.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),$e(this))},ae.prototype.render=he,J=[],je=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Ke=function(t,e){return t.__v.__b-e.__v.__b},oe.__r=0,ze=/(PointerCapture)$|Capture$/i,De=0,be=Fe(!1),we=Fe(!0);const pt=["id","title","content","type","status","category","tags","recurrence","date","header","icon","priority","createdDate","scheduledDate","startDate","dueDate","doneDate","cancelledDate","created","modified","filename"];function nt(t){const e=new Set(pt);for(const n of t)Object.keys(n.extra||{}).forEach(i=>e.add("extra."+i));return Array.from(e)}function q(t,e){if(e.startsWith("extra.")){const n=e.substring(6);return t.extra?.[n]}return t[e]}const ft="\\d{4}[-/]\\d{2}[-/]\\d{2}",gt=new RegExp(ft),mt=/#([\p{L}\p{N}_\/-]+)/gu,yt=/\(([^:：]+)::\s*([^)]+)\)/g,Ye=/^\s*-\s*\[[ xX-]\]/,vt=/^\s*-\s*\[x\]/i,bt=/^\s*-\s*\[-\]/;function it(t){return t.replace(/\//g,"-")}const wt="think",Q={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕"},Me="无日期",fe="think-dashboard-style",kt=`
.think-table{width:100%;border:1px solid #ccc;border-collapse:collapse;}
.think-table th,.think-table td{border:1px solid #ccc;padding:4px;}
.think-table th{background:#f0f0f0;text-align:center;}
.think-table td{text-align:left;}
.think-table td.empty{background:#f9f9f9;}
.tag-pill{background:#e0e0e0;border-radius:4px;padding:0 6px;margin-right:6px;font-size:90%;display:inline-block;}
.task-done{text-decoration:line-through;color:gray;}
.module-header{display:flex;align-items:center;padding:4px 8px;background:#eee;cursor:pointer;}
.module-title{flex:1;font-weight:bold;}
.module-toggle{margin-left:4px;}
.module-content{padding:6px 8px;}
.think-module a{color:black;text-decoration:none;}
`.trim();function xt(t){let e=t.replace(/^\s*-\s*\[[ xX]\]\s*/,"").trim();e=e.replace(/#[\p{L}\p{N}_-]+/gu,"");let n=e.split(/[\s(]/).find(i=>i&&i.trim());return n=n?.replace(new RegExp("^\\p{Extended_Pictographic}\\uFE0F?","u"),"").trim(),n?n.trim():""}function Dt(t){if(t.includes("🔺"))return"highest";if(t.includes("⏫"))return"high";if(t.includes("🔼"))return"medium";if(t.includes("🔽"))return"low";if(t.includes("⏬"))return"lowest"}function St(t,e,n,i){const s=e;if(!Ye.test(s))return null;let r="open";vt.test(s)?r="done":bt.test(s)&&(r="cancelled");const u=(s.match(mt)||[]).map(A=>A.replace("#",""));let h="none";const c=s.match(/🔁\s*([^\n📅⏳🛫➕✅❌]*)/);c&&c[1]&&(h=c[1].trim());const d={};let l;for(;(l=yt.exec(s))!==null;){const A=l[1].trim(),a=l[2].trim(),g=A.toLowerCase();if(["主题","标签","tag","tags"].includes(g))a.split(/[,，]/).forEach(b=>{const C=b.trim().replace(/^#/,"");C&&u.push(C)});else{const b=Number(a);let C=a;a!==""&&!isNaN(b)?C=b:/^(true|false)$/i.test(a)&&(C=a.toLowerCase()==="true"),d[A]=C}}const _=A=>{const a=s.match(new RegExp(`${A}s*(${gt.source})`));return a?it(a[1]):void 0},y=_(Q.done),w=_(Q.cancelled),k=_(Q.due),v=_(Q.scheduled),f=_(Q.start),m=_(Q.created),x=Dt(s);let E;const S=s.replace(Ye,"").trim(),N=S.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let M=S;N&&(E=N[1],M=M.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),M=xt(M);const $={id:`${t}#${n}`,title:M||"",content:s.trim(),type:"task",status:r,category:"任务",tags:Array.from(new Set(u)),recurrence:h,date:void 0,created:0,modified:0,extra:{}};return E&&($.icon=E,d.图标=E),x&&($.priority=x),m&&($.createdDate=m),v&&($.scheduledDate=v),f&&($.startDate=f),k&&($.dueDate=k),y&&($.doneDate=y,r==="done"&&($.date=y)),w&&($.cancelledDate=w,r==="cancelled"&&($.date=w)),r==="open"&&($.date=k||v||f||m),$.extra=d,$}function Et(t,e,n,i,s){const r=e.slice(n+1,i);let o="",u=null,h,c;const d=[],l={};let _=null,y="",w=!1,k=null;for(let f=0;f<r.length;f++){const m=r[f],x=m.trim();if(w)y+=(y?`
`:"")+m;else{if(x==="")continue;const E=x.match(/^([^:：]{1,20})::\s*(.*)$/);if(E){const S=E[1].trim(),N=E[2]||"",M=S.toLowerCase();if(["分类","类别","category"].includes(M))u=N.trim();else if(["主题","标签","tag","tags"].includes(M))_=N.trim();else if(["状态","status"].includes(M))h=N.trim();else if(["日期","date"].includes(M))c=it(N.trim());else if(["内容","content"].includes(M))w=!0,y=N;else if(["图标","icon"].includes(M))k=N.trim(),l.图标=k;else{const $=Number(N.trim());let A=N.trim();A!==""&&!isNaN($)?A=$:/^(true|false)$/i.test(A)&&(A=A.toLowerCase()==="true"),l[S]=A}}else w=!0,y=m}}_&&_.split(/[,，]/).map(f=>f.trim()).filter(Boolean).forEach(f=>d.push(f.replace(/^#/,""))),y.trim()!==""?o=y.trim().split(/\r?\n/)[0]:_&&(o=_.split(/[,，]/).map(f=>f.trim()).filter(Boolean).join(", ")),o=o.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),o&&(o=o.slice(0,10)),u||(u=s||"");const v={id:`${t}#${n+1}`,title:o||"",content:y.trim(),type:"block",status:h,category:u,tags:Array.from(new Set(d)),recurrence:"none",date:c,created:0,modified:0,extra:l};return k&&(v.icon=k),v}function Ct(t,e=250){let n=0,i=null;return function(...s){const r=Date.now();r-n>=e?(n=r,t.apply(this,s)):(clearTimeout(i),i=setTimeout(()=>{n=Date.now(),t.apply(this,s)},e-(r-n)))}}class G{constructor(e){this.items=[],this.fileIndex=new Map,this.changeListeners=new Set,this._emitThrottled=Ct(()=>this._emitChange(),250),this.app=e,G.instance=this}async scanAll(){this.items=[],this.fileIndex.clear();const e=this.app.vault.getMarkdownFiles();for(const n of e)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(e){try{const i=(await this.app.vault.read(e)).split(/\r?\n/),s=e.path,r=e.parent?.name||"",o=[],h=this.app.metadataCache.getFileCache(e)?.headings||[];let c=0,d=[],l="";for(let _=0;_<i.length;_++){const y=i[_];if(c<h.length&&h[c].position.start.line===_){const v=h[c].heading,f=v.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];d=f.map(x=>x.replace("#","")).filter(Boolean);let m=v;for(const x of f)m=m.replace(x,"").trim();l=m||"",c++;continue}if(y.trim()==="<!-- start -->"){const k=i.indexOf("<!-- end -->",_+1);if(k!==-1){const v=Et(s,i,_,k,r);if(v){v.created=e.stat.ctime,v.modified=e.stat.mtime,l&&(v.header=l),v.tags=Array.from(new Set([...d,...v.tags]));let f=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;v.filename=f,o.push(v)}_=k;continue}}const w=St(s,y,_+1,r);if(w){w.tags=Array.from(new Set([...d,...w.tags])),w.created=e.stat.ctime,w.modified=e.stat.mtime,l&&(w.header=l);let k=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;w.filename=k,o.push(w)}}return this.fileIndex.has(s)&&(this.items=this.items.filter(_=>_.id&&!_.id.startsWith(s+"#"))),this.fileIndex.set(s,o),this.items.push(...o),o}catch(n){return console.error("ThinkPlugin: 扫描文件失败",e.path,n),[]}}removeFileItems(e){this.fileIndex.has(e)&&(this.fileIndex.delete(e),this.items=this.items.filter(n=>!n.id.startsWith(e+"#")))}removeFile(e){this.removeFileItems(e)}queryItems(e=[],n=[]){let i=this.items.filter(s=>(e||[]).every(r=>this._matchItem(s,r)));return n.length>0&&i.sort((s,r)=>{for(const o of n){const u=q(s,o.field),h=q(r,o.field);if(!(u==null&&h==null)){if(u==null)return o.dir==="asc"?1:-1;if(h==null)return o.dir==="asc"?-1:1;if(typeof u=="number"&&typeof h=="number"){if(u!==h)return o.dir==="asc"?u-h:h-u}else{const c=String(u),d=String(h);if(c!==d)return o.dir==="asc"?c.localeCompare(d):d.localeCompare(c)}}}return 0}),i}query(e=[],n=[]){return this.queryItems(e,n)}async markItemDone(e){const n=e.split("#"),i=n[0],s=Number(n[1])||0,r=this.app.vault.getAbstractFileByPath(i);if(r instanceof Y.TFile)try{const u=(await this.app.vault.read(r)).split(/\r?\n/);if(s<=0||s>u.length)return;const h=u[s-1];if(!/^\s*-\s*\[ \]/.test(h))return;const c=window.moment,d=c().format("YYYY-MM-DD"),l=c().format("HH:mm");let _=h;if(_=_.replace(/(\s|^)(时长::[^\s\(\)]+)/g,(w,k,v)=>w.includes("(")&&w.includes(")")?w:`${k}(${v})`),/\(时长::[^\)]+\)/.test(_)?_=_.replace(/\((时长::[^\)]+)\)/,`(时间::${l}) ($1)`):/时长::[^\s]+/.test(_)?_=_.replace(/(时长::[^\s]+)/,`(时间::${l}) ($1)`):/🔁/.test(_)?_=_.replace(/(🔁)/,`(时间::${l}) $1`):_=_+` (时间::${l})`,_=_.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(_)||(_="- [x] "+_.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")),_=_.replace(/\s*✅\s*\d{4}-\d{2}-\d{2}$/,""),_=_.trim()+` ✅ ${d}`,h.includes("🔁")){const w=v=>{let f=v;f=f.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]"),f=f.replace(/\s*✅\s*\d{4}[-/]\d{2}[-/]\d{2}/,""),f=f.replace(/\(时间::\d{2}:\d{2}\)/,"");const m=v.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/),x=window.moment;let E=1,S="day",N=!1;m&&(m[1]&&(E=parseInt(m[1])),S=m[2],S.endsWith("s")&&(S=S.slice(0,-1)),N=!!m[3]);const A=(N?x():(()=>{const a=v.match(/📅\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(a)return x(a[1],["YYYY-MM-DD","YYYY/MM/DD"]);const g=v.match(/⏳\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(g)return x(g[1],["YYYY-MM-DD","YYYY/MM/DD"]);const b=v.match(/🛫\s*(\d{4}[-/]\d{2}[-/]\d{2})/);return b?x(b[1],["YYYY-MM-DD","YYYY/MM/DD"]):x()})()).clone().add(E,S+(E>1?"s":"")).format("YYYY-MM-DD");return/📅\s*\d{4}-\d{2}-\d{2}/.test(f)&&(f=f.replace(/📅\s*\d{4}[-/]\d{2}[-/]\d{2}/,`📅 ${A}`)),/⏳\s*\d{4}-\d{2}-\d{2}/.test(f)&&(f=f.replace(/⏳\s*\d{4}[-/]\d{2}[-/]\d{2}/,`⏳ ${A}`)),/🛫\s*\d{4}-\d{2}-\d{2}/.test(f)&&(f=f.replace(/🛫\s*\d{4}[-/]\d{2}[-/]\d{2}/,`🛫 ${A}`)),f=f.trim(),f};u[s-1]=_;const k=w(h);u.splice(s,0,k)}else u[s-1]=_;await this.app.vault.modify(r,u.join(`
`)),await this.scanFile(r),this._emitChange()}catch(o){console.error("ThinkPlugin: 标记任务完成时发生错误",o)}}_emitChange(){this.changeListeners.forEach(e=>{try{e()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}subscribe(e){this.changeListeners.add(e)}unsubscribe(e){this.changeListeners.delete(e)}notifyChange(){this._emitThrottled()}_matchItem(e,n){const i=q(e,n.field),s=n.value;if(n.op==="="||n.op==="!="){const r=i!=null&&s!=null&&String(i)===String(s);return n.op==="="?r:!r}if(n.op==="includes")return i==null?!1:Array.isArray(i)?i.some(r=>String(r).includes(String(s))):String(i).includes(String(s));if(n.op==="regex"){if(i==null)return!1;try{const r=new RegExp(String(s));return Array.isArray(i)?i.some(o=>r.test(String(o))):r.test(String(i))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",s),!1}}if(n.op===">"||n.op==="<"){if(i==null)return!1;const r=Number(i),o=Number(s);if(!isNaN(r)&&!isNaN(o))return n.op===">"?r>o:r<o;const u=Date.parse(String(i)),h=Date.parse(String(s));if(!isNaN(u)&&!isNaN(h))return n.op===">"?u>h:u<h;const c=String(i),d=String(s);return n.op===">"?c>d:c<d}return!1}}var Tt=0;function p(t,e,n,i,s,r){e||(e={});var o,u,h=e;if("ref"in h)for(u in h={},e)u=="ref"?o=e[u]:h[u]=e[u];var c={type:t,props:h,key:n,ref:o,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Tt,__i:-1,__u:0,__source:s,__self:r};if(typeof t=="function"&&(o=t.defaultProps))for(u in o)h[u]===void 0&&(h[u]=o[u]);return F.vnode&&F.vnode(c),c}function K(t){const e=t.lastIndexOf("#"),n=e>=0?t.substring(0,e):t,i=e>=0?t.substring(e+1):"";return`obsidian://advanced-uri?vault=${encodeURIComponent(G.instance.app.vault.getName())}&filepath=${encodeURIComponent(n)}${i?"&line="+i:""}`}function Nt({items:t,rowField:e,colField:n}){if(!e||!n)return p("div",{children:"（TableView 需要配置 rowField 和 colField）"});const i=[],s=[],r={};for(const o of t){const u=q(o,e)??Me,h=q(o,n)??Me,c=String(u),d=String(h);r[c]||(r[c]={},i.push(c)),r[c][d]||(r[c][d]=[]),r[c][d].push(o),s.includes(d)||s.push(d)}return i.sort(),s.sort(),p("table",{class:"think-table",children:[p("thead",{children:p("tr",{children:[p("th",{children:e}),s.map(o=>p("th",{children:o},o))]})}),p("tbody",{children:i.map(o=>p("tr",{children:[p("td",{children:p("strong",{children:o})}),s.map(u=>{const h=r[o]?.[u]||[];return h.length===0?p("td",{class:"empty"},u):p("td",{children:h.map(c=>p("div",{children:$t(c)},c.id))},u)})]},o))})]})}function $t(t){if(t.type==="task"){const e=t.status==="done",n="cb-"+t.id.replace(/[^a-zA-Z0-9]/g,"_");return p("span",{children:[!e&&p("input",{type:"checkbox",id:n,class:"task-checkbox",onChange:s=>{s.currentTarget.checked&&G.instance.markItemDone(t.id)}}),e&&p("input",{type:"checkbox",id:n,class:"task-checkbox done",checked:!0,onClick:s=>s.preventDefault()}),p("a",{href:K(t.id),target:"_blank",rel:"noopener",children:t.title})]})}return p("a",{href:K(t.id),target:"_blank",rel:"noopener",children:t.title})}const At={打卡:"#d2cceb",任务:"#caebf3",计划:"#d8ecb2",总结:"#E5D5B9",事件:"#94e2d6",感受:"#93daf0",思考:"#f09393"};function ge(t){return At[t]||"#e0e0e0"}function Ft(t){const{groupField:e,showMeta:n=!0,fields:i}=t;let{items:s}=t,r=s;i&&i.length>0&&(r=s.filter(d=>i.some(l=>{const _=q(d,l);return _!=null&&String(_).trim()!==""})));let o=null,u=[];if(e){o={};for(const d of r){const l=String(q(d,e)??"(none)");o[l]||(o[l]=[],u.push(l)),o[l].push(d)}u.sort()}const h=d=>{if(d.type!=="task")return null;const l=d.status==="done";return p("input",{type:"checkbox",class:`task-checkbox ${l?"done":""}`,checked:l,onClick:l?_=>_.preventDefault():void 0,onChange:async _=>{_.target.checked&&!l&&await G.instance.markItemDone(d.id)}})},c=d=>{if(i&&i.length>0){const l=i.includes("title"),_=i.includes("content"),y=["category","date","icon"];if(i.some(m=>y.includes(m))&&(l||_)){const m=[];i.forEach(S=>{if(!y.includes(S))return;const N=q(d,S);N==null||String(N).trim()===""||(S==="category"?m.push(p("span",{class:"tag-pill",style:`background:${ge(d.category)};`,children:d.category},"cat")):S==="date"?m.push(p("span",{class:"tag-pill",children:d.date},"date")):S==="icon"&&m.push(p("span",{class:"tag-pill",children:d.icon},"icon")))});const x=()=>{if(l){const S=_?p("span",{children:d.title}):p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",children:d.title});return p("div",{style:"line-height:1.5;margin-bottom:2px;",children:[h(d),S]})}return _?p("div",{style:"line-height:1.5;margin-bottom:2px;",children:[h(d),p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:d.content})]}):null},E=l&&_?p("div",{style:"white-space:pre-wrap;line-height:1.5;",children:p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",children:d.content})}):null;return p("div",{style:`\r
              display:grid;\r
              grid-template-columns:auto minmax(180px,1fr);\r
              gap:8px;\r
              align-items:start;\r
              margin-bottom:8px;\r
<<<<<<< HEAD
            `,children:[r("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:b}),r("div",{children:[E(),N]})]})}const w=[];let m=!1;return i.forEach((b,E)=>{const N=q(h,b);if(!m&&h.type==="task"&&(b==="title"||b==="content")&&(w.push(_(h)),m=!0),b==="content")w.push(r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:h.content},E));else if(b==="title")i.includes("content")?w.push(r("span",{children:h.title},E)):w.push(r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",children:h.title},E));else if(b==="tags")w.push(r("span",{children:h.tags.map(T=>r("span",{class:"tag-pill",children:T},T))},"tags"));else if(b==="category")w.push(r("span",{class:"tag-pill",style:`background:${ve(h.category)};`,children:h.category},E));else if(b==="icon")h.icon&&w.push(r("span",{class:"tag-pill",children:h.icon},E));else{if(N==null)return;const T=Array.isArray(N)?N.join(", "):String(N);w.push(r("span",{class:"tag-pill",children:T},E))}}),r("div",{style:"margin-bottom:8px;line-height:1.5;",children:w.map((b,E)=>r("span",{children:b},E))})}if(h.type==="task"){const c=h.status==="done";return r("div",{style:"margin-bottom:4px;line-height:1.5;",children:[_(h),r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",class:c?"task-done":"",children:h.title}),h.icon&&r("span",{class:"tag-pill",children:h.icon}),h.tags.map(o=>r("span",{class:"tag-pill",children:o},o))]})}else return r("div",{style:`\r
=======
            `,children:[p("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:m}),p("div",{children:[x(),E]})]})}const v=[];let f=!1;return i.forEach((m,x)=>{const E=q(d,m);if(!f&&d.type==="task"&&(m==="title"||m==="content")&&(v.push(h(d)),f=!0),m==="content")v.push(p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:d.content},x));else if(m==="title")i.includes("content")?v.push(p("span",{children:d.title},x)):v.push(p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",children:d.title},x));else if(m==="tags")v.push(p("span",{children:d.tags.map(S=>p("span",{class:"tag-pill",children:S},S))},"tags"));else if(m==="category")v.push(p("span",{class:"tag-pill",style:`background:${ge(d.category)};`,children:d.category},x));else if(m==="icon")d.icon&&v.push(p("span",{class:"tag-pill",children:d.icon},x));else{if(E==null)return;const S=Array.isArray(E)?E.join(", "):String(E);v.push(p("span",{class:"tag-pill",children:S},x))}}),p("div",{style:"margin-bottom:8px;line-height:1.5;",children:v.map((m,x)=>p("span",{children:m},x))})}if(d.type==="task"){const l=d.status==="done";return p("div",{style:"margin-bottom:4px;line-height:1.5;",children:[h(d),p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",class:l?"task-done":"",children:d.title}),d.icon&&p("span",{class:"tag-pill",children:d.icon}),d.tags.map(_=>p("span",{class:"tag-pill",children:_},_))]})}else return p("div",{style:`\r
>>>>>>> 5136864 (重复性字段能提取了)
            display:grid;\r
            grid-template-columns:auto minmax(180px,1fr);\r
            align-items:start;\r
            gap:8px;\r
            margin-bottom:8px;\r
          `,children:[n&&p("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:[p("span",{class:"tag-pill",style:`background:${ge(d.category)};`,children:d.category}),d.date&&p("span",{class:"tag-pill",children:d.date}),d.extra.图标&&p("span",{class:"tag-pill",children:d.extra.图标})]}),p("div",{style:"white-space:pre-wrap;line-height:1.5;",children:p("a",{href:`${K(d.id)}`,target:"_blank",rel:"noopener",children:d.content})})]})};return p("div",{children:o?u.map(d=>p("div",{children:[p("h5",{children:d}),o[d].map(l=>c(l))]})):r.map(d=>c(d))})}function Yt(t){return p("div",{children:"（Timeline 视图暂未实现）"})}function Mt(t){return p("div",{children:"（Calendar 日视图暂未实现）"})}function Vt(t){return p("div",{children:"（Chart 图表视图暂未实现）"})}function Lt(t){return Array.isArray(t)?t.join(", "):t==null?"":String(t)}function It({items:t,fields:e}){const n=e&&e.length?e:nt(t);return p("div",{children:p("table",{class:"think-table",style:"min-width:100%; white-space:nowrap;",children:[p("thead",{children:p("tr",{children:n.map(i=>p("th",{children:i},i))})}),p("tbody",{children:t.map(i=>p("tr",{children:n.map(s=>p("td",{children:Lt(q(i,s))},s))},i.id))})]})})}var ne,V,me,Ve,ce=0,st=[],I=F,Le=I.__b,Ie=I.__r,Pe=I.diffed,Oe=I.__c,Be=I.unmount,He=I.__;function Te(t,e){I.__h&&I.__h(V,t,ce||e),ce=0;var n=V.__H||(V.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function z(t){return ce=1,Pt(at,t)}function Pt(t,e,n){var i=Te(ne++,2);if(i.t=t,!i.__c&&(i.__=[at(void 0,e),function(u){var h=i.__N?i.__N[0]:i.__[0],c=i.t(h,u);h!==c&&(i.__N=[c,i.__[1]],i.__c.setState({}))}],i.__c=V,!V.__f)){var s=function(u,h,c){if(!i.__c.__H)return!0;var d=i.__c.__H.__.filter(function(_){return!!_.__c});if(d.every(function(_){return!_.__N}))return!r||r.call(this,u,h,c);var l=i.__c.props!==u;return d.forEach(function(_){if(_.__N){var y=_.__[0];_.__=_.__N,_.__N=void 0,y!==_.__[0]&&(l=!0)}}),r&&r.call(this,u,h,c)||l};V.__f=!0;var r=V.shouldComponentUpdate,o=V.componentWillUpdate;V.componentWillUpdate=function(u,h,c){if(this.__e){var d=r;r=void 0,s(u,h,c),r=d}o&&o.call(this,u,h,c)},V.shouldComponentUpdate=s}return i.__N||i.__}function ke(t,e){var n=Te(ne++,3);!I.__s&&rt(n.__H,e)&&(n.__=t,n.u=e,V.__H.__h.push(n))}function Ot(t){return ce=5,Bt(function(){return{current:t}},[])}function Bt(t,e){var n=Te(ne++,7);return rt(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Ht(){for(var t;t=st.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(le),t.__H.__h.forEach(xe),t.__H.__h=[]}catch(e){t.__H.__h=[],I.__e(e,t.__v)}}I.__b=function(t){V=null,Le&&Le(t)},I.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),He&&He(t,e)},I.__r=function(t){Ie&&Ie(t),ne=0;var e=(V=t.__c).__H;e&&(me===V?(e.__h=[],V.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(le),e.__h.forEach(xe),e.__h=[],ne=0)),me=V},I.diffed=function(t){Pe&&Pe(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(st.push(e)!==1&&Ve===I.requestAnimationFrame||((Ve=I.requestAnimationFrame)||Rt)(Ht)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),me=V=null},I.__c=function(t,e){e.some(function(n){try{n.__h.forEach(le),n.__h=n.__h.filter(function(i){return!i.__||xe(i)})}catch(i){e.some(function(s){s.__h&&(s.__h=[])}),e=[],I.__e(i,n.__v)}}),Oe&&Oe(t,e)},I.unmount=function(t){Be&&Be(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{le(i)}catch(s){e=s}}),n.__H=void 0,e&&I.__e(e,n.__v))};var Re=typeof requestAnimationFrame=="function";function Rt(t){var e,n=function(){clearTimeout(i),Re&&cancelAnimationFrame(e),setTimeout(t)},i=setTimeout(n,35);Re&&(e=requestAnimationFrame(n))}function le(t){var e=V,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),V=e}function xe(t){var e=V;t.__c=t.__(),V=e}function rt(t,e){return!t||t.length!==e.length||e.some(function(n,i){return n!==t[i]})}function at(t,e){return typeof e=="function"?e(t):e}function Wt({storageKey:t="inputSettings",plugin:e}){const n=e[t]||{},[i,s]=z(typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))),r=(u,h)=>s(c=>({...c,[u]:h})),o=async()=>{e[t]=i,await e.persistAll(),alert("已保存配置")};return p("div",{style:"display:flex;flex-direction:column;gap:6px;max-width:420px;",children:[p("label",{children:["主题 (可层级“生活/健康”)：",p("input",{value:i.topic||"",onInput:u=>r("topic",u.target.value)})]}),p("label",{children:["图标 (emoji)：",p("input",{value:i.icon||"",onInput:u=>r("icon",u.target.value),placeholder:"✨"})]}),p("label",{children:["任务字段清单 (逗号分隔)：",p("input",{value:i.taskFields||"",onInput:u=>r("taskFields",u.target.value),placeholder:"status,icon,repeat,…"})]}),p("label",{children:["Block 字段清单 (逗号分隔)：",p("input",{value:i.blockFields||"",onInput:u=>r("blockFields",u.target.value),placeholder:"分类,周期,日期,主题,图标,内容"})]}),p("button",{style:"margin-top:8px;",onClick:o,children:"💾 保存配置"})]})}const lt={TableView:Nt,BlockView:Ft,TimelineView:Yt,CalendarView:Mt,ChartView:Vt,ExcelView:It,SettingsFormView:Wt},We=lt,Ue=Object.keys(lt);class Ut extends Y.PluginSettingTab{constructor(e,n){super(e,n),this.selectedDashName="",this.plugin=n,n.dashboards.length>0&&(this.selectedDashName=n.dashboards[0].name)}display(){const{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Think 仪表盘 配置编辑"});const n=this.plugin.dataStore.queryItems(),i=nt(n),s=new Set,r=new Set,o=new Set,u=new Set,h=new Set;for(const a of n)(a.tags||[]).forEach(g=>g&&s.add(g)),a.category&&r.add(a.category),a.status&&o.add(a.status),a.recurrence&&u.add(a.recurrence),a.type&&h.add(a.type);const c=e.createEl("datalist");c.id="think-tags-list",Array.from(s).forEach(a=>c.createEl("option",{value:a}));const d=e.createEl("datalist");d.id="think-category-list",Array.from(r).forEach(a=>d.createEl("option",{value:a}));const l=e.createEl("datalist");l.id="think-status-list",Array.from(o).forEach(a=>l.createEl("option",{value:a}));const _=e.createEl("datalist");_.id="think-recurrence-list",Array.from(u).forEach(a=>_.createEl("option",{value:a}));const y=e.createEl("datalist");y.id="think-type-list",Array.from(h).forEach(a=>y.createEl("option",{value:a}));const w=e.createEl("datalist");w.id="think-fields-list",i.forEach(a=>w.createEl("option",{value:a}));const k=e.createEl("select");for(const a of this.plugin.dashboards){const g=k.createEl("option",{text:a.name});g.value=a.name,a.name===this.selectedDashName&&(g.selected=!0)}k.onchange=()=>{this.selectedDashName=k.value,this.display()};const v=e.createEl("button",{text:"新建仪表盘"});if(v.style.marginLeft="8px",v.onclick=()=>{let a="新仪表盘",g=a,b=1;for(;this.plugin.dashboards.find(L=>L.name===g);)g=a+b++;const C={name:g,modules:[]};this.plugin.dashboards.push(C),this.selectedDashName=g,this.plugin.saveData({dashboards:this.plugin.dashboards}),new Y.Notice("已添加新仪表盘配置"),this.display()},this.plugin.dashboards.length>0){const a=e.createEl("button",{text:"删除当前仪表盘"});a.style.marginLeft="8px",a.onclick=()=>{const g=this.plugin.dashboards.findIndex(b=>b.name===this.selectedDashName);g>=0&&(this.plugin.dashboards.splice(g,1),new Y.Notice(`已删除配置：${this.selectedDashName}`),this.selectedDashName=this.plugin.dashboards.length?this.plugin.dashboards[0].name:"",this.plugin.saveData({dashboards:this.plugin.dashboards}),this.display())}}e.createEl("hr");const f=this.plugin.dashboards.find(a=>a.name===this.selectedDashName);if(!f)return;const m=e.createEl("fieldset");m.createEl("legend",{text:"基础设置"}),new Y.Setting(m).setName("仪表盘名称").addText(a=>{a.setValue(f.name).onChange(g=>{f.name=g.trim()})}),new Y.Setting(m).setName("数据源路径").addText(a=>{a.setValue(f.path||"").onChange(g=>{f.path=g.trim()})}),new Y.Setting(m).setName("标签 (用逗号分隔)").addText(a=>{const g=Array.isArray(f.tags)?f.tags.join(","):f.tags||"";a.setValue(g).onChange(b=>{f.tags=b.split(/[,，]/).map(C=>C.trim()).filter(C=>C)})}),new Y.Setting(m).setName("初始视图").addDropdown(a=>{["年","季","月","周","天"].forEach(b=>a.addOption(b,b)),a.setValue(f.initialView||"月"),a.onChange(b=>{f.initialView=b})});const x=new Date,E=`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`,S=f.initialDate||E;f.initialDate||(f.initialDate=S),new Y.Setting(m).setName("初始日期").addText(a=>{a.inputEl.type="date",a.setValue(S).onChange(g=>{f.initialDate=g})}),e.createEl("h3",{text:"模块列表"}),f.modules.forEach((a,g)=>{const b=e.createEl("fieldset");b.style.border="1px solid #ccc",b.style.padding="8px",b.style.marginBottom="8px",b.dataset.index=g.toString(),b.createEl("legend",{text:`${a.title||"模块"} (${a.view})`}),new Y.Setting(b).setName("模块标题").addText(D=>{D.setValue(a.title).onChange(T=>a.title=T)}),new Y.Setting(b).setName("视图类型").addDropdown(D=>{Ue.forEach(T=>D.addOption(T,T)),D.setValue(a.view),D.onChange(T=>{a.view=T,this.display()})}),new Y.Setting(b).addToggle(D=>{D.setValue(!!a.collapsed).onChange(T=>{a.collapsed=T})}).setName("默认折叠"),a.view==="TableView"&&(new Y.Setting(b).setName("行字段 (rowField)").addText(D=>{D.setValue(a.props?.rowField||"").onChange(T=>{a.props||(a.props={}),a.props.rowField=T.trim()}),D.inputEl.setAttr("list","think-fields-list")}),new Y.Setting(b).setName("列字段 (colField)").addText(D=>{D.setValue(a.props?.colField||"").onChange(T=>{a.props||(a.props={}),a.props.colField=T.trim()}),D.inputEl.setAttr("list","think-fields-list")})),(a.view==="BlockView"||a.view==="TimelineView")&&new Y.Setting(b).setName("分组字段").addText(D=>{D.setValue(a.group||"").onChange(T=>{a.group=T.trim()||void 0}),D.inputEl.setAttr("list","think-fields-list")}),a.view!=="TableView"&&a.view!=="ChartView"&&a.view!=="CalendarView"&&new Y.Setting(b).setName("显示字段 (用逗号分隔)").addText(D=>{const T=a.fields?a.fields.join(","):"";D.setPlaceholder("如 title,tags,date").setValue(T).onChange(B=>{const O=B.split(/[,，]/).map(U=>U.trim()).filter(U=>U);a.fields=O.length>0?O:void 0}),D.inputEl.setAttr("list","think-fields-list")});const C=b.createDiv();C.style.borderTop="1px dashed #ccc",C.style.marginTop="6px",C.style.paddingTop="6px",C.createEl("strong",{text:"过滤规则"}),(a.filters||[]).forEach((D,T)=>{const B=C.createDiv({cls:"filter-row"});B.style.display="flex",B.style.marginBottom="4px";const O=B.createEl("input");O.type="text",O.style.flex="0 0 30%",O.value=D.field,O.setAttr("list","think-fields-list");const U=B.createEl("select");["=","!=","includes","regex",">","<"].forEach(j=>{U.add(new Option(j,j,!1,j===D.op))}),U.onchange=()=>{D.op=U.value};const H=B.createEl("input");H.type="text",H.style.flex="0 0 30%",H.value=String(D.value);const ee=()=>{H.removeAttribute("list");const j=O.value.trim();j==="tags"?H.setAttr("list","think-tags-list"):j==="category"?H.setAttr("list","think-category-list"):j==="status"?H.setAttr("list","think-status-list"):j==="recurrence"?H.setAttr("list","think-recurrence-list"):j==="type"&&H.setAttr("list","think-type-list")};ee(),O.onchange=()=>{D.field=O.value.trim(),ee()},H.onchange=()=>{D.value=H.value};const _e=B.createEl("button",{text:"删除"});_e.onclick=()=>{a.filters.splice(T,1),this.display()}});const L=C.createEl("button",{text:"+ 添加过滤条件"});L.onclick=()=>{a.filters||(a.filters=[]),a.filters.push({field:"",op:"=",value:""}),this.display()};const P=b.createDiv();P.style.borderTop="1px dashed #ccc",P.style.marginTop="6px",P.style.paddingTop="6px",P.createEl("strong",{text:"排序规则"}),(a.sort||[]).forEach((D,T)=>{const B=P.createDiv({cls:"sort-row"});B.style.display="flex",B.style.marginBottom="4px";const O=B.createEl("input");O.type="text",O.style.flex="0 0 40%",O.value=D.field,O.setAttr("list","think-fields-list"),O.onchange=()=>D.field=O.value.trim();const U=B.createEl("select");[["asc","升序"],["desc","降序"]].forEach(([ee,_e])=>{U.add(new Option(_e,ee,!1,ee===D.dir))}),U.onchange=()=>{D.dir=U.value};const H=B.createEl("button",{text:"删除"});H.style.marginLeft="4px",H.onclick=()=>{a.sort.splice(T,1),this.display()}});const W=P.createEl("button",{text:"+ 添加排序条件"});W.onclick=()=>{a.sort||(a.sort=[]),a.sort.push({field:"",dir:"asc"}),this.display()};const R=b.createDiv({cls:"module-actions"});if(R.style.textAlign="right",g>0){const D=R.createEl("button",{text:"↑ 上移"});D.onclick=()=>{const T=f.modules;[T[g-1],T[g]]=[T[g],T[g-1]],this.display()}}if(g<f.modules.length-1){const D=R.createEl("button",{text:"↓ 下移"});D.onclick=()=>{const T=f.modules;[T[g+1],T[g]]=[T[g],T[g+1]],this.display()}}const ot=R.createEl("button",{text:"删除模块"});ot.onclick=()=>{f.modules.splice(g,1),this.display()}});const N=e.createDiv(),M=N.createEl("select");Ue.forEach(a=>{M.add(new Option(a,a))});const $=N.createEl("button",{text:"添加模块"});$.style.marginLeft="6px",$.onclick=()=>{const g={view:M.value,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};f.modules.push(g),this.display()},e.createEl("hr");const A=e.createEl("button",{text:"保存配置"});A.onclick=()=>{if(f.name!==this.selectedDashName&&this.plugin.dashboards.some(a=>a!==f&&a.name===f.name)){new Y.Notice("配置名称已存在，请更换名称");return}this.plugin.saveData({dashboards:this.plugin.dashboards}).then(()=>{new Y.Notice("仪表盘配置已保存"),this.plugin.refreshAllDashboards(),this.selectedDashName=f.name,this.display()})}}}function ye({module:t,children:e}){const[n,i]=z(!!t.collapsed),s=Ot(null),r=()=>i(u=>!u),o=u=>{if(u.metaKey||u.ctrlKey){const h=!n,c=new CustomEvent("think-toggle-all",{detail:h});document.querySelectorAll(".think-module").forEach(d=>d.dispatchEvent(c))}else r()};return ke(()=>{const u=c=>{const d=c.detail;i(d)},h=s.current;if(h)return h.addEventListener("think-toggle-all",u),()=>h.removeEventListener("think-toggle-all",u)},[]),p("div",{class:"think-module",ref:s,children:[p("div",{class:"module-header",onClick:o,title:"点击折叠/展开；Ctrl/⌘ + 点击：全部折叠/展开",children:[p("span",{class:"module-title",children:t.title}),p("span",{class:"module-toggle",children:n?"▶":"▼"})]}),!n&&p("div",{class:"module-content",children:e})]})}const qt=["一","二","三","四"];function ve({config:t,dataStore:e,plugin:n}){const i=window.moment,s=t.initialView||"月",r=t.initialDate?i(t.initialDate,"YYYY-MM-DD"):i(),[o,u]=z(s),[h,c]=z(r),[d,l]=z(!1),[_,y]=z(null),[w,k]=z("TableView"),[v,f]=z(0),[m,x]=z("");ke(()=>{const a=()=>f(g=>g+1);return e.subscribe(a),()=>e.unsubscribe(a)},[e]),ke(()=>{d?(y((g=>typeof structuredClone=="function"?structuredClone(g):JSON.parse(JSON.stringify(g)))(t)),k("TableView")):y(null)},[d,t]);const E=(a,g)=>{let b=a.clone(),C=a.clone();switch(g){case"年":b=a.clone().startOf("year"),C=a.clone().endOf("year");break;case"季":b=a.clone().startOf("quarter"),C=a.clone().endOf("quarter");break;case"月":b=a.clone().startOf("month"),C=a.clone().endOf("month");break;case"周":b=a.clone().startOf("week"),C=a.clone().endOf("week");break;case"天":b=a.clone().startOf("day"),C=a.clone().endOf("day");break}return{startDate:b,endDate:C}},S=(a,g)=>{switch(g){case"年":return a.format("YYYY年");case"季":{const b=a.quarter();return`${a.year()}年${qt[b-1]}季度`}case"月":return a.format("YYYY-MM");case"周":return a.format("YYYY-[W]WW");case"天":return a.format("YYYY-MM-DD");default:return a.format("YYYY-MM-DD")}},N=()=>{switch(o){case"年":c(h.clone().subtract(1,"year"));break;case"季":c(h.clone().subtract(1,"quarter"));break;case"月":c(h.clone().subtract(1,"month"));break;case"周":c(h.clone().subtract(1,"week"));break;case"天":c(h.clone().subtract(1,"day"));break}},M=()=>{switch(o){case"年":c(h.clone().add(1,"year"));break;case"季":c(h.clone().add(1,"quarter"));break;case"月":c(h.clone().add(1,"month"));break;case"周":c(h.clone().add(1,"week"));break;case"天":c(h.clone().add(1,"day"));break}},$=()=>c(i()),A=a=>{if(a.view==="SettingsFormView"){const L=We[a.view];return p(ye,{module:a,children:p(L,{plugin:n,storageKey:"inputSettings"})})}let g=e.queryItems(a.filters||[],a.sort||[]);if(t.tags?.length&&(g=g.filter(L=>L.tags.some(P=>t.tags.some(W=>P.includes(W))))),t.path&&t.path.trim()!==""){const L=t.path.trim(),P=G.instance.app.vault.getAbstractFileByPath(L);if(P){if(P instanceof Y.TFolder){const W=L.endsWith("/")?L:L+"/";g=g.filter(R=>R.id.startsWith(W))}else if(P instanceof Y.TFile){const W=L+"#";g=g.filter(R=>R.id.startsWith(W))}}else{const W=L.endsWith("/")?L:L+"/";g=g.filter(R=>R.id.startsWith(W))}}if(o&&h){const{startDate:L,endDate:P}=E(h,o);g=g.filter(W=>{if(!W.date)return!0;const R=i(W.date,"YYYY-MM-DD");return R.isSameOrAfter(L)&&R.isSameOrBefore(P)})}if(m.trim()){const L=m.toLowerCase();g=g.filter(P=>(P.title+" "+P.content).toLowerCase().includes(L))}const b=We[a.view];if(!b)return p(ye,{module:a,children:p("div",{children:["未知视图: ",a.view]})});const C={...a.props||{}};return a.group&&(C.groupField=a.group),a.fields&&(C.fields=a.fields),p(ye,{module:a,children:p(b,{items:g,...C})})};return p("div",{children:[p("div",{class:"tp-toolbar",style:"margin-bottom:8px;",children:[["年","季","月","周","天"].map(a=>p("button",{onClick:()=>u(a),class:a===o?"active":"",children:a})),p("button",{disabled:!0,style:"font-weight:bold;margin:0 4px;background:#fff;cursor:default;",children:S(h,o)}),p("button",{onClick:N,children:"←"}),p("button",{onClick:M,children:"→"}),p("button",{onClick:$,children:"＝"}),p("input",{placeholder:"快速过滤…",style:"margin-left:4px;",value:m,onInput:a=>x(a.target.value)}),p("button",{onClick:()=>l(!d),style:"margin-left:4px;",children:"⚙︎"})]}),d&&_&&p("div",{style:"border:1px solid #eee;padding:12px;margin-bottom:12px;border-radius:8px;background:#fcfcfc;"}),!d&&t.modules.map(a=>A(a))]})}class jt extends Y.Plugin{constructor(){super(...arguments),this.dashboards=[],this.activeDashboards=[],this.inputSettings={}}async onload(){console.log("ThinkPlugin 加载 - 重构版");const e=await this.loadData();e?.dashboards&&(this.dashboards=e.dashboards),this.dashboards.length===0&&this._createDefaultDashboard(),this.inputSettings=e?.inputSettings??{};for(const s of this.dashboards)for(const r of s.modules)r.view==="ListView"&&(r.view="BlockView");this.dataStore=new G(this.app),await this.dataStore.scanAll();const n=this.app.vault.on.bind(this.app.vault),i=s=>this.dataStore.scanFile(s).then(()=>this.dataStore.notifyChange());this.registerEvent(n("modify",s=>{s instanceof Y.TFile&&s.extension==="md"&&i(s)})),this.registerEvent(n("create",s=>{s instanceof Y.TFile&&s.extension==="md"&&i(s)})),this.registerEvent(n("delete",s=>{s instanceof Y.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(s.path),this.dataStore.notifyChange())})),this.registerEvent(n("rename",(s,r)=>{s instanceof Y.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(r),i(s))})),this.registerMarkdownCodeBlockProcessor(wt,(s,r)=>{let o,u;try{const c=s.trim()?JSON.parse(s):{};Array.isArray(c.modules)?u={name:c.name||"__inline__",path:c.path||"",tags:c.tags||[],initialView:c.initialView||"月",initialDate:c.initialDate||"",modules:c.modules}:o=c.config||c.dashboard||c.name}catch(c){console.warn("ThinkPlugin: 仪表盘代码块 JSON 解析失败，使用默认",c)}if(u){pe(se(ve,{config:u,dataStore:this.dataStore,plugin:this}),r),this.activeDashboards.push({container:r,configName:u.name});return}!o&&this.dashboards.length&&(o=this.dashboards[0].name);const h=this.dashboards.find(c=>c.name===o);if(!h){r.createDiv({text:`找不到名称为 "${o}" 的仪表盘配置`});return}pe(se(ve,{config:h,dataStore:this.dataStore,plugin:this}),r),this.activeDashboards.push({container:r,configName:h.name})}),this._injectStyles(),this.addSettingTab(new Ut(this.app,this))}onunload(){const e=document.getElementById(fe);e&&e.remove(),console.log("ThinkPlugin 卸载")}refreshAllDashboards(){this.activeDashboards=this.activeDashboards.filter(e=>document.body.contains(e.container));for(const e of this.activeDashboards){const n=this.dashboards.find(i=>i.name===e.configName);n&&pe(se(ve,{config:n,dataStore:this.dataStore,plugin:this}),e.container)}}async persistAll(){const e={dashboards:this.dashboards,inputSettings:this.inputSettings};await this.saveData(e)}_createDefaultDashboard(){const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i={name:"默认仪表盘",path:"",tags:[],initialView:"月",initialDate:n,modules:[{view:"BlockView",title:"未完成任务",collapsed:!1,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"open"}],sort:[],props:{}},{view:"BlockView",title:"已完成任务",collapsed:!0,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"done"}],sort:[{field:"date",dir:"desc"}],props:{}}]};this.dashboards.push(i)}_injectStyles(){if(document.getElementById(fe))return;const e=document.createElement("style");e.id=fe,e.textContent=kt,document.head.appendChild(e)}}module.exports=jt;
//# sourceMappingURL=main.js.map
