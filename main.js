"use strict";const V=require("obsidian");var he,L,Ke,G,Ye,ze,Xe,Je,Ee,ke,xe,ne={},Ge=[],ct=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,pe=Array.isArray;function J(t,e){for(var n in e)t[n]=e[n];return t}function Ce(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function ae(t,e,n){var i,s,l,d={};for(l in e)l=="key"?i=e[l]:l=="ref"?s=e[l]:d[l]=e[l];if(arguments.length>2&&(d.children=arguments.length>3?he.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(l in t.defaultProps)d[l]===void 0&&(d[l]=t.defaultProps[l]);return le(t,d,i,s,null)}function le(t,e,n,i,s){var l={type:t,props:e,key:n,ref:i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:s??++Ke,__i:-1,__u:0};return s==null&&L.vnode!=null&&L.vnode(l),l}function _e(t){return t.children}function oe(t,e){this.props=t,this.context=e}function ee(t,e){if(e==null)return t.__?ee(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?ee(t):null}function Qe(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Qe(t)}}function Fe(t){(!t.__d&&(t.__d=!0)&&G.push(t)&&!de.__r++||Ye!=L.debounceRendering)&&((Ye=L.debounceRendering)||ze)(de)}function de(){for(var t,e,n,i,s,l,d,p=1;G.length;)G.length>p&&G.sort(Xe),t=G.shift(),p=G.length,t.__d&&(n=void 0,s=(i=(e=t).__v).__e,l=[],d=[],e.__P&&((n=J({},i)).__v=i.__v+1,L.vnode&&L.vnode(n),Te(e.__P,n,i,e.__n,e.__P.namespaceURI,32&i.__u?[s]:null,l,s??ee(i),!!(32&i.__u),d),n.__v=i.__v,n.__.__k[n.__i]=n,tt(l,n,d),n.__e!=s&&Qe(n)));de.__r=0}function Ze(t,e,n,i,s,l,d,p,_,u,h){var c,o,v,x,S,w,m=i&&i.__k||Ge,b=e.length;for(_=dt(n,e,m,_,b),c=0;c<b;c++)(v=n.__k[c])!=null&&(o=v.__i==-1?ne:m[v.__i]||ne,v.__i=c,w=Te(t,v,o,s,l,d,p,_,u,h),x=v.__e,v.ref&&o.ref!=v.ref&&(o.ref&&Ne(o.ref,null,v),h.push(v.ref,v.__c||x,v)),S==null&&x!=null&&(S=x),4&v.__u||o.__k===v.__k?_=et(v,_,t):typeof v.type=="function"&&w!==void 0?_=w:x&&(_=x.nextSibling),v.__u&=-7);return n.__e=S,_}function dt(t,e,n,i,s){var l,d,p,_,u,h=n.length,c=h,o=0;for(t.__k=new Array(s),l=0;l<s;l++)(d=e[l])!=null&&typeof d!="boolean"&&typeof d!="function"?(_=l+o,(d=t.__k[l]=typeof d=="string"||typeof d=="number"||typeof d=="bigint"||d.constructor==String?le(null,d,null,null,null):pe(d)?le(_e,{children:d},null,null,null):d.constructor==null&&d.__b>0?le(d.type,d.props,d.key,d.ref?d.ref:null,d.__v):d).__=t,d.__b=t.__b+1,p=null,(u=d.__i=ut(d,n,_,c))!=-1&&(c--,(p=n[u])&&(p.__u|=2)),p==null||p.__v==null?(u==-1&&(s>h?o--:s<h&&o++),typeof d.type!="function"&&(d.__u|=4)):u!=_&&(u==_-1?o--:u==_+1?o++:(u>_?o--:o++,d.__u|=4))):t.__k[l]=null;if(c)for(l=0;l<h;l++)(p=n[l])!=null&&(2&p.__u)==0&&(p.__e==i&&(i=ee(p)),it(p,p));return i}function et(t,e,n){var i,s;if(typeof t.type=="function"){for(i=t.__k,s=0;i&&s<i.length;s++)i[s]&&(i[s].__=t,e=et(i[s],e,n));return e}t.__e!=e&&(e&&t.type&&!n.contains(e)&&(e=ee(t)),n.insertBefore(t.__e,e||null),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function ut(t,e,n,i){var s,l,d=t.key,p=t.type,_=e[n];if(_===null&&t.key==null||_&&d==_.key&&p==_.type&&(2&_.__u)==0)return n;if(i>(_!=null&&(2&_.__u)==0?1:0))for(s=n-1,l=n+1;s>=0||l<e.length;){if(s>=0){if((_=e[s])&&(2&_.__u)==0&&d==_.key&&p==_.type)return s;s--}if(l<e.length){if((_=e[l])&&(2&_.__u)==0&&d==_.key&&p==_.type)return l;l++}}return-1}function Ve(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||ct.test(e)?n:n+"px"}function se(t,e,n,i,s){var l,d;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof i=="string"&&(t.style.cssText=i=""),i)for(e in i)n&&e in n||Ve(t.style,e,"");if(n)for(e in n)i&&n[e]==i[e]||Ve(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")l=e!=(e=e.replace(Je,"$1")),d=e.toLowerCase(),e=d in t||e=="onFocusOut"||e=="onFocusIn"?d.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+l]=n,n?i?n.u=i.u:(n.u=Ee,t.addEventListener(e,l?xe:ke,l)):t.removeEventListener(e,l?xe:ke,l);else{if(s=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Ie(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=Ee++;else if(e.t<n.u)return;return n(L.event?L.event(e):e)}}}function Te(t,e,n,i,s,l,d,p,_,u){var h,c,o,v,x,S,w,m,b,E,N,T,F,O,I,M,f,a=e.type;if(e.constructor!=null)return null;128&n.__u&&(_=!!(32&n.__u),l=[p=e.__e=n.__e]),(h=L.__b)&&h(e);e:if(typeof a=="function")try{if(m=e.props,b="prototype"in a&&a.prototype.render,E=(h=a.contextType)&&i[h.__c],N=h?E?E.props.value:h.__:i,n.__c?w=(c=e.__c=n.__c).__=c.__E:(b?e.__c=c=new a(m,N):(e.__c=c=new oe(m,N),c.constructor=a,c.render=pt),E&&E.sub(c),c.props=m,c.state||(c.state={}),c.context=N,c.__n=i,o=c.__d=!0,c.__h=[],c._sb=[]),b&&c.__s==null&&(c.__s=c.state),b&&a.getDerivedStateFromProps!=null&&(c.__s==c.state&&(c.__s=J({},c.__s)),J(c.__s,a.getDerivedStateFromProps(m,c.__s))),v=c.props,x=c.state,c.__v=e,o)b&&a.getDerivedStateFromProps==null&&c.componentWillMount!=null&&c.componentWillMount(),b&&c.componentDidMount!=null&&c.__h.push(c.componentDidMount);else{if(b&&a.getDerivedStateFromProps==null&&m!==v&&c.componentWillReceiveProps!=null&&c.componentWillReceiveProps(m,N),!c.__e&&c.shouldComponentUpdate!=null&&c.shouldComponentUpdate(m,c.__s,N)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(c.props=m,c.state=c.__s,c.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(g){g&&(g.__=e)}),T=0;T<c._sb.length;T++)c.__h.push(c._sb[T]);c._sb=[],c.__h.length&&d.push(c);break e}c.componentWillUpdate!=null&&c.componentWillUpdate(m,c.__s,N),b&&c.componentDidUpdate!=null&&c.__h.push(function(){c.componentDidUpdate(v,x,S)})}if(c.context=N,c.props=m,c.__P=t,c.__e=!1,F=L.__r,O=0,b){for(c.state=c.__s,c.__d=!1,F&&F(e),h=c.render(c.props,c.state,c.context),I=0;I<c._sb.length;I++)c.__h.push(c._sb[I]);c._sb=[]}else do c.__d=!1,F&&F(e),h=c.render(c.props,c.state,c.context),c.state=c.__s;while(c.__d&&++O<25);c.state=c.__s,c.getChildContext!=null&&(i=J(J({},i),c.getChildContext())),b&&!o&&c.getSnapshotBeforeUpdate!=null&&(S=c.getSnapshotBeforeUpdate(v,x)),M=h,h!=null&&h.type===_e&&h.key==null&&(M=nt(h.props.children)),p=Ze(t,pe(M)?M:[M],e,n,i,s,l,d,p,_,u),c.base=e.__e,e.__u&=-161,c.__h.length&&d.push(c),w&&(c.__E=c.__=null)}catch(g){if(e.__v=null,_||l!=null)if(g.then){for(e.__u|=_?160:128;p&&p.nodeType==8&&p.nextSibling;)p=p.nextSibling;l[l.indexOf(p)]=null,e.__e=p}else for(f=l.length;f--;)Ce(l[f]);else e.__e=n.__e,e.__k=n.__k;L.__e(g,e,n)}else l==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):p=e.__e=ht(n.__e,e,n,i,s,l,d,_,u);return(h=L.diffed)&&h(e),128&e.__u?void 0:p}function tt(t,e,n){for(var i=0;i<n.length;i++)Ne(n[i],n[++i],n[++i]);L.__c&&L.__c(e,t),t.some(function(s){try{t=s.__h,s.__h=[],t.some(function(l){l.call(s)})}catch(l){L.__e(l,s.__v)}})}function nt(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:pe(t)?t.map(nt):J({},t)}function ht(t,e,n,i,s,l,d,p,_){var u,h,c,o,v,x,S,w=n.props,m=e.props,b=e.type;if(b=="svg"?s="http://www.w3.org/2000/svg":b=="math"?s="http://www.w3.org/1998/Math/MathML":s||(s="http://www.w3.org/1999/xhtml"),l!=null){for(u=0;u<l.length;u++)if((v=l[u])&&"setAttribute"in v==!!b&&(b?v.localName==b:v.nodeType==3)){t=v,l[u]=null;break}}if(t==null){if(b==null)return document.createTextNode(m);t=document.createElementNS(s,b,m.is&&m),p&&(L.__m&&L.__m(e,l),p=!1),l=null}if(b==null)w===m||p&&t.data==m||(t.data=m);else{if(l=l&&he.call(t.childNodes),w=n.props||ne,!p&&l!=null)for(w={},u=0;u<t.attributes.length;u++)w[(v=t.attributes[u]).name]=v.value;for(u in w)if(v=w[u],u!="children"){if(u=="dangerouslySetInnerHTML")c=v;else if(!(u in m)){if(u=="value"&&"defaultValue"in m||u=="checked"&&"defaultChecked"in m)continue;se(t,u,null,v,s)}}for(u in m)v=m[u],u=="children"?o=v:u=="dangerouslySetInnerHTML"?h=v:u=="value"?x=v:u=="checked"?S=v:p&&typeof v!="function"||w[u]===v||se(t,u,v,w[u],s);if(h)p||c&&(h.__html==c.__html||h.__html==t.innerHTML)||(t.innerHTML=h.__html),e.__k=[];else if(c&&(t.innerHTML=""),Ze(e.type=="template"?t.content:t,pe(o)?o:[o],e,n,i,b=="foreignObject"?"http://www.w3.org/1999/xhtml":s,l,d,l?l[0]:n.__k&&ee(n,0),p,_),l!=null)for(u=l.length;u--;)Ce(l[u]);p||(u="value",b=="progress"&&x==null?t.removeAttribute("value"):x!=null&&(x!==t[u]||b=="progress"&&!x||b=="option"&&x!=w[u])&&se(t,u,x,w[u],s),u="checked",S!=null&&S!=t[u]&&se(t,u,S,w[u],s))}return t}function Ne(t,e,n){try{if(typeof t=="function"){var i=typeof t.__u=="function";i&&t.__u(),i&&e==null||(t.__u=t(e))}else t.current=e}catch(s){L.__e(s,n)}}function it(t,e,n){var i,s;if(L.unmount&&L.unmount(t),(i=t.ref)&&(i.current&&i.current!=t.__e||Ne(i,null,e)),(i=t.__c)!=null){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(l){L.__e(l,e)}i.base=i.__P=null}if(i=t.__k)for(s=0;s<i.length;s++)i[s]&&it(i[s],e,n||typeof t.type!="function");n||Ce(t.__e),t.__c=t.__=t.__e=void 0}function pt(t,e,n){return this.constructor(t,n)}function ge(t,e,n){var i,s,l,d;e==document&&(e=document.documentElement),L.__&&L.__(t,e),s=(i=!1)?null:e.__k,l=[],d=[],Te(e,t=e.__k=ae(_e,null,[t]),s||ne,ne,e.namespaceURI,s?null:e.firstChild?he.call(e.childNodes):null,l,s?s.__e:e.firstChild,i,d),tt(l,t,d)}he=Ge.slice,L={__e:function(t,e,n,i){for(var s,l,d;e=e.__;)if((s=e.__c)&&!s.__)try{if((l=s.constructor)&&l.getDerivedStateFromError!=null&&(s.setState(l.getDerivedStateFromError(t)),d=s.__d),s.componentDidCatch!=null&&(s.componentDidCatch(t,i||{}),d=s.__d),d)return s.__E=s}catch(p){t=p}throw t}},Ke=0,oe.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=J({},this.state),typeof t=="function"&&(t=t(J({},n),this.props)),t&&J(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Fe(this))},oe.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Fe(this))},oe.prototype.render=_e,G=[],ze=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Xe=function(t,e){return t.__v.__b-e.__v.__b},de.__r=0,Je=/(PointerCapture)$|Capture$/i,Ee=0,ke=Ie(!1),xe=Ie(!0);const _t=["id","title","content","type","status","category","tags","recurrence","date","header","icon","priority","createdDate","scheduledDate","startDate","dueDate","doneDate","cancelledDate","created","modified","filename"];function Ae(t){const e=new Set(_t);for(const n of t)Object.keys(n.extra||{}).forEach(i=>e.add("extra."+i));return Array.from(e)}function q(t,e){if(e.startsWith("extra.")){const n=e.substring(6);return t.extra?.[n]}return t[e]}const ft="\\d{4}[-/]\\d{2}[-/]\\d{2}",gt=new RegExp(ft),mt=/#([\p{L}\p{N}_\/-]+)/gu,vt=/\(([^:：]+)::\s*([^)]+)\)/g,Me=/^\s*-\s*\[[ xX-]\]/,yt=/^\s*-\s*\[x\]/i,bt=/^\s*-\s*\[-\]/;function st(t){return t.replace(/\//g,"-")}const wt="think",Z={done:"✅",cancelled:"❌",due:"📅",scheduled:"⏳",start:"🛫",created:"➕"},Le="无日期",me="think-dashboard-style",kt=`
.think-table{width:100%;border:1px solid #ccc;border-collapse:collapse;}
.think-table th,.think-table td{border:1px solid #ccc;padding:4px;}
.think-table th{background:#f0f0f0;text-align:center;}
.think-table td{text-align:left;}
.think-table td.empty{background:#f9f9f9;}
.tag-pill{background:#e0e0e0;border-radius:4px;padding:0 6px;margin-right:6px;font-size:90%;display:inline-block;}
.task-done{text-decoration:line-through;color:gray;}
.module-header{display:flex;align-items:center;padding:4px 8px;background:#eee;cursor:pointer;}
.module-title{flex:1;font-weight:bold;}
.module-toggle{margin-left:4px;}
.module-content{padding:6px 8px;}
.think-module a{color:black;text-decoration:none;}
`.trim();function xt(t){let e=t.replace(/^\s*-\s*\[[ xX]\]\s*/,"").trim();e=e.replace(/#[\p{L}\p{N}_-]+/gu,"");let n=e.split(/[\s(]/).find(i=>i&&i.trim());return n=n?.replace(new RegExp("^\\p{Extended_Pictographic}\\uFE0F?","u"),"").trim(),n?n.trim():""}function Dt(t){if(t.includes("🔺"))return"highest";if(t.includes("⏫"))return"high";if(t.includes("🔼"))return"medium";if(t.includes("🔽"))return"low";if(t.includes("⏬"))return"lowest"}function St(t,e,n,i){const s=e;if(!Me.test(s))return null;let l="open";yt.test(s)?l="done":bt.test(s)&&(l="cancelled");const p=(s.match(mt)||[]).map(M=>M.replace("#",""));let _="none";const u=s.match(/🔁\s*([^\n📅⏳🛫➕✅❌]*)/);u&&u[1]&&(_=u[1].trim());const h={};let c;for(;(c=vt.exec(s))!==null;){const M=c[1].trim(),f=c[2].trim(),a=M.toLowerCase();if(["主题","标签","tag","tags"].includes(a))f.split(/[,，]/).forEach(g=>{const y=g.trim().replace(/^#/,"");y&&p.push(y)});else{const g=Number(f);let y=f;f!==""&&!isNaN(g)?y=g:/^(true|false)$/i.test(f)&&(y=f.toLowerCase()==="true"),h[M]=y}}const o=M=>{const f=s.match(new RegExp(`${M}s*(${gt.source})`));return f?st(f[1]):void 0},v=o(Z.done),x=o(Z.cancelled),S=o(Z.due),w=o(Z.scheduled),m=o(Z.start),b=o(Z.created),E=Dt(s);let N;const T=s.replace(Me,"").trim(),F=T.match(new RegExp("^(\\p{Extended_Pictographic}\\uFE0F?)","u"));let O=T;F&&(N=F[1],O=O.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"")),O=xt(O);const I={id:`${t}#${n}`,title:O||"",content:s.trim(),type:"task",status:l,category:"任务",tags:Array.from(new Set(p)),recurrence:_,date:void 0,created:0,modified:0,extra:{}};return N&&(I.icon=N,h.图标=N),E&&(I.priority=E),b&&(I.createdDate=b),w&&(I.scheduledDate=w),m&&(I.startDate=m),S&&(I.dueDate=S),v&&(I.doneDate=v,l==="done"&&(I.date=v)),x&&(I.cancelledDate=x,l==="cancelled"&&(I.date=x)),l==="open"&&(I.date=S||w||m||b),I.extra=h,I}function Et(t,e,n,i,s){const l=e.slice(n+1,i);let d="",p=null,_,u;const h=[],c={};let o=null,v="",x=!1,S=null;for(let m=0;m<l.length;m++){const b=l[m],E=b.trim();if(x)v+=(v?`
`:"")+b;else{if(E==="")continue;const N=E.match(/^([^:：]{1,20})::\s*(.*)$/);if(N){const T=N[1].trim(),F=N[2]||"",O=T.toLowerCase();if(["分类","类别","category"].includes(O))p=F.trim();else if(["主题","标签","tag","tags"].includes(O))o=F.trim();else if(["状态","status"].includes(O))_=F.trim();else if(["日期","date"].includes(O))u=st(F.trim());else if(["内容","content"].includes(O))x=!0,v=F;else if(["图标","icon"].includes(O))S=F.trim(),c.图标=S;else{const I=Number(F.trim());let M=F.trim();M!==""&&!isNaN(I)?M=I:/^(true|false)$/i.test(M)&&(M=M.toLowerCase()==="true"),c[T]=M}}else x=!0,v=b}}o&&o.split(/[,，]/).map(m=>m.trim()).filter(Boolean).forEach(m=>h.push(m.replace(/^#/,""))),v.trim()!==""?d=v.trim().split(/\r?\n/)[0]:o&&(d=o.split(/[,，]/).map(m=>m.trim()).filter(Boolean).join(", ")),d=d.replace(new RegExp("^(?:\\p{Extended_Pictographic}\\uFE0F?\\s*)+","u"),"").trim(),d&&(d=d.slice(0,10)),p||(p=s||"");const w={id:`${t}#${n+1}`,title:d||"",content:v.trim(),type:"block",status:_,category:p,tags:Array.from(new Set(h)),recurrence:"none",date:u,created:0,modified:0,extra:c};return S&&(w.icon=S),w}function Ct(t,e=250){let n=0,i=null;return function(...s){const l=Date.now();l-n>=e?(n=l,t.apply(this,s)):(clearTimeout(i),i=setTimeout(()=>{n=Date.now(),t.apply(this,s)},e-(l-n)))}}class Q{constructor(e){this.items=[],this.fileIndex=new Map,this.changeListeners=new Set,this._emitThrottled=Ct(()=>this._emitChange(),250),this.app=e,Q.instance=this}async scanAll(){this.items=[],this.fileIndex.clear();const e=this.app.vault.getMarkdownFiles();for(const n of e)await this.scanFile(n)}async initialScan(){return this.scanAll()}async scanFile(e){try{const i=(await this.app.vault.read(e)).split(/\r?\n/),s=e.path,l=e.parent?.name||"",d=[],_=this.app.metadataCache.getFileCache(e)?.headings||[];let u=0,h=[],c="";for(let o=0;o<i.length;o++){const v=i[o];if(u<_.length&&_[u].position.start.line===o){const w=_[u].heading,m=w.match(/#([\p{L}\p{N}_\/-]+)/gu)||[];h=m.map(E=>E.replace("#","")).filter(Boolean);let b=w;for(const E of m)b=b.replace(E,"").trim();c=b||"",u++;continue}if(v.trim()==="<!-- start -->"){const S=i.indexOf("<!-- end -->",o+1);if(S!==-1){const w=Et(s,i,o,S,l);if(w){w.created=e.stat.ctime,w.modified=e.stat.mtime,c&&(w.header=c),w.tags=Array.from(new Set([...h,...w.tags]));let m=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;w.filename=m,d.push(w)}o=S;continue}}const x=St(s,v,o+1,l);if(x){x.tags=Array.from(new Set([...h,...x.tags])),x.created=e.stat.ctime,x.modified=e.stat.mtime,c&&(x.header=c);let S=e.name.toLowerCase().endsWith(".md")?e.name.slice(0,-3):e.name;x.filename=S,d.push(x)}}return this.fileIndex.has(s)&&(this.items=this.items.filter(o=>o.id&&!o.id.startsWith(s+"#"))),this.fileIndex.set(s,d),this.items.push(...d),d}catch(n){return console.error("ThinkPlugin: 扫描文件失败",e.path,n),[]}}removeFileItems(e){this.fileIndex.has(e)&&(this.fileIndex.delete(e),this.items=this.items.filter(n=>!n.id.startsWith(e+"#")))}removeFile(e){this.removeFileItems(e)}queryItems(e=[],n=[]){let i=this.items.filter(s=>(e||[]).every(l=>this._matchItem(s,l)));return n.length>0&&i.sort((s,l)=>{for(const d of n){const p=q(s,d.field),_=q(l,d.field);if(!(p==null&&_==null)){if(p==null)return d.dir==="asc"?1:-1;if(_==null)return d.dir==="asc"?-1:1;if(typeof p=="number"&&typeof _=="number"){if(p!==_)return d.dir==="asc"?p-_:_-p}else{const u=String(p),h=String(_);if(u!==h)return d.dir==="asc"?u.localeCompare(h):h.localeCompare(u)}}}return 0}),i}query(e=[],n=[]){return this.queryItems(e,n)}async markItemDone(e){const n=e.split("#"),i=n[0],s=Number(n[1])||0,l=this.app.vault.getAbstractFileByPath(i);if(l instanceof V.TFile)try{const p=(await this.app.vault.read(l)).split(/\r?\n/);if(s<=0||s>p.length)return;const _=p[s-1];if(!/^\s*-\s*\[ \]/.test(_))return;const u=window.moment,h=u().format("YYYY-MM-DD"),c=u().format("HH:mm");let o=_;if(o=o.replace(/(\s|^)(时长::[^\s\(\)]+)/g,(x,S,w)=>x.includes("(")&&x.includes(")")?x:`${S}(${w})`),/\(时长::[^\)]+\)/.test(o)?o=o.replace(/\((时长::[^\)]+)\)/,`(时间::${c}) ($1)`):/时长::[^\s]+/.test(o)?o=o.replace(/(时长::[^\s]+)/,`(时间::${c}) ($1)`):/🔁/.test(o)?o=o.replace(/(🔁)/,`(时间::${c}) $1`):o=o+` (时间::${c})`,o=o.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[x]"),/^-\s*\[x\]/.test(o)||(o="- [x] "+o.replace(/^-\s*\[.\]/,"").replace(/^-\s*/,"")),o=o.replace(/\s*✅\s*\d{4}-\d{2}-\d{2}$/,""),o=o.trim()+` ✅ ${h}`,_.includes("🔁")){const x=w=>{let m=w;m=m.replace(/^(\s*-\s*)\[[ xX-]\]/,"$1[ ]"),m=m.replace(/\s*✅\s*\d{4}[-/]\d{2}[-/]\d{2}/,""),m=m.replace(/\(时间::\d{2}:\d{2}\)/,"");const b=w.match(/🔁\s*every\s+(\d+)?\s*(day|week|month|year)s?\s*(when done)?/),E=window.moment;let N=1,T="day",F=!1;b&&(b[1]&&(N=parseInt(b[1])),T=b[2],T.endsWith("s")&&(T=T.slice(0,-1)),F=!!b[3]);const M=(F?E():(()=>{const f=w.match(/📅\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(f)return E(f[1],["YYYY-MM-DD","YYYY/MM/DD"]);const a=w.match(/⏳\s*(\d{4}[-/]\d{2}[-/]\d{2})/);if(a)return E(a[1],["YYYY-MM-DD","YYYY/MM/DD"]);const g=w.match(/🛫\s*(\d{4}[-/]\d{2}[-/]\d{2})/);return g?E(g[1],["YYYY-MM-DD","YYYY/MM/DD"]):E()})()).clone().add(N,T+(N>1?"s":"")).format("YYYY-MM-DD");return/📅\s*\d{4}-\d{2}-\d{2}/.test(m)&&(m=m.replace(/📅\s*\d{4}[-/]\d{2}[-/]\d{2}/,`📅 ${M}`)),/⏳\s*\d{4}-\d{2}-\d{2}/.test(m)&&(m=m.replace(/⏳\s*\d{4}[-/]\d{2}[-/]\d{2}/,`⏳ ${M}`)),/🛫\s*\d{4}-\d{2}-\d{2}/.test(m)&&(m=m.replace(/🛫\s*\d{4}[-/]\d{2}[-/]\d{2}/,`🛫 ${M}`)),m=m.trim(),m};p[s-1]=o;const S=x(_);p.splice(s,0,S)}else p[s-1]=o;await this.app.vault.modify(l,p.join(`
`)),await this.scanFile(l),this._emitChange()}catch(d){console.error("ThinkPlugin: 标记任务完成时发生错误",d)}}_emitChange(){this.changeListeners.forEach(e=>{try{e()}catch(n){console.error("ThinkPlugin: 数据变化通知错误",n)}})}subscribe(e){this.changeListeners.add(e)}unsubscribe(e){this.changeListeners.delete(e)}notifyChange(){this._emitThrottled()}_matchItem(e,n){const i=q(e,n.field),s=n.value;if(n.op==="="||n.op==="!="){const l=i!=null&&s!=null&&String(i)===String(s);return n.op==="="?l:!l}if(n.op==="includes")return i==null?!1:Array.isArray(i)?i.some(l=>String(l).includes(String(s))):String(i).includes(String(s));if(n.op==="regex"){if(i==null)return!1;try{const l=new RegExp(String(s));return Array.isArray(i)?i.some(d=>l.test(String(d))):l.test(String(i))}catch{return console.warn("ThinkPlugin: 无效的正则表达式",s),!1}}if(n.op===">"||n.op==="<"){if(i==null)return!1;const l=Number(i),d=Number(s);if(!isNaN(l)&&!isNaN(d))return n.op===">"?l>d:l<d;const p=Date.parse(String(i)),_=Date.parse(String(s));if(!isNaN(p)&&!isNaN(_))return n.op===">"?p>_:p<_;const u=String(i),h=String(s);return n.op===">"?u>h:u<h}return!1}}var Tt=0;function r(t,e,n,i,s,l){e||(e={});var d,p,_=e;if("ref"in _)for(p in _={},e)p=="ref"?d=e[p]:_[p]=e[p];var u={type:t,props:_,key:n,ref:d,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--Tt,__i:-1,__u:0,__source:s,__self:l};if(typeof t=="function"&&(d=t.defaultProps))for(p in d)_[p]===void 0&&(_[p]=d[p]);return L.vnode&&L.vnode(u),u}function z(t){const e=t.lastIndexOf("#"),n=e>=0?t.substring(0,e):t,i=e>=0?t.substring(e+1):"";return`obsidian://advanced-uri?vault=${encodeURIComponent(Q.instance.app.vault.getName())}&filepath=${encodeURIComponent(n)}${i?"&line="+i:""}`}function Nt({items:t,rowField:e,colField:n}){if(!e||!n)return r("div",{children:"（TableView 需要配置 rowField 和 colField）"});const i=[],s=[],l={};for(const d of t){const p=q(d,e)??Le,_=q(d,n)??Le,u=String(p),h=String(_);l[u]||(l[u]={},i.push(u)),l[u][h]||(l[u][h]=[]),l[u][h].push(d),s.includes(h)||s.push(h)}return i.sort(),s.sort(),r("table",{class:"think-table",children:[r("thead",{children:r("tr",{children:[r("th",{children:e}),s.map(d=>r("th",{children:d},d))]})}),r("tbody",{children:i.map(d=>r("tr",{children:[r("td",{children:r("strong",{children:d})}),s.map(p=>{const _=l[d]?.[p]||[];return _.length===0?r("td",{class:"empty"},p):r("td",{children:_.map(u=>r("div",{children:At(u)},u.id))},p)})]},d))})]})}function At(t){if(t.type==="task"){const e=t.status==="done",n="cb-"+t.id.replace(/[^a-zA-Z0-9]/g,"_");return r("span",{children:[!e&&r("input",{type:"checkbox",id:n,class:"task-checkbox",onChange:s=>{s.currentTarget.checked&&Q.instance.markItemDone(t.id)}}),e&&r("input",{type:"checkbox",id:n,class:"task-checkbox done",checked:!0,onClick:s=>s.preventDefault()}),t.icon&&r("span",{class:"task-icon",children:t.icon}),r("a",{href:z(t.id),target:"_blank",rel:"noopener",children:t.title})]})}return r("a",{href:z(t.id),target:"_blank",rel:"noopener",children:t.title})}const $t={打卡:"#d2cceb",任务:"#caebf3",计划:"#d8ecb2",总结:"#E5D5B9",事件:"#94e2d6",感受:"#93daf0",思考:"#f09393"};function ve(t){return $t[t]||"#e0e0e0"}function Yt(t){const{groupField:e,showMeta:n=!0,fields:i}=t;let{items:s}=t,l=s;i&&i.length>0&&(l=s.filter(h=>i.some(c=>{const o=q(h,c);return o!=null&&String(o).trim()!==""})));let d=null,p=[];if(e){d={};for(const h of l){const c=String(q(h,e)??"(none)");d[c]||(d[c]=[],p.push(c)),d[c].push(h)}p.sort()}const _=h=>{if(h.type!=="task")return null;const c=h.status==="done";return r("input",{type:"checkbox",class:`task-checkbox ${c?"done":""}`,checked:c,onClick:c?o=>o.preventDefault():void 0,onChange:async o=>{o.target.checked&&!c&&await Q.instance.markItemDone(h.id)}})},u=h=>{if(i&&i.length>0){const c=i.includes("title"),o=i.includes("content"),v=["category","date","icon"];if(i.some(b=>v.includes(b))&&(c||o)){const b=[];i.forEach(T=>{if(!v.includes(T))return;const F=q(h,T);F==null||String(F).trim()===""||(T==="category"?b.push(r("span",{class:"tag-pill",style:`background:${ve(h.category)};`,children:h.category},"cat")):T==="date"?b.push(r("span",{class:"tag-pill",children:h.date},"date")):T==="icon"&&b.push(r("span",{class:"tag-pill",children:h.icon},"icon")))});const E=()=>{if(c){const T=o?r("span",{children:h.title}):r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",children:h.title});return r("div",{style:"line-height:1.5;margin-bottom:2px;",children:[_(h),T]})}return o?r("div",{style:"line-height:1.5;margin-bottom:2px;",children:[_(h),r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:h.content})]}):null},N=c&&o?r("div",{style:"white-space:pre-wrap;line-height:1.5;",children:r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",children:h.content})}):null;return r("div",{style:`\r
              display:grid;\r
              grid-template-columns:auto minmax(180px,1fr);\r
              gap:8px;\r
              align-items:start;\r
              margin-bottom:8px;\r
            `,children:[r("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:b}),r("div",{children:[E(),N]})]})}const w=[];let m=!1;return i.forEach((b,E)=>{const N=q(h,b);if(!m&&h.type==="task"&&(b==="title"||b==="content")&&(w.push(_(h)),m=!0),b==="content")w.push(r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",style:"white-space:pre-wrap;",children:h.content},E));else if(b==="title")i.includes("content")?w.push(r("span",{children:h.title},E)):w.push(r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",children:h.title},E));else if(b==="tags")w.push(r("span",{children:h.tags.map(T=>r("span",{class:"tag-pill",children:T},T))},"tags"));else if(b==="category")w.push(r("span",{class:"tag-pill",style:`background:${ve(h.category)};`,children:h.category},E));else if(b==="icon")h.icon&&w.push(r("span",{class:"tag-pill",children:h.icon},E));else{if(N==null)return;const T=Array.isArray(N)?N.join(", "):String(N);w.push(r("span",{class:"tag-pill",children:T},E))}}),r("div",{style:"margin-bottom:8px;line-height:1.5;",children:w.map((b,E)=>r("span",{children:b},E))})}if(h.type==="task"){const c=h.status==="done";return r("div",{style:"margin-bottom:4px;line-height:1.5;",children:[_(h),r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",class:c?"task-done":"",children:h.title}),h.icon&&r("span",{class:"tag-pill",children:h.icon}),h.tags.map(o=>r("span",{class:"tag-pill",children:o},o))]})}else return r("div",{style:`\r
            display:grid;\r
            grid-template-columns:auto minmax(180px,1fr);\r
            align-items:start;\r
            gap:8px;\r
            margin-bottom:8px;\r
          `,children:[n&&r("div",{style:"font-size:90%;display:flex;flex-wrap:wrap;gap:4px;",children:[r("span",{class:"tag-pill",style:`background:${ve(h.category)};`,children:h.category}),h.date&&r("span",{class:"tag-pill",children:h.date}),h.extra.图标&&r("span",{class:"tag-pill",children:h.extra.图标})]}),r("div",{style:"white-space:pre-wrap;line-height:1.5;",children:r("a",{href:`${z(h.id)}`,target:"_blank",rel:"noopener",children:h.content})})]})};return r("div",{children:d?p.map(h=>r("div",{children:[r("h5",{children:h}),d[h].map(c=>u(c))]})):l.map(h=>u(h))})}function Ft(t){return r("div",{children:"（Timeline 视图暂未实现）"})}function Vt(t){return r("div",{children:"（Calendar 日视图暂未实现）"})}function It(t){return r("div",{children:"（Chart 图表视图暂未实现）"})}function Mt(t){return Array.isArray(t)?t.join(", "):t==null?"":String(t)}function Lt({items:t,fields:e}){const n=e&&e.length?e:Ae(t);return r("div",{children:r("table",{class:"think-table",style:"min-width:100%; white-space:nowrap;",children:[r("thead",{children:r("tr",{children:n.map(i=>r("th",{children:i},i))})}),r("tbody",{children:t.map(i=>r("tr",{children:n.map(s=>r("td",{children:Mt(q(i,s))},s))},i.id))})]})})}var ie,B,ye,Pe,ue=0,rt=[],H=L,Oe=H.__b,Be=H.__r,He=H.diffed,Re=H.__c,We=H.unmount,Ue=H.__;function $e(t,e){H.__h&&H.__h(B,t,ue||e),ue=0;var n=B.__H||(B.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function X(t){return ue=1,Pt(lt,t)}function Pt(t,e,n){var i=$e(ie++,2);if(i.t=t,!i.__c&&(i.__=[lt(void 0,e),function(p){var _=i.__N?i.__N[0]:i.__[0],u=i.t(_,p);_!==u&&(i.__N=[u,i.__[1]],i.__c.setState({}))}],i.__c=B,!B.__f)){var s=function(p,_,u){if(!i.__c.__H)return!0;var h=i.__c.__H.__.filter(function(o){return!!o.__c});if(h.every(function(o){return!o.__N}))return!l||l.call(this,p,_,u);var c=i.__c.props!==p;return h.forEach(function(o){if(o.__N){var v=o.__[0];o.__=o.__N,o.__N=void 0,v!==o.__[0]&&(c=!0)}}),l&&l.call(this,p,_,u)||c};B.__f=!0;var l=B.shouldComponentUpdate,d=B.componentWillUpdate;B.componentWillUpdate=function(p,_,u){if(this.__e){var h=l;l=void 0,s(p,_,u),l=h}d&&d.call(this,p,_,u)},B.shouldComponentUpdate=s}return i.__N||i.__}function De(t,e){var n=$e(ie++,3);!H.__s&&at(n.__H,e)&&(n.__=t,n.u=e,B.__H.__h.push(n))}function Ot(t){return ue=5,Bt(function(){return{current:t}},[])}function Bt(t,e){var n=$e(ie++,7);return at(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Ht(){for(var t;t=rt.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(ce),t.__H.__h.forEach(Se),t.__H.__h=[]}catch(e){t.__H.__h=[],H.__e(e,t.__v)}}H.__b=function(t){B=null,Oe&&Oe(t)},H.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),Ue&&Ue(t,e)},H.__r=function(t){Be&&Be(t),ie=0;var e=(B=t.__c).__H;e&&(ye===B?(e.__h=[],B.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(ce),e.__h.forEach(Se),e.__h=[],ie=0)),ye=B},H.diffed=function(t){He&&He(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(rt.push(e)!==1&&Pe===H.requestAnimationFrame||((Pe=H.requestAnimationFrame)||Rt)(Ht)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),ye=B=null},H.__c=function(t,e){e.some(function(n){try{n.__h.forEach(ce),n.__h=n.__h.filter(function(i){return!i.__||Se(i)})}catch(i){e.some(function(s){s.__h&&(s.__h=[])}),e=[],H.__e(i,n.__v)}}),Re&&Re(t,e)},H.unmount=function(t){We&&We(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(i){try{ce(i)}catch(s){e=s}}),n.__H=void 0,e&&H.__e(e,n.__v))};var je=typeof requestAnimationFrame=="function";function Rt(t){var e,n=function(){clearTimeout(i),je&&cancelAnimationFrame(e),setTimeout(t)},i=setTimeout(n,35);je&&(e=requestAnimationFrame(n))}function ce(t){var e=B,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),B=e}function Se(t){var e=B;t.__c=t.__(),B=e}function at(t,e){return!t||t.length!==e.length||e.some(function(n,i){return n!==t[i]})}function lt(t,e){return typeof e=="function"?e(t):e}function Wt({storageKey:t="inputSettings",plugin:e}){const n=e[t]||{},[i,s]=X(typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))),l=(p,_)=>s(u=>({...u,[p]:_})),d=async()=>{e[t]=i,await e.persistAll(),alert("已保存配置")};return r("div",{style:"display:flex;flex-direction:column;gap:6px;max-width:420px;",children:[r("label",{children:["主题 (可层级“生活/健康”)：",r("input",{value:i.topic||"",onInput:p=>l("topic",p.target.value)})]}),r("label",{children:["图标 (emoji)：",r("input",{value:i.icon||"",onInput:p=>l("icon",p.target.value),placeholder:"✨"})]}),r("label",{children:["任务字段清单 (逗号分隔)：",r("input",{value:i.taskFields||"",onInput:p=>l("taskFields",p.target.value),placeholder:"status,icon,repeat,…"})]}),r("label",{children:["Block 字段清单 (逗号分隔)：",r("input",{value:i.blockFields||"",onInput:p=>l("blockFields",p.target.value),placeholder:"分类,周期,日期,主题,图标,内容"})]}),r("button",{style:"margin-top:8px;",onClick:d,children:"💾 保存配置"})]})}const ot={TableView:Nt,BlockView:Yt,TimelineView:Ft,CalendarView:Vt,ChartView:It,ExcelView:Lt,SettingsFormView:Wt},re=ot,qe=Object.keys(ot);class Ut extends V.PluginSettingTab{constructor(e,n){super(e,n),this.selectedDashName="",this.plugin=n,n.dashboards.length>0&&(this.selectedDashName=n.dashboards[0].name)}display(){const{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Think 仪表盘 配置编辑"});const n=this.plugin.dataStore.queryItems(),i=Ae(n),s=new Set,l=new Set,d=new Set,p=new Set,_=new Set;for(const f of n)(f.tags||[]).forEach(a=>a&&s.add(a)),f.category&&l.add(f.category),f.status&&d.add(f.status),f.recurrence&&p.add(f.recurrence),f.type&&_.add(f.type);const u=e.createEl("datalist");u.id="think-tags-list",Array.from(s).forEach(f=>u.createEl("option",{value:f}));const h=e.createEl("datalist");h.id="think-category-list",Array.from(l).forEach(f=>h.createEl("option",{value:f}));const c=e.createEl("datalist");c.id="think-status-list",Array.from(d).forEach(f=>c.createEl("option",{value:f}));const o=e.createEl("datalist");o.id="think-recurrence-list",Array.from(p).forEach(f=>o.createEl("option",{value:f}));const v=e.createEl("datalist");v.id="think-type-list",Array.from(_).forEach(f=>v.createEl("option",{value:f}));const x=e.createEl("datalist");x.id="think-fields-list",i.forEach(f=>x.createEl("option",{value:f}));const S=e.createEl("select");for(const f of this.plugin.dashboards){const a=S.createEl("option",{text:f.name});a.value=f.name,f.name===this.selectedDashName&&(a.selected=!0)}S.onchange=()=>{this.selectedDashName=S.value,this.display()};const w=e.createEl("button",{text:"新建仪表盘"});if(w.style.marginLeft="8px",w.onclick=()=>{let f="新仪表盘",a=f,g=1;for(;this.plugin.dashboards.find(k=>k.name===a);)a=f+g++;const y={name:a,modules:[]};this.plugin.dashboards.push(y),this.selectedDashName=a,this.plugin.saveData({dashboards:this.plugin.dashboards}),new V.Notice("已添加新仪表盘配置"),this.display()},this.plugin.dashboards.length>0){const f=e.createEl("button",{text:"删除当前仪表盘"});f.style.marginLeft="8px",f.onclick=()=>{const a=this.plugin.dashboards.findIndex(g=>g.name===this.selectedDashName);a>=0&&(this.plugin.dashboards.splice(a,1),new V.Notice(`已删除配置：${this.selectedDashName}`),this.selectedDashName=this.plugin.dashboards.length?this.plugin.dashboards[0].name:"",this.plugin.saveData({dashboards:this.plugin.dashboards}),this.display())}}e.createEl("hr");const m=this.plugin.dashboards.find(f=>f.name===this.selectedDashName);if(!m)return;const b=e.createEl("fieldset");b.createEl("legend",{text:"基础设置"}),new V.Setting(b).setName("仪表盘名称").addText(f=>{f.setValue(m.name).onChange(a=>{m.name=a.trim()})}),new V.Setting(b).setName("数据源路径").addText(f=>{f.setValue(m.path||"").onChange(a=>{m.path=a.trim()})}),new V.Setting(b).setName("标签 (用逗号分隔)").addText(f=>{const a=Array.isArray(m.tags)?m.tags.join(","):m.tags||"";f.setValue(a).onChange(g=>{m.tags=g.split(/[,，]/).map(y=>y.trim()).filter(y=>y)})}),new V.Setting(b).setName("初始视图").addDropdown(f=>{["年","季","月","周","天"].forEach(g=>f.addOption(g,g)),f.setValue(m.initialView||"月"),f.onChange(g=>{m.initialView=g})});const E=new Date,N=`${E.getFullYear()}-${String(E.getMonth()+1).padStart(2,"0")}-${String(E.getDate()).padStart(2,"0")}`,T=m.initialDate||N;m.initialDate||(m.initialDate=T),new V.Setting(b).setName("初始日期").addText(f=>{f.inputEl.type="date",f.setValue(T).onChange(a=>{m.initialDate=a})}),e.createEl("h3",{text:"模块列表"}),m.modules.forEach((f,a)=>{const g=e.createEl("fieldset");g.style.border="1px solid #ccc",g.style.padding="8px",g.style.marginBottom="8px",g.dataset.index=a.toString(),g.createEl("legend",{text:`${f.title||"模块"} (${f.view})`}),new V.Setting(g).setName("模块标题").addText(C=>{C.setValue(f.title).onChange(Y=>f.title=Y)}),new V.Setting(g).setName("视图类型").addDropdown(C=>{qe.forEach(Y=>C.addOption(Y,Y)),C.setValue(f.view),C.onChange(Y=>{f.view=Y,this.display()})}),new V.Setting(g).addToggle(C=>{C.setValue(!!f.collapsed).onChange(Y=>{f.collapsed=Y})}).setName("默认折叠"),f.view==="TableView"&&(new V.Setting(g).setName("行字段 (rowField)").addText(C=>{C.setValue(f.props?.rowField||"").onChange(Y=>{f.props||(f.props={}),f.props.rowField=Y.trim()}),C.inputEl.setAttr("list","think-fields-list")}),new V.Setting(g).setName("列字段 (colField)").addText(C=>{C.setValue(f.props?.colField||"").onChange(Y=>{f.props||(f.props={}),f.props.colField=Y.trim()}),C.inputEl.setAttr("list","think-fields-list")})),(f.view==="BlockView"||f.view==="TimelineView")&&new V.Setting(g).setName("分组字段").addText(C=>{C.setValue(f.group||"").onChange(Y=>{f.group=Y.trim()||void 0}),C.inputEl.setAttr("list","think-fields-list")}),f.view!=="TableView"&&f.view!=="ChartView"&&f.view!=="CalendarView"&&new V.Setting(g).setName("显示字段 (用逗号分隔)").addText(C=>{const Y=f.fields?f.fields.join(","):"";C.setPlaceholder("如 title,tags,date").setValue(Y).onChange(W=>{const R=W.split(/[,，]/).map(j=>j.trim()).filter(j=>j);f.fields=R.length>0?R:void 0}),C.inputEl.setAttr("list","think-fields-list")});const y=g.createDiv();y.style.borderTop="1px dashed #ccc",y.style.marginTop="6px",y.style.paddingTop="6px",y.createEl("strong",{text:"过滤规则"}),(f.filters||[]).forEach((C,Y)=>{const W=y.createDiv({cls:"filter-row"});W.style.display="flex",W.style.marginBottom="4px";const R=W.createEl("input");R.type="text",R.style.flex="0 0 30%",R.value=C.field,R.setAttr("list","think-fields-list");const j=W.createEl("select");["=","!=","includes","regex",">","<"].forEach(K=>{j.add(new Option(K,K,!1,K===C.op))}),j.onchange=()=>{C.op=j.value};const U=W.createEl("input");U.type="text",U.style.flex="0 0 30%",U.value=String(C.value);const te=()=>{U.removeAttribute("list");const K=R.value.trim();K==="tags"?U.setAttr("list","think-tags-list"):K==="category"?U.setAttr("list","think-category-list"):K==="status"?U.setAttr("list","think-status-list"):K==="recurrence"?U.setAttr("list","think-recurrence-list"):K==="type"&&U.setAttr("list","think-type-list")};te(),R.onchange=()=>{C.field=R.value.trim(),te()},U.onchange=()=>{C.value=U.value};const fe=W.createEl("button",{text:"删除"});fe.onclick=()=>{f.filters.splice(Y,1),this.display()}});const k=y.createEl("button",{text:"+ 添加过滤条件"});k.onclick=()=>{f.filters||(f.filters=[]),f.filters.push({field:"",op:"=",value:""}),this.display()};const D=g.createDiv();D.style.borderTop="1px dashed #ccc",D.style.marginTop="6px",D.style.paddingTop="6px",D.createEl("strong",{text:"排序规则"}),(f.sort||[]).forEach((C,Y)=>{const W=D.createDiv({cls:"sort-row"});W.style.display="flex",W.style.marginBottom="4px";const R=W.createEl("input");R.type="text",R.style.flex="0 0 40%",R.value=C.field,R.setAttr("list","think-fields-list"),R.onchange=()=>C.field=R.value.trim();const j=W.createEl("select");[["asc","升序"],["desc","降序"]].forEach(([te,fe])=>{j.add(new Option(fe,te,!1,te===C.dir))}),j.onchange=()=>{C.dir=j.value};const U=W.createEl("button",{text:"删除"});U.style.marginLeft="4px",U.onclick=()=>{f.sort.splice(Y,1),this.display()}});const $=D.createEl("button",{text:"+ 添加排序条件"});$.onclick=()=>{f.sort||(f.sort=[]),f.sort.push({field:"",dir:"asc"}),this.display()};const A=g.createDiv({cls:"module-actions"});if(A.style.textAlign="right",a>0){const C=A.createEl("button",{text:"↑ 上移"});C.onclick=()=>{const Y=m.modules;[Y[a-1],Y[a]]=[Y[a],Y[a-1]],this.display()}}if(a<m.modules.length-1){const C=A.createEl("button",{text:"↓ 下移"});C.onclick=()=>{const Y=m.modules;[Y[a+1],Y[a]]=[Y[a],Y[a+1]],this.display()}}const P=A.createEl("button",{text:"删除模块"});P.onclick=()=>{m.modules.splice(a,1),this.display()}});const F=e.createDiv(),O=F.createEl("select");qe.forEach(f=>{O.add(new Option(f,f))});const I=F.createEl("button",{text:"添加模块"});I.style.marginLeft="6px",I.onclick=()=>{const a={view:O.value,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};m.modules.push(a),this.display()},e.createEl("hr");const M=e.createEl("button",{text:"保存配置"});M.onclick=()=>{if(m.name!==this.selectedDashName&&this.plugin.dashboards.some(f=>f!==m&&f.name===m.name)){new V.Notice("配置名称已存在，请更换名称");return}this.plugin.saveData({dashboards:this.plugin.dashboards}).then(()=>{new V.Notice("仪表盘配置已保存"),this.plugin.refreshAllDashboards(),this.selectedDashName=m.name,this.display()})}}}function be({module:t,children:e}){const[n,i]=X(!!t.collapsed),s=Ot(null),l=()=>i(p=>!p),d=p=>{if(p.metaKey||p.ctrlKey){const _=!n,u=new CustomEvent("think-toggle-all",{detail:_});document.querySelectorAll(".think-module").forEach(h=>h.dispatchEvent(u))}else l()};return De(()=>{const p=u=>{const h=u.detail;i(h)},_=s.current;if(_)return _.addEventListener("think-toggle-all",p),()=>_.removeEventListener("think-toggle-all",p)},[]),r("div",{class:"think-module",ref:s,children:[r("div",{class:"module-header",onClick:d,title:"点击折叠/展开；Ctrl/⌘ + 点击：全部折叠/展开",children:[r("span",{class:"module-title",children:t.title}),r("span",{class:"module-toggle",children:n?"▶":"▼"})]}),!n&&r("div",{class:"module-content",children:e})]})}const jt=["一","二","三","四"];function we({config:t,dataStore:e,plugin:n}){const i=window.moment,s=t.initialView||"月",l=t.initialDate?i(t.initialDate,"YYYY-MM-DD"):i(),[d,p]=X(s),[_,u]=X(l),[h,c]=X(!1),[o,v]=X(null),[x,S]=X("TableView"),[w,m]=X(0),[b,E]=X("");De(()=>{const a=()=>m(g=>g+1);return e.subscribe(a),()=>e.unsubscribe(a)},[e]),De(()=>{h?(v((g=>typeof structuredClone=="function"?structuredClone(g):JSON.parse(JSON.stringify(g)))(t)),S("TableView")):v(null)},[h,t]);const N=(a,g)=>{let y=a.clone(),k=a.clone();switch(g){case"年":y=a.clone().startOf("year"),k=a.clone().endOf("year");break;case"季":y=a.clone().startOf("quarter"),k=a.clone().endOf("quarter");break;case"月":y=a.clone().startOf("month"),k=a.clone().endOf("month");break;case"周":y=a.clone().startOf("week"),k=a.clone().endOf("week");break;case"天":y=a.clone().startOf("day"),k=a.clone().endOf("day");break}return{startDate:y,endDate:k}},T=(a,g)=>{switch(g){case"年":return a.format("YYYY年");case"季":{const y=a.quarter();return`${a.year()}年${jt[y-1]}季度`}case"月":return a.format("YYYY-MM");case"周":return a.format("YYYY-[W]WW");case"天":return a.format("YYYY-MM-DD");default:return a.format("YYYY-MM-DD")}},F=()=>{switch(d){case"年":u(_.clone().subtract(1,"year"));break;case"季":u(_.clone().subtract(1,"quarter"));break;case"月":u(_.clone().subtract(1,"month"));break;case"周":u(_.clone().subtract(1,"week"));break;case"天":u(_.clone().subtract(1,"day"));break}},O=()=>{switch(d){case"年":u(_.clone().add(1,"year"));break;case"季":u(_.clone().add(1,"quarter"));break;case"月":u(_.clone().add(1,"month"));break;case"周":u(_.clone().add(1,"week"));break;case"天":u(_.clone().add(1,"day"));break}},I=()=>u(i()),M=a=>{if(a.view==="SettingsFormView"){const D=re[a.view];return r(be,{module:a,children:r(D,{plugin:n,storageKey:"inputSettings"})})}let g=e.queryItems(a.filters||[],a.sort||[]);if(t.tags?.length&&(g=g.filter(D=>D.tags.some($=>t.tags.some(A=>$.includes(A))))),t.path&&t.path.trim()!==""){const D=t.path.trim(),$=Q.instance.app.vault.getAbstractFileByPath(D);if($){if($ instanceof V.TFolder){const A=D.endsWith("/")?D:D+"/";g=g.filter(P=>P.id.startsWith(A))}else if($ instanceof V.TFile){const A=D+"#";g=g.filter(P=>P.id.startsWith(A))}}else{const A=D.endsWith("/")?D:D+"/";g=g.filter(P=>P.id.startsWith(A))}}if(d&&_){const{startDate:D,endDate:$}=N(_,d);g=g.filter(A=>{if(!A.date)return!0;const P=i(A.date,"YYYY-MM-DD");return P.isSameOrAfter(D)&&P.isSameOrBefore($)})}if(b.trim()){const D=b.toLowerCase();g=g.filter($=>($.title+" "+$.content).toLowerCase().includes(D))}const y=re[a.view];if(!y)return r(be,{module:a,children:r("div",{children:["未知视图: ",a.view]})});const k={...a.props||{}};return a.group&&(k.groupField=a.group),a.fields&&(k.fields=a.fields),r(be,{module:a,children:r(y,{items:g,...k})})},f=()=>{if(!o)return;const a=t.name,g=o.name.trim();if(g===""){new V.Notice("名称不能为空");return}if(g!==a&&n.dashboards.some(k=>k!==t&&k.name===g)){new V.Notice("配置名称已存在，请更换名称");return}t.name=g,t.path=o.path||"",t.tags=o.tags||[],t.initialView=o.initialView||"月",t.initialDate=o.initialDate||i().format("YYYY-MM-DD"),t.modules=o.modules,g!==a&&n.activeDashboards.forEach(k=>{k.configName===a&&(k.configName=g)});const y=n.persistAll?n.persistAll():n.saveData({dashboards:n.dashboards,inputSettings:n.inputSettings});Promise.resolve(y).then(()=>{new V.Notice("仪表盘配置已保存"),n.refreshAllDashboards()}),c(!1)};return r("div",{children:[r("div",{class:"tp-toolbar",style:"margin-bottom:8px;",children:[["年","季","月","周","天"].map(a=>r("button",{onClick:()=>p(a),class:a===d?"active":"",children:a})),r("button",{disabled:!0,style:"font-weight:bold;margin:0 4px;background:#fff;cursor:default;",children:T(_,d)}),r("button",{onClick:F,children:"←"}),r("button",{onClick:O,children:"→"}),r("button",{onClick:I,children:"＝"}),r("input",{placeholder:"快速过滤…",style:"margin-left:4px;",value:b,onInput:a=>E(a.target.value)}),r("button",{onClick:()=>c(!h),style:"margin-left:4px;",children:"⚙︎"})]}),h&&o&&r("div",{style:"border:1px solid #eee;padding:12px;margin-bottom:12px;border-radius:8px;background:#fcfcfc;",children:[r("h3",{style:"margin-top:0;",children:"编辑配置"}),r("fieldset",{style:"margin-bottom:10px;",children:[r("legend",{children:"基础设置"}),r("label",{children:["配置名称:",r("input",{type:"text",value:o.name,onInput:a=>v({...o,name:a.target.value})})]}),r("br",{}),r("label",{children:["数据源路径:",r("input",{type:"text",value:o.path||"",onInput:a=>v({...o,path:a.target.value})})]}),r("br",{}),r("label",{children:["标签(逗号分隔):",r("input",{type:"text",value:Array.isArray(o.tags)?o.tags.join(","):o.tags||"",onInput:a=>{const y=a.target.value.split(/[,，]/).map(k=>k.trim()).filter(Boolean);v({...o,tags:y})}})]}),r("br",{}),r("label",{children:["初始视图:",r("select",{value:o.initialView||"月",onChange:a=>v({...o,initialView:a.target.value}),children:["年","季","月","周","天"].map(a=>r("option",{value:a,children:a}))})]}),r("br",{}),r("label",{children:["初始日期:",r("input",{type:"date",value:o.initialDate||i().format("YYYY-MM-DD"),onChange:a=>v({...o,initialDate:a.target.value})})]}),r("br",{})]}),r("div",{id:"modulesArea",children:[o.modules.map((a,g)=>r("fieldset",{style:"border:1px solid #ccc;padding:8px;margin-bottom:8px;",children:[r("legend",{children:[a.title||"模块"," (",a.view,")"]}),r("div",{children:r("label",{children:["模块标题:",r("input",{type:"text",value:a.title,onInput:y=>{const k=[...o.modules];k[g]={...a,title:y.target.value},v({...o,modules:k})}})]})}),r("div",{children:r("label",{children:["视图类型:",r("select",{value:a.view,onChange:y=>{const k=[...o.modules];k[g]={...a,view:y.target.value},v({...o,modules:k})},children:Object.keys(re).map(y=>r("option",{value:y,children:y}))})]})}),r("div",{children:r("label",{children:["默认折叠:",r("input",{type:"checkbox",checked:!!a.collapsed,onChange:y=>{const k=[...o.modules];k[g]={...a,collapsed:y.target.checked},v({...o,modules:k})}})]})}),a.view==="TableView"&&r("div",{children:[r("label",{children:["行字段:",r("input",{type:"text",value:a.props?.rowField||"",onInput:y=>{const k=[...o.modules];k[g]={...a,props:{...a.props,rowField:y.target.value}},v({...o,modules:k})}})]}),r("br",{}),r("label",{children:["列字段:",r("input",{type:"text",value:a.props?.colField||"",onInput:y=>{const k=[...o.modules];k[g]={...a,props:{...a.props,colField:y.target.value}},v({...o,modules:k})}})]})]}),(a.view==="BlockView"||a.view==="TimelineView")&&r("div",{children:r("label",{children:["分组字段:",r("input",{type:"text",value:a.group||"",onInput:y=>{const k=[...o.modules];k[g]={...a,group:y.target.value||void 0},v({...o,modules:k})}})]})}),a.view!=="TableView"&&a.view!=="ChartView"&&a.view!=="CalendarView"&&r("div",{children:r("label",{children:["显示字段(逗号分隔 / * 为动态):",r("input",{type:"text",placeholder:"如 title,tags,date 或 *",value:a.fields?a.fields.join(","):"",onInput:y=>{const k=y.target.value,D=k.trim()==="*"?["*"]:k.split(/[,，]/).map(A=>A.trim()).filter(Boolean),$=[...o.modules];$[g]={...a,fields:D.length?D:void 0},v({...o,modules:$})}})]})}),r("div",{style:"border-top:1px dashed #ccc;margin-top:6px;padding-top:6px;",children:[r("strong",{children:"过滤规则"}),(a.filters||[]).map((y,k)=>r("div",{style:"display:flex;margin-bottom:4px;",children:[r("input",{type:"text",style:"flex:0 0 30%;",value:y.field,onInput:D=>{const $=D.target.value,A=[...a.filters||[]];A[k]={...y,field:$};const P=[...o.modules];P[g]={...a,filters:A},v({...o,modules:P})}}),r("select",{value:y.op,onChange:D=>{const $=D.target.value,A=[...a.filters||[]];A[k]={...y,op:$};const P=[...o.modules];P[g]={...a,filters:A},v({...o,modules:P})},children:["=","!=","includes","regex",">","<"].map(D=>r("option",{value:D,children:D}))}),r("input",{type:"text",style:"flex:0 0 30%;",value:String(y.value),onInput:D=>{const $=D.target.value,A=[...a.filters||[]];A[k]={...y,value:$};const P=[...o.modules];P[g]={...a,filters:A},v({...o,modules:P})}}),r("button",{onClick:()=>{const D=[...a.filters||[]];D.splice(k,1);const $=[...o.modules];$[g]={...a,filters:D},v({...o,modules:$})},children:"删除"})]})),r("button",{onClick:()=>{const y=[...a.filters||[],{field:"",op:"=",value:""}],k=[...o.modules];k[g]={...a,filters:y},v({...o,modules:k})},children:"+ 添加过滤条件"})]}),r("div",{style:"border-top:1px dashed #ccc;margin-top:6px;padding-top:6px;",children:[r("strong",{children:"排序规则"}),(a.sort||[]).map((y,k)=>r("div",{style:"display:flex;margin-bottom:4px;",children:[r("input",{type:"text",style:"flex:0 0 40%;",value:y.field,onInput:D=>{const $=D.target.value,A=[...a.sort||[]];A[k]={...y,field:$};const P=[...o.modules];P[g]={...a,sort:A},v({...o,modules:P})}}),r("select",{value:y.dir,onChange:D=>{const $=D.target.value,A=[...a.sort||[]];A[k]={...y,dir:$};const P=[...o.modules];P[g]={...a,sort:A},v({...o,modules:P})},children:[r("option",{value:"asc",children:"升序"}),r("option",{value:"desc",children:"降序"})]}),r("button",{style:"margin-left:4px;",onClick:()=>{const D=[...a.sort||[]];D.splice(k,1);const $=[...o.modules];$[g]={...a,sort:D},v({...o,modules:$})},children:"删除"})]})),r("button",{onClick:()=>{const y=[...a.sort||[],{field:"",dir:"asc"}],k=[...o.modules];k[g]={...a,sort:y},v({...o,modules:k})},children:"+ 添加排序条件"})]}),r("div",{style:"text-align:right;",children:[g>0&&r("button",{onClick:()=>{const y=[...o.modules];[y[g-1],y[g]]=[y[g],y[g-1]],v({...o,modules:y})},children:"↑ 上移"}),g<o.modules.length-1&&r("button",{onClick:()=>{const y=[...o.modules];[y[g],y[g+1]]=[y[g+1],y[g]],v({...o,modules:y})},children:"↓ 下移"}),r("button",{onClick:()=>{const y=[...o.modules];y.splice(g,1),v({...o,modules:y})},children:"删除模块"})]})]})),r("div",{children:[r("select",{value:x,onChange:a=>S(a.target.value),children:Object.keys(re).map(a=>r("option",{value:a,children:a}))}),r("button",{style:"margin-left:6px;",onClick:()=>{const a={view:x,title:"新模块",collapsed:!1,filters:[],sort:[],props:{}};v({...o,modules:[...o.modules,a]})},children:"添加模块"})]})]}),r("hr",{}),r("button",{onClick:f,children:"保存配置"}),r("button",{style:"margin-left:8px;",onClick:()=>c(!1),children:"取消"}),r("datalist",{id:"fields-list",children:Ae(e.query()).map(a=>r("option",{value:a}))})]}),!h&&t.modules.map(a=>M(a))]})}class qt extends V.Plugin{constructor(){super(...arguments),this.dashboards=[],this.activeDashboards=[],this.inputSettings={}}async onload(){console.log("ThinkPlugin 加载 - 重构版");const e=await this.loadData();e?.dashboards&&(this.dashboards=e.dashboards),this.dashboards.length===0&&this._createDefaultDashboard(),this.inputSettings=e?.inputSettings??{};for(const s of this.dashboards)for(const l of s.modules)l.view==="ListView"&&(l.view="BlockView");this.dataStore=new Q(this.app),await this.dataStore.scanAll();const n=this.app.vault.on.bind(this.app.vault),i=s=>this.dataStore.scanFile(s).then(()=>this.dataStore.notifyChange());this.registerEvent(n("modify",s=>{s instanceof V.TFile&&s.extension==="md"&&i(s)})),this.registerEvent(n("create",s=>{s instanceof V.TFile&&s.extension==="md"&&i(s)})),this.registerEvent(n("delete",s=>{s instanceof V.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(s.path),this.dataStore.notifyChange())})),this.registerEvent(n("rename",(s,l)=>{s instanceof V.TFile&&s.extension==="md"&&(this.dataStore.removeFileItems(l),i(s))})),this.registerMarkdownCodeBlockProcessor(wt,(s,l)=>{let d,p;try{const u=s.trim()?JSON.parse(s):{};Array.isArray(u.modules)?p={name:u.name||"__inline__",path:u.path||"",tags:u.tags||[],initialView:u.initialView||"月",initialDate:u.initialDate||"",modules:u.modules}:d=u.config||u.dashboard||u.name}catch(u){console.warn("ThinkPlugin: 仪表盘代码块 JSON 解析失败，使用默认",u)}if(p){ge(ae(we,{config:p,dataStore:this.dataStore,plugin:this}),l),this.activeDashboards.push({container:l,configName:p.name});return}!d&&this.dashboards.length&&(d=this.dashboards[0].name);const _=this.dashboards.find(u=>u.name===d);if(!_){l.createDiv({text:`找不到名称为 "${d}" 的仪表盘配置`});return}ge(ae(we,{config:_,dataStore:this.dataStore,plugin:this}),l),this.activeDashboards.push({container:l,configName:_.name})}),this._injectStyles(),this.addSettingTab(new Ut(this.app,this))}onunload(){const e=document.getElementById(me);e&&e.remove(),console.log("ThinkPlugin 卸载")}refreshAllDashboards(){this.activeDashboards=this.activeDashboards.filter(e=>document.body.contains(e.container));for(const e of this.activeDashboards){const n=this.dashboards.find(i=>i.name===e.configName);n&&ge(ae(we,{config:n,dataStore:this.dataStore,plugin:this}),e.container)}}async persistAll(){const e={dashboards:this.dashboards,inputSettings:this.inputSettings};await this.saveData(e)}_createDefaultDashboard(){const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i={name:"默认仪表盘",path:"",tags:[],initialView:"月",initialDate:n,modules:[{view:"BlockView",title:"未完成任务",collapsed:!1,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"open"}],sort:[],props:{}},{view:"BlockView",title:"已完成任务",collapsed:!0,filters:[{field:"type",op:"=",value:"task"},{field:"status",op:"=",value:"done"}],sort:[{field:"date",dir:"desc"}],props:{}}]};this.dashboards.push(i)}_injectStyles(){if(document.getElementById(me))return;const e=document.createElement("style");e.id=me,e.textContent=kt,document.head.appendChild(e)}}module.exports=qt;
//# sourceMappingURL=main.js.map
