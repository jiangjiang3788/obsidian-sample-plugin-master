# Think Plugin  —  本轮改动总览

下文汇总了 **全部新增 / 重写 / 需同步更新** 的文件、依赖与构建配置，方便你或团队一次性对照合并。若未列出，则保持原代码不变即可。

---

## 1 依赖

| 包                                 | 作用                          | 安装命令                                     |
| --------------------------------- | --------------------------- | ---------------------------------------- |
| **formik**                        | 表单状态管理（DashboardConfigForm） | `npm i formik`                           |
| **@preact/preset-vite**           | Vite‑Preact 预设              | `npm i -D @preact/preset-vite`           |
| **@types/react @types/react-dom** | 仅供 Formik 及别名解析用的类型         | `npm i -D @types/react @types/react-dom` |

> **不要** 再安装 `react` / `react-dom`，我们已通过 **alias→preact/compat** 解决兼容。

---

## 2 构建配置

### `vite.config.ts` (全新或覆盖)

```ts
import { defineConfig } from 'vite';
import preact from '@preact/preset-vite';

export default defineConfig({
  plugins: [preact()],
  resolve: {
    alias: {
      react: 'preact/compat',
      'react-dom': 'preact/compat',
      'react-dom/test-utils': 'preact/test-utils',
      'react/jsx-runtime': 'preact/jsx-runtime',
    },
  },
  build: {
    outDir: 'dist',
    lib: {
      entry: 'src/main.ts',
      formats: ['cjs'],
      fileName: () => 'main.js',
    },
    rollupOptions: { external: ['obsidian'] },
    sourcemap: true,
  },
  optimizeDeps: { include: ['preact', 'preact/hooks'] },
  esbuild: {
    jsxFactory: 'h',
    jsxFragment: 'Fragment',
    jsxInject: `import { h, Fragment } from 'preact'`,
  },
});
```

---

## 3 核心源码

| 文件                                   | 状态     | 关键改动                                                                                                    |
| ------------------------------------ | ------ | ------------------------------------------------------------------------------------------------------- |
| **`src/main.ts`**                    | **重写** | + `openSettingsForDashboard`（设置跳转）<br>+ 默认仪表盘注入<br>+ 数据层初始化与样式注入                                        |
| **`src/utils/itemFilter.ts`**        | **新增** | 统一 `filters` / `sort` / 日期区间 / 关键字过滤助手                                                                  |
| **`src/ui/SettingsTab.ts`**          | **重写** | 折叠式管理多仪表盘；读取 `localStorage` 定位目标；可新增/删除                                                                 |
| **`src/ui/DashboardConfigForm.tsx`** | **重写** | 表单可编辑 `filters`/`sort`/`fields`/`props`；模块 FieldArray 支持增删                                              |
| **`src/views/Dashboard.tsx`**        | **修改** | 齿轮按钮 → 设置页跳转；调用 `itemFilter`；保留原渲染逻辑                                                                    |
| **`src/views/SettingsFormView.tsx`** | 路径注释   | 文件本体未变                                                                                                  |
| **`src/views/styles.css`**           | 可选     | 增加折叠箭头样式：<br>`summary::marker { content:'▼ '; }`<br>`details[open] > summary::marker { content:'▲ '; }` |

---

## 4 代码片段索引

> 以下均在 **`src/`** 根下，已提供完整文件；此处仅摘录要点便于检索。

### 4.1 `main.ts`

```ts
openSettingsForDashboard(name: string) {
  localStorage.setItem('think-target-dash', name);
  this.app.setting.open();
  this.app.setting.openTabById(this.manifest.id);
}
```

### 4.2 `SettingsTab.ts`

```ts
const want = localStorage.getItem('think-target-dash');
if (dash.name === want) { wrap.open = true; localStorage.removeItem('think-target-dash'); }
```

### 4.3 `Dashboard.tsx`

```tsx
<button
  onClick={() => plugin.openSettingsForDashboard(config.name)}
  title="在插件设置中编辑本仪表盘"
>⚙︎</button>
```

### 4.4 `itemFilter.ts`（示例）

```ts
export function filterByRules(items, rules) { /* … */ }
export function sortItems(items, rules) { /* … */ }
export function filterByDateRange(items, startISO, endISO) { /* … */ }
export function filterByKeyword(items, kw) { /* … */ }
```

---

## 5 迁移步骤

1. **备份** 原插件目录。
2. 替换 / 新增上表中所有文件。
3. 安装依赖：

   ```bash
   npm i
   npm i formik
   npm i -D @preact/preset-vite @types/react @types/react-dom
   ```
4. 重新编译：`npm run build`（生产）或 `npm run dev`（热重载）。
5. 在 Obsidian **停用→启用** 插件一次；
6. 打开任意仪表盘，点击齿轮应自动跳到设置并展开对应配置；在设置页可折叠编辑各模块的新字段。

---

## 6 验证清单

* [ ] `npm run build` 通过，bundle 未额外引入 `react`（≈20 KB 左右即可）。
* [ ] 齿轮按钮跳转成功，无控制台报错。
* [ ] SettingsTab 能折叠展开、增删仪表盘；模块可编辑新字段并保存。
* [ ] Dashboard 过滤 / 排序 / 关键字搜索功能正常。

---

> 如需进一步扩展（例如在表单里提供可视化 JSON 编辑器），可基于当前架构继续迭代；本改动已剥离重复逻辑、统一过滤器，便于后续维护。
