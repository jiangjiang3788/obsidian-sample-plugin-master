<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>源码浏览器（复制专用 · .pyc 完全隐藏）</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;height:100vh;display:flex;overflow:hidden;
  font-family:system-ui;
}
button{
  font-size:12px;padding:4px 10px;border:1px solid #ccc;
  border-radius:6px;background:#f5f7fa;cursor:pointer;
}
#sidebar{
  width:460px;border-right:1px solid #ddd;
  padding:10px;overflow:auto;
}
.toolbar{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.toolbar-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
#tree details{margin-left:1em}
.fileRow{margin-left:2em;display:flex;gap:6px;cursor:pointer}
.selected{background:#e8ebf0}
#previewPane{flex:1;display:flex;flex-direction:column}
#previewHeader{padding:6px 10px;border-bottom:1px solid #ddd;font-weight:700}
#preview{
  flex:1;border:none;resize:none;padding:12px;
  font-family:monospace;background:#fafafa;white-space:pre;
}
.toast{
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  background:#2196f3;color:#fff;padding:8px 14px;border-radius:6px;
  opacity:0;animation:fadeIn .25s forwards,fadeOut .25s forwards 2s;
}
@keyframes fadeIn{to{opacity:1}}
@keyframes fadeOut{to{opacity:0}}
</style>
</head>

<body>

<div id="sidebar">
  <div class="toolbar">

    <div class="toolbar-row">
      <button id="openDir">选择文件夹</button>
    </div>

    <div class="toolbar-row">
      <button id="copySelected">复制选中内容</button>
      <button id="copyPaths">复制路径</button>
    </div>

    <div class="toolbar-row">
      <label>
        <input id="skipBinary" type="checkbox" checked>
        跳过二进制/无关文件
      </label>
      <label>
        单文件上限(KB)
        <input id="maxKB" type="text" value="512" style="width:80px">
      </label>
    </div>

    <div class="toolbar-row">
      <button id="selectAll">全选</button>
      <button id="clearAll">取消全选</button>
    </div>

  </div>
  <div id="tree"></div>
</div>

<div id="previewPane">
  <div id="previewHeader">文件预览（只读）</div>
  <textarea id="preview" readonly>// 点击文件查看内容</textarea>
</div>

<script>
const $ = id => document.getElementById(id);
let rootHandle=null;
let checked=new Map();
let selectedEl=null;

/* ---------- extensions ---------- */
function extOf(p){
  const i=p.lastIndexOf('.');
  return i>=0?p.slice(i+1).toLowerCase():'';
}

// ✅ 永久忽略规则（最高优先级）
function shouldAlwaysIgnore(path){
  return extOf(path)==='pyc';
}

const skipExt=new Set([
 'db','sqlite','sqlite3','log',
 'png','jpg','jpeg','gif','webp','bmp','ico',
 'zip','7z','rar','tar','gz','bz2','xz',
 'pdf','exe','dll','so','dylib',
 'mp3','mp4','mov','mkv','avi',
 'pyo','pyd','class','o'
]);

function toast(msg){
  const t=document.createElement('div');
  t.className='toast';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2400);
}

/* ---------- checkbox ---------- */
function updateChecked(cb){
  const p=cb.dataset.path;
  const t=cb.dataset.type;
  cb.checked?checked.set(p,{type:t}):checked.delete(p);
}
function setSubtree(details,state){
  details.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.checked=state;
    updateChecked(cb);
  });
}

/* ---------- render ---------- */
async function render(dir,rel,box){
  for await(const [name,h] of dir){
    const path=rel+name;

    if(h.kind==='file'){
      if(shouldAlwaysIgnore(path)) continue; // ✅ 树里不显示 pyc

      const row=document.createElement('div');
      row.className='fileRow';

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.dataset.path=path;
      cb.dataset.type='file';
      cb.onchange=()=>updateChecked(cb);

      const label=document.createElement('span');
      label.textContent=name;

      row.append(cb,label);
      row.onclick=async e=>{
        if(e.target===cb)return;
        selectedEl?.classList.remove('selected');
        row.classList.add('selected');
        selectedEl=row;
        $('preview').value=await (await h.getFile()).text();
      };
      box.appendChild(row);
    }else{
      const d=document.createElement('details');
      const s=document.createElement('summary');

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.dataset.path=path;
      cb.dataset.type='folder';
      cb.onclick=e=>{
        e.stopPropagation();
        updateChecked(cb);
        setSubtree(d,cb.checked);
      };

      s.append(cb,name);
      d.appendChild(s);
      const inner=document.createElement('div');
      d.appendChild(inner);
      box.appendChild(d);

      await render(h,path+'/',inner);
    }
  }
}

/* ---------- traversal ---------- */
async function findHandle(path){
  const parts=path.split('/').filter(Boolean);
  let cur=rootHandle;
  for(let i=0;i<parts.length;i++){
    cur=i===parts.length-1
      ? await cur.getFileHandle(parts[i]).catch(()=>null)
      : await cur.getDirectoryHandle(parts[i]).catch(()=>null);
    if(!cur)return null;
  }
  return cur;
}

async function collectFiles(h,p){
  const out=[];
  for await(const [n,ch] of h){
    if(ch.kind==='file'){
      const fp=p+n;
      if(shouldAlwaysIgnore(fp)) continue; // ✅ 递归时也过滤
      out.push(fp);
    }else{
      out.push(...await collectFiles(ch,p+n+'/'));
    }
  }
  return out;
}

/* ---------- clipboard ---------- */
async function copyText(t){
  try{await navigator.clipboard.writeText(t);}
  catch{
    const w=window.open('','','width=900,height=700');
    if(!w)return;
    w.document.write(`<textarea style="width:100%;height:100%">${t}</textarea>`);
    w.document.querySelector('textarea').select();
  }
}

/* ---------- buttons ---------- */
$('openDir').onclick=async()=>{
  rootHandle=await showDirectoryPicker();
  $('tree').innerHTML='';
  checked.clear();
  $('preview').value='// 点击文件查看内容';
  await render(rootHandle,'',$('tree'));
  toast('文件夹已打开');
};

$('copySelected').onclick=async()=>{
  let files=[];
  for(const [p,m] of checked){
    if(m.type==='file') files.push(p);
    if(m.type==='folder'){
      const h=await findHandle(p);
      if(h) files.push(...await collectFiles(h,p+'/'));
    }
  }
  files=[...new Set(files)].sort();

  let out='',used=0,skipped=0;
  const maxKB=parseInt($('maxKB').value||'0',10);

  for(const f of files){
    const h=await findHandle(f);
    if(!h)continue;
    const file=await h.getFile();

    if($('skipBinary').checked && skipExt.has(extOf(f))){
      out+=`===== ${f} =====\n[SKIPPED]\n\n`;skipped++;continue;
    }
    if(maxKB>0 && file.size>maxKB*1024){
      out+=`===== ${f} =====\n[SKIPPED: TOO LARGE]\n\n`;skipped++;continue;
    }

    out+=`===== ${f} =====\n${await file.text()}\n\n`;
    used++;
  }

  await copyText(out.trimEnd());
  toast(`复制完成：${used} 文件，跳过 ${skipped}`);
};

$('copyPaths').onclick=async()=>{
  await copyText([...checked.keys()].sort().join('\n'));
  toast('路径已复制');
};

$('selectAll').onclick=()=>{
  document.querySelectorAll('#tree input[type=checkbox]').forEach(cb=>{
    cb.checked=true;updateChecked(cb);
  });
  toast('已全选');
};

$('clearAll').onclick=()=>{
  document.querySelectorAll('#tree input[type=checkbox]').forEach(cb=>cb.checked=false);
  checked.clear();
  toast('已取消全选');
};
</script>

</body>
</html>
